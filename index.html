<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.loli.net/css?family=Noto+Serif+SC:300,300italic,400,400italic,700,700italic%7CMa+Shan+Zheng:300,300italic,400,400italic,700,700italic%7CJetBrains+Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.2/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"hf7751.gitee.io","root":"/","images":"/images","scheme":"Muse","version":"8.2.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"بحث...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}};
  </script>
<meta property="og:type" content="website">
<meta property="og:title" content="元">
<meta property="og:url" content="https://hf7751.gitee.io/index.html">
<meta property="og:site_name" content="元">
<meta property="og:locale">
<meta property="article:author" content="hefei">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://hf7751.gitee.io/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-Hans'
  };
</script>
<title>元</title>
  




  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="تشغيل شريط التصفح" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">元</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          المحتويات
        </li>
        <li class="sidebar-nav-overview">
          عام
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">hefei</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">7</span>
          <span class="site-state-item-name">المقالات</span>
        </a>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hf7751.gitee.io/2021/03/11/21-40/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="hefei">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="元">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/03/11/21-40/" class="post-title-link" itemprop="url">SQL练习题21-40</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">نُشر في</span>
      

      <time title="أُنشأ: 2021-03-11 02:36:18 / عُدل: 03:46:30" itemprop="dateCreated datePublished" datetime="2021-03-11T02:36:18+08:00">2021-03-11</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="21-寻找用户推荐人"><a href="#21-寻找用户推荐人" class="headerlink" title="21. 寻找用户推荐人"></a>21. 寻找用户推荐人</h2><p>需求：写一个查询语句，返回一个编号列表，列表中编号的推荐人的编号都 <strong>不是</strong> 2</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>name</th>
</tr>
</thead>
<tbody><tr>
<td>Will</td>
</tr>
<tr>
<td>Jane</td>
</tr>
<tr>
<td>Bill</td>
</tr>
<tr>
<td>Zack</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="number">21</span>_customer (id <span class="type">INT</span>,name <span class="type">VARCHAR</span>(<span class="number">25</span>),referee_id <span class="type">INT</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">21</span>_customer;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">21</span>_customer (id, name, referee_id) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;Will&#x27;</span>, <span class="keyword">null</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">21</span>_customer (id, name, referee_id) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;Jane&#x27;</span>, <span class="keyword">null</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">21</span>_customer (id, name, referee_id) <span class="keyword">values</span> (<span class="number">3</span>, <span class="string">&#x27;Alex&#x27;</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">21</span>_customer (id, name, referee_id) <span class="keyword">values</span> (<span class="number">4</span>, <span class="string">&#x27;Bill&#x27;</span>, <span class="keyword">null</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">21</span>_customer (id, name, referee_id) <span class="keyword">values</span> (<span class="number">5</span>, <span class="string">&#x27;Zack&#x27;</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">21</span>_customer (id, name, referee_id) <span class="keyword">values</span> (<span class="number">6</span>, <span class="string">&#x27;Mark&#x27;</span>, <span class="number">2</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">      name</span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">      <span class="number">21</span>_customer</span><br><span class="line"><span class="keyword">WHERE</span> </span><br><span class="line">      referee_id <span class="operator">&lt;&gt;</span> <span class="number">2</span> <span class="keyword">OR</span> referee_id <span class="keyword">IS</span> <span class="keyword">NULL</span>;</span><br></pre></td></tr></table></figure>

<h2 id="22-2016年的投资"><a href="#22-2016年的投资" class="headerlink" title="22. 2016年的投资"></a>22. 2016年的投资</h2><p>需求：写一个查询语句，将 2016 年 (TIV_2016) 所有成功投资的金额加起来，保留 2 位小数。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>TIV_2016</th>
</tr>
</thead>
<tbody><tr>
<td>45.00</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="number">22</span>_insurance (PID <span class="type">INTEGER</span>(<span class="number">11</span>), TIV_2015 <span class="type">NUMERIC</span>(<span class="number">15</span>,<span class="number">2</span>), TIV_2016 <span class="type">NUMERIC</span>(<span class="number">15</span>,<span class="number">2</span>), LAT <span class="type">NUMERIC</span>(<span class="number">5</span>,<span class="number">2</span>), LON <span class="type">NUMERIC</span>(<span class="number">5</span>,<span class="number">2</span>) );</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">22</span>_insurance;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">22</span>_insurance (PID, TIV_2015, TIV_2016, LAT, LON) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">10</span>, <span class="number">5</span>, <span class="number">10</span>, <span class="number">10</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">22</span>_insurance (PID, TIV_2015, TIV_2016, LAT, LON) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">20</span>, <span class="number">20</span>, <span class="number">20</span>, <span class="number">20</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">22</span>_insurance (PID, TIV_2015, TIV_2016, LAT, LON) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">10</span>, <span class="number">30</span>, <span class="number">20</span>, <span class="number">20</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">22</span>_insurance (PID, TIV_2015, TIV_2016, LAT, LON) <span class="keyword">values</span> (<span class="number">4</span>, <span class="number">10</span>, <span class="number">40</span>, <span class="number">40</span>, <span class="number">40</span>);</span><br></pre></td></tr></table></figure>

<p>提示：</p>
<p>对于一个投保人，他在 2016 年成功投资的条件是：</p>
<p>他在 2015 年的投保额 (TIV_2015) 至少跟一个其他投保人在 2015 年的投保额相同。<br>他所在的城市必须与其他投保人都不同（也就是说维度和经度不能跟其他任何一个投保人完全相同）。</p>
<p>就如最后一个投保人，第一个投保人同时满足两个条件：</p>
<ol>
<li>他在 2015 年的投保金额 TIV_2015 为 10 ，与第三个和第四个投保人在 2015 年的投保金额相同。</li>
<li>他所在城市的经纬度是独一无二的。</li>
</ol>
<p>第二个投保人两个条件都不满足。他在 2015 年的投资 TIV_2015 与其他任何投保人都不相同。<br>且他所在城市的经纬度与第三个投保人相同。基于同样的原因，第三个投保人投资失败。</p>
<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="built_in">SUM</span>(i.TIV_2016) <span class="keyword">AS</span> TIV_2016</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    <span class="number">22</span>_insurance <span class="keyword">as</span> i</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    i.TIV_2015 <span class="keyword">IN</span>(</span><br><span class="line">                          <span class="keyword">SELECT</span></span><br><span class="line">                                TIV_2015</span><br><span class="line">                          <span class="keyword">FROM</span></span><br><span class="line">                                <span class="number">22</span>_insurance</span><br><span class="line">                          <span class="keyword">GROUP</span> <span class="keyword">BY</span> </span><br><span class="line">                                TIV_2015</span><br><span class="line">                          <span class="keyword">HAVING</span> </span><br><span class="line">                                <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="operator">&gt;</span> <span class="number">1</span></span><br><span class="line">                          )</span><br><span class="line"><span class="keyword">AND</span> </span><br><span class="line">    CONCAT(LAT, LON) <span class="keyword">IN</span>(</span><br><span class="line">                          <span class="keyword">SELECT</span></span><br><span class="line">                                CONCAT(LAT, LON)</span><br><span class="line">                          <span class="keyword">FROM</span></span><br><span class="line">                                <span class="number">22</span>_insurance</span><br><span class="line">                          <span class="keyword">GROUP</span> <span class="keyword">BY</span> </span><br><span class="line">                                LAT , LON</span><br><span class="line">                          <span class="keyword">HAVING</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">    );</span><br></pre></td></tr></table></figure>

<h2 id="23-订单最多的客户"><a href="#23-订单最多的客户" class="headerlink" title="23. 订单最多的客户"></a>23. 订单最多的客户</h2><p>需求：在表 orders 中找到订单数最多客户对应的 customer_number 。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>customer_number</th>
</tr>
</thead>
<tbody><tr>
<td>3</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">23</span>_orders (order_number <span class="type">int</span>, customer_number <span class="type">int</span>, order_date <span class="type">date</span>, required_date <span class="type">date</span>, shipped_date <span class="type">date</span>, status <span class="type">char</span>(<span class="number">15</span>), comment <span class="type">char</span>(<span class="number">200</span>), key(order_number));</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">23</span>_orders;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">23</span>_orders (order_number, customer_number, order_date, required_date, shipped_date, status) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="string">&#x27;2017-04-09&#x27;</span>, <span class="string">&#x27;2017-04-13&#x27;</span>, <span class="string">&#x27;2017-04-12&#x27;</span>, <span class="string">&#x27;Closed&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">23</span>_orders (order_number, customer_number, order_date, required_date, shipped_date, status) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">2</span>, <span class="string">&#x27;2017-04-15&#x27;</span>, <span class="string">&#x27;2017-04-20&#x27;</span>, <span class="string">&#x27;2017-04-18&#x27;</span>, <span class="string">&#x27;Closed&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">23</span>_orders (order_number, customer_number, order_date, required_date, shipped_date, status) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">3</span>, <span class="string">&#x27;2017-04-16&#x27;</span>, <span class="string">&#x27;2017-04-25&#x27;</span>, <span class="string">&#x27;2017-04-20&#x27;</span>, <span class="string">&#x27;Closed&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">23</span>_orders (order_number, customer_number, order_date, required_date, shipped_date, status) <span class="keyword">values</span> (<span class="number">4</span>, <span class="number">3</span>, <span class="string">&#x27;2017-04-18&#x27;</span>, <span class="string">&#x27;2017-04-28&#x27;</span>, <span class="string">&#x27;2017-04-25&#x27;</span>, <span class="string">&#x27;Closed&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    customer_number</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    <span class="number">23</span>_orders</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> </span><br><span class="line">    customer_number</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">    <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">DESC</span></span><br><span class="line">LIMIT <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>进阶： 如果有多位顾客订单数并列最多，你能找到他们所有的 customer_number 吗？</p>
<h2 id="24-大的国家"><a href="#24-大的国家" class="headerlink" title="24. 大的国家"></a>24. 大的国家</h2><p>需求：编写一个SQL查询，输出表中所有大国家的名称、人口和面积。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>name</th>
<th>population</th>
<th>area</th>
</tr>
</thead>
<tbody><tr>
<td>Afghanistan</td>
<td>25500100</td>
<td>652230</td>
</tr>
<tr>
<td>Algeria</td>
<td>37100000</td>
<td>2381741</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">24</span>_World (name <span class="type">varchar</span>(<span class="number">255</span>), continent <span class="type">varchar</span>(<span class="number">255</span>), area <span class="type">int</span>, population <span class="type">int</span>, gdp <span class="type">bigint</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">24</span>_world;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">24</span>_World (name, continent, area, population, gdp) <span class="keyword">values</span> (<span class="string">&#x27;Afghanistan&#x27;</span>, <span class="string">&#x27;Asia&#x27;</span>, <span class="number">652230</span>, <span class="number">25500100</span>, <span class="number">20343000000</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">24</span>_World (name, continent, area, population, gdp) <span class="keyword">values</span> (<span class="string">&#x27;Albania&#x27;</span>, <span class="string">&#x27;Europe&#x27;</span>, <span class="number">28748</span>, <span class="number">2831741</span>, <span class="number">12960000000</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">24</span>_World (name, continent, area, population, gdp) <span class="keyword">values</span> (<span class="string">&#x27;Algeria&#x27;</span>, <span class="string">&#x27;Africa&#x27;</span>, <span class="number">2381741</span>, <span class="number">37100000</span>, <span class="number">188681000000</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">24</span>_World (name, continent, area, population, gdp) <span class="keyword">values</span> (<span class="string">&#x27;Andorra&#x27;</span>, <span class="string">&#x27;Europe&#x27;</span>, <span class="number">468</span>, <span class="number">78115</span>, <span class="number">3712000000</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">24</span>_World (name, continent, area, population, gdp) <span class="keyword">values</span> (<span class="string">&#x27;Angola&#x27;</span>, <span class="string">&#x27;Africa&#x27;</span>, <span class="number">1246700</span>, <span class="number">20609294</span>, <span class="number">100990000000</span>);</span><br></pre></td></tr></table></figure>

<p>说明：如果一个国家的面积超过300万平方公里，或者人口超过2500万，那么这个国家就是大国家。</p>
<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一：or</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">      w.name,</span><br><span class="line">      w.population,</span><br><span class="line">      w.area</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      <span class="number">24</span>_World w</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">      w.area <span class="operator">&gt;</span><span class="number">3000000</span> <span class="keyword">or</span> w.population <span class="operator">&gt;</span><span class="number">25000000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法二：union</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">      w.name,</span><br><span class="line">      w.population,</span><br><span class="line">      w.area</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      <span class="number">24</span>_World w</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">      w.area<span class="operator">&gt;</span><span class="number">3000000</span></span><br><span class="line"><span class="keyword">union</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">      w.name,</span><br><span class="line">      w.population,</span><br><span class="line">      w.area</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      <span class="number">24</span>_World w</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">      w.population<span class="operator">&gt;</span><span class="number">25000000</span></span><br></pre></td></tr></table></figure>

<h2 id="25-超过五名学生的课"><a href="#25-超过五名学生的课" class="headerlink" title="25. 超过五名学生的课"></a>25. 超过五名学生的课</h2><p>需求：编写一个 SQL 查询，列出所有超过或等于5名学生的课。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>class</th>
</tr>
</thead>
<tbody><tr>
<td>Math</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">25</span>_courses (student <span class="type">varchar</span>(<span class="number">255</span>), class <span class="type">varchar</span>(<span class="number">255</span>));</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">25</span>_courses;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">25</span>_courses (student, class) <span class="keyword">values</span> (<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;Math&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">25</span>_courses (student, class) <span class="keyword">values</span> (<span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;English&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">25</span>_courses (student, class) <span class="keyword">values</span> (<span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;Math&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">25</span>_courses (student, class) <span class="keyword">values</span> (<span class="string">&#x27;D&#x27;</span>, <span class="string">&#x27;Biology&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">25</span>_courses (student, class) <span class="keyword">values</span> (<span class="string">&#x27;E&#x27;</span>, <span class="string">&#x27;Math&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">25</span>_courses (student, class) <span class="keyword">values</span> (<span class="string">&#x27;F&#x27;</span>, <span class="string">&#x27;Computer&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">25</span>_courses (student, class) <span class="keyword">values</span> (<span class="string">&#x27;G&#x27;</span>, <span class="string">&#x27;Math&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">25</span>_courses (student, class) <span class="keyword">values</span> (<span class="string">&#x27;H&#x27;</span>, <span class="string">&#x27;Math&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">25</span>_courses (student, class) <span class="keyword">values</span> (<span class="string">&#x27;I&#x27;</span>, <span class="string">&#x27;Math&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">      class </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      <span class="number">25</span>_courses </span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">      class</span><br><span class="line"><span class="keyword">having</span> </span><br><span class="line">      <span class="built_in">count</span>(<span class="keyword">distinct</span> student)<span class="operator">&gt;=</span><span class="number">5</span> ;</span><br></pre></td></tr></table></figure>

<h2 id="26-好友申请"><a href="#26-好友申请" class="headerlink" title="26. 好友申请"></a>26. 好友申请</h2><p>需求一：写一个查询语句，求出好友申请的通过率，用 2 位小数表示。通过率由接受好友申请的数目除以申请总数。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>accept_rate</th>
</tr>
</thead>
<tbody><tr>
<td>0.80</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">26</span>_friend_request ( sender_id <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>, send_to_id <span class="type">INT</span> <span class="keyword">NULL</span>, request_date <span class="type">DATE</span> <span class="keyword">NULL</span>);</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">26</span>_request_accepted ( requester_id <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>, accepter_id <span class="type">INT</span> <span class="keyword">NULL</span>, accept_date <span class="type">DATE</span> <span class="keyword">NULL</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">26</span>_friend_request;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">26</span>_friend_request (sender_id, send_to_id, request_date) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">2</span>, <span class="string">&#x27;2016/06/01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">26</span>_friend_request (sender_id, send_to_id, request_date) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">3</span>, <span class="string">&#x27;2016/06/01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">26</span>_friend_request (sender_id, send_to_id, request_date) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">4</span>, <span class="string">&#x27;2016/06/01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">26</span>_friend_request (sender_id, send_to_id, request_date) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">3</span>, <span class="string">&#x27;2016/06/02&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">26</span>_friend_request (sender_id, send_to_id, request_date) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">4</span>, <span class="string">&#x27;2016/06/09&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">26</span>_request_accepted;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">26</span>_request_accepted (requester_id, accepter_id, accept_date) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">2</span>, <span class="string">&#x27;2016/06/03&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">26</span>_request_accepted (requester_id, accepter_id, accept_date) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">3</span>, <span class="string">&#x27;2016/06/08&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">26</span>_request_accepted (requester_id, accepter_id, accept_date) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">3</span>, <span class="string">&#x27;2016/06/08&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">26</span>_request_accepted (requester_id, accepter_id, accept_date) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">4</span>, <span class="string">&#x27;2016/06/09&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>注意:</p>
<p>​        通过的好友申请不一定都在表 friend_request 中。在这种情况下，你只需要统计总的被通过的申请数（不管它们在不在原来的申请中），并将它除以申请总数，得到通过率<br>一个好友申请发送者有可能会给接受者发几条好友申请，也有可能一个好友申请会被通过好几次。这种情况下，重复的好友申请只统计一次。<br>如果一个好友申请都没有，通过率为 0.00 。</p>
<p>解释： 总共有 5 个申请，其中 4 个是不重复且被通过的好友申请，所以成功率是 0.80 。</p>
<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">      round(</span><br><span class="line">            ifnull(</span><br><span class="line">                   (<span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> (<span class="keyword">select</span> <span class="keyword">distinct</span> requester_id, accepter_id <span class="keyword">from</span> <span class="number">26</span>_request_accepted) <span class="keyword">as</span> A)</span><br><span class="line">                   <span class="operator">/</span></span><br><span class="line">                   (<span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> (<span class="keyword">select</span> <span class="keyword">distinct</span> sender_id, send_to_id <span class="keyword">from</span> <span class="number">26</span>_friend_request) <span class="keyword">as</span> B)</span><br><span class="line">            , <span class="number">0</span>)</span><br><span class="line">      , <span class="number">2</span>) <span class="keyword">as</span> accept_rate;</span><br></pre></td></tr></table></figure>



<p>需求二：写一个查询语句，求出谁拥有最多的好友和他拥有的好友数目。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>num</th>
</tr>
</thead>
<tbody><tr>
<td>3</td>
<td>3</td>
</tr>
</tbody></table>
<p><strong>注意：</strong></p>
<ul>
<li>保证拥有最多好友数目的只有 1 个人。</li>
<li>好友申请只会被接受一次，所以不会有 <strong>requester_id</strong> 和 <strong>accepter_id</strong> 值都相同的重复记录。</li>
</ul>
<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">     ids <span class="keyword">as</span> id,</span><br><span class="line">     cnt <span class="keyword">as</span> num</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    (<span class="keyword">select</span></span><br><span class="line">           ids,</span><br><span class="line">           <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> cnt</span><br><span class="line">     <span class="keyword">from</span></span><br><span class="line">           (<span class="keyword">select</span> </span><br><span class="line">                  requester_id <span class="keyword">as</span> ids </span><br><span class="line">            <span class="keyword">from</span></span><br><span class="line">                  <span class="number">26</span>_request_accepted</span><br><span class="line">            <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">            <span class="keyword">select</span></span><br><span class="line">                  accepter_id </span><br><span class="line">            <span class="keyword">from</span></span><br><span class="line">                  <span class="number">26</span>_request_accepted</span><br><span class="line">            ) <span class="keyword">as</span> tbl1</span><br><span class="line">     <span class="keyword">group</span> <span class="keyword">by</span> ids</span><br><span class="line">     ) <span class="keyword">as</span> tbl2</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> </span><br><span class="line">     cnt <span class="keyword">desc</span></span><br><span class="line">limit <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<h2 id="27-体育馆人流量"><a href="#27-体育馆人流量" class="headerlink" title="27. 体育馆人流量"></a>27. 体育馆人流量</h2><p>需求：请编写一个查询语句，找出人流量的高峰期。高峰期定义，至少连续三行记录中的人流量不少于100。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>visit_date</th>
<th>people</th>
</tr>
</thead>
<tbody><tr>
<td>5</td>
<td>2017-01-05</td>
<td>145</td>
</tr>
<tr>
<td>6</td>
<td>2017-01-06</td>
<td>1455</td>
</tr>
<tr>
<td>7</td>
<td>2017-01-07</td>
<td>199</td>
</tr>
<tr>
<td>8</td>
<td>2017-01-08</td>
<td>188</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">27</span>_stadium (id <span class="type">int</span>, visit_date <span class="type">DATE</span> <span class="keyword">NULL</span>, people <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">27</span>_stadium;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">27</span>_stadium (id, visit_date, people) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;2017-01-01&#x27;</span>, <span class="number">10</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">27</span>_stadium (id, visit_date, people) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;2017-01-02&#x27;</span>, <span class="number">109</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">27</span>_stadium (id, visit_date, people) <span class="keyword">values</span> (<span class="number">3</span>, <span class="string">&#x27;2017-01-03&#x27;</span>, <span class="number">150</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">27</span>_stadium (id, visit_date, people) <span class="keyword">values</span> (<span class="number">4</span>, <span class="string">&#x27;2017-01-04&#x27;</span>, <span class="number">99</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">27</span>_stadium (id, visit_date, people) <span class="keyword">values</span> (<span class="number">5</span>, <span class="string">&#x27;2017-01-05&#x27;</span>, <span class="number">145</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">27</span>_stadium (id, visit_date, people) <span class="keyword">values</span> (<span class="number">6</span>, <span class="string">&#x27;2017-01-06&#x27;</span>, <span class="number">1455</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">27</span>_stadium (id, visit_date, people) <span class="keyword">values</span> (<span class="number">7</span>, <span class="string">&#x27;2017-01-07&#x27;</span>, <span class="number">199</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">27</span>_stadium (id, visit_date, people) <span class="keyword">values</span> (<span class="number">8</span>, <span class="string">&#x27;2017-01-08&#x27;</span>, <span class="number">188</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">     <span class="keyword">distinct</span> a.<span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">     <span class="number">27</span>_stadium <span class="keyword">as</span> a,</span><br><span class="line">     <span class="number">27</span>_stadium <span class="keyword">as</span> b,</span><br><span class="line">     <span class="number">27</span>_stadium <span class="keyword">as</span> c</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">     ((a.id <span class="operator">=</span> b.id<span class="number">-1</span> <span class="keyword">and</span> b.id<span class="operator">+</span><span class="number">1</span> <span class="operator">=</span> c.id) <span class="keyword">or</span>(a.id<span class="number">-1</span> <span class="operator">=</span> b.id <span class="keyword">and</span> a.id<span class="operator">+</span><span class="number">1</span> <span class="operator">=</span> c.id) <span class="keyword">or</span>(a.id<span class="number">-1</span> <span class="operator">=</span> c.id <span class="keyword">and</span> c.id<span class="number">-1</span> <span class="operator">=</span> b.id))</span><br><span class="line">      <span class="keyword">and</span> </span><br><span class="line">     (a.people<span class="operator">&gt;=</span><span class="number">100</span> <span class="keyword">and</span> b.people<span class="operator">&gt;=</span><span class="number">100</span> <span class="keyword">and</span> c.people<span class="operator">&gt;=</span><span class="number">100</span>)</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> </span><br><span class="line">     a.id;</span><br></pre></td></tr></table></figure>

<h2 id="28-连续空余座位"><a href="#28-连续空余座位" class="headerlink" title="28. 连续空余座位"></a>28. 连续空余座位</h2><p>需求：编写一个 SQL 查询，获取所有空余座位，并将它们按照 seat_id 排序</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>seat_id</th>
</tr>
</thead>
<tbody><tr>
<td>3</td>
</tr>
<tr>
<td>4</td>
</tr>
<tr>
<td>5</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">28</span>_cinema (seat_id <span class="type">int</span> <span class="keyword">primary</span> key auto_increment, <span class="keyword">free</span> bool);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">28</span>_cinema;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">28</span>_cinema (seat_id, <span class="keyword">free</span>) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">28</span>_cinema (seat_id, <span class="keyword">free</span>) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">28</span>_cinema (seat_id, <span class="keyword">free</span>) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">28</span>_cinema (seat_id, <span class="keyword">free</span>) <span class="keyword">values</span> (<span class="number">4</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">28</span>_cinema (seat_id, <span class="keyword">free</span>) <span class="keyword">values</span> (<span class="number">5</span>, <span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong></p>
<ul>
<li>seat_id 字段是一个自增的整数，free 字段是布尔类型（’1’ 表示空余， ‘0’ 表示已被占据）。</li>
<li>连续空余座位的定义是大于等于 2 个连续空余的座位。</li>
</ul>
<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">     <span class="keyword">distinct</span> a.seat_id</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">     <span class="number">28</span>_cinema a </span><br><span class="line"><span class="keyword">join</span> </span><br><span class="line">     <span class="number">28</span>_cinema b</span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">     <span class="built_in">abs</span>(a.seat_id <span class="operator">-</span> b.seat_id) <span class="operator">=</span> <span class="number">1</span> <span class="keyword">and</span> a.free <span class="operator">=</span> <span class="literal">true</span> <span class="keyword">and</span> b.free <span class="operator">=</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> </span><br><span class="line">     a.seat_id;</span><br></pre></td></tr></table></figure>

<h2 id="29-销售员"><a href="#29-销售员" class="headerlink" title="29. 销售员"></a>29. 销售员</h2><p>需求：输出所有表 salesperson中，没有向公司 ‘RED’ 销售任何东西的销售员。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>name</th>
</tr>
</thead>
<tbody><tr>
<td>Amy</td>
</tr>
<tr>
<td>Mark</td>
</tr>
<tr>
<td>Alex</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">29</span>_salesperson (sales_id <span class="type">int</span>, name <span class="type">varchar</span>(<span class="number">255</span>), salary <span class="type">int</span>,commission_rate <span class="type">int</span>, hire_date <span class="type">varchar</span>(<span class="number">255</span>));</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">29</span>_company (com_id <span class="type">int</span>, name <span class="type">varchar</span>(<span class="number">255</span>), city <span class="type">varchar</span>(<span class="number">255</span>));</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">29</span>_orders (order_id <span class="type">int</span>, order_date <span class="type">varchar</span>(<span class="number">255</span>), com_id <span class="type">int</span>, sales_id <span class="type">int</span>, amount <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">29</span>_salesperson;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">29</span>_salesperson (sales_id, name, salary, commission_rate, hire_date) <span class="keyword">values</span> (<span class="number">1</span>,<span class="string">&#x27;John&#x27;</span>,<span class="number">100000</span>, <span class="number">6</span>, <span class="string">&#x27;4/1/2006&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">29</span>_salesperson (sales_id, name, salary, commission_rate, hire_date) <span class="keyword">values</span> (<span class="number">2</span>,<span class="string">&#x27;Amy&#x27;</span>, <span class="number">12000</span>, <span class="number">5</span>, <span class="string">&#x27;5/1/2010&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">29</span>_salesperson (sales_id, name, salary, commission_rate, hire_date) <span class="keyword">values</span> (<span class="number">3</span>,<span class="string">&#x27;Mark&#x27;</span>,<span class="number">65000</span>, <span class="number">12</span>, <span class="string">&#x27;12/25/2008&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">29</span>_salesperson (sales_id, name, salary, commission_rate, hire_date) <span class="keyword">values</span> (<span class="number">4</span>,<span class="string">&#x27;Pam&#x27;</span>, <span class="number">25000</span>, <span class="number">25</span>, <span class="string">&#x27;1/1/2005&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">29</span>_salesperson (sales_id, name, salary, commission_rate, hire_date) <span class="keyword">values</span> (<span class="number">5</span>,<span class="string">&#x27;Alex&#x27;</span>, <span class="number">5000</span>, <span class="number">10</span>, <span class="string">&#x27;2/3/2007&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">29</span>_company;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">29</span>_company (com_id, name, city) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;RED&#x27;</span>, <span class="string">&#x27;Boston&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">29</span>_company (com_id, name, city) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;ORANGE&#x27;</span>, <span class="string">&#x27;New York&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">29</span>_company (com_id, name, city) <span class="keyword">values</span> (<span class="number">3</span>, <span class="string">&#x27;YELLOW&#x27;</span>, <span class="string">&#x27;Boston&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">29</span>_company (com_id, name, city) <span class="keyword">values</span> (<span class="number">4</span>, <span class="string">&#x27;GREEN&#x27;</span>, <span class="string">&#x27;Austin&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">29</span>_orders;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">29</span>_orders (order_id, order_date, com_id, sales_id, amount) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;1/1/2014&#x27;</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">10000</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">29</span>_orders (order_id, order_date, com_id, sales_id, amount) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;2/1/2014&#x27;</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">5000</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">29</span>_orders (order_id, order_date, com_id, sales_id, amount) <span class="keyword">values</span> (<span class="number">3</span>, <span class="string">&#x27;3/1/2014&#x27;</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">50000</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">29</span>_orders (order_id, order_date, com_id, sales_id, amount) <span class="keyword">values</span> (<span class="number">4</span>, <span class="string">&#x27;4/1/2014&#x27;</span>, <span class="number">1</span>, <span class="number">4</span>, <span class="number">25000</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    s.name</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    <span class="number">29</span>_salesperson s</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    s.sales_id <span class="keyword">NOT</span> <span class="keyword">IN</span> (</span><br><span class="line">                       <span class="keyword">SELECT</span></span><br><span class="line">                             o.sales_id</span><br><span class="line">                       <span class="keyword">FROM</span></span><br><span class="line">                             <span class="number">29</span>_orders o</span><br><span class="line">                       <span class="keyword">LEFT</span> <span class="keyword">JOIN</span></span><br><span class="line">                             <span class="number">29</span>_company c </span><br><span class="line">                       <span class="keyword">ON</span></span><br><span class="line">                             o.com_id <span class="operator">=</span> c.com_id</span><br><span class="line">                       <span class="keyword">WHERE</span></span><br><span class="line">                             c.name <span class="operator">=</span> <span class="string">&#x27;RED&#x27;</span></span><br><span class="line">    );</span><br></pre></td></tr></table></figure>

<h2 id="30-节点树"><a href="#30-节点树" class="headerlink" title="30. 节点树"></a>30. 节点树</h2><p>需求：写一个查询语句，输出所有节点的编号和节点的类型，并将结果按照节点编号排序。</p>
<p>表 tree，<strong>id</strong> 是树节点的编号， <strong>p_id</strong> 是它父节点的 <strong>id 。</strong></p>
<p>树中每个节点属于以下三种类型之一：</p>
<p>​        叶子：如果这个节点没有任何孩子节点。</p>
<p>​        根：如果这个节点是整棵树的根，即没有父节点。</p>
<p>​        内部节点：如果这个节点既不是叶子节点也不是根节点。</p>
<table>
<thead>
<tr>
<th>id</th>
<th>p_id</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>null</td>
</tr>
<tr>
<td>2</td>
<td>1</td>
</tr>
<tr>
<td>3</td>
<td>1</td>
</tr>
<tr>
<td>4</td>
<td>2</td>
</tr>
<tr>
<td>5</td>
<td>2</td>
</tr>
</tbody></table>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>Type</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>Root</td>
</tr>
<tr>
<td>2</td>
<td>Inner</td>
</tr>
<tr>
<td>3</td>
<td>Leaf</td>
</tr>
<tr>
<td>4</td>
<td>Leaf</td>
</tr>
<tr>
<td>5</td>
<td>Leaf</td>
</tr>
</tbody></table>
<p>解释:</p>
<p>节点 1 是根节点，因为它的父节点是 NULL ，同时它有孩子节点 2 和 3 。</p>
<p>节点 2 是内部节点，因为它有父节点 1 ，也有孩子节点 4 和 5 。</p>
<p>节点 3, 4 和 5 都是叶子节点，因为它们都有父节点同时没有孩子节点。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">30</span>_tree (id <span class="type">int</span>, p_id <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">30</span>_tree;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">30</span>_tree (id, p_id) <span class="keyword">values</span> (<span class="number">1</span>, <span class="keyword">null</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">30</span>_tree (id, p_id) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">30</span>_tree (id, p_id) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">30</span>_tree (id, p_id) <span class="keyword">values</span> (<span class="number">4</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">30</span>_tree (id, p_id) <span class="keyword">values</span> (<span class="number">5</span>, <span class="number">2</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一：</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    id, <span class="string">&#x27;Root&#x27;</span> <span class="keyword">AS</span> Type</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    <span class="number">30</span>_tree</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    p_id <span class="keyword">IS</span> <span class="keyword">NULL</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">UNION</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    id, <span class="string">&#x27;Leaf&#x27;</span> <span class="keyword">AS</span> Type</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    <span class="number">30</span>_tree</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    id <span class="keyword">NOT</span> <span class="keyword">IN</span> (<span class="keyword">SELECT</span></span><br><span class="line">                     <span class="keyword">DISTINCT</span> p_id</span><br><span class="line">               <span class="keyword">FROM</span></span><br><span class="line">                     <span class="number">30</span>_tree</span><br><span class="line">               <span class="keyword">WHERE</span></span><br><span class="line">                     p_id <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>)</span><br><span class="line">    <span class="keyword">AND</span> p_id <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">UNION</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    id, <span class="string">&#x27;Inner&#x27;</span> <span class="keyword">AS</span> Type</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    <span class="number">30</span>_tree</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    id <span class="keyword">IN</span> (<span class="keyword">SELECT</span></span><br><span class="line">                <span class="keyword">DISTINCT</span> p_id</span><br><span class="line">           <span class="keyword">FROM</span></span><br><span class="line">                <span class="number">30</span>_tree</span><br><span class="line">           <span class="keyword">WHERE</span></span><br><span class="line">                p_id <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>)</span><br><span class="line">    <span class="keyword">AND</span> p_id <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法二：</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">      id <span class="keyword">AS</span> `Id`,</span><br><span class="line">      <span class="keyword">CASE</span> </span><br><span class="line">          <span class="keyword">WHEN</span> t1.id <span class="operator">=</span> (<span class="keyword">SELECT</span> t2.id <span class="keyword">FROM</span> <span class="number">30</span>_tree <span class="keyword">as</span> t2 <span class="keyword">WHERE</span> t2.p_id <span class="keyword">IS</span> <span class="keyword">NULL</span>) <span class="keyword">THEN</span> <span class="string">&#x27;Root&#x27;</span></span><br><span class="line">          <span class="keyword">WHEN</span> t1.id <span class="keyword">IN</span> (<span class="keyword">SELECT</span> t3.p_id <span class="keyword">FROM</span> <span class="number">30</span>_tree t3) <span class="keyword">THEN</span> <span class="string">&#x27;Inner&#x27;</span></span><br><span class="line">          <span class="keyword">ELSE</span> <span class="string">&#x27;Leaf&#x27;</span></span><br><span class="line">      <span class="keyword">END</span> <span class="keyword">AS</span> Type</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">      <span class="number">30</span>_tree t1</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> `Id`;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法三：</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    t1.id,</span><br><span class="line">    IF(ISNULL(t1.p_id),<span class="string">&#x27;Root&#x27;</span>, IF(t1.id <span class="keyword">IN</span> (<span class="keyword">SELECT</span> p_id <span class="keyword">FROM</span> <span class="number">30</span>_tree), <span class="string">&#x27;Inner&#x27;</span>,<span class="string">&#x27;Leaf&#x27;</span>)) Type</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    <span class="number">30</span>_tree t1</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> t1.id;</span><br></pre></td></tr></table></figure>

<h2 id="31-判断是否是三角形"><a href="#31-判断是否是三角形" class="headerlink" title="31. 判断是否是三角形"></a>31. 判断是否是三角形</h2><p>需求：编写一个 SQL 查询，判断三条线段是否能形成一个三角形。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>x</th>
<th>y</th>
<th>z</th>
<th>triangle</th>
</tr>
</thead>
<tbody><tr>
<td>13</td>
<td>15</td>
<td>30</td>
<td>No</td>
</tr>
<tr>
<td>10</td>
<td>20</td>
<td>15</td>
<td>Yes</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">31</span>_triangle (x <span class="type">int</span>, y <span class="type">int</span>, z <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">31</span>_triangle;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">31</span>_triangle (x, y, z) <span class="keyword">values</span> (<span class="number">13</span>, <span class="number">15</span>, <span class="number">30</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">31</span>_triangle (x, y, z) <span class="keyword">values</span> (<span class="number">10</span>, <span class="number">20</span>, <span class="number">15</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">      x,</span><br><span class="line">      y,</span><br><span class="line">      z,</span><br><span class="line">      if((x <span class="operator">+</span> y <span class="operator">&lt;=</span> z <span class="keyword">or</span> x <span class="operator">+</span> z <span class="operator">&lt;=</span> y <span class="keyword">or</span> y <span class="operator">+</span> z <span class="operator">&lt;=</span> x), &quot;No&quot;, &quot;Yes&quot;) <span class="keyword">as</span> triangle</span><br><span class="line"><span class="keyword">from</span> <span class="number">31</span>_triangle;</span><br></pre></td></tr></table></figure>

<h2 id="32-平面上的最近距离"><a href="#32-平面上的最近距离" class="headerlink" title="32. 平面上的最近距离"></a>32. 平面上的最近距离</h2><p>需求：写一个查询语句找到两点之间的最近距离，保留 2 位小数。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>shortest</th>
</tr>
</thead>
<tbody><tr>
<td>1.00</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">32</span>_point_2d (x <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>, y <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">32</span>_point_2d;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">32</span>_point_2d (x, y) <span class="keyword">values</span> (<span class="number">-1</span>, <span class="number">-1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">32</span>_point_2d (x, y) <span class="keyword">values</span> (<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">32</span>_point_2d (x, y) <span class="keyword">values</span> (<span class="number">-1</span>, <span class="number">-2</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一：</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    ROUND(<span class="built_in">SQRT</span>(<span class="built_in">MIN</span>((POW(p1.x <span class="operator">-</span> p2.x, <span class="number">2</span>) <span class="operator">+</span> POW(p1.y <span class="operator">-</span> p2.y, <span class="number">2</span>)))), <span class="number">2</span>) <span class="keyword">AS</span> shortest</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    <span class="number">32</span>_point_2d p1</span><br><span class="line"><span class="keyword">JOIN</span></span><br><span class="line">    <span class="number">32</span>_point_2d p2 </span><br><span class="line"><span class="keyword">ON</span> </span><br><span class="line">    p1.x <span class="operator">!=</span> p2.x <span class="keyword">OR</span> p1.y <span class="operator">!=</span> p2.y;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法二：</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    ROUND(<span class="built_in">SQRT</span>(<span class="built_in">MIN</span>((POW(p1.x <span class="operator">-</span> p2.x, <span class="number">2</span>) <span class="operator">+</span> POW(p1.y <span class="operator">-</span> p2.y, <span class="number">2</span>)))),<span class="number">2</span>) <span class="keyword">AS</span> shortest</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    <span class="number">32</span>_point_2d p1</span><br><span class="line"><span class="keyword">JOIN</span></span><br><span class="line">    <span class="number">32</span>_point_2d p2 </span><br><span class="line"><span class="keyword">ON</span> (p1.x <span class="operator">&lt;=</span> p2.x <span class="keyword">AND</span> p1.y <span class="operator">&lt;</span> p2.y) <span class="keyword">OR</span> (p1.x <span class="operator">&lt;=</span> p2.x <span class="keyword">AND</span> p1.y <span class="operator">&gt;</span> p2.y) <span class="keyword">OR</span> (p1.x <span class="operator">&lt;</span> p2.x <span class="keyword">AND</span> p1.y <span class="operator">=</span> p2.y);</span><br></pre></td></tr></table></figure>

<h2 id="33-直线上最近距离"><a href="#33-直线上最近距离" class="headerlink" title="33. 直线上最近距离"></a>33. 直线上最近距离</h2><p>需求：找到这些点中最近两个点之间的距离。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>shortest</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">33</span>_point (x <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>, <span class="keyword">UNIQUE</span> INDEX x_UNIQUE (x <span class="keyword">ASC</span>));</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">33</span>_point;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">33</span>_point (x) <span class="keyword">values</span> (<span class="number">-1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">33</span>_point (x) <span class="keyword">values</span> (<span class="number">0</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">33</span>_point (x) <span class="keyword">values</span> (<span class="number">2</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="built_in">MIN</span>(<span class="built_in">ABS</span>(p1.x <span class="operator">-</span> p2.x)) <span class="keyword">AS</span> shortest</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    <span class="number">33</span>_point p1</span><br><span class="line"><span class="keyword">JOIN</span></span><br><span class="line">    <span class="number">33</span>_point p2 </span><br><span class="line"><span class="keyword">ON</span> p1.x <span class="operator">!=</span> p2.x;</span><br></pre></td></tr></table></figure>

<h2 id="34-二级关注者"><a href="#34-二级关注者" class="headerlink" title="34. 二级关注者"></a>34. 二级关注者</h2><p>需求：对每一个关注者(follower)，查询他的关注者数目。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>follower</th>
<th>num</th>
</tr>
</thead>
<tbody><tr>
<td>B</td>
<td>2</td>
</tr>
<tr>
<td>D</td>
<td>1</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">34</span>_follow (followee <span class="type">varchar</span>(<span class="number">255</span>), follower <span class="type">varchar</span>(<span class="number">255</span>));</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">34</span>_follow;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">34</span>_follow (followee, follower) <span class="keyword">values</span> (<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">34</span>_follow (followee, follower) <span class="keyword">values</span> (<span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">34</span>_follow (followee, follower) <span class="keyword">values</span> (<span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;D&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">34</span>_follow (followee, follower) <span class="keyword">values</span> (<span class="string">&#x27;D&#x27;</span>, <span class="string">&#x27;E&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>解释：</p>
<p>以A为主体，A为被关注者，B为被关注者，求出关注B的关注者。这里需要注意，被关注者永远不会被他 / 她自己关注。<br>将结果按照字典序返回。</p>
<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">      followee <span class="keyword">as</span> <span class="string">&#x27;follower&#x27;</span>,</span><br><span class="line">      <span class="built_in">count</span>(<span class="keyword">distinct</span> follower) <span class="keyword">as</span> num</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">      <span class="number">34</span>_follow</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">      followee <span class="keyword">in</span>(<span class="keyword">select</span> follower <span class="keyword">from</span> <span class="number">34</span>_follow)</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>说明：这里的group by 表示使用第一列作为分组依据，order by 同理。</p>
<h2 id="35-平均工资"><a href="#35-平均工资" class="headerlink" title="35. 平均工资"></a>35. 平均工资</h2><p>需求：写一个查询语句，求出在每一个工资发放日，每个部门的平均工资与公司的平均工资的比较结果 （高 / 低 / 相同）</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>pay_month</th>
<th>department_id</th>
<th>comparison</th>
</tr>
</thead>
<tbody><tr>
<td>2017-03</td>
<td>1</td>
<td>higher</td>
</tr>
<tr>
<td>2017-03</td>
<td>2</td>
<td>lower</td>
</tr>
<tr>
<td>2017-02</td>
<td>1</td>
<td>same</td>
</tr>
<tr>
<td>2017-02</td>
<td>2</td>
<td>same</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">35</span>_salary (id <span class="type">int</span>, employee_id <span class="type">int</span>, amount <span class="type">int</span>, pay_date <span class="type">date</span>);</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">35</span>_employee (employee_id <span class="type">int</span>, department_id <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">35</span>_salary;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">35</span>_salary (id, employee_id, amount, pay_date) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="number">9000</span>, <span class="string">&#x27;2017/03/31&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">35</span>_salary (id, employee_id, amount, pay_date) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">2</span>, <span class="number">6000</span>, <span class="string">&#x27;2017/03/31&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">35</span>_salary (id, employee_id, amount, pay_date) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">3</span>, <span class="number">10000</span>, <span class="string">&#x27;2017/03/31&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">35</span>_salary (id, employee_id, amount, pay_date) <span class="keyword">values</span> (<span class="number">4</span>, <span class="number">1</span>, <span class="number">7000</span>, <span class="string">&#x27;2017/02/28&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">35</span>_salary (id, employee_id, amount, pay_date) <span class="keyword">values</span> (<span class="number">5</span>, <span class="number">2</span>, <span class="number">6000</span>, <span class="string">&#x27;2017/02/28&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">35</span>_salary (id, employee_id, amount, pay_date) <span class="keyword">values</span> (<span class="number">6</span>, <span class="number">3</span>, <span class="number">8000</span>, <span class="string">&#x27;2017/02/28&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">35</span>_employee;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">35</span>_employee (employee_id, department_id) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">35</span>_employee (employee_id, department_id) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">35</span>_employee (employee_id, department_id) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">2</span>);</span><br></pre></td></tr></table></figure>

<p>解释:</p>
<p>在三月，公司的平均工资是 (9000+6000+10000)/3 = 8333.33…</p>
<p>由于部门 1 里只有一个 employee_id 为 1 的员工，所以部门 1 的平均工资就是此人的工资 9000 。因为 9000 &gt; 8333.33 ，所以比较结果是 ‘higher’。</p>
<p>第二个部门的平均工资为 employee_id 为 2 和 3 两个人的平均工资，为 (6000+10000)/2=8000 。因为 8000 &lt; 8333.33 ，所以比较结果是 ‘lower’ 。</p>
<p> 在二月用同样的公式求平均工资并比较，比较结果为 ‘same’ ，因为部门 1 和部门 2 的平均工资与公司的平均工资相同，都是 7000 。</p>
<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">      department_salary.pay_month,</span><br><span class="line">      department_id,</span><br><span class="line">      <span class="keyword">case</span></span><br><span class="line">          <span class="keyword">when</span> department_avg<span class="operator">&gt;</span>company_avg <span class="keyword">then</span> <span class="string">&#x27;higher&#x27;</span></span><br><span class="line">          <span class="keyword">when</span> department_avg<span class="operator">&lt;</span>company_avg <span class="keyword">then</span> <span class="string">&#x27;lower&#x27;</span></span><br><span class="line">          <span class="keyword">else</span> <span class="string">&#x27;same&#x27;</span></span><br><span class="line">      <span class="keyword">end</span> <span class="keyword">as</span> comparison</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">     (<span class="keyword">select</span></span><br><span class="line">            department_id,</span><br><span class="line">            <span class="built_in">avg</span>(amount) <span class="keyword">as</span> department_avg,</span><br><span class="line">            date_format(pay_date, <span class="string">&#x27;%Y-%m&#x27;</span>) <span class="keyword">as</span> pay_month</span><br><span class="line">      <span class="keyword">from</span> </span><br><span class="line">            <span class="number">35</span>_salary <span class="keyword">as</span> s1</span><br><span class="line">      <span class="keyword">join</span></span><br><span class="line">            <span class="number">35</span>_employee <span class="keyword">as</span> e1</span><br><span class="line">      <span class="keyword">on</span>  </span><br><span class="line">            s1.employee_id <span class="operator">=</span> e1.employee_id</span><br><span class="line">      <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">            department_id, pay_month</span><br><span class="line">     ) <span class="keyword">as</span> department_salary</span><br><span class="line"><span class="keyword">join</span></span><br><span class="line">    (<span class="keyword">select</span></span><br><span class="line">           <span class="built_in">avg</span>(amount) <span class="keyword">as</span> company_avg,</span><br><span class="line">           date_format(pay_date, <span class="string">&#x27;%Y-%m&#x27;</span>) <span class="keyword">as</span> pay_month </span><br><span class="line">     <span class="keyword">from</span> </span><br><span class="line">           <span class="number">35</span>_salary</span><br><span class="line">     <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">           date_format(pay_date, <span class="string">&#x27;%Y-%m&#x27;</span>)</span><br><span class="line">     ) <span class="keyword">as</span> company_salary</span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">     department_salary.pay_month <span class="operator">=</span> company_salary.pay_month;</span><br></pre></td></tr></table></figure>

<h2 id="36-学生地理信息报告"><a href="#36-学生地理信息报告" class="headerlink" title="36. 学生地理信息报告"></a>36. 学生地理信息报告</h2><p>需求：写一个查询语句实现对大洲（continent）列的 透视表 操作，使得每个学生按照姓名的字母顺序依次排列在对应的大洲下面。输出的标题应依次为美洲（America）、亚洲（Asia）和欧洲（Europe）。数据保证来自美洲的学生不少于来自亚洲或者欧洲的学生。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>America</th>
<th>Asia</th>
<th>Europe</th>
</tr>
</thead>
<tbody><tr>
<td>Jack</td>
<td>Xi</td>
<td>Pascal</td>
</tr>
<tr>
<td>Jane</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">36</span>_student (name <span class="type">varchar</span>(<span class="number">50</span>), continent <span class="type">varchar</span>(<span class="number">7</span>));</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">36</span>_student;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">36</span>_student (name, continent) <span class="keyword">values</span> (<span class="string">&#x27;Jane&#x27;</span>, <span class="string">&#x27;America&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">36</span>_student (name, continent) <span class="keyword">values</span> (<span class="string">&#x27;Pascal&#x27;</span>, <span class="string">&#x27;Europe&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">36</span>_student (name, continent) <span class="keyword">values</span> (<span class="string">&#x27;Xi&#x27;</span>, <span class="string">&#x27;Asia&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">36</span>_student (name, continent) <span class="keyword">values</span> (<span class="string">&#x27;Jack&#x27;</span>, <span class="string">&#x27;America&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">      <span class="built_in">MAX</span>(if(A.continent <span class="operator">=</span> <span class="string">&#x27;America&#x27;</span>,A.NAME,<span class="keyword">NULL</span>)) <span class="keyword">AS</span> `America`,</span><br><span class="line">      <span class="built_in">MAX</span>(if(A.continent <span class="operator">=</span> <span class="string">&#x27;Asia&#x27;</span>,A.NAME,<span class="keyword">NULL</span>)) <span class="keyword">AS</span> `Asia`,</span><br><span class="line">      <span class="built_in">MAX</span>(if(A.continent <span class="operator">=</span> <span class="string">&#x27;Europe&#x27;</span>,A.NAME,<span class="keyword">NULL</span>)) <span class="keyword">AS</span> `Europe`</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">     (<span class="keyword">SELECT</span> </span><br><span class="line">             S1.continent,</span><br><span class="line">             S1.NAME,</span><br><span class="line">             S1.row_id,</span><br><span class="line">             <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> `trank`</span><br><span class="line">	  <span class="keyword">FROM</span> </span><br><span class="line">	        (<span class="keyword">SELECT</span></span><br><span class="line">                    S.<span class="operator">*</span>,</span><br><span class="line">                    <span class="variable">@row</span>_id:<span class="operator">=</span>(<span class="variable">@row</span>_id <span class="operator">+</span> <span class="number">1</span>) <span class="keyword">AS</span> `row_id`</span><br><span class="line">		     <span class="keyword">FROM</span></span><br><span class="line">                    <span class="number">36</span>_student <span class="keyword">AS</span> S,</span><br><span class="line">                    (<span class="keyword">SELECT</span> <span class="variable">@row</span>_id:<span class="operator">=</span><span class="number">0</span>) <span class="keyword">AS</span> T</span><br><span class="line">             ) <span class="keyword">AS</span> S1 </span><br><span class="line">	  <span class="keyword">JOIN</span> </span><br><span class="line">	        (<span class="keyword">SELECT</span></span><br><span class="line">                    S.<span class="operator">*</span>,</span><br><span class="line">                    <span class="variable">@n</span>_row_id:<span class="operator">=</span>(<span class="variable">@n</span>_row_id <span class="operator">+</span> <span class="number">1</span>) <span class="keyword">AS</span> `n_row_id`</span><br><span class="line">		     <span class="keyword">FROM</span> </span><br><span class="line">                    <span class="number">36</span>_student <span class="keyword">AS</span> S,</span><br><span class="line">                    (<span class="keyword">SELECT</span> <span class="variable">@n</span>_row_id:<span class="operator">=</span><span class="number">0</span>) <span class="keyword">AS</span> T</span><br><span class="line">	         ) <span class="keyword">AS</span> S2 </span><br><span class="line">	  <span class="keyword">ON</span> </span><br><span class="line">            (S1.continent <span class="operator">=</span> S2.continent <span class="keyword">AND</span> (S1.NAME <span class="operator">&gt;</span> S2.NAME <span class="keyword">OR</span> (S1.NAME <span class="operator">=</span> S2.NAME <span class="keyword">AND</span> S1.row_id <span class="operator">&gt;=</span> S2.n_row_id)))</span><br><span class="line">	  <span class="keyword">group</span> <span class="keyword">BY</span></span><br><span class="line">             S1.continent,S1.NAME,S1.row_id</span><br><span class="line">	  <span class="keyword">order</span> <span class="keyword">BY</span></span><br><span class="line">             S1.continent,S1.NAME</span><br><span class="line">      ) <span class="keyword">AS</span> A</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> </span><br><span class="line">      A.trank;</span><br><span class="line">      </span><br><span class="line"><span class="comment">-- 方法二      </span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="built_in">MAX</span>(IF(continent <span class="operator">=</span> <span class="string">&#x27;America&#x27;</span>, name, <span class="keyword">NULL</span>)) America,</span><br><span class="line">    <span class="built_in">MAX</span>(IF(continent <span class="operator">=</span> <span class="string">&#x27;Asia&#x27;</span>, name, <span class="keyword">NULL</span>)) Asia,</span><br><span class="line">    <span class="built_in">MAX</span>(IF(continent <span class="operator">=</span> <span class="string">&#x27;Europe&#x27;</span>, name, <span class="keyword">NULL</span>)) Europe</span><br><span class="line"><span class="keyword">FROM</span>   </span><br><span class="line">    (<span class="keyword">SELECT</span> continent,name,<span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> continent <span class="keyword">ORDER</span> <span class="keyword">BY</span> name) rn <span class="keyword">FROM</span> <span class="number">36</span>_student) T</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> rn</span><br></pre></td></tr></table></figure>

<h2 id="37-只出现一次的最大数字"><a href="#37-只出现一次的最大数字" class="headerlink" title="37. 只出现一次的最大数字"></a>37. 只出现一次的最大数字</h2><p>需求：编写一个 SQL 查询，找到只出现过一次的数字中，最大的一个数字。如果没有只出现一次的数字，输出 null 。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>num</th>
</tr>
</thead>
<tbody><tr>
<td>6</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">37</span>_my_numbers (num <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">37</span>_my_numbers;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">37</span>_my_numbers (num) <span class="keyword">values</span> (<span class="number">8</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">37</span>_my_numbers (num) <span class="keyword">values</span> (<span class="number">8</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">37</span>_my_numbers (num) <span class="keyword">values</span> (<span class="number">3</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">37</span>_my_numbers (num) <span class="keyword">values</span> (<span class="number">3</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">37</span>_my_numbers (num) <span class="keyword">values</span> (<span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">37</span>_my_numbers (num) <span class="keyword">values</span> (<span class="number">4</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">37</span>_my_numbers (num) <span class="keyword">values</span> (<span class="number">5</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">37</span>_my_numbers (num) <span class="keyword">values</span> (<span class="number">6</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">      ifnull((<span class="keyword">SELECT</span> </span><br><span class="line">                    num</span><br><span class="line">              <span class="keyword">FROM</span> </span><br><span class="line">                    <span class="number">37</span>_my_numbers</span><br><span class="line">              <span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">                    num</span><br><span class="line">              <span class="keyword">having</span></span><br><span class="line">                    <span class="built_in">count</span>(<span class="operator">*</span>) <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">              <span class="keyword">order</span> <span class="keyword">by</span> </span><br><span class="line">                    num <span class="keyword">desc</span></span><br><span class="line">              limit <span class="number">1</span>), <span class="keyword">null</span>) <span class="keyword">as</span> num;</span><br></pre></td></tr></table></figure>

<h2 id="38-有趣的电影"><a href="#38-有趣的电影" class="headerlink" title="38. 有趣的电影"></a>38. 有趣的电影</h2><p>需求：编写一个 SQL 查询，找出所有影片描述为非 boring (不无聊) 的并且 id 为奇数 的影片，结果请按等级 rating 排列</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>movie</th>
<th>description</th>
<th>rating</th>
</tr>
</thead>
<tbody><tr>
<td>5</td>
<td>House card</td>
<td>Interesting</td>
<td>9.1</td>
</tr>
<tr>
<td>1</td>
<td>War</td>
<td>great 3D</td>
<td>8.9</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">38</span>_cinema (id <span class="type">int</span>, movie <span class="type">varchar</span>(<span class="number">255</span>), description <span class="type">varchar</span>(<span class="number">255</span>), rating <span class="type">float</span>(<span class="number">2</span>, <span class="number">1</span>));</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">38</span>_cinema;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">38</span>_cinema (id, movie, description, rating) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;War&#x27;</span>, <span class="string">&#x27;great 3D&#x27;</span>, <span class="number">8.9</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">38</span>_cinema (id, movie, description, rating) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;Science&#x27;</span>, <span class="string">&#x27;fiction&#x27;</span>, <span class="number">8.5</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">38</span>_cinema (id, movie, description, rating) <span class="keyword">values</span> (<span class="number">3</span>, <span class="string">&#x27;irish&#x27;</span>, <span class="string">&#x27;boring&#x27;</span>, <span class="number">6.2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">38</span>_cinema (id, movie, description, rating) <span class="keyword">values</span> (<span class="number">4</span>, <span class="string">&#x27;Ice song&#x27;</span>, <span class="string">&#x27;Fantacy&#x27;</span>, <span class="number">8.6</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">38</span>_cinema (id, movie, description, rating) <span class="keyword">values</span> (<span class="number">5</span>, <span class="string">&#x27;House card&#x27;</span>, <span class="string">&#x27;Interesting&#x27;</span>, <span class="number">9.1</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">      id,</span><br><span class="line">      movie,</span><br><span class="line">      description,</span><br><span class="line">      rating</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      <span class="number">38</span>_cinema</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">      <span class="built_in">mod</span>(id, <span class="number">2</span>) <span class="operator">=</span> <span class="number">1</span> <span class="keyword">and</span> description <span class="operator">!=</span> <span class="string">&#x27;boring&#x27;</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> </span><br><span class="line">      rating <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<p>说明：mod 函数求余数</p>
<h2 id="39-换座位"><a href="#39-换座位" class="headerlink" title="39. 换座位"></a>39. 换座位</h2><p>需求：编写一个 SQL 查询，对相邻的两位同学进行位置交换（例如：id=1 和id=2 的进行交换，id=3 和id=4 的进行交换）。如果学生人数是奇数，则不需要改变最后一个同学的座位。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>student</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>Doris</td>
</tr>
<tr>
<td>2</td>
<td>Abbot</td>
</tr>
<tr>
<td>3</td>
<td>Green</td>
</tr>
<tr>
<td>4</td>
<td>Emerson</td>
</tr>
<tr>
<td>5</td>
<td>Jeames</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">39</span>_seat(id <span class="type">int</span>, student <span class="type">varchar</span>(<span class="number">255</span>));</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">39</span>_seat;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">39</span>_seat (id, student) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;Abbot&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">39</span>_seat (id, student) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;Doris&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">39</span>_seat (id, student) <span class="keyword">values</span> (<span class="number">3</span>, <span class="string">&#x27;Emerson&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">39</span>_seat (id, student) <span class="keyword">values</span> (<span class="number">4</span>, <span class="string">&#x27;Green&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">39</span>_seat (id, student) <span class="keyword">values</span> (<span class="number">5</span>, <span class="string">&#x27;Jeames&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">      a.id,</span><br><span class="line">      ifnull(b.student,a.student) <span class="keyword">as</span> student </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      <span class="number">39</span>_seat <span class="keyword">as</span> a </span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">      <span class="number">39</span>_seat <span class="keyword">as</span> b </span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">      (a.id<span class="operator">%</span><span class="number">2</span><span class="operator">=</span><span class="number">1</span> <span class="operator">&amp;&amp;</span> a.id<span class="operator">=</span>b.id<span class="number">-1</span>) <span class="operator">||</span> (a.id<span class="operator">%</span><span class="number">2</span><span class="operator">=</span><span class="number">0</span> <span class="operator">&amp;&amp;</span> a.id<span class="operator">=</span>b.id<span class="operator">+</span><span class="number">1</span>) </span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> </span><br><span class="line">      a.id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法二</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">      if(id<span class="operator">%</span><span class="number">2</span><span class="operator">=</span><span class="number">0</span>,id<span class="number">-1</span>,if(id<span class="operator">=</span>cnt,id,id<span class="operator">+</span><span class="number">1</span>)) <span class="keyword">as</span> id,</span><br><span class="line">      student</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      (<span class="keyword">select</span> </span><br><span class="line">             <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> cnt</span><br><span class="line">       <span class="keyword">from</span> </span><br><span class="line">             <span class="number">39</span>_seat</span><br><span class="line">      )<span class="keyword">as</span> a,</span><br><span class="line">      <span class="number">39</span>_seat</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法三      </span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">      b.id,</span><br><span class="line">      a.student</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      <span class="number">39</span>_seat <span class="keyword">as</span> a,</span><br><span class="line">      <span class="number">39</span>_seat <span class="keyword">as</span> b,</span><br><span class="line">      (<span class="keyword">select</span></span><br><span class="line">             <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> cnt</span><br><span class="line">       <span class="keyword">from</span></span><br><span class="line">             <span class="number">39</span>_seat</span><br><span class="line">      ) <span class="keyword">as</span> c </span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">      b.id<span class="operator">=</span><span class="number">1</span><span class="operator">^</span>(a.id<span class="number">-1</span>)<span class="operator">+</span><span class="number">1</span> <span class="operator">||</span> (c.cnt<span class="operator">%</span><span class="number">2</span> <span class="operator">&amp;&amp;</span> b.id<span class="operator">=</span>c.cnt <span class="operator">&amp;&amp;</span> a.id<span class="operator">=</span>c.cnt);</span><br></pre></td></tr></table></figure>

<h2 id="40-交换性别"><a href="#40-交换性别" class="headerlink" title="40. 交换性别"></a>40. 交换性别</h2><p>需求：给定一个 salary 表，有 m = 男性 和 f = 女性 的值。交换所有的 f 和 m 值（例如，将所有 f 值更改为 m，反之亦然）。要求只使用一个更新（Update）语句，并且没有中间的临时表。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>name</th>
<th>sex</th>
<th>salary</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>A</td>
<td>f</td>
<td>2500</td>
</tr>
<tr>
<td>2</td>
<td>B</td>
<td>m</td>
<td>1500</td>
</tr>
<tr>
<td>3</td>
<td>C</td>
<td>f</td>
<td>5500</td>
</tr>
<tr>
<td>4</td>
<td>D</td>
<td>m</td>
<td>500</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> <span class="number">40</span>_salary(id <span class="type">int</span>, name <span class="type">varchar</span>(<span class="number">100</span>), sex <span class="type">char</span>(<span class="number">1</span>), salary <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">40</span>_salary;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">40</span>_salary (id, name, sex, salary) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;m&#x27;</span>, <span class="number">2500</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">40</span>_salary (id, name, sex, salary) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;f&#x27;</span>, <span class="number">1500</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">40</span>_salary (id, name, sex, salary) <span class="keyword">values</span> (<span class="number">3</span>, <span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;m&#x27;</span>, <span class="number">5500</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">40</span>_salary (id, name, sex, salary) <span class="keyword">values</span> (<span class="number">4</span>, <span class="string">&#x27;D&#x27;</span>, <span class="string">&#x27;f&#x27;</span>, <span class="number">500</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">UPDATE <span class="number">40</span>_salary</span><br><span class="line"><span class="keyword">SET</span></span><br><span class="line">    sex <span class="operator">=</span> <span class="keyword">CASE</span> sex</span><br><span class="line">               <span class="keyword">WHEN</span> <span class="string">&#x27;m&#x27;</span> <span class="keyword">THEN</span> <span class="string">&#x27;f&#x27;</span></span><br><span class="line">               <span class="keyword">ELSE</span> <span class="string">&#x27;m&#x27;</span></span><br><span class="line">          <span class="keyword">END</span>;</span><br></pre></td></tr></table></figure>

<h2 id=""><a href="#" class="headerlink" title=""></a></h2>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hf7751.gitee.io/2021/03/11/1-20/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="hefei">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="元">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/03/11/1-20/" class="post-title-link" itemprop="url">1-20</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">نُشر في</span>
      

      <time title="أُنشأ: 2021-03-11 02:36:18 / عُدل: 03:43:29" itemprop="dateCreated datePublished" datetime="2021-03-11T02:36:18+08:00">2021-03-11</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="1-组合两个表"><a href="#1-组合两个表" class="headerlink" title="1. 组合两个表"></a>1. 组合两个表</h2><p>需求：编写一个 SQL 查询，对两表进行关联，展示列为：<br>FirstName, LastName, City, State</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>FirstName</th>
<th>LastName</th>
<th>City</th>
<th>State</th>
</tr>
</thead>
<tbody><tr>
<td>Allen</td>
<td>Wang</td>
<td>New York City</td>
<td>New York</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">1</span>_Person (PersonId <span class="type">int</span>, FirstName <span class="type">varchar</span>(<span class="number">255</span>), LastName <span class="type">varchar</span>(<span class="number">255</span>));</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">1</span>_Address (AddressId <span class="type">int</span>, PersonId <span class="type">int</span>, City <span class="type">varchar</span>(<span class="number">255</span>), State <span class="type">varchar</span>(<span class="number">255</span>));</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">1</span>_Person;</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">1</span>_Address;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">1</span>_Person (PersonId, LastName, FirstName) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;Wang&#x27;</span>, <span class="string">&#x27;Allen&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">1</span>_Address (AddressId, PersonId, City, State) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="string">&#x27;New York City&#x27;</span>, <span class="string">&#x27;New York&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">     p.FirstName,</span><br><span class="line">     p.LastName,</span><br><span class="line">     a.City,</span><br><span class="line">     a.State</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">     <span class="number">1</span>_Person <span class="keyword">as</span> p </span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> </span><br><span class="line">     <span class="number">1</span>_Address <span class="keyword">as</span> a </span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">     p.PersonId <span class="operator">=</span> a.PersonId;</span><br></pre></td></tr></table></figure>

<h2 id="2-第二高的薪水"><a href="#2-第二高的薪水" class="headerlink" title="2. 第二高的薪水"></a>2. 第二高的薪水</h2><p><strong>需求一</strong>：编写一个 SQL 查询，获取 Employee 表中第二高的薪水（Salary）。如果不存在第二高的薪水，那么查询应返回 null。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>SecondHighestSalary</th>
</tr>
</thead>
<tbody><tr>
<td>200</td>
</tr>
</tbody></table>
<p>建表语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">2</span>_Employee (Id <span class="type">int</span>, Salary <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">2</span>_Employee;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">2</span>_Employee (Id, Salary) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">100</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">2</span>_Employee (Id, Salary) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">200</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">2</span>_Employee (Id, Salary) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">300</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一：</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line"> IFNULL((<span class="keyword">select</span> </span><br><span class="line">               <span class="keyword">DISTINCT</span> Salary</span><br><span class="line">	     <span class="keyword">from</span>  </span><br><span class="line">               <span class="number">2</span>_Employee</span><br><span class="line">	     <span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">               Salary <span class="keyword">DESC</span></span><br><span class="line">	     limit <span class="number">1</span>,<span class="number">1</span></span><br><span class="line">         ), <span class="keyword">NULL</span>)  <span class="keyword">as</span> SecondHighestSalary;</span><br><span class="line">    </span><br><span class="line"><span class="comment">-- 方法二：</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">       <span class="built_in">max</span>(Salary) <span class="keyword">as</span> SecondHighestSalary </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">       <span class="number">2</span>_Employee</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">       Salary <span class="operator">&lt;</span> (<span class="keyword">select</span></span><br><span class="line">                       <span class="built_in">max</span>(Salary) </span><br><span class="line">                 <span class="keyword">from</span> </span><br><span class="line">                       <span class="number">2</span>_Employee</span><br><span class="line">                );</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法三：</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">      <span class="built_in">max</span>(e1.salary) <span class="keyword">as</span> SecondHighestSalary</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">      <span class="number">2</span>_Employee e1,</span><br><span class="line">      <span class="number">2</span>_Employee e2</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">      e1.id</span><br><span class="line"><span class="keyword">having</span></span><br><span class="line">      <span class="built_in">sum</span>(if(e1.salary <span class="operator">&gt;</span> e2.salary,<span class="number">1</span>,<span class="number">0</span>)) <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>提示：LIMIT 子句可以被用于强制 SELECT 语句返回指定的记录数。LIMIT 接受一个或两个数字参数。参数必须是一个整数常量。如果给定两个参数，第一个参数指定第一个返回记录行的偏移量，第二个参数指定返回记录行的最大数目。</p>
<p><strong>需求二</strong>：编写一个 SQL 查询，获取 Employee 表中第 n 高的薪水（Salary）。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一：</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> getNthHighestSalary_1(N <span class="type">INT</span>) <span class="keyword">RETURNS</span> <span class="type">INT</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">  <span class="keyword">SET</span> n <span class="operator">=</span> N<span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">RETURN</span> (     </span><br><span class="line">  <span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> Salary <span class="keyword">FROM</span> <span class="number">2</span>_Employee <span class="keyword">ORDER</span> <span class="keyword">BY</span> Salary <span class="keyword">DESC</span> LIMIT n,<span class="number">1</span></span><br><span class="line">  );</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> getNthHighestSalary_1(<span class="number">2</span>) ;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方案二：</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> getNthHighestSalary_2(N <span class="type">INT</span>) <span class="keyword">RETURNS</span> <span class="type">INT</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">  <span class="keyword">RETURN</span> (     </span><br><span class="line">        <span class="keyword">SELECT</span>  IF(count<span class="operator">&lt;</span>N,<span class="keyword">NULL</span>,min) </span><br><span class="line">        <span class="keyword">FROM</span></span><br><span class="line">          (<span class="keyword">SELECT</span> </span><br><span class="line">                 <span class="built_in">MIN</span>(Salary) <span class="keyword">AS</span> min, <span class="built_in">COUNT</span>(<span class="number">1</span>) <span class="keyword">AS</span> count</span><br><span class="line">           <span class="keyword">FROM</span></span><br><span class="line">                (<span class="keyword">SELECT</span> </span><br><span class="line">                       <span class="keyword">DISTINCT</span> Salary</span><br><span class="line">                 <span class="keyword">FROM</span> </span><br><span class="line">                       <span class="number">2</span>_Employee</span><br><span class="line">                 <span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">                       Salary <span class="keyword">DESC</span> </span><br><span class="line">                 LIMIT N) <span class="keyword">AS</span> a</span><br><span class="line">          ) <span class="keyword">as</span> b</span><br><span class="line">        );</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> getNthHighestSalary_2(<span class="number">2</span>) ;</span><br></pre></td></tr></table></figure>

<h2 id="3-分数排名"><a href="#3-分数排名" class="headerlink" title="3. 分数排名"></a>3. 分数排名</h2><p>需求：编写一个 SQL 查询来实现分数排名。如果两个分数相同，则两个分数排名（Rank）相同。请注意，平分后的下一个名次应该是下一个连续的整数值。换句话说，名次之间不应该有“间隔”。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>Score</th>
<th>Rank</th>
</tr>
</thead>
<tbody><tr>
<td>4.00</td>
<td>1</td>
</tr>
<tr>
<td>4.00</td>
<td>1</td>
</tr>
<tr>
<td>3.85</td>
<td>2</td>
</tr>
<tr>
<td>3.65</td>
<td>3</td>
</tr>
<tr>
<td>3.65</td>
<td>3</td>
</tr>
<tr>
<td>3.50</td>
<td>4</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">3</span>_Scores (Id <span class="type">int</span>, Score <span class="type">DECIMAL</span>(<span class="number">3</span>,<span class="number">2</span>));</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">3</span>_Scores;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">3</span>_Scores (Id, Score) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">3.5</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">3</span>_Scores (Id, Score) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">3.65</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">3</span>_Scores (Id, Score) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">4.0</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">3</span>_Scores (Id, Score) <span class="keyword">values</span> (<span class="number">4</span>, <span class="number">3.85</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">3</span>_Scores (Id, Score) <span class="keyword">values</span> (<span class="number">5</span>, <span class="number">4.0</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">3</span>_Scores (Id, Score) <span class="keyword">values</span> (<span class="number">6</span>, <span class="number">3.65</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一：</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">      a.Score <span class="keyword">as</span> score , </span><br><span class="line">      (<span class="keyword">select</span> </span><br><span class="line">              <span class="built_in">count</span>(<span class="keyword">distinct</span> b.Score) </span><br><span class="line">       <span class="keyword">from</span> </span><br><span class="line">              <span class="number">3</span>_Scores b </span><br><span class="line">       <span class="keyword">where</span> </span><br><span class="line">              b.Score <span class="operator">&gt;=</span>a.Score) <span class="keyword">as</span> `rank`</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">     <span class="number">3</span>_Scores a </span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> </span><br><span class="line">     Score <span class="keyword">DESC</span>;</span><br><span class="line">     </span><br><span class="line"><span class="comment">-- 方法二：</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">		Score,</span><br><span class="line">		<span class="built_in">dense_rank</span>() <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> Score <span class="keyword">desc</span>) `rank`</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">		<span class="number">3</span>_Scores;</span><br></pre></td></tr></table></figure>

<h2 id="4-连续出现的数字"><a href="#4-连续出现的数字" class="headerlink" title="4. 连续出现的数字"></a>4. 连续出现的数字</h2><p>需求：编写一个 SQL 查询，查找所有至少连续出现三次的数字。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>ConsecutiveNums</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">4</span>_Logs (Id <span class="type">int</span>, Num <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">4</span>_Logs;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">4</span>_Logs (Id, Num) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">4</span>_Logs (Id, Num) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">4</span>_Logs (Id, Num) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">4</span>_Logs (Id, Num) <span class="keyword">values</span> (<span class="number">4</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">4</span>_Logs (Id, Num) <span class="keyword">values</span> (<span class="number">5</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">4</span>_Logs (Id, Num) <span class="keyword">values</span> (<span class="number">6</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">4</span>_Logs (Id, Num) <span class="keyword">values</span> (<span class="number">7</span>, <span class="number">2</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一：</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">	l1.Num</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    <span class="number">4</span>_Logs l1,</span><br><span class="line">    <span class="number">4</span>_Logs l2,</span><br><span class="line">    <span class="number">4</span>_Logs l3</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    l1.Id <span class="operator">=</span> l2.Id <span class="operator">-</span> <span class="number">1</span> <span class="keyword">AND</span> l1.Num <span class="operator">=</span> l2.Num</span><br><span class="line">    <span class="keyword">AND</span> l2.Id <span class="operator">=</span> l3.Id <span class="operator">-</span> <span class="number">1</span> <span class="keyword">AND</span> l2.Num <span class="operator">=</span> l3.Num;</span><br><span class="line">    </span><br><span class="line"><span class="comment">-- 方法二：</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">	l1.Num</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">	<span class="number">4</span>_Logs l1</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">	<span class="number">4</span>_Logs l2</span><br><span class="line"><span class="keyword">on</span></span><br><span class="line">	l1.Id <span class="operator">=</span> l2.Id <span class="operator">-</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">	<span class="number">4</span>_Logs l3</span><br><span class="line"><span class="keyword">on</span></span><br><span class="line">	l2.Id <span class="operator">=</span> l3.Id <span class="operator">-</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">	l1.num <span class="operator">=</span> l2.num <span class="keyword">and</span> l2.num <span class="operator">=</span> l3.num;</span><br><span class="line">    </span><br><span class="line"><span class="comment">-- 方法三：</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> Num ConsecutiveNums</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">	(<span class="keyword">select</span></span><br><span class="line">			Num,</span><br><span class="line">			<span class="built_in">lead</span>(Num,<span class="number">1</span>,<span class="keyword">null</span>) <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> id) n2,</span><br><span class="line">			<span class="built_in">lead</span>(Num,<span class="number">2</span>,<span class="keyword">null</span>) <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> id) n3</span><br><span class="line">	<span class="keyword">from</span> <span class="number">4</span>_Logs</span><br><span class="line">	)t1</span><br><span class="line"><span class="keyword">where</span> Num <span class="operator">=</span> n2 <span class="keyword">and</span> Num <span class="operator">=</span> n3;</span><br></pre></td></tr></table></figure>

<h2 id="5-超过经理收入的员工"><a href="#5-超过经理收入的员工" class="headerlink" title="5. 超过经理收入的员工"></a>5. 超过经理收入的员工</h2><p>需求：Employee 表包含所有员工，他们的经理也属于员工。每个员工都有一个 Id，此外还有一列对应员工的经理的 Id。编写一个 SQL 查询，该查询可以获取收入超过他们经理的员工的姓名。</p>
<p>数据样式：</p>
<table>
<thead>
<tr>
<th>Id</th>
<th>Name</th>
<th>Salary</th>
<th>ManagerId</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>Joe</td>
<td>70000</td>
<td>3</td>
</tr>
<tr>
<td>2</td>
<td>Henry</td>
<td>80000</td>
<td>4</td>
</tr>
<tr>
<td>3</td>
<td>Sam</td>
<td>60000</td>
<td>null</td>
</tr>
<tr>
<td>4</td>
<td>Max</td>
<td>90000</td>
<td>null</td>
</tr>
</tbody></table>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>Employee</th>
</tr>
</thead>
<tbody><tr>
<td>Joe</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">5</span>_Employee (Id <span class="type">int</span>, Name <span class="type">varchar</span>(<span class="number">255</span>), Salary <span class="type">int</span>, ManagerId <span class="type">int</span>);</span><br><span class="line"><span class="keyword">truncate</span> <span class="keyword">table</span> <span class="number">5</span>_Employee;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">5</span>_Employee (Id, Name, Salary, ManagerId) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;Joe&#x27;</span>, <span class="number">70000</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">5</span>_Employee (Id, Name, Salary, ManagerId) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;Henry&#x27;</span>, <span class="number">80000</span>, <span class="number">4</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">5</span>_Employee (Id, Name, Salary, ManagerId) <span class="keyword">values</span> (<span class="number">3</span>, <span class="string">&#x27;Sam&#x27;</span>, <span class="number">60000</span>, <span class="keyword">null</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">5</span>_Employee (Id, Name, Salary, ManagerId) <span class="keyword">values</span> (<span class="number">4</span>, <span class="string">&#x27;Max&#x27;</span>, <span class="number">90000</span>, <span class="keyword">null</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">     a.NAME <span class="keyword">AS</span> Employee</span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">     <span class="number">5</span>_Employee <span class="keyword">AS</span> a </span><br><span class="line"><span class="keyword">JOIN</span> </span><br><span class="line">     <span class="number">5</span>_Employee <span class="keyword">AS</span> b</span><br><span class="line"><span class="keyword">ON</span> </span><br><span class="line">     a.ManagerId <span class="operator">=</span> b.Id </span><br><span class="line"><span class="keyword">AND</span> </span><br><span class="line">     a.Salary <span class="operator">&gt;</span> b.Salary;</span><br></pre></td></tr></table></figure>

<h2 id="6-查找重复的邮箱"><a href="#6-查找重复的邮箱" class="headerlink" title="6. 查找重复的邮箱"></a>6. 查找重复的邮箱</h2><p>需求：编写一个 SQL 查询，查找 Person 表中所有重复的电子邮箱。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>Email</th>
</tr>
</thead>
<tbody><tr>
<td><a href="mailto:&#97;&#64;&#98;&#46;&#99;&#111;&#109;">&#97;&#64;&#98;&#46;&#99;&#111;&#109;</a></td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">6</span>_Person (Id <span class="type">int</span>, Email <span class="type">varchar</span>(<span class="number">255</span>));</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">6</span>_Person;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">6</span>_Person (Id, Email) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;a@b.com&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">6</span>_Person (Id, Email) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;c@d.com&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">6</span>_Person (Id, Email) <span class="keyword">values</span> (<span class="number">3</span>, <span class="string">&#x27;a@b.com&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">      Email</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      <span class="number">6</span>_Person</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">      Email</span><br><span class="line"><span class="keyword">having</span> </span><br><span class="line">      <span class="built_in">count</span>(Email) <span class="operator">&gt;</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<h2 id="7-从不订购的客户"><a href="#7-从不订购的客户" class="headerlink" title="7. 从不订购的客户"></a>7. 从不订购的客户</h2><p>需求：某网站包含两个表，Customers 表和 Orders 表。编写一个 SQL 查询，找出所有从不订购任何东西的客户。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>Customers</th>
</tr>
</thead>
<tbody><tr>
<td>Henry</td>
</tr>
<tr>
<td>Max</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">7</span>_Customers (Id <span class="type">int</span>, Name <span class="type">varchar</span>(<span class="number">255</span>));</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">7</span>_Orders (Id <span class="type">int</span>, CustomerId <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">7</span>_Customers;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">7</span>_Customers (Id, Name) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;Joe&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">7</span>_Customers (Id, Name) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;Henry&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">7</span>_Customers (Id, Name) <span class="keyword">values</span> (<span class="number">3</span>, <span class="string">&#x27;Sam&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">7</span>_Customers (Id, Name) <span class="keyword">values</span> (<span class="number">4</span>, <span class="string">&#x27;Max&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">7</span>_Orders;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">7</span>_Orders (Id, CustomerId) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">7</span>_Orders (Id, CustomerId) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一：</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">     c.name <span class="keyword">as</span> <span class="string">&#x27;Customers&#x27;</span></span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">     <span class="number">7</span>_Customers <span class="keyword">as</span> c</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">     c.id <span class="keyword">not</span> <span class="keyword">in</span>(<span class="keyword">select</span> customerid <span class="keyword">from</span> <span class="number">7</span>_Orders);</span><br><span class="line">     </span><br><span class="line"><span class="comment">-- 方法二：</span></span><br><span class="line"><span class="keyword">select</span>  </span><br><span class="line">	c.Name Customers</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">	<span class="number">7</span>_Customers  c </span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> </span><br><span class="line">	<span class="number">7</span>_Orders  o</span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">	c.id <span class="operator">=</span> o.CustomerId</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">	o.id <span class="keyword">is</span> <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure>

<h2 id="8-部门工资最高的员工"><a href="#8-部门工资最高的员工" class="headerlink" title="8. 部门工资最高的员工"></a>8. 部门工资最高的员工</h2><p><strong>需求一</strong>：编写一个 SQL 查询，找出每个部门工资最高的员工。例如，根据上述给定的表格，Max 在 IT 部门有最高工资，Henry 在 Sales 部门有最高工资。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>Department</th>
<th>Employee</th>
<th>Salary</th>
</tr>
</thead>
<tbody><tr>
<td>IT</td>
<td>Jim</td>
<td>90000</td>
</tr>
<tr>
<td>IT</td>
<td>Max</td>
<td>90000</td>
</tr>
<tr>
<td>Sales</td>
<td>Henry</td>
<td>80000</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">8</span>_Employee (Id <span class="type">int</span>, Name <span class="type">varchar</span>(<span class="number">255</span>), Salary <span class="type">int</span>, DepartmentId <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">8</span>_Department (Id <span class="type">int</span>, Name <span class="type">varchar</span>(<span class="number">255</span>));</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">8</span>_Employee;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">8</span>_Employee (Id, Name, Salary, DepartmentId) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;Joe&#x27;</span>, <span class="number">75000</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">8</span>_Employee (Id, Name, Salary, DepartmentId) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;Jim&#x27;</span>, <span class="number">90000</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">8</span>_Employee (Id, Name, Salary, DepartmentId) <span class="keyword">values</span> (<span class="number">3</span>, <span class="string">&#x27;Henry&#x27;</span>, <span class="number">80000</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">8</span>_Employee (Id, Name, Salary, DepartmentId) <span class="keyword">values</span> (<span class="number">4</span>, <span class="string">&#x27;Sam&#x27;</span>, <span class="number">60000</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">8</span>_Employee (Id, Name, Salary, DepartmentId) <span class="keyword">values</span> (<span class="number">5</span>, <span class="string">&#x27;Max&#x27;</span>, <span class="number">90000</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">8</span>_Employee (Id, Name, Salary, DepartmentId) <span class="keyword">values</span> (<span class="number">6</span>, <span class="string">&#x27;Randy&#x27;</span>, <span class="number">85000</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">8</span>_Employee (Id, Name, Salary, DepartmentId) <span class="keyword">values</span> (<span class="number">7</span>, <span class="string">&#x27;Will&#x27;</span>, <span class="number">70000</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">8</span>_Department;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">8</span>_Department (Id, Name) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;IT&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">8</span>_Department (Id, Name) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;Sales&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一：</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    d.name <span class="keyword">AS</span> <span class="string">&#x27;Department&#x27;</span>,</span><br><span class="line">    e.name <span class="keyword">AS</span> <span class="string">&#x27;Employee&#x27;</span>,</span><br><span class="line">    Salary</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    <span class="number">8</span>_Employee <span class="keyword">as</span> e</span><br><span class="line"><span class="keyword">JOIN</span></span><br><span class="line">    <span class="number">8</span>_Department <span class="keyword">as</span> d</span><br><span class="line"><span class="keyword">ON</span></span><br><span class="line">	e.DepartmentId <span class="operator">=</span> d.Id</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    (e.DepartmentId , Salary) <span class="keyword">IN</span></span><br><span class="line">    (   <span class="keyword">SELECT</span></span><br><span class="line">            DepartmentId, <span class="built_in">MAX</span>(Salary)</span><br><span class="line">        <span class="keyword">FROM</span></span><br><span class="line">            <span class="number">8</span>_Employee</span><br><span class="line">        <span class="keyword">GROUP</span> <span class="keyword">BY</span> DepartmentId</span><br><span class="line">	);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法二：</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">	Department,Employee,Salary</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">	(<span class="keyword">select</span> </span><br><span class="line">     	d.Name Department,</span><br><span class="line">     	e.Name Employee,</span><br><span class="line">     	e.Salary,</span><br><span class="line">		<span class="built_in">rank</span>() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> d.id <span class="keyword">order</span> <span class="keyword">by</span> Salary <span class="keyword">desc</span>) rk</span><br><span class="line">	<span class="keyword">from</span> </span><br><span class="line">     	<span class="number">8</span>_Employee e </span><br><span class="line">    <span class="keyword">join</span> </span><br><span class="line">     	<span class="number">8</span>_Department d</span><br><span class="line">	<span class="keyword">on</span> e.DepartmentId<span class="operator">=</span>d.id</span><br><span class="line">	)tmp</span><br><span class="line"><span class="keyword">where</span> rk <span class="operator">=</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p><strong>需求二</strong>：编写一个 SQL 查询，找出每个部门获得前三高工资的所有员工。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>Department</th>
<th>Employee</th>
<th>Salary</th>
</tr>
</thead>
<tbody><tr>
<td>IT</td>
<td>Max</td>
<td>90000</td>
</tr>
<tr>
<td>IT</td>
<td>Jim</td>
<td>90000</td>
</tr>
<tr>
<td>IT</td>
<td>Randy</td>
<td>85000</td>
</tr>
<tr>
<td>IT</td>
<td>Joe</td>
<td>75000</td>
</tr>
<tr>
<td>Sales</td>
<td>Henry</td>
<td>80000</td>
</tr>
<tr>
<td>Sales</td>
<td>Sam</td>
<td>60000</td>
</tr>
</tbody></table>
<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一：</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    d.Name <span class="keyword">AS</span> <span class="string">&#x27;Department&#x27;</span>, e1.Name <span class="keyword">AS</span> <span class="string">&#x27;Employee&#x27;</span>, e1.Salary</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    <span class="number">8</span>_Employee e1</span><br><span class="line"><span class="keyword">JOIN</span></span><br><span class="line">    <span class="number">8</span>_Department d</span><br><span class="line"><span class="keyword">ON</span> </span><br><span class="line">    e1.DepartmentId <span class="operator">=</span> d.Id</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    (<span class="keyword">SELECT</span></span><br><span class="line">		<span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> e2.Salary)</span><br><span class="line">    <span class="keyword">FROM</span></span><br><span class="line">      	<span class="number">8</span>_Employee e2</span><br><span class="line">    <span class="keyword">WHERE</span></span><br><span class="line">    	e1.Salary <span class="operator">&lt;</span> e2.Salary</span><br><span class="line">    <span class="keyword">AND</span> </span><br><span class="line">     	e1.DepartmentId <span class="operator">=</span> e2.DepartmentId) <span class="operator">&lt;</span> <span class="number">3</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> Department, e1.salary <span class="keyword">desc</span>;</span><br><span class="line">        </span><br><span class="line"><span class="comment">-- 方法二：</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">	Department,</span><br><span class="line">	Employee,</span><br><span class="line">	Salary</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">	(<span class="keyword">select</span> </span><br><span class="line">     	d.Name  Department,</span><br><span class="line">     	e.Name Employee,</span><br><span class="line">     	e.Salary,</span><br><span class="line">		<span class="built_in">dense_rank</span>() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> d.id <span class="keyword">order</span> <span class="keyword">by</span> Salary <span class="keyword">desc</span>) rk</span><br><span class="line">	<span class="keyword">from</span> </span><br><span class="line">     	<span class="number">8</span>_Employee e </span><br><span class="line">    <span class="keyword">join</span> </span><br><span class="line">     	<span class="number">8</span>_Department d</span><br><span class="line">	<span class="keyword">on</span> </span><br><span class="line">     	e.DepartmentId<span class="operator">=</span>d.id</span><br><span class="line">	)tmp</span><br><span class="line"><span class="keyword">where</span> rk <span class="operator">&lt;=</span><span class="number">3</span></span><br></pre></td></tr></table></figure>

<h2 id="9-删除重复的电子邮箱"><a href="#9-删除重复的电子邮箱" class="headerlink" title="9. 删除重复的电子邮箱"></a>9. 删除重复的电子邮箱</h2><p>需求：编写一个 SQL 查询，来删除 Person 表中所有重复的电子邮箱，重复的邮箱里只保留 Id 最小 的那个。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>Id</th>
<th>Email</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td><a href="mailto:&#106;&#111;&#x68;&#x6e;&#x40;&#101;&#x78;&#97;&#109;&#x70;&#108;&#x65;&#46;&#99;&#x6f;&#109;">&#106;&#111;&#x68;&#x6e;&#x40;&#101;&#x78;&#97;&#109;&#x70;&#108;&#x65;&#46;&#99;&#x6f;&#109;</a></td>
</tr>
<tr>
<td>2</td>
<td><a href="mailto:&#98;&#111;&#x62;&#64;&#101;&#120;&#97;&#109;&#112;&#x6c;&#x65;&#46;&#99;&#x6f;&#x6d;">&#98;&#111;&#x62;&#64;&#101;&#120;&#97;&#109;&#112;&#x6c;&#x65;&#46;&#99;&#x6f;&#x6d;</a></td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">9</span>_Person (Id <span class="type">int</span>, email <span class="type">varchar</span>(<span class="number">255</span>));</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">9</span>_Person;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">9</span>_Person (Id, email) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;john@example.com&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">9</span>_Person (Id, email) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;bob@example.com&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">9</span>_Person (Id, email) <span class="keyword">values</span> (<span class="number">3</span>, <span class="string">&#x27;john@example.com&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DELETE</span> </span><br><span class="line">      p1 </span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">      <span class="number">9</span>_Person p1,</span><br><span class="line">      <span class="number">9</span>_Person p2</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">      p1.Email <span class="operator">=</span> p2.Email <span class="keyword">AND</span> p1.Id <span class="operator">&gt;</span> p2.Id;</span><br></pre></td></tr></table></figure>

<h2 id="10-上升的温度"><a href="#10-上升的温度" class="headerlink" title="10. 上升的温度"></a>10. 上升的温度</h2><p>需求：编写一个 SQL 查询，来查找与之前（昨天的）日期相比温度更高的所有日期的 Id。</p>
<table>
<thead>
<tr>
<th>Id</th>
</tr>
</thead>
<tbody><tr>
<td>2</td>
</tr>
<tr>
<td>4</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">10</span>_Weather (Id <span class="type">int</span>, RecordDate <span class="type">date</span>, Temperature <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">10</span>_Weather;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">10</span>_Weather (Id, RecordDate, Temperature) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;2015-01-01&#x27;</span>, <span class="number">10</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">10</span>_Weather (Id, RecordDate, Temperature) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;2015-01-02&#x27;</span>, <span class="number">25</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">10</span>_Weather (Id, RecordDate, Temperature) <span class="keyword">values</span> (<span class="number">3</span>, <span class="string">&#x27;2015-01-03&#x27;</span>, <span class="number">20</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">10</span>_Weather (Id, RecordDate, Temperature) <span class="keyword">values</span> (<span class="number">4</span>, <span class="string">&#x27;2015-01-04&#x27;</span>, <span class="number">30</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一：</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    w1.id <span class="keyword">AS</span> <span class="string">&#x27;Id&#x27;</span></span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    <span class="number">10</span>_Weather w1</span><br><span class="line"><span class="keyword">JOIN</span></span><br><span class="line">    <span class="number">10</span>_Weather w2 </span><br><span class="line"><span class="keyword">ON</span> </span><br><span class="line">    DATEDIFF(w1.RecordDate, w2.RecordDate) <span class="operator">=</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">AND</span> w1.Temperature <span class="operator">&gt;</span> w2.Temperature;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法二：</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">	Id</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">	(<span class="keyword">select</span> </span><br><span class="line">     	Id,</span><br><span class="line">     	RecordDate,</span><br><span class="line">     	Temperature,</span><br><span class="line">		<span class="built_in">lag</span>(RecordDate,<span class="number">1</span>,<span class="number">9999</span><span class="number">-99</span><span class="number">-99</span>) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> RecordDate) yd,</span><br><span class="line">		<span class="built_in">lag</span>(Temperature,<span class="number">1</span>,<span class="number">999</span>) <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> RecordDate ) yt</span><br><span class="line">	<span class="keyword">from</span> </span><br><span class="line">     	<span class="number">10</span>_Weather </span><br><span class="line">	)tmp</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">	Temperature <span class="operator">&gt;</span> yt <span class="keyword">and</span> datediff(RecordDate,yd)<span class="operator">=</span><span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<h2 id="11-行程和用户"><a href="#11-行程和用户" class="headerlink" title="11. 行程和用户"></a>11. 行程和用户</h2><p>需求：写一段 SQL 语句查出 2019年10月1日 至 2019年10月3日 期间非禁止用户的取消率。基于上表，你的 SQL 语句应返回如下结果，取消率（Cancellation Rate）保留两位小数。取消率的计算方式如下：(被司机或乘客取消的非禁止用户生成的订单数量) / (非禁止用户生成的订单总数)</p>
<p>Trips表：所有出租车的行程信息。每段行程有唯一键 Id，Client_Id 和 Driver_Id 是 Users 表中 Users_Id 的外键。Status 是枚举类型，枚举成员为 (‘completed’, ‘cancelled_by_driver’, ‘cancelled_by_client’)。</p>
<table>
<thead>
<tr>
<th>Id</th>
<th>Client_Id</th>
<th>Driver_Id</th>
<th>City_Id</th>
<th>Status</th>
<th>Request_at</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>1</td>
<td>10</td>
<td>1</td>
<td>completed</td>
<td>2019-10-01</td>
</tr>
<tr>
<td>2</td>
<td>2</td>
<td>11</td>
<td>1</td>
<td>cancelled_by_driver</td>
<td>2019-10-01</td>
</tr>
<tr>
<td>3</td>
<td>3</td>
<td>12</td>
<td>6</td>
<td>completed</td>
<td>2019-10-01</td>
</tr>
<tr>
<td>4</td>
<td>4</td>
<td>13</td>
<td>6</td>
<td>cancelled_by_client</td>
<td>2019-10-01</td>
</tr>
<tr>
<td>5</td>
<td>1</td>
<td>10</td>
<td>1</td>
<td>completed</td>
<td>2019-10-02</td>
</tr>
<tr>
<td>6</td>
<td>2</td>
<td>11</td>
<td>6</td>
<td>completed</td>
<td>2019-10-02</td>
</tr>
<tr>
<td>7</td>
<td>3</td>
<td>12</td>
<td>6</td>
<td>completed</td>
<td>2019-10-02</td>
</tr>
<tr>
<td>8</td>
<td>2</td>
<td>12</td>
<td>12</td>
<td>completed</td>
<td>2019-10-03</td>
</tr>
<tr>
<td>9</td>
<td>3</td>
<td>10</td>
<td>12</td>
<td>completed</td>
<td>2019-10-03</td>
</tr>
<tr>
<td>10</td>
<td>4</td>
<td>13</td>
<td>12</td>
<td>cancelled_by_driver</td>
<td>2019-10-03</td>
</tr>
</tbody></table>
<p>Users 表存所有用户。每个用户有唯一键 Users_Id。Banned 表示这个用户是否被禁止，Role 则是一个表示（‘client’, ‘driver’, ‘partner’）的枚举类型。</p>
<table>
<thead>
<tr>
<th>Users_Id</th>
<th>Banned</th>
<th>Role</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>No</td>
<td>client</td>
</tr>
<tr>
<td>2</td>
<td>Yes</td>
<td>client</td>
</tr>
<tr>
<td>3</td>
<td>No</td>
<td>client</td>
</tr>
<tr>
<td>4</td>
<td>No</td>
<td>client</td>
</tr>
<tr>
<td>10</td>
<td>No</td>
<td>driver</td>
</tr>
<tr>
<td>11</td>
<td>No</td>
<td>driver</td>
</tr>
<tr>
<td>12</td>
<td>No</td>
<td>driver</td>
</tr>
<tr>
<td>13</td>
<td>No</td>
<td>driver</td>
</tr>
</tbody></table>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>Day</th>
<th>Cancellation Rate</th>
</tr>
</thead>
<tbody><tr>
<td>2019-10-01</td>
<td>0.33</td>
</tr>
<tr>
<td>2019-10-02</td>
<td>0.00</td>
</tr>
<tr>
<td>2019-10-03</td>
<td>0.50</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">11</span>_Trips (Id <span class="type">int</span>, Client_Id <span class="type">int</span>, Driver_Id <span class="type">int</span>, City_Id <span class="type">int</span>, Status ENUM(<span class="string">&#x27;completed&#x27;</span>, <span class="string">&#x27;cancelled_by_driver&#x27;</span>, <span class="string">&#x27;cancelled_by_client&#x27;</span>), Request_at <span class="type">varchar</span>(<span class="number">50</span>));</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">11</span>_Users (Users_Id <span class="type">int</span>, Banned <span class="type">varchar</span>(<span class="number">50</span>), Role ENUM(<span class="string">&#x27;client&#x27;</span>, <span class="string">&#x27;driver&#x27;</span>, <span class="string">&#x27;partner&#x27;</span>));</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">11</span>_Trips;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">11</span>_Trips (Id, Client_Id, Driver_Id, City_Id, Status, Request_at) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="number">10</span>, <span class="number">1</span>, <span class="string">&#x27;completed&#x27;</span>, <span class="string">&#x27;2019-10-01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">11</span>_Trips (Id, Client_Id, Driver_Id, City_Id, Status, Request_at) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">2</span>, <span class="number">11</span>, <span class="number">1</span>, <span class="string">&#x27;cancelled_by_driver&#x27;</span>, <span class="string">&#x27;2019-10-01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">11</span>_Trips (Id, Client_Id, Driver_Id, City_Id, Status, Request_at) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">3</span>, <span class="number">12</span>, <span class="number">6</span>, <span class="string">&#x27;completed&#x27;</span>, <span class="string">&#x27;2019-10-01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">11</span>_Trips (Id, Client_Id, Driver_Id, City_Id, Status, Request_at) <span class="keyword">values</span> (<span class="number">4</span>, <span class="number">4</span>, <span class="number">13</span>, <span class="number">6</span>, <span class="string">&#x27;cancelled_by_client&#x27;</span>, <span class="string">&#x27;2019-10-01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">11</span>_Trips (Id, Client_Id, Driver_Id, City_Id, Status, Request_at) <span class="keyword">values</span> (<span class="number">5</span>, <span class="number">1</span>, <span class="number">10</span>, <span class="number">1</span>, <span class="string">&#x27;completed&#x27;</span>, <span class="string">&#x27;2019-10-02&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">11</span>_Trips (Id, Client_Id, Driver_Id, City_Id, Status, Request_at) <span class="keyword">values</span> (<span class="number">6</span>, <span class="number">2</span>, <span class="number">11</span>, <span class="number">6</span>, <span class="string">&#x27;completed&#x27;</span>, <span class="string">&#x27;2019-10-02&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">11</span>_Trips (Id, Client_Id, Driver_Id, City_Id, Status, Request_at) <span class="keyword">values</span> (<span class="number">7</span>, <span class="number">3</span>, <span class="number">12</span>, <span class="number">6</span>, <span class="string">&#x27;completed&#x27;</span>, <span class="string">&#x27;2019-10-02&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">11</span>_Trips (Id, Client_Id, Driver_Id, City_Id, Status, Request_at) <span class="keyword">values</span> (<span class="number">8</span>, <span class="number">2</span>, <span class="number">12</span>, <span class="number">12</span>, <span class="string">&#x27;completed&#x27;</span>, <span class="string">&#x27;2019-10-03&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">11</span>_Trips (Id, Client_Id, Driver_Id, City_Id, Status, Request_at) <span class="keyword">values</span> (<span class="number">9</span>, <span class="number">3</span>, <span class="number">10</span>, <span class="number">12</span>, <span class="string">&#x27;completed&#x27;</span>, <span class="string">&#x27;2019-10-03&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">11</span>_Trips (Id, Client_Id, Driver_Id, City_Id, Status, Request_at) <span class="keyword">values</span> (<span class="number">10</span>, <span class="number">4</span>, <span class="number">13</span>, <span class="number">12</span>, <span class="string">&#x27;cancelled_by_driver&#x27;</span>, <span class="string">&#x27;2019-10-03&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">11</span>_Users;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">11</span>_Users (Users_Id, Banned, Role) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;No&#x27;</span>, <span class="string">&#x27;client&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">11</span>_Users (Users_Id, Banned, Role) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;Yes&#x27;</span>, <span class="string">&#x27;client&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">11</span>_Users (Users_Id, Banned, Role) <span class="keyword">values</span> (<span class="number">3</span>, <span class="string">&#x27;No&#x27;</span>, <span class="string">&#x27;client&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">11</span>_Users (Users_Id, Banned, Role) <span class="keyword">values</span> (<span class="number">4</span>, <span class="string">&#x27;No&#x27;</span>, <span class="string">&#x27;client&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">11</span>_Users (Users_Id, Banned, Role) <span class="keyword">values</span> (<span class="number">10</span>, <span class="string">&#x27;No&#x27;</span>, <span class="string">&#x27;driver&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">11</span>_Users (Users_Id, Banned, Role) <span class="keyword">values</span> (<span class="number">11</span>, <span class="string">&#x27;No&#x27;</span>, <span class="string">&#x27;driver&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">11</span>_Users (Users_Id, Banned, Role) <span class="keyword">values</span> (<span class="number">12</span>, <span class="string">&#x27;No&#x27;</span>, <span class="string">&#x27;driver&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">11</span>_Users (Users_Id, Banned, Role) <span class="keyword">values</span> (<span class="number">13</span>, <span class="string">&#x27;No&#x27;</span>, <span class="string">&#x27;driver&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">方法一：</span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">      T.request_at <span class="keyword">AS</span> `<span class="keyword">Day</span>`, </span><br><span class="line">	  ROUND(</span><br><span class="line">            <span class="built_in">SUM</span>(IF(T.STATUS <span class="operator">=</span> <span class="string">&#x27;completed&#x27;</span>,<span class="number">0</span>,<span class="number">1</span>))<span class="operator">/</span> <span class="built_in">COUNT</span>(T.STATUS),</span><br><span class="line">            <span class="number">2</span></span><br><span class="line">            ) <span class="keyword">AS</span> `Cancellation Rate`</span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">      <span class="number">11</span>_Trips <span class="keyword">AS</span> T</span><br><span class="line"><span class="keyword">JOIN</span> </span><br><span class="line">      <span class="number">11</span>_Users <span class="keyword">AS</span> U1 </span><br><span class="line"><span class="keyword">ON</span> </span><br><span class="line">      T.client_id <span class="operator">=</span> U1.users_id <span class="keyword">AND</span> U1.banned <span class="operator">=</span><span class="string">&#x27;No&#x27;</span></span><br><span class="line"><span class="keyword">WHERE</span> </span><br><span class="line">      T.request_at <span class="keyword">BETWEEN</span> <span class="string">&#x27;2019-10-01&#x27;</span> <span class="keyword">AND</span> <span class="string">&#x27;2019-10-03&#x27;</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> </span><br><span class="line">      T.request_at;</span><br></pre></td></tr></table></figure>

<h2 id="12-游戏玩法分析"><a href="#12-游戏玩法分析" class="headerlink" title="12. 游戏玩法分析"></a>12. 游戏玩法分析</h2><p><strong>需求一</strong>：写一条 SQL 查询语句获取每位玩家 第一次登陆平台的日期。</p>
<p> Activity表：显示了某些游戏的玩家的活动情况。</p>
<table>
<thead>
<tr>
<th>player_id</th>
<th>device_id</th>
<th>event_date</th>
<th>games_played</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>2</td>
<td>2016-03-01</td>
<td>5</td>
</tr>
<tr>
<td>1</td>
<td>2</td>
<td>2016-03-02</td>
<td>6</td>
</tr>
<tr>
<td>2</td>
<td>3</td>
<td>2017-06-25</td>
<td>1</td>
</tr>
<tr>
<td>3</td>
<td>1</td>
<td>2016-03-01</td>
<td>0</td>
</tr>
<tr>
<td>3</td>
<td>4</td>
<td>2018-07-03</td>
<td>5</td>
</tr>
</tbody></table>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>player_id</th>
<th>first_login</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>2016-03-01</td>
</tr>
<tr>
<td>2</td>
<td>2017-06-25</td>
</tr>
<tr>
<td>3</td>
<td>2016-03-02</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">12</span>_Activity (player_id <span class="type">int</span>, device_id <span class="type">int</span>, event_date <span class="type">date</span>, games_played <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">12</span>_Activity;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">12</span>_Activity (player_id, device_id, event_date, games_played) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">2</span>, <span class="string">&#x27;2016-03-01&#x27;</span>, <span class="number">5</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">12</span>_Activity (player_id, device_id, event_date, games_played) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">2</span>, <span class="string">&#x27;2016-03-02&#x27;</span>, <span class="number">6</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">12</span>_Activity (player_id, device_id, event_date, games_played) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">3</span>, <span class="string">&#x27;2017-06-25&#x27;</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">12</span>_Activity (player_id, device_id, event_date, games_played) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">1</span>, <span class="string">&#x27;2016-03-01&#x27;</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">12</span>_Activity (player_id, device_id, event_date, games_played) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">4</span>, <span class="string">&#x27;2018-07-03&#x27;</span>, <span class="number">5</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">      player_id, </span><br><span class="line">      <span class="built_in">min</span>(event_date) <span class="keyword">as</span> first_login </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      <span class="number">12</span>_Activity </span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">      player_id;</span><br></pre></td></tr></table></figure>

<p><strong>需求二</strong>：描述每一个玩家首次登陆的设备名称</p>
<table>
<thead>
<tr>
<th>player_id</th>
<th>device_id</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>2</td>
</tr>
<tr>
<td>2</td>
<td>3</td>
</tr>
<tr>
<td>3</td>
<td>1</td>
</tr>
</tbody></table>
<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一：</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">     player_id,</span><br><span class="line">     device_id </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">     <span class="number">12</span>_Activity</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">     (player_id,event_date) <span class="keyword">in</span> (<span class="keyword">select</span></span><br><span class="line">                                      player_id, </span><br><span class="line">                                      <span class="built_in">min</span>(event_date)</span><br><span class="line">                                <span class="keyword">from</span></span><br><span class="line">                                      <span class="number">12</span>_Activity </span><br><span class="line">                                <span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">                                      player_id);</span><br><span class="line"> </span><br><span class="line"><span class="comment">-- 方法二：</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">	  player_id,</span><br><span class="line">	  device_id</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">	  (<span class="keyword">select</span> </span><br><span class="line">         	player_id,</span><br><span class="line">       		event_date,</span><br><span class="line">       		device_id,</span><br><span class="line">			<span class="built_in">rank</span>() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> player_id <span class="keyword">order</span> <span class="keyword">by</span> event_date) rk</span><br><span class="line">	   <span class="keyword">from</span> </span><br><span class="line">       		<span class="number">12</span>_Activity</span><br><span class="line">		) tmp</span><br><span class="line"><span class="keyword">where</span> rk <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p><strong>需求三</strong>：编写一个 SQL 查询，同时报告每组玩家和日期，以及玩家到目前为止玩了多少游戏。也就是说，在此日期之前玩家所玩的游戏总数。详细情况请查看示例。</p>
<table>
<thead>
<tr>
<th>player_id</th>
<th>event_date</th>
<th>games_played_so_far</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>2016-03-01</td>
<td>5</td>
</tr>
<tr>
<td>1</td>
<td>2016-05-02</td>
<td>11</td>
</tr>
<tr>
<td>2</td>
<td>2017-06-25</td>
<td>1</td>
</tr>
<tr>
<td>3</td>
<td>2016-03-02</td>
<td>0</td>
</tr>
<tr>
<td>3</td>
<td>2018-07-03</td>
<td>5</td>
</tr>
</tbody></table>
<p>提示：提示：对于 ID 为 1 的玩家，2016-05-02 共玩了 5+6=11 个游戏.<br>对于 ID 为 3 的玩家，2018-07-03 共玩了 0+5=5 个游戏。</p>
<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一：</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">      A.player_id,</span><br><span class="line">      A.event_date,</span><br><span class="line">      <span class="built_in">SUM</span>(B.games_played) <span class="keyword">AS</span> `games_played_so_far`</span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">      <span class="number">12</span>_Activity <span class="keyword">AS</span> A</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">JOIN</span> </span><br><span class="line">      <span class="number">12</span>_Activity <span class="keyword">AS</span> B </span><br><span class="line"><span class="keyword">ON</span> </span><br><span class="line">      A.player_id <span class="operator">=</span> B.player_id </span><br><span class="line">      <span class="keyword">AND</span> A.event_date <span class="operator">&gt;=</span> B.event_date</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> </span><br><span class="line">      A.player_id,A.event_date;</span><br><span class="line">      </span><br><span class="line"><span class="comment">-- 方法二：</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">	  player_id,</span><br><span class="line">	  event_date ,</span><br><span class="line">	  <span class="built_in">sum</span>(games_played) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> player_id <span class="keyword">order</span> <span class="keyword">by</span>  event_date )games_played_so_far</span><br><span class="line"><span class="keyword">from</span> <span class="number">12</span>_Activity;</span><br></pre></td></tr></table></figure>

<p><strong>需求四</strong>：编写一个 SQL 查询，报告在首次登录的第二天再次登录的玩家的百分比，四舍五入到小数点后两位。换句话说，您需要计算从首次登录日期开始至少连续两天登录的玩家的数量，然后除以玩家总数。</p>
<table>
<thead>
<tr>
<th>fraction</th>
</tr>
</thead>
<tbody><tr>
<td>0.33</td>
</tr>
</tbody></table>
<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一：</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">      round(</span><br><span class="line">            <span class="built_in">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> datediff(a.event_date,b.first_date)<span class="operator">=</span><span class="number">1</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>)</span><br><span class="line">               <span class="operator">/</span></span><br><span class="line">               (<span class="keyword">select</span> <span class="built_in">count</span>(<span class="keyword">distinct</span>(player_id)) <span class="keyword">from</span> <span class="number">12</span>_Activity)</span><br><span class="line">            ,<span class="number">2</span> ) <span class="keyword">as</span> fraction</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      <span class="number">12</span>_Activity a,</span><br><span class="line">     (<span class="keyword">select</span> </span><br><span class="line">             player_id,</span><br><span class="line">             <span class="built_in">min</span>(event_date) first_date </span><br><span class="line">      <span class="keyword">from</span> </span><br><span class="line">             <span class="number">12</span>_Activity </span><br><span class="line">      <span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">             player_id</span><br><span class="line">     ) b</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">      a.player_id<span class="operator">=</span>b.player_id;</span><br><span class="line">      </span><br><span class="line">      </span><br><span class="line"><span class="comment">-- 方法二：</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">      round(<span class="built_in">avg</span>(a.event_date <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span>), <span class="number">2</span>) fraction</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">     (<span class="keyword">select</span></span><br><span class="line">            player_id,</span><br><span class="line">            <span class="built_in">min</span>(event_date) <span class="keyword">as</span> first_date</span><br><span class="line">      <span class="keyword">from</span> </span><br><span class="line">            <span class="number">12</span>_Activity</span><br><span class="line">      <span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">            player_id) b</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> </span><br><span class="line">      <span class="number">12</span>_Activity a </span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">      b.player_id<span class="operator">=</span>a.player_id <span class="keyword">and</span> datediff(a.event_date, b.first_date)<span class="operator">=</span><span class="number">1</span></span><br></pre></td></tr></table></figure>

<p><strong>需求五</strong>：编写一个 SQL 查询，报告每个安装日期、当天安装游戏的玩家数量和第一天的保留时间。</p>
<table>
<thead>
<tr>
<th>install_dt</th>
<th>installs</th>
<th>Day1_retention</th>
</tr>
</thead>
<tbody><tr>
<td>2016-03-01</td>
<td>2</td>
<td>0.50</td>
</tr>
<tr>
<td>2017-06-25</td>
<td>1</td>
<td>0.00</td>
</tr>
</tbody></table>
<p>提示：玩家 1 和 3 在 2016-03-01 安装了游戏，但只有玩家 1 在 2016-03-02 重新登录，所以 2016-03-01 的第一天保留时间是 1/2=0.50<br>玩家 2 在 2017-06-25 安装了游戏，但在 2017-06-26 没有重新登录，因此 2017-06-25 的第一天保留为 0/1=0.00</p>
<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">      A.event_date <span class="keyword">AS</span> install_dt,</span><br><span class="line">      <span class="built_in">COUNT</span>(A.player_id) <span class="keyword">AS</span> installs,</span><br><span class="line">      round(<span class="built_in">COUNT</span>(C.player_id)<span class="operator">/</span><span class="built_in">COUNT</span>(A.player_id),<span class="number">2</span>) <span class="keyword">AS</span> Day1_retention</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">      <span class="number">12</span>_Activity <span class="keyword">AS</span> A</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">JOIN</span></span><br><span class="line">      <span class="number">12</span>_Activity <span class="keyword">AS</span> B</span><br><span class="line"><span class="keyword">ON</span></span><br><span class="line">      A.player_id <span class="operator">=</span> B.player_id <span class="keyword">AND</span> A.event_date <span class="operator">&gt;</span> B.event_date</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">JOIN</span></span><br><span class="line">      <span class="number">12</span>_Activity <span class="keyword">AS</span> C</span><br><span class="line"><span class="keyword">ON</span></span><br><span class="line">      A.player_id <span class="operator">=</span> C.player_id <span class="keyword">AND</span> C.event_date <span class="operator">=</span> DATE_ADD(A.event_date,<span class="type">INTERVAL</span> <span class="number">1</span> <span class="keyword">DAY</span>)</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">      B.event_date <span class="keyword">IS</span> <span class="keyword">NULL</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">      A.event_date;</span><br></pre></td></tr></table></figure>

<h2 id="13-员工薪水中位数"><a href="#13-员工薪水中位数" class="headerlink" title="13. 员工薪水中位数"></a>13. 员工薪水中位数</h2><p>需求：请编写SQL查询来查找每个公司的薪水中位数。挑战点：你是否可以在不使用任何内置的SQL函数的情况下解决此问题。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>Id</th>
<th>Company</th>
<th>Salary</th>
</tr>
</thead>
<tbody><tr>
<td>5</td>
<td>A</td>
<td>451</td>
</tr>
<tr>
<td>6</td>
<td>A</td>
<td>513</td>
</tr>
<tr>
<td>12</td>
<td>B</td>
<td>234</td>
</tr>
<tr>
<td>9</td>
<td>B</td>
<td>1154</td>
</tr>
<tr>
<td>15</td>
<td>C</td>
<td>2645</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">13</span>_Employee (Id <span class="type">int</span>, Company <span class="type">varchar</span>(<span class="number">255</span>), Salary <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">13</span>_Employee;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">13</span>_Employee (Id, Company, Salary) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;A&#x27;</span>, <span class="number">2341</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">13</span>_Employee (Id, Company, Salary) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;A&#x27;</span>, <span class="number">341</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">13</span>_Employee (Id, Company, Salary) <span class="keyword">values</span> (<span class="number">3</span>, <span class="string">&#x27;A&#x27;</span>, <span class="number">15</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">13</span>_Employee (Id, Company, Salary) <span class="keyword">values</span> (<span class="number">4</span>, <span class="string">&#x27;A&#x27;</span>, <span class="number">15314</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">13</span>_Employee (Id, Company, Salary) <span class="keyword">values</span> (<span class="number">5</span>, <span class="string">&#x27;A&#x27;</span>, <span class="number">451</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">13</span>_Employee (Id, Company, Salary) <span class="keyword">values</span> (<span class="number">6</span>, <span class="string">&#x27;A&#x27;</span>, <span class="number">513</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">13</span>_Employee (Id, Company, Salary) <span class="keyword">values</span> (<span class="number">7</span>, <span class="string">&#x27;B&#x27;</span>, <span class="number">15</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">13</span>_Employee (Id, Company, Salary) <span class="keyword">values</span> (<span class="number">8</span>, <span class="string">&#x27;B&#x27;</span>, <span class="number">13</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">13</span>_Employee (Id, Company, Salary) <span class="keyword">values</span> (<span class="number">9</span>, <span class="string">&#x27;B&#x27;</span>, <span class="number">1154</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">13</span>_Employee (Id, Company, Salary) <span class="keyword">values</span> (<span class="number">10</span>, <span class="string">&#x27;B&#x27;</span>, <span class="number">1345</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">13</span>_Employee (Id, Company, Salary) <span class="keyword">values</span> (<span class="number">11</span>, <span class="string">&#x27;B&#x27;</span>, <span class="number">1221</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">13</span>_Employee (Id, Company, Salary) <span class="keyword">values</span> (<span class="number">12</span>, <span class="string">&#x27;B&#x27;</span>, <span class="number">234</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">13</span>_Employee (Id, Company, Salary) <span class="keyword">values</span> (<span class="number">13</span>, <span class="string">&#x27;C&#x27;</span>, <span class="number">2345</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">13</span>_Employee (Id, Company, Salary) <span class="keyword">values</span> (<span class="number">14</span>, <span class="string">&#x27;C&#x27;</span>, <span class="number">2865</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">13</span>_Employee (Id, Company, Salary) <span class="keyword">values</span> (<span class="number">15</span>, <span class="string">&#x27;C&#x27;</span>, <span class="number">2645</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">13</span>_Employee (Id, Company, Salary) <span class="keyword">values</span> (<span class="number">16</span>, <span class="string">&#x27;C&#x27;</span>, <span class="number">2652</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">13</span>_Employee (Id, Company, Salary) <span class="keyword">values</span> (<span class="number">17</span>, <span class="string">&#x27;C&#x27;</span>, <span class="number">65</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一：</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">     b.id,</span><br><span class="line">     b.company,</span><br><span class="line">     b.salary</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    (<span class="keyword">select</span></span><br><span class="line">           id,</span><br><span class="line">           company,</span><br><span class="line">           salary,</span><br><span class="line">           <span class="keyword">case</span> <span class="variable">@com</span> <span class="keyword">when</span> company <span class="keyword">then</span> <span class="variable">@rk</span>:<span class="operator">=</span><span class="variable">@rk</span><span class="operator">+</span><span class="number">1</span> <span class="keyword">else</span> <span class="variable">@rk</span>:<span class="operator">=</span><span class="number">1</span> <span class="keyword">end</span> rk,</span><br><span class="line">           <span class="variable">@com</span>:<span class="operator">=</span>company</span><br><span class="line">    <span class="keyword">from</span> </span><br><span class="line">           <span class="number">13</span>_Employee,</span><br><span class="line">           (<span class="keyword">select</span> <span class="variable">@rk</span>:<span class="operator">=</span><span class="number">0</span>, <span class="variable">@com</span>:<span class="operator">=</span><span class="string">&#x27;&#x27;</span>) a</span><br><span class="line">    <span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">           company,salary</span><br><span class="line">    ) b</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> </span><br><span class="line">    (<span class="keyword">select</span></span><br><span class="line">           company,</span><br><span class="line">           <span class="built_in">count</span>(<span class="number">1</span>)<span class="operator">/</span><span class="number">2</span> cnt</span><br><span class="line">     <span class="keyword">from</span> </span><br><span class="line">           <span class="number">13</span>_Employee</span><br><span class="line">     <span class="keyword">group</span> <span class="keyword">by</span> company</span><br><span class="line">    ) c</span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">     b.company<span class="operator">=</span>c.company</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">     b.rk <span class="keyword">in</span> (cnt<span class="operator">+</span><span class="number">0.5</span>,cnt<span class="operator">+</span><span class="number">1</span>,cnt);</span><br><span class="line">     </span><br><span class="line"><span class="comment">-- 方法二：</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">	 Id,</span><br><span class="line">	 Company,</span><br><span class="line">	 Salary</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">	(<span class="keyword">select</span></span><br><span class="line">           Id,</span><br><span class="line">     	   Company,</span><br><span class="line">     	   Salary,</span><br><span class="line">		   <span class="built_in">ROW_NUMBER</span>() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> Company <span class="keyword">order</span> <span class="keyword">by</span> Salary) rk,</span><br><span class="line">		   <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> Company) cnt</span><br><span class="line">	<span class="keyword">from</span> <span class="number">13</span>_Employee</span><br><span class="line">	)t1</span><br><span class="line"><span class="keyword">where</span> rk <span class="keyword">IN</span> (<span class="built_in">FLOOR</span>((cnt <span class="operator">+</span> <span class="number">1</span>)<span class="operator">/</span><span class="number">2</span>), <span class="built_in">FLOOR</span>((cnt <span class="operator">+</span> <span class="number">2</span>)<span class="operator">/</span><span class="number">2</span>))</span><br></pre></td></tr></table></figure>

<h2 id="14-至少有5名直接下属的经理"><a href="#14-至少有5名直接下属的经理" class="headerlink" title="14. 至少有5名直接下属的经理"></a>14. 至少有5名直接下属的经理</h2><p>需求：Employee 表，请编写一个SQL查询来查找至少有5名直接下属的经理。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>Name</th>
</tr>
</thead>
<tbody><tr>
<td>John</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">14</span>_Employee (Id <span class="type">int</span>, Name <span class="type">varchar</span>(<span class="number">255</span>), Department <span class="type">varchar</span>(<span class="number">255</span>), ManagerId <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">14</span>_Employee;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">14</span>_Employee (Id, Name, Department, ManagerId) <span class="keyword">values</span> (<span class="number">101</span>, <span class="string">&#x27;John&#x27;</span>, <span class="string">&#x27;A&#x27;</span>, <span class="keyword">null</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">14</span>_Employee (Id, Name, Department, ManagerId) <span class="keyword">values</span> (<span class="number">102</span>, <span class="string">&#x27;Dan&#x27;</span>, <span class="string">&#x27;A&#x27;</span>, <span class="number">101</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">14</span>_Employee (Id, Name, Department, ManagerId) <span class="keyword">values</span> (<span class="number">103</span>, <span class="string">&#x27;James&#x27;</span>, <span class="string">&#x27;A&#x27;</span>, <span class="number">101</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">14</span>_Employee (Id, Name, Department, ManagerId) <span class="keyword">values</span> (<span class="number">104</span>, <span class="string">&#x27;Amy&#x27;</span>, <span class="string">&#x27;A&#x27;</span>, <span class="number">101</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">14</span>_Employee (Id, Name, Department, ManagerId) <span class="keyword">values</span> (<span class="number">105</span>, <span class="string">&#x27;Anne&#x27;</span>, <span class="string">&#x27;A&#x27;</span>, <span class="number">101</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">14</span>_Employee (Id, Name, Department, ManagerId) <span class="keyword">values</span> (<span class="number">106</span>, <span class="string">&#x27;Ron&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="number">101</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一：</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    Name</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    <span class="number">14</span>_Employee <span class="keyword">AS</span> t1 </span><br><span class="line"><span class="keyword">JOIN</span> </span><br><span class="line">   (<span class="keyword">SELECT</span></span><br><span class="line">        ManagerId</span><br><span class="line">    <span class="keyword">FROM</span></span><br><span class="line">        <span class="number">14</span>_Employee</span><br><span class="line">    <span class="keyword">GROUP</span> <span class="keyword">BY</span> </span><br><span class="line">        ManagerId</span><br><span class="line">    <span class="keyword">HAVING</span></span><br><span class="line">        <span class="built_in">COUNT</span>(ManagerId) <span class="operator">&gt;=</span> <span class="number">5</span></span><br><span class="line">    ) <span class="keyword">AS</span> t2</span><br><span class="line"><span class="keyword">ON</span>  </span><br><span class="line">    t1.Id <span class="operator">=</span> t2.ManagerId;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法二：</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">	Name</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">	<span class="number">14</span>_Employee</span><br><span class="line"><span class="keyword">where</span> Id <span class="keyword">in</span> (</span><br><span class="line">			<span class="keyword">select</span></span><br><span class="line">    			  ManagerId</span><br><span class="line">			<span class="keyword">from</span></span><br><span class="line">    			  <span class="number">14</span>_Employee</span><br><span class="line">			<span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">    			  ManagerId</span><br><span class="line">			<span class="keyword">having</span></span><br><span class="line">    			  <span class="built_in">count</span>(<span class="operator">*</span>)<span class="operator">&gt;=</span><span class="number">5</span> );</span><br></pre></td></tr></table></figure>

<h2 id="15-给定数字的频率查询中位数"><a href="#15-给定数字的频率查询中位数" class="headerlink" title="15. 给定数字的频率查询中位数"></a>15. 给定数字的频率查询中位数</h2><p>需求：请编写一个查询来查找所有数字的中位数并将结果命名为 median 。</p>
<p>根据下表数据可以看出，原始数据为：<code>0,0,1,2,2,2,3</code>  中位数为2。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>median</th>
</tr>
</thead>
<tbody><tr>
<td>2.0000</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">15</span>_Numbers (Number <span class="type">int</span>, Frequency <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">15</span>_Numbers;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">15</span>_Numbers (Number, Frequency) <span class="keyword">values</span> (<span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">15</span>_Numbers (Number, Frequency) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">15</span>_Numbers (Number, Frequency) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">15</span>_Numbers (Number, Frequency) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<p>提示：如果 n1.Number 为中位数，n1.Number（包含本身）前累计的数字应大于等于总数/2 ，同时n1.Number（不包含本身）前累计数字应小于等于总数/2。</p>
<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">      <span class="built_in">avg</span>(t.number) <span class="keyword">as</span> median</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">      (<span class="keyword">select</span></span><br><span class="line">             n1.number,</span><br><span class="line">             n1.frequency,</span><br><span class="line">             (<span class="keyword">select</span> </span><br><span class="line">                   <span class="built_in">sum</span>(frequency) </span><br><span class="line">              <span class="keyword">from</span> </span><br><span class="line">                   <span class="number">15</span>_Numbers n2</span><br><span class="line">              <span class="keyword">where</span> </span><br><span class="line">                   n2.number<span class="operator">&lt;=</span>n1.number</span><br><span class="line">             ) <span class="keyword">as</span> asc_frequency,</span><br><span class="line">             (<span class="keyword">select</span></span><br><span class="line">                   <span class="built_in">sum</span>(frequency)</span><br><span class="line">              <span class="keyword">from</span> </span><br><span class="line">                   <span class="number">15</span>_Numbers n3 </span><br><span class="line">              <span class="keyword">where</span> </span><br><span class="line">                   n3.number<span class="operator">&gt;=</span>n1.number</span><br><span class="line">             ) <span class="keyword">as</span> desc_frequency</span><br><span class="line">      <span class="keyword">from</span> </span><br><span class="line">             <span class="number">15</span>_Numbers n1</span><br><span class="line">      ) t</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">      t.asc_frequency<span class="operator">&gt;=</span> (<span class="keyword">select</span> <span class="built_in">sum</span>(frequency) <span class="keyword">from</span> <span class="number">15</span>_Numbers)<span class="operator">/</span><span class="number">2</span></span><br><span class="line">      <span class="keyword">and</span> t.desc_frequency<span class="operator">&gt;=</span> (<span class="keyword">select</span> <span class="built_in">sum</span>(frequency) <span class="keyword">from</span> <span class="number">15</span>_Numbers)<span class="operator">/</span><span class="number">2</span>;</span><br></pre></td></tr></table></figure>

<h2 id="16-当选者"><a href="#16-当选者" class="headerlink" title="16. 当选者"></a>16. 当选者</h2><p>需求：请编写 sql 语句来找到当选者（CandidateId）的名字，</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>Name</th>
</tr>
</thead>
<tbody><tr>
<td>B</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">16</span>_Candidate (id <span class="type">int</span>, Name <span class="type">varchar</span>(<span class="number">255</span>));</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">16</span>_Vote (id <span class="type">int</span>, CandidateId <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">16</span>_Candidate;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">16</span>_Candidate (id, Name) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;A&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">16</span>_Candidate (id, Name) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;B&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">16</span>_Candidate (id, Name) <span class="keyword">values</span> (<span class="number">3</span>, <span class="string">&#x27;C&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">16</span>_Candidate (id, Name) <span class="keyword">values</span> (<span class="number">4</span>, <span class="string">&#x27;D&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">16</span>_Candidate (id, Name) <span class="keyword">values</span> (<span class="number">5</span>, <span class="string">&#x27;E&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">16</span>_Vote;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">16</span>_Vote (id, CandidateId) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">16</span>_Vote (id, CandidateId) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">4</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">16</span>_Vote (id, CandidateId) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">16</span>_Vote (id, CandidateId) <span class="keyword">values</span> (<span class="number">4</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">16</span>_Vote (id, CandidateId) <span class="keyword">values</span> (<span class="number">5</span>, <span class="number">5</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    name <span class="keyword">AS</span> <span class="string">&#x27;Name&#x27;</span></span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    <span class="number">16</span>_Candidate a</span><br><span class="line"><span class="keyword">JOIN</span></span><br><span class="line">    (<span class="keyword">SELECT</span></span><br><span class="line">        CandidateId</span><br><span class="line">    <span class="keyword">FROM</span></span><br><span class="line">        <span class="number">16</span>_Vote</span><br><span class="line">    <span class="keyword">GROUP</span> <span class="keyword">BY</span> </span><br><span class="line">        CandidateId</span><br><span class="line">    <span class="keyword">ORDER</span> <span class="keyword">BY</span> </span><br><span class="line">        <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">DESC</span></span><br><span class="line">    LIMIT <span class="number">1</span></span><br><span class="line">    ) <span class="keyword">AS</span> winner</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    a.id <span class="operator">=</span> winner.CandidateId;</span><br></pre></td></tr></table></figure>

<h2 id="17-员工奖金"><a href="#17-员工奖金" class="headerlink" title="17. 员工奖金"></a>17. 员工奖金</h2><p>需求：选出所有 bonus &lt; 1000 的员工的 name 及其 bonus。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>name</th>
<th>bonus</th>
</tr>
</thead>
<tbody><tr>
<td>John</td>
<td>null</td>
</tr>
<tr>
<td>Dan</td>
<td>500</td>
</tr>
<tr>
<td>Brad</td>
<td>null</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">17</span>_Employee (EmpId <span class="type">int</span>, Name <span class="type">varchar</span>(<span class="number">255</span>), Supervisor <span class="type">int</span>, Salary <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">17</span>_Bonus (EmpId <span class="type">int</span>, Bonus <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">17</span>_Employee;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">17</span>_Employee (EmpId, Name, Supervisor, Salary) <span class="keyword">values</span> (<span class="number">3</span>, <span class="string">&#x27;Brad&#x27;</span>, <span class="keyword">null</span>, <span class="number">4000</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">17</span>_Employee (EmpId, Name, Supervisor, Salary) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;John&#x27;</span>, <span class="number">3</span>, <span class="number">1000</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">17</span>_Employee (EmpId, Name, Supervisor, Salary) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;Dan&#x27;</span>, <span class="number">3</span>, <span class="number">2000</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">17</span>_Employee (EmpId, Name, Supervisor, Salary) <span class="keyword">values</span> (<span class="number">4</span>, <span class="string">&#x27;Thomas&#x27;</span>, <span class="number">3</span>, <span class="number">4000</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">17</span>_Bonus;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">17</span>_Bonus (EmpId, Bonus) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">500</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">17</span>_Bonus (EmpId, Bonus) <span class="keyword">values</span> (<span class="number">4</span>, <span class="number">2000</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    e.name, </span><br><span class="line">    b.bonus</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    <span class="number">17</span>_Employee e</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span></span><br><span class="line">    <span class="number">17</span>_Bonus b</span><br><span class="line"><span class="keyword">ON</span> </span><br><span class="line">    e.empid <span class="operator">=</span> b.empid</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    bonus <span class="operator">&lt;</span> <span class="number">1000</span> <span class="keyword">OR</span> bonus <span class="keyword">IS</span> <span class="keyword">NULL</span>;</span><br></pre></td></tr></table></figure>

<h2 id="18-最高回答率"><a href="#18-最高回答率" class="headerlink" title="18. 最高回答率"></a>18. 最高回答率</h2><p>需求：请编写SQL查询来找到具有最高回答率的问题。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>survey_log</th>
</tr>
</thead>
<tbody><tr>
<td>285</td>
</tr>
</tbody></table>
<p>​        从 <code>survey_log</code> 表中获得回答率最高的问题，<code>survey_log</code> 表包含这些列<strong>：id</strong>, <strong>action</strong>, <strong>question_id</strong>, <strong>answer_id</strong>, <strong>q_num</strong>, <strong>timestamp</strong>。id 表示用户 id；action 有以下几种值：”show”，”answer”，”skip”；当 action 值为 “answer” 时 answer_id 非空，而 action 值为 “show” 或者 “skip” 时 answer_id 为空；q_num 表示当前会话中问题的编号。</p>
<p>​        </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">18</span>_survey_log (uid <span class="type">int</span>, action <span class="type">varchar</span>(<span class="number">255</span>), question_id <span class="type">int</span>, answer_id <span class="type">int</span>, q_num <span class="type">int</span>, <span class="type">timestamp</span> <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">18</span>_survey_log;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">18</span>_survey_log (uid, action, question_id, answer_id, q_num, <span class="type">timestamp</span>) <span class="keyword">values</span> (<span class="number">5</span>, <span class="string">&#x27;show&#x27;</span>, <span class="number">285</span>, <span class="keyword">null</span>, <span class="number">1</span>, <span class="number">123</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">18</span>_survey_log (uid, action, question_id, answer_id, q_num, <span class="type">timestamp</span>) <span class="keyword">values</span> (<span class="number">5</span>, <span class="string">&#x27;answer&#x27;</span>, <span class="number">285</span>, <span class="number">124124</span>, <span class="number">1</span>, <span class="number">124</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">18</span>_survey_log (uid, action, question_id, answer_id, q_num, <span class="type">timestamp</span>) <span class="keyword">values</span> (<span class="number">5</span>, <span class="string">&#x27;show&#x27;</span>, <span class="number">369</span>, <span class="keyword">null</span>, <span class="number">2</span>, <span class="number">125</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">18</span>_survey_log (uid, action, question_id, answer_id, q_num, <span class="type">timestamp</span>) <span class="keyword">values</span> (<span class="number">5</span>, <span class="string">&#x27;skip&#x27;</span>, <span class="number">369</span>, <span class="keyword">null</span>, <span class="number">2</span>, <span class="number">126</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    question_id <span class="keyword">as</span> survey_log</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">   (<span class="keyword">SELECT</span> </span><br><span class="line">         question_id,</span><br><span class="line">         <span class="built_in">SUM</span>(<span class="keyword">case</span> <span class="keyword">when</span> action<span class="operator">=</span>&quot;answer&quot; <span class="keyword">THEN</span> <span class="number">1</span> <span class="keyword">ELSE</span> <span class="number">0</span> <span class="keyword">END</span>) <span class="keyword">as</span> num_answer,</span><br><span class="line">         <span class="built_in">SUM</span>(<span class="keyword">case</span> <span class="keyword">when</span> action<span class="operator">=</span>&quot;show&quot; <span class="keyword">THEN</span> <span class="number">1</span> <span class="keyword">ELSE</span> <span class="number">0</span> <span class="keyword">END</span>) <span class="keyword">as</span> num_show</span><br><span class="line">	<span class="keyword">FROM</span> </span><br><span class="line">         <span class="number">18</span>_survey_log</span><br><span class="line">	<span class="keyword">GROUP</span> <span class="keyword">BY</span> </span><br><span class="line">         question_id</span><br><span class="line">    ) <span class="keyword">as</span> tbl</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">    (num_answer <span class="operator">/</span> num_show) <span class="keyword">DESC</span></span><br><span class="line">LIMIT <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法二</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    question_id <span class="keyword">AS</span> <span class="string">&#x27;survey_log&#x27;</span></span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    <span class="number">18</span>_survey_log</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">    question_id</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">    <span class="built_in">COUNT</span>(answer_id) <span class="operator">/</span> <span class="built_in">COUNT</span>(IF(action <span class="operator">=</span> <span class="string">&#x27;show&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) <span class="keyword">DESC</span></span><br><span class="line">LIMIT <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<h2 id="19-员工累计薪水"><a href="#19-员工累计薪水" class="headerlink" title="19. 员工累计薪水"></a>19. 员工累计薪水</h2><p>需求：查询一个员工三个月内的累计薪水，但是不包括最近一个月的薪水。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>Id</th>
<th>Month</th>
<th>Salary</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>3</td>
<td>90</td>
</tr>
<tr>
<td>1</td>
<td>2</td>
<td>50</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>20</td>
</tr>
<tr>
<td>2</td>
<td>1</td>
<td>20</td>
</tr>
<tr>
<td>3</td>
<td>3</td>
<td>100</td>
</tr>
<tr>
<td>3</td>
<td>2</td>
<td>40</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">19</span>_Employee (Id <span class="type">int</span>, <span class="keyword">Month</span> <span class="type">int</span>, Salary <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">19</span>_Employee;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">19</span>_Employee (Id, <span class="keyword">Month</span>, Salary) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="number">20</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">19</span>_Employee (Id, <span class="keyword">Month</span>, Salary) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">1</span>, <span class="number">20</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">19</span>_Employee (Id, <span class="keyword">Month</span>, Salary) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">2</span>, <span class="number">30</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">19</span>_Employee (Id, <span class="keyword">Month</span>, Salary) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">2</span>, <span class="number">30</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">19</span>_Employee (Id, <span class="keyword">Month</span>, Salary) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">2</span>, <span class="number">40</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">19</span>_Employee (Id, <span class="keyword">Month</span>, Salary) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">3</span>, <span class="number">40</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">19</span>_Employee (Id, <span class="keyword">Month</span>, Salary) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">3</span>, <span class="number">60</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">19</span>_Employee (Id, <span class="keyword">Month</span>, Salary) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">4</span>, <span class="number">60</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">19</span>_Employee (Id, <span class="keyword">Month</span>, Salary) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">4</span>, <span class="number">70</span>);</span><br></pre></td></tr></table></figure>

<p>说明：员工 1 除去最近一个月（月份 4），有三个月的薪水记录：月份 3 薪水为 40，月份 2 薪水为 30，月份 1 薪水为 20。所以近 3 个月的薪水累计分别为 (40 + 30 + 20) = 90，(30 + 20) = 50 和 20。</p>
<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    E1.id,</span><br><span class="line">    E1.month,</span><br><span class="line">    (IFNULL(E1.salary, <span class="number">0</span>) <span class="operator">+</span> IFNULL(E2.salary, <span class="number">0</span>) <span class="operator">+</span> IFNULL(E3.salary, <span class="number">0</span>)) <span class="keyword">AS</span> Salary</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    (<span class="keyword">SELECT</span></span><br><span class="line">        id, <span class="built_in">MAX</span>(<span class="keyword">month</span>) <span class="keyword">AS</span> <span class="keyword">month</span></span><br><span class="line">    <span class="keyword">FROM</span></span><br><span class="line">        <span class="number">19</span>_Employee</span><br><span class="line">    <span class="keyword">GROUP</span> <span class="keyword">BY</span> </span><br><span class="line">        id</span><br><span class="line">    <span class="keyword">HAVING</span> </span><br><span class="line">        <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="operator">&gt;</span> <span class="number">1</span>) <span class="keyword">AS</span> maxmonth</span><br><span class="line">    <span class="keyword">LEFT</span> <span class="keyword">JOIN</span></span><br><span class="line">        <span class="number">19</span>_Employee E1 </span><br><span class="line">    <span class="keyword">ON</span> </span><br><span class="line">        (maxmonth.id <span class="operator">=</span> E1.id <span class="keyword">AND</span> maxmonth.month <span class="operator">&gt;</span> E1.month)</span><br><span class="line">    <span class="keyword">LEFT</span> <span class="keyword">JOIN</span></span><br><span class="line">        <span class="number">19</span>_Employee E2 </span><br><span class="line">    <span class="keyword">ON</span> </span><br><span class="line">        (E2.id <span class="operator">=</span> E1.id <span class="keyword">AND</span> E2.month <span class="operator">=</span> E1.month <span class="operator">-</span> <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> </span><br><span class="line">        <span class="number">19</span>_Employee E3 </span><br><span class="line">    <span class="keyword">ON</span></span><br><span class="line">        (E3.id <span class="operator">=</span> E1.id <span class="keyword">AND</span> E3.month <span class="operator">=</span> E1.month <span class="operator">-</span> <span class="number">2</span>)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> </span><br><span class="line">    id <span class="keyword">ASC</span> , <span class="keyword">month</span> <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<h2 id="20-统计各专业人数"><a href="#20-统计各专业人数" class="headerlink" title="20. 统计各专业人数"></a>20. 统计各专业人数</h2><p>需求：查询 department 表中每个专业的学生人数 （即使没有学生的专业也需列出）。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>dept_name</th>
<th>student_number</th>
</tr>
</thead>
<tbody><tr>
<td>Engineering</td>
<td>2</td>
</tr>
<tr>
<td>Science</td>
<td>1</td>
</tr>
<tr>
<td>Law</td>
<td>0</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="number">20</span>_student (student_id <span class="type">INT</span>,student_name <span class="type">VARCHAR</span>(<span class="number">45</span>), gender <span class="type">VARCHAR</span>(<span class="number">6</span>), dept_id <span class="type">INT</span>);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="number">20</span>_department (dept_id <span class="type">INT</span>, dept_name <span class="type">VARCHAR</span>(<span class="number">255</span>));</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">20</span>_student;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">20</span>_student (student_id, student_name, gender, dept_id) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;Jack&#x27;</span>, <span class="string">&#x27;M&#x27;</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">20</span>_student (student_id, student_name, gender, dept_id) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;Jane&#x27;</span>, <span class="string">&#x27;F&#x27;</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">20</span>_student (student_id, student_name, gender, dept_id) <span class="keyword">values</span> (<span class="number">3</span>, <span class="string">&#x27;Mark&#x27;</span>, <span class="string">&#x27;M&#x27;</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">20</span>_department;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">20</span>_department (dept_id, dept_name) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;Engineering&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">20</span>_department (dept_id, dept_name) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;Science&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">20</span>_department (dept_id, dept_name) <span class="keyword">values</span> (<span class="number">3</span>, <span class="string">&#x27;Law&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    dept_name,</span><br><span class="line">    <span class="built_in">COUNT</span>(student_id) <span class="keyword">AS</span> student_number</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    <span class="number">20</span>_department d</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">OUTER</span> <span class="keyword">JOIN</span></span><br><span class="line">    <span class="number">20</span>_student s</span><br><span class="line"><span class="keyword">ON</span></span><br><span class="line">    d.dept_id <span class="operator">=</span> s.dept_id</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> </span><br><span class="line">    d.dept_name</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> </span><br><span class="line">    student_number <span class="keyword">DESC</span>, </span><br><span class="line">    d.dept_name;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hf7751.gitee.io/2021/03/11/41-60/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="hefei">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="元">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/03/11/41-60/" class="post-title-link" itemprop="url">بدون عنوان</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">نُشر في</span>

      <time title="أُنشأ: 2021-03-11 02:36:18" itemprop="dateCreated datePublished" datetime="2021-03-11T02:36:18+08:00">2021-03-11</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">عُدل في</span>
        <time title="عُدل: 2021-03-04 15:48:04" itemprop="dateModified" datetime="2021-03-04T15:48:04+08:00">2021-03-04</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="41-买下所有产品的用户"><a href="#41-买下所有产品的用户" class="headerlink" title="41. 买下所有产品的用户"></a>41. 买下所有产品的用户</h2><p>需求：编写一个 SQL 查询，从 Customer 表中查询购买了 Product 表中所有产品的客户的 id。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>customer_id</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
</tr>
<tr>
<td>3</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">41</span>_Customer (customer_id <span class="type">int</span>, product_key <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> <span class="number">41</span>_Product (product_key <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">41</span>_Customer;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">41</span>_Customer (customer_id, product_key) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">5</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">41</span>_Customer (customer_id, product_key) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">6</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">41</span>_Customer (customer_id, product_key) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">5</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">41</span>_Customer (customer_id, product_key) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">6</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">41</span>_Customer (customer_id, product_key) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">6</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">41</span>_Product;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">41</span>_Product (product_key) <span class="keyword">values</span> (<span class="number">5</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">41</span>_Product (product_key) <span class="keyword">values</span> (<span class="number">6</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">	customer_id</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">	(<span class="keyword">select</span></span><br><span class="line">          customer_id,</span><br><span class="line">          <span class="built_in">count</span>(<span class="keyword">distinct</span> product_key) <span class="keyword">as</span> num </span><br><span class="line"> 	 <span class="keyword">from</span></span><br><span class="line">          <span class="number">41</span>_Customer</span><br><span class="line"> 	 <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">          customer_id) t</span><br><span class="line"><span class="keyword">join</span> </span><br><span class="line">    (<span class="keyword">select</span></span><br><span class="line">          <span class="built_in">count</span>(product_key) <span class="keyword">as</span> num</span><br><span class="line">     <span class="keyword">from</span> </span><br><span class="line">          <span class="number">41</span>_Product) m </span><br><span class="line"><span class="keyword">on</span> t.num <span class="operator">=</span> m.num;</span><br></pre></td></tr></table></figure>

<h2 id="42-合作过至少三次的演员和导演"><a href="#42-合作过至少三次的演员和导演" class="headerlink" title="42. 合作过至少三次的演员和导演"></a>42. 合作过至少三次的演员和导演</h2><p>需求：编写一个 SQL 查询，查询语句获取合作过至少三次的演员和导演的 id 对 (actor_id, director_id)</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>actor_id</th>
<th>director_id</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>1</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">42</span>_ActorDirector (actor_id <span class="type">int</span>, director_id <span class="type">int</span>, <span class="type">timestamp</span> <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">42</span>_ActorDirector;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">42</span>_ActorDirector (actor_id, director_id, <span class="type">timestamp</span>) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">42</span>_ActorDirector (actor_id, director_id, <span class="type">timestamp</span>) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">42</span>_ActorDirector (actor_id, director_id, <span class="type">timestamp</span>) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">42</span>_ActorDirector (actor_id, director_id, <span class="type">timestamp</span>) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">42</span>_ActorDirector (actor_id, director_id, <span class="type">timestamp</span>) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">2</span>, <span class="number">4</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">42</span>_ActorDirector (actor_id, director_id, <span class="type">timestamp</span>) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">1</span>, <span class="number">5</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">42</span>_ActorDirector (actor_id, director_id, <span class="type">timestamp</span>) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">1</span>, <span class="number">6</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">      actor_id,</span><br><span class="line">      director_id</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      <span class="number">42</span>_ActorDirector </span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">      actor_id,director_id </span><br><span class="line"><span class="keyword">having</span> </span><br><span class="line">      <span class="built_in">count</span>(<span class="operator">*</span>)<span class="operator">&gt;=</span><span class="number">3</span>;</span><br></pre></td></tr></table></figure>

<h2 id="43-产品销售分析"><a href="#43-产品销售分析" class="headerlink" title="43. 产品销售分析"></a>43. 产品销售分析</h2><p>需求一：获取产品表 <code>Product</code> 中所有的 <strong>产品名称 product name</strong> 以及 该产品在 <code>Sales</code> 表中相对应的 <strong>上市年份 year</strong> 和 <strong>价格 price</strong>。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>product_name</th>
<th>year</th>
<th>price</th>
</tr>
</thead>
<tbody><tr>
<td>Nokia</td>
<td>2008</td>
<td>5000</td>
</tr>
<tr>
<td>Nokia</td>
<td>2009</td>
<td>5000</td>
</tr>
<tr>
<td>Apple</td>
<td>2011</td>
<td>9000</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span>  If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">43</span>_Sales (sale_id <span class="type">int</span>, product_id <span class="type">int</span>, <span class="keyword">year</span> <span class="type">int</span>, quantity <span class="type">int</span>, price <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span>  If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">43</span>_Product (product_id <span class="type">int</span>, product_name <span class="type">varchar</span>(<span class="number">10</span>));</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">43</span>_Sales;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">43</span>_Sales (sale_id, product_id, <span class="keyword">year</span>, quantity, price) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">100</span>, <span class="number">2008</span>, <span class="number">10</span>, <span class="number">5000</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">43</span>_Sales (sale_id, product_id, <span class="keyword">year</span>, quantity, price) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">100</span>, <span class="number">2009</span>, <span class="number">12</span>, <span class="number">5000</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">43</span>_Sales (sale_id, product_id, <span class="keyword">year</span>, quantity, price) <span class="keyword">values</span> (<span class="number">7</span>, <span class="number">200</span>, <span class="number">2011</span>, <span class="number">15</span>, <span class="number">9000</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">43</span>_Product;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">43</span>_Product (product_id, product_name) <span class="keyword">values</span> (<span class="number">100</span>, <span class="string">&#x27;Nokia&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">43</span>_Product (product_id, product_name) <span class="keyword">values</span> (<span class="number">200</span>, <span class="string">&#x27;Apple&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">43</span>_Product (product_id, product_name) <span class="keyword">values</span> (<span class="number">300</span>, <span class="string">&#x27;Samsung&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">      product_name,</span><br><span class="line">      <span class="keyword">year</span>,</span><br><span class="line">      price</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      <span class="number">43</span>_Sales </span><br><span class="line"><span class="keyword">inner</span> <span class="keyword">join</span> </span><br><span class="line">      <span class="number">43</span>_Product</span><br><span class="line"><span class="keyword">on</span></span><br><span class="line">      <span class="number">43</span>_Sales.product_id <span class="operator">=</span> <span class="number">43</span>_Product.product_id;</span><br></pre></td></tr></table></figure>

<p>需求二：按产品 id（product_id ）来统计每个产品的销售总量。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>product_id</th>
<th>total_quantity</th>
</tr>
</thead>
<tbody><tr>
<td>100</td>
<td>22</td>
</tr>
<tr>
<td>200</td>
<td>15</td>
</tr>
</tbody></table>
<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    product_id, </span><br><span class="line">    <span class="built_in">SUM</span>(quantity) <span class="keyword">as</span> total_quantity</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    <span class="number">43</span>_Sales</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">    product_id;</span><br></pre></td></tr></table></figure>

<p>需求三：选出每个销售产品的第一年 的 产品 id、年份、数量 和 价格。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>product_id</th>
<th>first_year</th>
<th>quantity</th>
<th>price</th>
</tr>
</thead>
<tbody><tr>
<td>100</td>
<td>2008</td>
<td>10</td>
<td>5000</td>
</tr>
<tr>
<td>200</td>
<td>2011</td>
<td>15</td>
<td>9000</td>
</tr>
</tbody></table>
<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">      product_id,</span><br><span class="line">      <span class="keyword">year</span> <span class="keyword">as</span> first_year, </span><br><span class="line">      quantity,</span><br><span class="line">      price</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      <span class="number">43</span>_Sales</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">     (product_id , <span class="keyword">year</span>) <span class="keyword">in</span>(</span><br><span class="line">                            <span class="keyword">select</span></span><br><span class="line">                                  product_id ,</span><br><span class="line">                                  <span class="built_in">min</span>(<span class="keyword">year</span>)</span><br><span class="line">                            <span class="keyword">from</span></span><br><span class="line">                                  <span class="number">43</span>_Sales</span><br><span class="line">                            <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">                                  product_id</span><br><span class="line">                            );</span><br></pre></td></tr></table></figure>

<h2 id="44-项目员工"><a href="#44-项目员工" class="headerlink" title="44. 项目员工"></a>44. 项目员工</h2><p>需求一：查询每一个项目中员工的平均工作年限，精确到小数点后两位。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>project_id</th>
<th>average_years</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>2.00</td>
</tr>
<tr>
<td>2</td>
<td>2.50</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">44</span>_Project (project_id <span class="type">int</span>, employee_id <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">44</span>_Employee (employee_id <span class="type">int</span>, name <span class="type">varchar</span>(<span class="number">10</span>), experience_years <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">44</span>_Project;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">44</span>_Project (project_id, employee_id) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">44</span>_Project (project_id, employee_id) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">44</span>_Project (project_id, employee_id) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">44</span>_Project (project_id, employee_id) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">44</span>_Project (project_id, employee_id) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">4</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">44</span>_Employee;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">44</span>_Employee (employee_id, name, experience_years) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;Khaled&#x27;</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">44</span>_Employee (employee_id, name, experience_years) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;Ali&#x27;</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">44</span>_Employee (employee_id, name, experience_years) <span class="keyword">values</span> (<span class="number">3</span>, <span class="string">&#x27;John&#x27;</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">44</span>_Employee (employee_id, name, experience_years) <span class="keyword">values</span> (<span class="number">4</span>, <span class="string">&#x27;Doe&#x27;</span>, <span class="number">2</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">      project_id ,</span><br><span class="line">      round(<span class="built_in">avg</span>(experience_years),<span class="number">2</span>) <span class="keyword">as</span> average_years</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      <span class="number">44</span>_Project p</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">      <span class="number">44</span>_Employee e</span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">      p.employee_id <span class="operator">=</span> e.employee_id</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">      project_id</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">      project_id;</span><br></pre></td></tr></table></figure>

<p>需求二：报告所有雇员最多的项目。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>project_id</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
</tr>
</tbody></table>
<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">      project_id</span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">      <span class="number">44</span>_Project</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> </span><br><span class="line">      project_id</span><br><span class="line"><span class="keyword">HAVING</span> </span><br><span class="line">      <span class="built_in">COUNT</span>(employee_id) <span class="operator">=</span> (<span class="keyword">SELECT</span></span><br><span class="line">                                  <span class="built_in">MAX</span>(count_employee_id)</span><br><span class="line">                            <span class="keyword">FROM</span></span><br><span class="line">                                (<span class="keyword">SELECT</span> </span><br><span class="line">                                       project_id,</span><br><span class="line">                                       <span class="built_in">COUNT</span>(employee_id) <span class="keyword">AS</span> count_employee_id</span><br><span class="line">                                 <span class="keyword">FROM</span></span><br><span class="line">                                       <span class="number">44</span>_Project</span><br><span class="line">                                 <span class="keyword">GROUP</span> <span class="keyword">BY</span> </span><br><span class="line">                                       project_id</span><br><span class="line">                                ) <span class="keyword">As</span> temp</span><br><span class="line">                           );</span><br></pre></td></tr></table></figure>

<p>需求三：报告在每一个项目中经验最丰富的雇员是谁。如果出现经验年数相同的情况，请报告所有具有最大经验年数的员工。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>project_id</th>
<th>employee_id</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td>2</td>
<td>1</td>
</tr>
</tbody></table>
<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">      p.project_id,</span><br><span class="line">      p.employee_id</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      <span class="number">44</span>_Project p</span><br><span class="line"><span class="keyword">join</span> </span><br><span class="line">      <span class="number">44</span>_Employee e</span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">      p.employee_id <span class="operator">=</span> e.employee_id</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">     (p.project_id, e.experience_years) <span class="keyword">in</span> (<span class="keyword">select</span></span><br><span class="line">                                                  p.project_id,</span><br><span class="line">                                                  <span class="built_in">max</span>(e.experience_years)</span><br><span class="line">                                            <span class="keyword">from</span></span><br><span class="line">                                                  <span class="number">44</span>_project p </span><br><span class="line">                                            <span class="keyword">join</span></span><br><span class="line">                                                  <span class="number">44</span>_employee e</span><br><span class="line">                                            <span class="keyword">on</span> </span><br><span class="line">                                                  p.employee_id <span class="operator">=</span> e.employee_id</span><br><span class="line">                                            <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">                                                  p.project_id</span><br><span class="line">                                           );</span><br></pre></td></tr></table></figure>

<h2 id="45-销售分析"><a href="#45-销售分析" class="headerlink" title="45. 销售分析"></a>45. 销售分析</h2><p>需求一：编写一个 SQL 查询，查询总销售额最高的销售者，如果有并列的，就都展示出来。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>seller_id</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
</tr>
<tr>
<td>3</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">45</span>_Product (product_id <span class="type">int</span>, product_name <span class="type">varchar</span>(<span class="number">10</span>), unit_price <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">45</span>_Sales (seller_id <span class="type">int</span>, product_id <span class="type">int</span>,buyer_id <span class="type">int</span>, sale_date <span class="type">date</span>, quantity <span class="type">int</span>, price <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">45</span>_Product;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">45</span>_Product (product_id, product_name, unit_price) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;S8&#x27;</span>, <span class="number">1000</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">45</span>_Product (product_id, product_name, unit_price) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;G4&#x27;</span>, <span class="number">800</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">45</span>_Product (product_id, product_name, unit_price) <span class="keyword">values</span> (<span class="number">3</span>, <span class="string">&#x27;iPhone&#x27;</span>, <span class="number">1400</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">45</span>_Sales;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">45</span>_Sales (seller_id, product_id, buyer_id, sale_date, quantity, price) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>,<span class="string">&#x27;2019-01-21&#x27;</span>, <span class="number">2</span>, <span class="number">2000</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">45</span>_Sales (seller_id, product_id, buyer_id, sale_date, quantity, price) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>,<span class="string">&#x27;2019-02-17&#x27;</span>, <span class="number">1</span>, <span class="number">800</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">45</span>_Sales (seller_id, product_id, buyer_id, sale_date, quantity, price) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">1</span>, <span class="number">3</span>,<span class="string">&#x27;2019-06-02&#x27;</span>, <span class="number">1</span>, <span class="number">800</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">45</span>_Sales (seller_id, product_id, buyer_id, sale_date, quantity, price) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>,<span class="string">&#x27;2019-05-13&#x27;</span>, <span class="number">2</span>, <span class="number">2800</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">      seller_id </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      <span class="number">45</span>_Sales</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">      seller_id</span><br><span class="line"><span class="keyword">having</span> </span><br><span class="line">      <span class="built_in">sum</span>(price) <span class="operator">=</span> (<span class="keyword">select</span></span><br><span class="line">                          <span class="built_in">sum</span>(price) <span class="keyword">as</span> ye_ji</span><br><span class="line">                    <span class="keyword">from</span>  </span><br><span class="line">                          <span class="number">45</span>_Sales</span><br><span class="line">                    <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">                          seller_id</span><br><span class="line">                    <span class="keyword">order</span> <span class="keyword">by</span> </span><br><span class="line">                          ye_ji <span class="keyword">desc</span></span><br><span class="line">                    limit <span class="number">1</span></span><br><span class="line">                   );</span><br></pre></td></tr></table></figure>

<p>需求二：编写一个 SQL 查询，查询购买了 S8 手机却没有购买 iPhone 的买家。注意这里 S8 和 iPhone 是 Product 表中的产品。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>buyer_id</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
</tr>
</tbody></table>
<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">      <span class="keyword">distinct</span> buyer_id</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      <span class="number">45</span>_product p </span><br><span class="line"><span class="keyword">inner</span> <span class="keyword">join</span> </span><br><span class="line">      <span class="number">45</span>_sales s</span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">      p.product_id<span class="operator">=</span>s.product_id</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">      product_name<span class="operator">=</span><span class="string">&#x27;S8&#x27;</span> <span class="keyword">and</span> buyer_id <span class="keyword">not</span> <span class="keyword">in</span> (<span class="keyword">select</span></span><br><span class="line">                                                    buyer_id</span><br><span class="line">                                              <span class="keyword">from</span></span><br><span class="line">                                                    <span class="number">45</span>_product p</span><br><span class="line">                                              <span class="keyword">inner</span> <span class="keyword">join</span></span><br><span class="line">                                                    <span class="number">45</span>_sales s</span><br><span class="line">                                              <span class="keyword">on</span></span><br><span class="line">                                                    p.product_id<span class="operator">=</span>s.product_id</span><br><span class="line">                                              <span class="keyword">where</span></span><br><span class="line">                                                    product_name<span class="operator">=</span><span class="string">&#x27;iPhone&#x27;</span></span><br><span class="line">                                              );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法二</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">      s8 <span class="keyword">as</span> buyer_id</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      (<span class="keyword">select</span> </span><br><span class="line">             <span class="keyword">distinct</span> buyer_id s8</span><br><span class="line">       <span class="keyword">from</span></span><br><span class="line">             <span class="number">45</span>_product p </span><br><span class="line">       <span class="keyword">inner</span> <span class="keyword">join</span> </span><br><span class="line">             <span class="number">45</span>_sales s</span><br><span class="line">       <span class="keyword">on</span></span><br><span class="line">             p.product_id<span class="operator">=</span>s.product_id</span><br><span class="line">       <span class="keyword">where</span></span><br><span class="line">             product_name<span class="operator">=</span><span class="string">&#x27;S8&#x27;</span>) t1</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">      (<span class="keyword">select</span></span><br><span class="line">             <span class="keyword">distinct</span> buyer_id ip</span><br><span class="line">       <span class="keyword">from</span></span><br><span class="line">             <span class="number">45</span>_product p</span><br><span class="line">       <span class="keyword">inner</span> <span class="keyword">join</span> </span><br><span class="line">             <span class="number">45</span>_sales s</span><br><span class="line">       <span class="keyword">on</span></span><br><span class="line">             p.product_id<span class="operator">=</span>s.product_id</span><br><span class="line">       <span class="keyword">where</span></span><br><span class="line">             product_name<span class="operator">=</span><span class="string">&#x27;iPhone&#x27;</span></span><br><span class="line">      ) t2</span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">       s8<span class="operator">=</span>ip</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">       ip <span class="keyword">is</span> <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure>

<p>需求三：编写一个 SQL 查询，报告2019年仅在春季才售出的产品。即在2019-01-01至2019-03-31（含）之间。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>product_id</th>
<th>product_name</th>
</tr>
</thead>
<tbody><tr>
<td>2</td>
<td>G4</td>
</tr>
</tbody></table>
<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">	<span class="keyword">DISTINCT</span> s.product_id,</span><br><span class="line">    p.product_name</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    <span class="number">45</span>_Sales <span class="keyword">AS</span> s</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span></span><br><span class="line">    <span class="number">45</span>_Product <span class="keyword">AS</span> p</span><br><span class="line"><span class="keyword">ON</span></span><br><span class="line">    s.product_id <span class="operator">=</span> p.product_id</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">	s.product_id <span class="keyword">NOT</span> <span class="keyword">IN</span>(</span><br><span class="line">		<span class="keyword">SELECT</span></span><br><span class="line">			 <span class="keyword">DISTINCT</span> product_id</span><br><span class="line">		<span class="keyword">FROM</span></span><br><span class="line">		     <span class="number">45</span>_Sales</span><br><span class="line">		<span class="keyword">WHERE</span></span><br><span class="line">			sale_date <span class="keyword">NOT</span> <span class="keyword">BETWEEN</span> <span class="string">&#x27;2019-01-01&#x27;</span> <span class="keyword">AND</span> <span class="string">&#x27;2019-03-31&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h2 id="46-小众书籍"><a href="#46-小众书籍" class="headerlink" title="46. 小众书籍"></a>46. 小众书籍</h2><p>需求：筛选出过去一年中订单总量少于10本的书籍 。注意：不考虑上架（available from）距今不满一个月的书籍。并且假设今天是2019-06-23 。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>book_id</th>
<th>name</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>Kalila And Demna</td>
</tr>
<tr>
<td>2</td>
<td>28 Letters</td>
</tr>
<tr>
<td>5</td>
<td>The Hunger Games</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">46</span>_Books (book_id <span class="type">int</span>, name <span class="type">varchar</span>(<span class="number">50</span>), available_from <span class="type">date</span>);</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">46</span>_Orders (order_id <span class="type">int</span>, book_id <span class="type">int</span>, quantity <span class="type">int</span>, dispatch_date <span class="type">date</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">46</span>_Books;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">46</span>_Books (book_id, name, available_from) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;Kalila And Demna&#x27;</span>, <span class="string">&#x27;2010-01-01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">46</span>_Books (book_id, name, available_from) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;28 Letters&#x27;</span>, <span class="string">&#x27;2012-05-12&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">46</span>_Books (book_id, name, available_from) <span class="keyword">values</span> (<span class="number">3</span>, <span class="string">&#x27;The Hobbit&#x27;</span>, <span class="string">&#x27;2019-06-10&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">46</span>_Books (book_id, name, available_from) <span class="keyword">values</span> (<span class="number">4</span>, <span class="string">&#x27;13 Reasons Why&#x27;</span>, <span class="string">&#x27;2019-06-01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">46</span>_Books (book_id, name, available_from) <span class="keyword">values</span> (<span class="number">5</span>, <span class="string">&#x27;The Hunger Games&#x27;</span>, <span class="string">&#x27;2008-09-21&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">46</span>_Orders;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">46</span>_Orders (order_id, book_id, quantity, dispatch_date) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="string">&#x27;2018-07-26&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">46</span>_Orders (order_id, book_id, quantity, dispatch_date) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="string">&#x27;2018-11-05&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">46</span>_Orders (order_id, book_id, quantity, dispatch_date) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">3</span>, <span class="number">8</span>, <span class="string">&#x27;2019-06-11&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">46</span>_Orders (order_id, book_id, quantity, dispatch_date) <span class="keyword">values</span> (<span class="number">4</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="string">&#x27;2019-06-05&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">46</span>_Orders (order_id, book_id, quantity, dispatch_date) <span class="keyword">values</span> (<span class="number">5</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="string">&#x27;2019-06-20&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">46</span>_Orders (order_id, book_id, quantity, dispatch_date) <span class="keyword">values</span> (<span class="number">6</span>, <span class="number">5</span>, <span class="number">9</span>, <span class="string">&#x27;2009-02-02&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">46</span>_Orders (order_id, book_id, quantity, dispatch_date) <span class="keyword">values</span> (<span class="number">7</span>, <span class="number">5</span>, <span class="number">8</span>, <span class="string">&#x27;2010-04-13&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">      t1.book_id,</span><br><span class="line">      (<span class="keyword">select</span> name <span class="keyword">from</span> <span class="number">46</span>_books t3 <span class="keyword">where</span> t1.book_id <span class="operator">=</span> t3.book_id) <span class="keyword">as</span> name</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      (<span class="keyword">select</span></span><br><span class="line">             <span class="operator">*</span></span><br><span class="line">       <span class="keyword">from</span></span><br><span class="line">             <span class="number">46</span>_books</span><br><span class="line">       <span class="keyword">where</span></span><br><span class="line">             available_from <span class="operator">&lt;</span> date_sub(<span class="string">&#x27;2019-06-23&#x27;</span>,<span class="type">interval</span> <span class="number">1</span> <span class="keyword">Month</span>)</span><br><span class="line">      ) t1 </span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> </span><br><span class="line">      (<span class="keyword">select</span> </span><br><span class="line">             <span class="operator">*</span>,</span><br><span class="line">             <span class="keyword">case</span></span><br><span class="line">                  <span class="keyword">when</span> dispatch_date <span class="keyword">between</span> <span class="string">&#x27;2018-06-23&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2019-06-23&#x27;</span> <span class="keyword">then</span> quantity</span><br><span class="line">                  <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">              <span class="keyword">end</span> num</span><br><span class="line">       <span class="keyword">from</span> <span class="number">46</span>_orders</span><br><span class="line">      )  t2</span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">     t1.book_id<span class="operator">=</span>t2.book_id </span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">     t1.book_id </span><br><span class="line"><span class="keyword">having</span> </span><br><span class="line">     <span class="built_in">sum</span>(if(t2.num <span class="keyword">is</span> <span class="keyword">null</span>,<span class="number">0</span>,t2.num))<span class="operator">&lt;</span><span class="number">10</span>;</span><br></pre></td></tr></table></figure>

<h2 id="47-每日新用户统计"><a href="#47-每日新用户统计" class="headerlink" title="47. 每日新用户统计"></a>47. 每日新用户统计</h2><p>需求一：编写一个 SQL 查询，以查询从今天起最多 90 天内，每个日期内首次登录的用户数。假设今天是 <strong>2019-06-30</strong>.</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>login_date</th>
<th>user_count</th>
</tr>
</thead>
<tbody><tr>
<td>2019-05-01</td>
<td>1</td>
</tr>
<tr>
<td>2019-06-21</td>
<td>2</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">47</span>_Traffic (user_id <span class="type">int</span>, activity ENUM(<span class="string">&#x27;login&#x27;</span>, <span class="string">&#x27;logout&#x27;</span>, <span class="string">&#x27;jobs&#x27;</span>, <span class="string">&#x27;groups&#x27;</span>, <span class="string">&#x27;homepage&#x27;</span>), activity_date <span class="type">date</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">47</span>_Traffic;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">47</span>_Traffic (user_id, activity, activity_date) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;login&#x27;</span>, <span class="string">&#x27;2019-05-01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">47</span>_Traffic (user_id, activity, activity_date) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;homepage&#x27;</span>, <span class="string">&#x27;2019-05-01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">47</span>_Traffic (user_id, activity, activity_date) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;logout&#x27;</span>, <span class="string">&#x27;2019-05-01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">47</span>_Traffic (user_id, activity, activity_date) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;login&#x27;</span>, <span class="string">&#x27;2019-06-21&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">47</span>_Traffic (user_id, activity, activity_date) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;logout&#x27;</span>, <span class="string">&#x27;2019-06-21&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">47</span>_Traffic (user_id, activity, activity_date) <span class="keyword">values</span> (<span class="number">3</span>, <span class="string">&#x27;login&#x27;</span>, <span class="string">&#x27;2019-01-01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">47</span>_Traffic (user_id, activity, activity_date) <span class="keyword">values</span> (<span class="number">3</span>, <span class="string">&#x27;jobs&#x27;</span>, <span class="string">&#x27;2019-01-01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">47</span>_Traffic (user_id, activity, activity_date) <span class="keyword">values</span> (<span class="number">3</span>, <span class="string">&#x27;logout&#x27;</span>, <span class="string">&#x27;2019-01-01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">47</span>_Traffic (user_id, activity, activity_date) <span class="keyword">values</span> (<span class="number">4</span>, <span class="string">&#x27;login&#x27;</span>, <span class="string">&#x27;2019-06-21&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">47</span>_Traffic (user_id, activity, activity_date) <span class="keyword">values</span> (<span class="number">4</span>, <span class="string">&#x27;groups&#x27;</span>, <span class="string">&#x27;2019-06-21&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">47</span>_Traffic (user_id, activity, activity_date) <span class="keyword">values</span> (<span class="number">4</span>, <span class="string">&#x27;logout&#x27;</span>, <span class="string">&#x27;2019-06-21&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">47</span>_Traffic (user_id, activity, activity_date) <span class="keyword">values</span> (<span class="number">5</span>, <span class="string">&#x27;login&#x27;</span>, <span class="string">&#x27;2019-03-01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">47</span>_Traffic (user_id, activity, activity_date) <span class="keyword">values</span> (<span class="number">5</span>, <span class="string">&#x27;logout&#x27;</span>, <span class="string">&#x27;2019-03-01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">47</span>_Traffic (user_id, activity, activity_date) <span class="keyword">values</span> (<span class="number">5</span>, <span class="string">&#x27;login&#x27;</span>, <span class="string">&#x27;2019-06-21&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">47</span>_Traffic (user_id, activity, activity_date) <span class="keyword">values</span> (<span class="number">5</span>, <span class="string">&#x27;logout&#x27;</span>, <span class="string">&#x27;2019-06-21&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    minx <span class="keyword">as</span> login_date,</span><br><span class="line">    <span class="built_in">count</span>(user_id) <span class="keyword">as</span> user_count</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">   (<span class="keyword">select</span> </span><br><span class="line">          user_id,</span><br><span class="line">          <span class="built_in">min</span>(activity_date) <span class="keyword">as</span> minx</span><br><span class="line">    <span class="keyword">from</span> </span><br><span class="line">          <span class="number">47</span>_Traffic</span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">          activity<span class="operator">=</span><span class="string">&#x27;login&#x27;</span></span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">          user_id</span><br><span class="line">    <span class="keyword">having</span> </span><br><span class="line">          datediff(<span class="string">&#x27;2019-06-30&#x27;</span>,minx)<span class="operator">&lt;=</span><span class="number">90</span></span><br><span class="line">    )s</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">    minx;</span><br></pre></td></tr></table></figure>

<h2 id="48-每位学生的最高成绩"><a href="#48-每位学生的最高成绩" class="headerlink" title="48. 每位学生的最高成绩"></a>48. 每位学生的最高成绩</h2><p>需求：查询每位学生获得的最高成绩和它所对应的科目，若科目成绩并列，取 <code>course_id</code> 最小的一门。查询结果需按 <code>student_id</code> 增序进行排序。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>student_id</th>
<th>course_id</th>
<th>grade</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>2</td>
<td>99</td>
</tr>
<tr>
<td>2</td>
<td>2</td>
<td>95</td>
</tr>
<tr>
<td>3</td>
<td>3</td>
<td>82</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">48</span>_Enrollments (student_id <span class="type">int</span>, course_id <span class="type">int</span>, grade <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">48</span>_Enrollments;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">48</span>_Enrollments (student_id, course_id, grade) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">2</span>, <span class="number">95</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">48</span>_Enrollments (student_id, course_id, grade) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">3</span>, <span class="number">95</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">48</span>_Enrollments (student_id, course_id, grade) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="number">90</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">48</span>_Enrollments (student_id, course_id, grade) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">2</span>, <span class="number">99</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">48</span>_Enrollments (student_id, course_id, grade) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">1</span>, <span class="number">80</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">48</span>_Enrollments (student_id, course_id, grade) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">2</span>, <span class="number">75</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">48</span>_Enrollments (student_id, course_id, grade) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">3</span>, <span class="number">82</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">      e1.student_id,</span><br><span class="line">      <span class="built_in">min</span>(e1.course_id) <span class="keyword">as</span> course_id,</span><br><span class="line">      <span class="built_in">max</span>(e1.grade) <span class="keyword">as</span> grade</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      <span class="number">48</span>_Enrollments e1</span><br><span class="line"><span class="keyword">right</span> <span class="keyword">join</span></span><br><span class="line">     (<span class="keyword">select</span></span><br><span class="line">            student_id,</span><br><span class="line">            <span class="built_in">max</span>(grade) <span class="keyword">as</span> max1 </span><br><span class="line">      <span class="keyword">from</span> </span><br><span class="line">            <span class="number">48</span>_Enrollments</span><br><span class="line">      <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">            student_id </span><br><span class="line">     )e2</span><br><span class="line"><span class="keyword">on</span></span><br><span class="line">      e2.student_id<span class="operator">=</span>e1.student_id </span><br><span class="line">      <span class="keyword">and</span></span><br><span class="line">      e2.max1 <span class="operator">=</span> e1.grade</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">      e1.student_id</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> </span><br><span class="line">      e1.student_id;</span><br></pre></td></tr></table></figure>

<h2 id="49-举报记录"><a href="#49-举报记录" class="headerlink" title="49. 举报记录"></a>49. 举报记录</h2><p>需求一： 编写一条SQL，查询昨天不同举报类型的数量，假设今天是 <strong>2019-07-05</strong>。 在action 列标记为<code>report</code> 被认为遭到举报，对应的产生举报原因。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>report_reason</th>
<th>report_count</th>
</tr>
</thead>
<tbody><tr>
<td>spam</td>
<td>1</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">49</span>_Actions (user_id <span class="type">int</span>, post_id <span class="type">int</span>, action_date <span class="type">date</span>, action ENUM(<span class="string">&#x27;view&#x27;</span>, <span class="string">&#x27;like&#x27;</span>, <span class="string">&#x27;reaction&#x27;</span>, <span class="string">&#x27;comment&#x27;</span>, <span class="string">&#x27;report&#x27;</span>, <span class="string">&#x27;share&#x27;</span>), extra <span class="type">varchar</span>(<span class="number">10</span>));</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">49</span>_Actions;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">49</span>_Actions (user_id, post_id, action_date, action, extra) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="string">&#x27;2019-07-01&#x27;</span>, <span class="string">&#x27;view&#x27;</span>, <span class="keyword">null</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">49</span>_Actions (user_id, post_id, action_date, action, extra) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="string">&#x27;2019-07-01&#x27;</span>, <span class="string">&#x27;like&#x27;</span>, <span class="keyword">null</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">49</span>_Actions (user_id, post_id, action_date, action, extra) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="string">&#x27;2019-07-01&#x27;</span>, <span class="string">&#x27;share&#x27;</span>, <span class="keyword">null</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">49</span>_Actions (user_id, post_id, action_date, action, extra) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">4</span>, <span class="string">&#x27;2019-07-04&#x27;</span>, <span class="string">&#x27;view&#x27;</span>, <span class="keyword">null</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">49</span>_Actions (user_id, post_id, action_date, action, extra) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">4</span>, <span class="string">&#x27;2019-07-04&#x27;</span>, <span class="string">&#x27;report&#x27;</span>, <span class="string">&#x27;spam&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">49</span>_Actions (user_id, post_id, action_date, action, extra) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">4</span>, <span class="string">&#x27;2019-07-04&#x27;</span>, <span class="string">&#x27;view&#x27;</span>, <span class="keyword">null</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">49</span>_Actions (user_id, post_id, action_date, action, extra) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">4</span>, <span class="string">&#x27;2019-07-04&#x27;</span>, <span class="string">&#x27;report&#x27;</span>, <span class="string">&#x27;spam&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">49</span>_Actions (user_id, post_id, action_date, action, extra) <span class="keyword">values</span> (<span class="number">4</span>, <span class="number">3</span>, <span class="string">&#x27;2019-07-02&#x27;</span>, <span class="string">&#x27;view&#x27;</span>, <span class="keyword">null</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">49</span>_Actions (user_id, post_id, action_date, action, extra) <span class="keyword">values</span> (<span class="number">4</span>, <span class="number">3</span>, <span class="string">&#x27;2019-07-02&#x27;</span>, <span class="string">&#x27;report&#x27;</span>, <span class="string">&#x27;spam&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">49</span>_Actions (user_id, post_id, action_date, action, extra) <span class="keyword">values</span> (<span class="number">5</span>, <span class="number">2</span>, <span class="string">&#x27;2019-07-03&#x27;</span>, <span class="string">&#x27;view&#x27;</span>, <span class="keyword">null</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">49</span>_Actions (user_id, post_id, action_date, action, extra) <span class="keyword">values</span> (<span class="number">5</span>, <span class="number">2</span>, <span class="string">&#x27;2019-07-03&#x27;</span>, <span class="string">&#x27;report&#x27;</span>, <span class="string">&#x27;racism&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">49</span>_Actions (user_id, post_id, action_date, action, extra) <span class="keyword">values</span> (<span class="number">5</span>, <span class="number">5</span>, <span class="string">&#x27;2019-07-03&#x27;</span>, <span class="string">&#x27;view&#x27;</span>, <span class="keyword">null</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">49</span>_Actions (user_id, post_id, action_date, action, extra) <span class="keyword">values</span> (<span class="number">5</span>, <span class="number">5</span>, <span class="string">&#x27;2019-07-03&#x27;</span>, <span class="string">&#x27;report&#x27;</span>, <span class="string">&#x27;racism&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">      extra report_reason,</span><br><span class="line">      <span class="built_in">count</span>(<span class="keyword">distinct</span> post_id) report_count </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      <span class="number">49</span>_Actions </span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">      datediff(<span class="string">&#x27;2019-07-05&#x27;</span>, action_date) <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">      <span class="keyword">and</span></span><br><span class="line">      extra <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">      <span class="keyword">and</span></span><br><span class="line">      action <span class="operator">=</span> <span class="string">&#x27;report&#x27;</span> </span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">      extra;</span><br></pre></td></tr></table></figure>

<h2 id="50-查询活跃业务"><a href="#50-查询活跃业务" class="headerlink" title="50. 查询活跃业务"></a>50. 查询活跃业务</h2><p>需求：写一段 SQL 来查询所有活跃的业务。如果一个业务的某个事件类型的发生次数大于此事件类型在所有业务中的平均发生次数，并且该业务至少有两个这样的事件类型，那么该业务就可被看做是活跃业务。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>business_id</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
</tr>
</tbody></table>
<p>reviews、 ads 和 page views 的总平均发生次数分别是 (7+3)/2=5, (11+7+6)/3=8, (3+12)/2=7.5。<br>id 为 1 的业务有 7 个 ‘reviews’ 事件（大于 5）和 11 个 ‘ads’ 事件（大于 8），所以它是活跃业务。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">50</span>_Events (business_id <span class="type">int</span>, event_type <span class="type">varchar</span>(<span class="number">10</span>), occurences <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">50</span>_Events;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">50</span>_Events (business_id, event_type, occurences) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;reviews&#x27;</span>, <span class="number">7</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">50</span>_Events (business_id, event_type, occurences) <span class="keyword">values</span> (<span class="number">3</span>, <span class="string">&#x27;reviews&#x27;</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">50</span>_Events (business_id, event_type, occurences) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;ads&#x27;</span>, <span class="number">11</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">50</span>_Events (business_id, event_type, occurences) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;ads&#x27;</span>, <span class="number">7</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">50</span>_Events (business_id, event_type, occurences) <span class="keyword">values</span> (<span class="number">3</span>, <span class="string">&#x27;ads&#x27;</span>, <span class="number">6</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">50</span>_Events (business_id, event_type, occurences) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;page views&#x27;</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">50</span>_Events (business_id, event_type, occurences) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;page views&#x27;</span>, <span class="number">12</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    e2.business_id</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    <span class="number">50</span>_events e2</span><br><span class="line"><span class="keyword">join</span> </span><br><span class="line">   (<span class="keyword">select</span> </span><br><span class="line">          event_type,</span><br><span class="line">          <span class="built_in">avg</span>(occurences) <span class="keyword">as</span> avg_occ</span><br><span class="line">    <span class="keyword">from</span></span><br><span class="line">          <span class="number">50</span>_events</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">		  event_type) e1</span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">    e2.event_type <span class="operator">=</span> e1.event_type </span><br><span class="line">    <span class="keyword">and</span> </span><br><span class="line">    e2.occurences <span class="operator">&gt;</span> e1.avg_occ</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">    e2.business_id</span><br><span class="line"><span class="keyword">having</span> </span><br><span class="line">    <span class="built_in">count</span>(business_id) <span class="operator">&gt;=</span><span class="number">2</span>;</span><br></pre></td></tr></table></figure>

<h2 id="51-用户购买平台"><a href="#51-用户购买平台" class="headerlink" title="51. 用户购买平台"></a>51. 用户购买平台</h2><p>需求一： 写一段 SQL 来查找每天 <strong>仅</strong> 使用手机端用户、<strong>仅</strong> 使用桌面端用户和 <strong>同时</strong> 使用桌面端和手机端的用户人数和总支出金额。 </p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>spend_date</th>
<th>platform</th>
<th>total_amount</th>
<th>total_users</th>
</tr>
</thead>
<tbody><tr>
<td>2019-07-01</td>
<td>desktop</td>
<td>100</td>
<td>1</td>
</tr>
<tr>
<td>2019-07-01</td>
<td>mobile</td>
<td>100</td>
<td>1</td>
</tr>
<tr>
<td>2019-07-01</td>
<td>both</td>
<td>200</td>
<td>1</td>
</tr>
<tr>
<td>2019-07-02</td>
<td>desktop</td>
<td>100</td>
<td>1</td>
</tr>
<tr>
<td>2019-07-02</td>
<td>mobile</td>
<td>100</td>
<td>1</td>
</tr>
<tr>
<td>2019-07-02</td>
<td>both</td>
<td>0</td>
<td>0</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">51</span>_Spending (user_id <span class="type">int</span>, spend_date <span class="type">date</span>, platform ENUM(<span class="string">&#x27;desktop&#x27;</span>, <span class="string">&#x27;mobile&#x27;</span>), amount <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">51</span>_Spending;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">51</span>_Spending (user_id, spend_date, platform, amount) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;2019-07-01&#x27;</span>, <span class="string">&#x27;mobile&#x27;</span>, <span class="number">100</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">51</span>_Spending (user_id, spend_date, platform, amount) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;2019-07-01&#x27;</span>, <span class="string">&#x27;desktop&#x27;</span>, <span class="number">100</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">51</span>_Spending (user_id, spend_date, platform, amount) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;2019-07-01&#x27;</span>, <span class="string">&#x27;mobile&#x27;</span>, <span class="number">100</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">51</span>_Spending (user_id, spend_date, platform, amount) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;2019-07-02&#x27;</span>, <span class="string">&#x27;mobile&#x27;</span>, <span class="number">100</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">51</span>_Spending (user_id, spend_date, platform, amount) <span class="keyword">values</span> (<span class="number">3</span>, <span class="string">&#x27;2019-07-01&#x27;</span>, <span class="string">&#x27;desktop&#x27;</span>, <span class="number">100</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">51</span>_Spending (user_id, spend_date, platform, amount) <span class="keyword">values</span> (<span class="number">3</span>, <span class="string">&#x27;2019-07-02&#x27;</span>, <span class="string">&#x27;desktop&#x27;</span>, <span class="number">100</span>);</span><br></pre></td></tr></table></figure>

<p>在 2019-07-01, 用户1 同时 使用桌面端和手机端购买, 用户2 仅 使用了手机端购买，而用户3 仅 使用了桌面端购买。</p>
<p>在 2019-07-02, 用户2 仅 使用了手机端购买, 用户3 仅 使用了桌面端购买，且没有用户 同时 使用桌面端和手机端购买。</p>
<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">      temp1.spend_date,</span><br><span class="line">      temp1.platform, </span><br><span class="line">      ifnull(temp3.total_amount, <span class="number">0</span>) total_amount, </span><br><span class="line">      ifnull(temp3.total_users,<span class="number">0</span>) total_users</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">     (<span class="keyword">select</span></span><br><span class="line">            <span class="keyword">distinct</span>(spend_date),</span><br><span class="line">            p.platform   </span><br><span class="line">      <span class="keyword">from</span> </span><br><span class="line">            <span class="number">51</span>_Spending,</span><br><span class="line">           (<span class="keyword">select</span></span><br><span class="line">                  <span class="string">&#x27;desktop&#x27;</span> <span class="keyword">as</span> platform <span class="keyword">union</span></span><br><span class="line">            <span class="keyword">select</span> </span><br><span class="line">                  <span class="string">&#x27;mobile&#x27;</span> <span class="keyword">as</span> platform <span class="keyword">union</span></span><br><span class="line">            <span class="keyword">select</span></span><br><span class="line">                  <span class="string">&#x27;both&#x27;</span> <span class="keyword">as</span> platform</span><br><span class="line">           ) <span class="keyword">as</span> p </span><br><span class="line">       ) <span class="keyword">as</span> temp1</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> </span><br><span class="line">      (<span class="keyword">select</span></span><br><span class="line">             spend_date,</span><br><span class="line">             platform,</span><br><span class="line">             <span class="built_in">sum</span>(amount) <span class="keyword">as</span> total_amount,</span><br><span class="line">             <span class="built_in">count</span>(user_id) total_users</span><br><span class="line">       <span class="keyword">from</span></span><br><span class="line">            (<span class="keyword">select</span></span><br><span class="line">                   spend_date,</span><br><span class="line">                   user_id, </span><br><span class="line">                   <span class="keyword">case</span> <span class="built_in">count</span>(<span class="keyword">distinct</span> platform)</span><br><span class="line">                        <span class="keyword">when</span> <span class="number">1</span> <span class="keyword">then</span> platform</span><br><span class="line">                        <span class="keyword">when</span> <span class="number">2</span> <span class="keyword">then</span> <span class="string">&#x27;both&#x27;</span></span><br><span class="line">                   <span class="keyword">end</span> <span class="keyword">as</span>  platform, </span><br><span class="line">                   <span class="built_in">sum</span>(amount) <span class="keyword">as</span> amount</span><br><span class="line">             <span class="keyword">from</span> </span><br><span class="line">                   <span class="number">51</span>_Spending</span><br><span class="line">             <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">                   spend_date,</span><br><span class="line">                   user_id</span><br><span class="line">            ) <span class="keyword">as</span> temp2</span><br><span class="line">      <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">             spend_date,</span><br><span class="line">             platform</span><br><span class="line">      ) <span class="keyword">as</span>  temp3</span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">      temp1.platform <span class="operator">=</span> temp3.platform <span class="keyword">and</span></span><br><span class="line">      temp1.spend_date <span class="operator">=</span> temp3.spend_date;</span><br></pre></td></tr></table></figure>

<h2 id="52-查询近30天活跃用户"><a href="#52-查询近30天活跃用户" class="headerlink" title="52. 查询近30天活跃用户"></a>52. 查询近30天活跃用户</h2><p>需求一：请写SQL查询出截至 <strong>2019-07-27</strong>（包含2019-07-27）<strong>，近</strong> 30天的每日活跃用户数（当天只要有一条活动记录，即为活跃用户）。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>day</th>
<th>active_users</th>
</tr>
</thead>
<tbody><tr>
<td>2019-07-20</td>
<td>2</td>
</tr>
<tr>
<td>2019-07-21</td>
<td>2</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">52</span>_Activity (user_id <span class="type">int</span>, session_id <span class="type">int</span>, activity_date <span class="type">date</span>, activity_type ENUM(<span class="string">&#x27;open_session&#x27;</span>, <span class="string">&#x27;end_session&#x27;</span>, <span class="string">&#x27;scroll_down&#x27;</span>, <span class="string">&#x27;send_message&#x27;</span>));</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">52</span>_Activity;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">52</span>_Activity (user_id, session_id, activity_date, activity_type) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="string">&#x27;2019-07-20&#x27;</span>, <span class="string">&#x27;open_session&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">52</span>_Activity (user_id, session_id, activity_date, activity_type) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="string">&#x27;2019-07-20&#x27;</span>, <span class="string">&#x27;scroll_down&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">52</span>_Activity (user_id, session_id, activity_date, activity_type) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="string">&#x27;2019-07-20&#x27;</span>, <span class="string">&#x27;end_session&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">52</span>_Activity (user_id, session_id, activity_date, activity_type) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">4</span>, <span class="string">&#x27;2019-07-20&#x27;</span>, <span class="string">&#x27;open_session&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">52</span>_Activity (user_id, session_id, activity_date, activity_type) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">4</span>, <span class="string">&#x27;2019-07-21&#x27;</span>, <span class="string">&#x27;send_message&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">52</span>_Activity (user_id, session_id, activity_date, activity_type) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">4</span>, <span class="string">&#x27;2019-07-21&#x27;</span>, <span class="string">&#x27;end_session&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">52</span>_Activity (user_id, session_id, activity_date, activity_type) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">2</span>, <span class="string">&#x27;2019-07-21&#x27;</span>, <span class="string">&#x27;open_session&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">52</span>_Activity (user_id, session_id, activity_date, activity_type) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">2</span>, <span class="string">&#x27;2019-07-21&#x27;</span>, <span class="string">&#x27;send_message&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">52</span>_Activity (user_id, session_id, activity_date, activity_type) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">2</span>, <span class="string">&#x27;2019-07-21&#x27;</span>, <span class="string">&#x27;end_session&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">52</span>_Activity (user_id, session_id, activity_date, activity_type) <span class="keyword">values</span> (<span class="number">4</span>, <span class="number">3</span>, <span class="string">&#x27;2019-06-25&#x27;</span>, <span class="string">&#x27;open_session&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">52</span>_Activity (user_id, session_id, activity_date, activity_type) <span class="keyword">values</span> (<span class="number">4</span>, <span class="number">3</span>, <span class="string">&#x27;2019-06-25&#x27;</span>, <span class="string">&#x27;end_session&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">      t.activity_date <span class="keyword">as</span> <span class="keyword">day</span>,</span><br><span class="line">      <span class="built_in">count</span>(<span class="keyword">distinct</span> t.user_id) <span class="keyword">as</span> active_users</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">     (<span class="keyword">select</span> </span><br><span class="line">            activity_date,</span><br><span class="line">            user_id</span><br><span class="line">      <span class="keyword">from</span></span><br><span class="line">            <span class="number">52</span>_Activity</span><br><span class="line">      <span class="keyword">where</span> </span><br><span class="line">            datediff(<span class="string">&#x27;2019-07-27&#x27;</span>,activity_date) <span class="operator">&lt;</span><span class="number">30</span></span><br><span class="line">            <span class="keyword">and</span></span><br><span class="line">            datediff( <span class="string">&#x27;2019-07-27&#x27;</span>, activity_date) <span class="operator">&gt;=</span><span class="number">0</span></span><br><span class="line">      <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">            user_id,</span><br><span class="line">            activity_date</span><br><span class="line">      <span class="keyword">having</span> </span><br><span class="line">            <span class="built_in">count</span>(activity_type)<span class="operator">&gt;</span><span class="number">0</span></span><br><span class="line">     ) <span class="keyword">as</span> t</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">      t.activity_date;</span><br></pre></td></tr></table></figure>

<p>需求二：编写SQL查询以查找截至2019年7月27日（含）的30天内每个用户的平均会话数，四舍五入到小数点后两位。我们要为用户计算的会话是在该时间段内至少进行了一项活动的会话。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>average_sessions_per_user</th>
</tr>
</thead>
<tbody><tr>
<td>1.00</td>
</tr>
</tbody></table>
<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">      ROUND(IFNULL(<span class="built_in">AVG</span>(count_session_id), <span class="number">0</span>), <span class="number">2</span>) <span class="keyword">AS</span> average_sessions_per_user</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">     (<span class="keyword">SELECT</span></span><br><span class="line">            <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> session_id) <span class="keyword">AS</span> count_session_id</span><br><span class="line">      <span class="keyword">FROM</span></span><br><span class="line">            <span class="number">52</span>_Activity</span><br><span class="line">      <span class="keyword">WHERE</span> </span><br><span class="line">            activity_date <span class="keyword">BETWEEN</span> DATE_SUB(&quot;2019-07-27&quot;, <span class="type">INTERVAL</span> <span class="number">29</span> <span class="keyword">DAY</span>) <span class="keyword">AND</span> &quot;2019-07-27&quot;</span><br><span class="line">      <span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">            user_id</span><br><span class="line">      ) <span class="keyword">AS</span> temp;</span><br></pre></td></tr></table></figure>

<h2 id="53-文章浏览"><a href="#53-文章浏览" class="headerlink" title="53. 文章浏览"></a>53. 文章浏览</h2><p>需求一：找出所有浏览过自己文章的作者，结果按照 id 升序排列。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>id</th>
</tr>
</thead>
<tbody><tr>
<td>4</td>
</tr>
<tr>
<td>7</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">53</span>_Views (article_id <span class="type">int</span>, author_id <span class="type">int</span>, viewer_id <span class="type">int</span>, view_date <span class="type">date</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">53</span>_Views;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">53</span>_Views (article_id, author_id, viewer_id, view_date) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="string">&#x27;2019-08-01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">53</span>_Views (article_id, author_id, viewer_id, view_date) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="string">&#x27;2019-08-01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">53</span>_Views (article_id, author_id, viewer_id, view_date) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">3</span>, <span class="number">6</span>, <span class="string">&#x27;2019-08-02&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">53</span>_Views (article_id, author_id, viewer_id, view_date) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="string">&#x27;2019-08-01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">53</span>_Views (article_id, author_id, viewer_id, view_date) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">7</span>, <span class="number">6</span>, <span class="string">&#x27;2019-08-02&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">53</span>_Views (article_id, author_id, viewer_id, view_date) <span class="keyword">values</span> (<span class="number">4</span>, <span class="number">7</span>, <span class="number">1</span>, <span class="string">&#x27;2019-07-22&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">53</span>_Views (article_id, author_id, viewer_id, view_date) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="string">&#x27;2019-07-21&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">53</span>_Views (article_id, author_id, viewer_id, view_date) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="string">&#x27;2019-07-21&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">      <span class="keyword">distinct</span> viewer_id <span class="keyword">as</span> id</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      <span class="number">53</span>_Views </span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">      viewer_id <span class="operator">=</span> author_id</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> </span><br><span class="line">      viewer_id;</span><br></pre></td></tr></table></figure>

<p>需求二：找出在同一天阅读至少两篇文章的人，结果按照 id 升序排序。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>project_id</th>
</tr>
</thead>
<tbody><tr>
<td>5</td>
</tr>
<tr>
<td>6</td>
</tr>
</tbody></table>
<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">      <span class="keyword">DISTINCT</span> viewer_id <span class="keyword">as</span> id </span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">      <span class="number">53</span>_views</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> </span><br><span class="line">      viewer_id,view_date</span><br><span class="line"><span class="keyword">HAVING</span></span><br><span class="line">      <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> article_id)<span class="operator">&gt;=</span><span class="number">2</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> </span><br><span class="line">      viewer_id;</span><br></pre></td></tr></table></figure>

<h2 id="54-市场分析"><a href="#54-市场分析" class="headerlink" title="54. 市场分析"></a>54. 市场分析</h2><p>需求一： 请写出一条SQL语句以查询每个用户的注册日期和在 <strong>2019</strong> 年作为买家的订单总数。 </p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>buyer_id</th>
<th>join_date</th>
<th>orders_in_2019</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>2018-01-01</td>
<td>1</td>
</tr>
<tr>
<td>2</td>
<td>2018-02-09</td>
<td>2</td>
</tr>
<tr>
<td>3</td>
<td>2018-01-19</td>
<td>0</td>
</tr>
<tr>
<td>4</td>
<td>2018-05-21</td>
<td>0</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">54</span>_Users (user_id <span class="type">int</span>, join_date <span class="type">date</span>, favorite_brand <span class="type">varchar</span>(<span class="number">10</span>));</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> <span class="number">54</span>_Orders (order_id <span class="type">int</span>, order_date <span class="type">date</span>, item_id <span class="type">int</span>, buyer_id <span class="type">int</span>, seller_id <span class="type">int</span>);</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> <span class="number">54</span>_Items (item_id <span class="type">int</span>, item_brand <span class="type">varchar</span>(<span class="number">10</span>));</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">54</span>_Users;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">54</span>_Users (user_id, join_date, favorite_brand) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;2018-01-01&#x27;</span>, <span class="string">&#x27;Lenovo&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">54</span>_Users (user_id, join_date, favorite_brand) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;2018-02-09&#x27;</span>, <span class="string">&#x27;Samsung&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">54</span>_Users (user_id, join_date, favorite_brand) <span class="keyword">values</span> (<span class="number">3</span>, <span class="string">&#x27;2018-01-19&#x27;</span>, <span class="string">&#x27;LG&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">54</span>_Users (user_id, join_date, favorite_brand) <span class="keyword">values</span> (<span class="number">4</span>, <span class="string">&#x27;2018-05-21&#x27;</span>, <span class="string">&#x27;HP&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">54</span>_Orders;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">54</span>_Orders (order_id, order_date, item_id, buyer_id, seller_id) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;2019-08-01&#x27;</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">54</span>_Orders (order_id, order_date, item_id, buyer_id, seller_id) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;2018-08-02&#x27;</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">54</span>_Orders (order_id, order_date, item_id, buyer_id, seller_id) <span class="keyword">values</span> (<span class="number">3</span>, <span class="string">&#x27;2019-08-03&#x27;</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">54</span>_Orders (order_id, order_date, item_id, buyer_id, seller_id) <span class="keyword">values</span> (<span class="number">4</span>, <span class="string">&#x27;2018-08-04&#x27;</span>, <span class="number">1</span>, <span class="number">4</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">54</span>_Orders (order_id, order_date, item_id, buyer_id, seller_id) <span class="keyword">values</span> (<span class="number">5</span>, <span class="string">&#x27;2018-08-04&#x27;</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">4</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">54</span>_Orders (order_id, order_date, item_id, buyer_id, seller_id) <span class="keyword">values</span> (<span class="number">6</span>, <span class="string">&#x27;2019-08-05&#x27;</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">4</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">54</span>_Items;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">54</span>_Items (item_id, item_brand) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;Samsung&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">54</span>_Items (item_id, item_brand) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;Lenovo&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">54</span>_Items (item_id, item_brand) <span class="keyword">values</span> (<span class="number">3</span>, <span class="string">&#x27;LG&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">54</span>_Items (item_id, item_brand) <span class="keyword">values</span> (<span class="number">4</span>, <span class="string">&#x27;HP&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">       user_id <span class="keyword">AS</span> buyer_id,</span><br><span class="line">       join_date,</span><br><span class="line">       IFNULL(<span class="built_in">COUNT</span>(buyer_Id), <span class="number">0</span>) <span class="keyword">AS</span> orders_in_2019</span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">       <span class="number">54</span>_Users u </span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span></span><br><span class="line">       <span class="number">54</span>_Orders o</span><br><span class="line"><span class="keyword">ON</span>  </span><br><span class="line">       U.user_id <span class="operator">=</span> o.buyer_id </span><br><span class="line">       <span class="keyword">AND</span></span><br><span class="line">       order_date <span class="operator">&gt;=</span> <span class="string">&#x27;2019-01-01&#x27;</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">       user_id</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">       user_id;</span><br></pre></td></tr></table></figure>

<p>需求二： 写一个 SQL 查询确定每一个用户按日期顺序卖出的第二件商品的品牌是否是他们最喜爱的品牌。如果一个用户卖出少于两件商品，查询的结果是 <code>no</code> 。 </p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>seller_id</th>
<th>2nd_item_fav_brand</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>no</td>
</tr>
<tr>
<td>2</td>
<td>no</td>
</tr>
<tr>
<td>3</td>
<td>yes</td>
</tr>
<tr>
<td>4</td>
<td>no</td>
</tr>
</tbody></table>
<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">      user_id <span class="keyword">as</span> seller_id,</span><br><span class="line">      if (r2.item_brand <span class="keyword">is</span> <span class="keyword">null</span> <span class="operator">||</span> r2.item_brand <span class="operator">!=</span> favorite_brand, &quot;no&quot;, &quot;yes&quot;) <span class="keyword">as</span> <span class="number">2</span>nd_item_fav_brand</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      <span class="number">54</span>_users</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> </span><br><span class="line">     (<span class="keyword">select</span></span><br><span class="line">            r1.seller_id,</span><br><span class="line">            i.item_brand </span><br><span class="line">      <span class="keyword">from</span></span><br><span class="line">           (<span class="keyword">select</span> </span><br><span class="line">                  <span class="variable">@rk</span> :<span class="operator">=</span> if (<span class="variable">@seller</span> <span class="operator">=</span> a.seller_id, <span class="variable">@rk</span> <span class="operator">+</span> <span class="number">1</span>, <span class="number">1</span>) <span class="keyword">as</span> `rank`,</span><br><span class="line">                  <span class="variable">@seller</span> :<span class="operator">=</span> a.seller_id <span class="keyword">as</span> seller_id, </span><br><span class="line">                  a.item_id</span><br><span class="line">            <span class="keyword">from</span> </span><br><span class="line">                 (<span class="keyword">select</span> </span><br><span class="line">                       seller_id,</span><br><span class="line">                       item_id</span><br><span class="line">                  <span class="keyword">from</span> </span><br><span class="line">                       <span class="number">54</span>_orders </span><br><span class="line">                  <span class="keyword">order</span> <span class="keyword">by</span> </span><br><span class="line">                       seller_id, order_date) a,</span><br><span class="line">                 (<span class="keyword">select</span> <span class="variable">@seller</span> :<span class="operator">=</span> <span class="number">-1</span>, <span class="variable">@rk</span> :<span class="operator">=</span> <span class="number">0</span>) b</span><br><span class="line">            ) r1</span><br><span class="line">     <span class="keyword">join</span> </span><br><span class="line">          <span class="number">54</span>_items i</span><br><span class="line">     <span class="keyword">on</span></span><br><span class="line">          r1.item_id <span class="operator">=</span> i.item_id</span><br><span class="line">     <span class="keyword">where</span></span><br><span class="line">          r1.`rank` <span class="operator">=</span> <span class="number">2</span>) r2 </span><br><span class="line"><span class="keyword">on</span></span><br><span class="line">     user_id <span class="operator">=</span> r2.seller_id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法二：</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">     user_id seller_id,</span><br><span class="line">     if(favorite_brand <span class="operator">=</span> item_brand, <span class="string">&#x27;yes&#x27;</span>, <span class="string">&#x27;no&#x27;</span>) <span class="number">2</span>nd_item_fav_brand</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">     <span class="number">54</span>_users</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">    (<span class="keyword">select</span></span><br><span class="line">          o1.seller_id,</span><br><span class="line">          item_brand</span><br><span class="line">     <span class="keyword">from</span></span><br><span class="line">          <span class="number">54</span>_orders o1 </span><br><span class="line">     <span class="keyword">join</span></span><br><span class="line">          <span class="number">54</span>_orders o2</span><br><span class="line">     <span class="keyword">on</span></span><br><span class="line">          o1.seller_id <span class="operator">=</span> o2.seller_id</span><br><span class="line">     <span class="keyword">join</span></span><br><span class="line">          <span class="number">54</span>_items i</span><br><span class="line">     <span class="keyword">on</span></span><br><span class="line">          o1.item_id <span class="operator">=</span> i.item_id</span><br><span class="line">     <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">          o1.order_id</span><br><span class="line">     <span class="keyword">having</span> </span><br><span class="line">          <span class="built_in">sum</span>(o1.order_date <span class="operator">&gt;</span> o2.order_date) <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">     ) tmp</span><br><span class="line"><span class="keyword">on</span> user_id <span class="operator">=</span> seller_id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法三：</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">     u.seller_id,</span><br><span class="line">     if(favorite_brand <span class="operator">=</span> item_brand, <span class="string">&#x27;yes&#x27;</span>, <span class="string">&#x27;no&#x27;</span>) <span class="keyword">as</span>  <span class="number">2</span>nd_item_fav_brand                          </span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    (<span class="keyword">select</span> user_id <span class="keyword">as</span> seller_id <span class="keyword">from</span> <span class="number">54</span>_Users) u</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">    (<span class="keyword">select</span> </span><br><span class="line">           <span class="operator">*</span> </span><br><span class="line">     <span class="keyword">from</span></span><br><span class="line">          (<span class="keyword">select</span></span><br><span class="line">                o.order_date,</span><br><span class="line">                o.seller_id,</span><br><span class="line">                i.item_brand,</span><br><span class="line">                u.favorite_brand,</span><br><span class="line">                <span class="built_in">rank</span>() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> o.seller_id <span class="keyword">order</span> <span class="keyword">by</span> o.order_date) rnk</span><br><span class="line">           <span class="keyword">from</span> </span><br><span class="line">                <span class="number">54</span>_Orders o </span><br><span class="line">           <span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">                <span class="number">54</span>_Users u</span><br><span class="line">           <span class="keyword">on</span> </span><br><span class="line">                o.seller_id <span class="operator">=</span> u.user_id</span><br><span class="line">           <span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">                <span class="number">54</span>_Items i</span><br><span class="line">           <span class="keyword">on</span> </span><br><span class="line">                o.item_id <span class="operator">=</span> i.item_id</span><br><span class="line">           ) t1</span><br><span class="line">     <span class="keyword">where</span> rnk <span class="operator">=</span> <span class="number">2</span></span><br><span class="line">     ) t2</span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">     u.seller_id <span class="operator">=</span> t2.seller_id</span><br></pre></td></tr></table></figure>

<h2 id="55-指定日期产品价格"><a href="#55-指定日期产品价格" class="headerlink" title="55. 指定日期产品价格"></a>55. 指定日期产品价格</h2><p>需求一： 写一段 SQL来查找在 <strong>2019-08-16</strong> 时全部产品的价格，假设所有产品在修改前的价格都是 <strong>10。</strong> </p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>project_id</th>
<th>price</th>
</tr>
</thead>
<tbody><tr>
<td>2</td>
<td>50</td>
</tr>
<tr>
<td>1</td>
<td>35</td>
</tr>
<tr>
<td>3</td>
<td>10</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">55</span>_Products (product_id <span class="type">int</span>, new_price <span class="type">int</span>, change_date <span class="type">date</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">55</span>_Products;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">55</span>_Products (product_id, new_price, change_date) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">20</span>, <span class="string">&#x27;2019-08-14&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">55</span>_Products (product_id, new_price, change_date) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">50</span>, <span class="string">&#x27;2019-08-14&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">55</span>_Products (product_id, new_price, change_date) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">30</span>, <span class="string">&#x27;2019-08-15&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">55</span>_Products (product_id, new_price, change_date) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">35</span>, <span class="string">&#x27;2019-08-16&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">55</span>_Products (product_id, new_price, change_date) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">65</span>, <span class="string">&#x27;2019-08-17&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">55</span>_Products (product_id, new_price, change_date) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">20</span>, <span class="string">&#x27;2019-08-18&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="operator">*</span> </span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">    (<span class="keyword">SELECT</span> </span><br><span class="line">           product_id,</span><br><span class="line">           new_price <span class="keyword">AS</span> price</span><br><span class="line">     <span class="keyword">FROM</span> </span><br><span class="line">           <span class="number">55</span>_Products</span><br><span class="line">     <span class="keyword">WHERE</span> (product_id, change_date) <span class="keyword">IN</span> (</span><br><span class="line">                                          <span class="keyword">SELECT</span></span><br><span class="line">                                                product_id,</span><br><span class="line">                                                <span class="built_in">MAX</span>(change_date)</span><br><span class="line">                                          <span class="keyword">FROM</span> </span><br><span class="line">                                                <span class="number">55</span>_Products</span><br><span class="line">                                          <span class="keyword">WHERE</span> </span><br><span class="line">                                                change_date <span class="operator">&lt;=</span> <span class="string">&#x27;2019-08-16&#x27;</span></span><br><span class="line">                                          <span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">                                                product_id</span><br><span class="line">                                         )</span><br><span class="line">     <span class="keyword">UNION</span></span><br><span class="line">     <span class="keyword">SELECT</span></span><br><span class="line">            <span class="keyword">DISTINCT</span> product_id, <span class="number">10</span> <span class="keyword">AS</span> price</span><br><span class="line">     <span class="keyword">FROM</span> </span><br><span class="line">            <span class="number">55</span>_Products</span><br><span class="line">     <span class="keyword">WHERE</span> </span><br><span class="line">            product_id <span class="keyword">NOT</span> <span class="keyword">IN</span> (<span class="keyword">SELECT</span></span><br><span class="line">                                     product_id</span><br><span class="line">                               <span class="keyword">FROM</span>  </span><br><span class="line">                                     <span class="number">55</span>_Products</span><br><span class="line">                               <span class="keyword">WHERE</span> change_date <span class="operator">&lt;=</span> <span class="string">&#x27;2019-08-16&#x27;</span></span><br><span class="line">                              )</span><br><span class="line">     ) tmp</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> </span><br><span class="line">     price <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<h2 id="56-即时食物配送"><a href="#56-即时食物配送" class="headerlink" title="56. 即时食物配送"></a>56. 即时食物配送</h2><p>需求一：查询语句获取即时订单所占的百分比， <strong>保留两位小数。</strong></p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>immediate_percentage</th>
</tr>
</thead>
<tbody><tr>
<td>42.86</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">56</span>_Delivery (delivery_id <span class="type">int</span>, customer_id <span class="type">int</span>, order_date <span class="type">date</span>, customer_pref_delivery_date <span class="type">date</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">56</span>_Delivery;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">56</span>_Delivery (delivery_id, customer_id, order_date, customer_pref_delivery_date) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="string">&#x27;2019-08-01&#x27;</span>, <span class="string">&#x27;2019-08-02&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">56</span>_Delivery (delivery_id, customer_id, order_date, customer_pref_delivery_date) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">5</span>, <span class="string">&#x27;2019-08-02&#x27;</span>, <span class="string">&#x27;2019-08-02&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">56</span>_Delivery (delivery_id, customer_id, order_date, customer_pref_delivery_date) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">1</span>, <span class="string">&#x27;2019-08-11&#x27;</span>, <span class="string">&#x27;2019-08-11&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">56</span>_Delivery (delivery_id, customer_id, order_date, customer_pref_delivery_date) <span class="keyword">values</span> (<span class="number">4</span>, <span class="number">3</span>, <span class="string">&#x27;2019-08-24&#x27;</span>, <span class="string">&#x27;2019-08-26&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">56</span>_Delivery (delivery_id, customer_id, order_date, customer_pref_delivery_date) <span class="keyword">values</span> (<span class="number">5</span>, <span class="number">4</span>, <span class="string">&#x27;2019-08-21&#x27;</span>, <span class="string">&#x27;2019-08-22&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">56</span>_Delivery (delivery_id, customer_id, order_date, customer_pref_delivery_date) <span class="keyword">values</span> (<span class="number">6</span>, <span class="number">2</span>, <span class="string">&#x27;2019-08-11&#x27;</span>, <span class="string">&#x27;2019-08-13&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">56</span>_Delivery (delivery_id, customer_id, order_date, customer_pref_delivery_date) <span class="keyword">values</span> (<span class="number">7</span>, <span class="number">4</span>, <span class="string">&#x27;2019-08-09&#x27;</span>, <span class="string">&#x27;2019-08-09&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> ROUND(</span><br><span class="line">    (<span class="keyword">SELECT</span></span><br><span class="line">           <span class="built_in">COUNT</span>(delivery_id)</span><br><span class="line">    <span class="keyword">FROM</span> </span><br><span class="line">           <span class="number">56</span>_Delivery</span><br><span class="line">    <span class="keyword">WHERE</span> </span><br><span class="line">           order_date <span class="operator">=</span> customer_pref_delivery_date</span><br><span class="line">    ) <span class="operator">*</span> <span class="number">100</span> <span class="operator">/</span> <span class="built_in">COUNT</span>(delivery_id) , <span class="number">2</span>) <span class="keyword">AS</span> immediate_percentage</span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">    <span class="number">56</span>_Delivery;</span><br></pre></td></tr></table></figure>

<p>需求二：查询语句获取即时订单在所有用户的首次订单中的比例。<strong>保留两位小数。</strong></p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>immediate_percentage</th>
</tr>
</thead>
<tbody><tr>
<td>40.00</td>
</tr>
</tbody></table>
<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">      round(</span><br><span class="line">               <span class="built_in">count</span>(<span class="keyword">case</span> <span class="keyword">when</span> d.order_date <span class="operator">=</span> d.customer_pref_delivery_date <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">end</span>)</span><br><span class="line">               <span class="operator">*</span> </span><br><span class="line">               <span class="number">100</span><span class="operator">/</span><span class="built_in">count</span>(<span class="operator">*</span>), <span class="number">2</span>) <span class="keyword">as</span> immediate_percentage</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">     <span class="number">56</span>_Delivery d,</span><br><span class="line">    (<span class="keyword">select</span></span><br><span class="line">           delivery_id,</span><br><span class="line">           customer_id,</span><br><span class="line">           <span class="built_in">min</span>(order_date) <span class="keyword">as</span> order_date</span><br><span class="line">     <span class="keyword">from</span></span><br><span class="line">           <span class="number">56</span>_Delivery</span><br><span class="line">     <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">           customer_id</span><br><span class="line">    ) <span class="keyword">as</span> t</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">     d.customer_id <span class="operator">=</span> t.customer_id</span><br><span class="line">     <span class="keyword">and</span> d.order_date <span class="operator">=</span> t.order_date;</span><br></pre></td></tr></table></figure>

<h2 id="57-重新格式化部门表"><a href="#57-重新格式化部门表" class="headerlink" title="57. 重新格式化部门表"></a>57. 重新格式化部门表</h2><p>需求一：编写一个 SQL 查询来重新格式化表，使得新的表中有一个部门 id 列和一些对应 每个月 的收入（revenue）列。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>Jan_Revenue</th>
<th>Feb_Revenue</th>
<th>Mar_Revenue</th>
<th>…</th>
<th>Dec_Revenue</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>8000</td>
<td>7000</td>
<td>6000</td>
<td>…</td>
<td>null</td>
</tr>
<tr>
<td>2</td>
<td>9000</td>
<td>null</td>
<td>null</td>
<td>…</td>
<td>null</td>
</tr>
<tr>
<td>3</td>
<td>null</td>
<td>10000</td>
<td>null</td>
<td>…</td>
<td>null</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">57</span>_Department (id <span class="type">int</span>, revenue <span class="type">int</span>, <span class="keyword">month</span> <span class="type">varchar</span>(<span class="number">5</span>));</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">57</span>_Department;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">57</span>_Department (id, revenue, <span class="keyword">month</span>) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">8000</span>, <span class="string">&#x27;Jan&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">57</span>_Department (id, revenue, <span class="keyword">month</span>) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">9000</span>, <span class="string">&#x27;Jan&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">57</span>_Department (id, revenue, <span class="keyword">month</span>) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">10000</span>, <span class="string">&#x27;Feb&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">57</span>_Department (id, revenue, <span class="keyword">month</span>) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">7000</span>, <span class="string">&#x27;Feb&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">57</span>_Department (id, revenue, <span class="keyword">month</span>) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">6000</span>, <span class="string">&#x27;Mar&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">      <span class="keyword">DISTINCT</span> id <span class="keyword">AS</span> &quot;id&quot;,</span><br><span class="line">      <span class="built_in">SUM</span>(IF (<span class="keyword">month</span> <span class="operator">=</span> &quot;Jan&quot;, revenue, <span class="keyword">null</span>)) <span class="keyword">AS</span> &quot;Jan_Revenue&quot;,</span><br><span class="line">      <span class="built_in">SUM</span>(IF (<span class="keyword">month</span> <span class="operator">=</span> &quot;Feb&quot;, revenue, <span class="keyword">null</span>)) <span class="keyword">AS</span> &quot;Feb_Revenue&quot;,</span><br><span class="line">      <span class="built_in">SUM</span>(IF (<span class="keyword">month</span> <span class="operator">=</span> &quot;Mar&quot;, revenue, <span class="keyword">null</span>)) <span class="keyword">AS</span> &quot;Mar_Revenue&quot;,</span><br><span class="line">      <span class="built_in">SUM</span>(IF (<span class="keyword">month</span> <span class="operator">=</span> &quot;Apr&quot;, revenue, <span class="keyword">null</span>)) <span class="keyword">AS</span> &quot;Apr_Revenue&quot;,</span><br><span class="line">      <span class="built_in">SUM</span>(IF (<span class="keyword">month</span> <span class="operator">=</span> &quot;May&quot;, revenue, <span class="keyword">null</span>)) <span class="keyword">AS</span> &quot;May_Revenue&quot;,</span><br><span class="line">      <span class="built_in">SUM</span>(IF (<span class="keyword">month</span> <span class="operator">=</span> &quot;Jun&quot;, revenue, <span class="keyword">null</span>)) <span class="keyword">AS</span> &quot;Jun_Revenue&quot;,</span><br><span class="line">      <span class="built_in">SUM</span>(IF (<span class="keyword">month</span> <span class="operator">=</span> &quot;Jul&quot;, revenue, <span class="keyword">null</span>)) <span class="keyword">AS</span> &quot;Jul_Revenue&quot;,</span><br><span class="line">      <span class="built_in">SUM</span>(IF (<span class="keyword">month</span> <span class="operator">=</span> &quot;Aug&quot;, revenue, <span class="keyword">null</span>)) <span class="keyword">AS</span> &quot;Aug_Revenue&quot;,</span><br><span class="line">      <span class="built_in">SUM</span>(IF (<span class="keyword">month</span> <span class="operator">=</span> &quot;Sep&quot;, revenue, <span class="keyword">null</span>)) <span class="keyword">AS</span> &quot;Sep_Revenue&quot;,</span><br><span class="line">      <span class="built_in">SUM</span>(IF (<span class="keyword">month</span> <span class="operator">=</span> &quot;Oct&quot;, revenue, <span class="keyword">null</span>)) <span class="keyword">AS</span> &quot;Oct_Revenue&quot;,</span><br><span class="line">      <span class="built_in">SUM</span>(IF (<span class="keyword">month</span> <span class="operator">=</span> &quot;Nov&quot;, revenue, <span class="keyword">null</span>)) <span class="keyword">AS</span> &quot;Nov_Revenue&quot;,</span><br><span class="line">      <span class="built_in">SUM</span>(IF (<span class="keyword">month</span> <span class="operator">=</span> &quot;Dec&quot;, revenue, <span class="keyword">null</span>)) <span class="keyword">AS</span> &quot;Dec_Revenue&quot; </span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">      <span class="number">57</span>_Department</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> id;</span><br></pre></td></tr></table></figure>

<h2 id="58-每月交易"><a href="#58-每月交易" class="headerlink" title="58. 每月交易"></a>58. 每月交易</h2><p>需求一：查找每个月和每个国家/地区的事务数及其总金额、已批准的事务数及其总金额。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>month</th>
<th>country</th>
<th>trans_count</th>
<th>approved_count</th>
<th>trans_total_amount</th>
<th>approved_total_amount</th>
</tr>
</thead>
<tbody><tr>
<td>2018-12</td>
<td>US</td>
<td>2</td>
<td>1</td>
<td>3000</td>
<td>1000</td>
</tr>
<tr>
<td>2019-01</td>
<td>US</td>
<td>1</td>
<td>1</td>
<td>2000</td>
<td>2000</td>
</tr>
<tr>
<td>2019-01</td>
<td>DE</td>
<td>1</td>
<td>1</td>
<td>2000</td>
<td>2000</td>
</tr>
<tr>
<td>2019-05</td>
<td>US</td>
<td>2</td>
<td>1</td>
<td>3000</td>
<td>1000</td>
</tr>
<tr>
<td>2019-06</td>
<td>US</td>
<td>3</td>
<td>2</td>
<td>12000</td>
<td>8000</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> <span class="number">58</span>_Transactions (id <span class="type">int</span>, country <span class="type">varchar</span>(<span class="number">4</span>), state enum(<span class="string">&#x27;approved&#x27;</span>, <span class="string">&#x27;declined&#x27;</span>), amount <span class="type">int</span>, trans_date <span class="type">date</span>);</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> <span class="number">58</span>_Chargebacks (trans_id <span class="type">int</span>, trans_date <span class="type">date</span>);</span><br><span class="line"><span class="keyword">truncate</span> <span class="keyword">table</span> <span class="number">58</span>_Transactions;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">58</span>_Transactions (id, country, state, amount, trans_date) <span class="keyword">values</span> (<span class="number">101</span>, <span class="string">&#x27;US&#x27;</span>, <span class="string">&#x27;approved&#x27;</span>, <span class="number">1000</span>, <span class="string">&#x27;2018-12-18&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">58</span>_Transactions (id, country, state, amount, trans_date) <span class="keyword">values</span> (<span class="number">102</span>, <span class="string">&#x27;US&#x27;</span>, <span class="string">&#x27;declined&#x27;</span>, <span class="number">2000</span>, <span class="string">&#x27;2018-12-19&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">58</span>_Transactions (id, country, state, amount, trans_date) <span class="keyword">values</span> (<span class="number">103</span>, <span class="string">&#x27;US&#x27;</span>, <span class="string">&#x27;approved&#x27;</span>, <span class="number">2000</span>, <span class="string">&#x27;2019-01-01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">58</span>_Transactions (id, country, state, amount, trans_date) <span class="keyword">values</span> (<span class="number">104</span>, <span class="string">&#x27;DE&#x27;</span>, <span class="string">&#x27;approved&#x27;</span>, <span class="number">2000</span>, <span class="string">&#x27;2019-01-07&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">58</span>_Transactions (id, country, state, amount, trans_date) <span class="keyword">values</span> (<span class="number">105</span>, <span class="string">&#x27;US&#x27;</span>, <span class="string">&#x27;approved&#x27;</span>, <span class="number">1000</span>, <span class="string">&#x27;2019-05-18&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">58</span>_Transactions (id, country, state, amount, trans_date) <span class="keyword">values</span> (<span class="number">106</span>, <span class="string">&#x27;US&#x27;</span>, <span class="string">&#x27;declined&#x27;</span>, <span class="number">2000</span>, <span class="string">&#x27;2019-05-19&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">58</span>_Transactions (id, country, state, amount, trans_date) <span class="keyword">values</span> (<span class="number">107</span>, <span class="string">&#x27;US&#x27;</span>, <span class="string">&#x27;approved&#x27;</span>, <span class="number">3000</span>, <span class="string">&#x27;2019-06-10&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">58</span>_Transactions (id, country, state, amount, trans_date) <span class="keyword">values</span> (<span class="number">108</span>, <span class="string">&#x27;US&#x27;</span>, <span class="string">&#x27;declined&#x27;</span>, <span class="number">4000</span>, <span class="string">&#x27;2019-06-13&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">58</span>_Transactions (id, country, state, amount, trans_date) <span class="keyword">values</span> (<span class="number">109</span>, <span class="string">&#x27;US&#x27;</span>, <span class="string">&#x27;approved&#x27;</span>, <span class="number">5000</span>, <span class="string">&#x27;2019-06-15&#x27;</span>);</span><br><span class="line"><span class="keyword">truncate</span> <span class="keyword">table</span> <span class="number">58</span>_Chargebacks;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">58</span>_Chargebacks (trans_id, trans_date) <span class="keyword">values</span> (<span class="number">102</span>, <span class="string">&#x27;2019-05-29&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">58</span>_Chargebacks (trans_id, trans_date) <span class="keyword">values</span> (<span class="number">101</span>, <span class="string">&#x27;2019-06-30&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">58</span>_Chargebacks (trans_id, trans_date) <span class="keyword">values</span> (<span class="number">105</span>, <span class="string">&#x27;2019-09-18&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">      date_format(trans_date,<span class="string">&#x27;%Y-%m&#x27;</span>) <span class="keyword">as</span> <span class="keyword">month</span>,</span><br><span class="line">      country,</span><br><span class="line">      <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> trans_count,</span><br><span class="line">      <span class="built_in">sum</span>(if(state<span class="operator">=</span><span class="string">&#x27;approved&#x27;</span>,<span class="number">1</span>,<span class="number">0</span>)) <span class="keyword">as</span> approved_count,</span><br><span class="line">      <span class="built_in">sum</span>(amount) <span class="keyword">as</span> trans_total_amount,</span><br><span class="line">      <span class="built_in">sum</span>(if(state<span class="operator">=</span><span class="string">&#x27;approved&#x27;</span>,amount,<span class="number">0</span>)) <span class="keyword">as</span> approved_total_amount</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      <span class="number">58</span>_Transactions t</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">      date_format(trans_date,<span class="string">&#x27;%Y-%m&#x27;</span>),</span><br><span class="line">      country;</span><br></pre></td></tr></table></figure>

<p>需求二：编写一个 SQL 查询，以查找每个月和每个国家/地区的已批准交易的数量及其总金额、退单的数量及其总金额。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>month</th>
<th>country</th>
<th>approved_count</th>
<th>approved_amount</th>
<th>chargeback_count</th>
<th>chargeback_amount</th>
</tr>
</thead>
<tbody><tr>
<td>2018-12</td>
<td>US</td>
<td>1</td>
<td>1000</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>2019-01</td>
<td>DE</td>
<td>1</td>
<td>2000</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>2019-01</td>
<td>US</td>
<td>1</td>
<td>2000</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>2019-05</td>
<td>US</td>
<td>1</td>
<td>1000</td>
<td>1</td>
<td>2000</td>
</tr>
<tr>
<td>2019-06</td>
<td>US</td>
<td>2</td>
<td>8000</td>
<td>1</td>
<td>1000</td>
</tr>
<tr>
<td>2019-09</td>
<td>US</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>1000</td>
</tr>
</tbody></table>
<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">       <span class="keyword">month</span> <span class="keyword">as</span> <span class="keyword">MONTH</span>,</span><br><span class="line">       country <span class="keyword">as</span> COUNTRY,</span><br><span class="line">       <span class="built_in">SUM</span>(IF(type <span class="operator">=</span> <span class="string">&#x27;approved&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) <span class="keyword">AS</span> APPROVED_COUNT,</span><br><span class="line">       <span class="built_in">SUM</span>(IF(type <span class="operator">=</span> <span class="string">&#x27;approved&#x27;</span>, amount, <span class="number">0</span>)) <span class="keyword">AS</span> APPROVED_AMOUNT,</span><br><span class="line">       <span class="built_in">SUM</span>(IF(type <span class="operator">=</span> <span class="string">&#x27;chargeback&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) <span class="keyword">AS</span> CHARGEBACK_COUNT,</span><br><span class="line">       <span class="built_in">SUM</span>(IF(type <span class="operator">=</span> <span class="string">&#x27;chargeback&#x27;</span>, amount, <span class="number">0</span>)) <span class="keyword">AS</span> CHARGEBACK_AMOUNT</span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">      (<span class="keyword">SELECT</span> </span><br><span class="line">              date_format(t.trans_date,<span class="string">&#x27;%Y-%m&#x27;</span>) <span class="keyword">AS</span> <span class="keyword">month</span>,</span><br><span class="line">              t.country,</span><br><span class="line">              amount,</span><br><span class="line">              <span class="string">&#x27;approved&#x27;</span> <span class="keyword">AS</span> type</span><br><span class="line">        <span class="keyword">FROM</span></span><br><span class="line">              <span class="number">58</span>_Transactions <span class="keyword">AS</span> t</span><br><span class="line">        <span class="keyword">WHERE</span> </span><br><span class="line">              state <span class="operator">=</span> <span class="string">&#x27;approved&#x27;</span></span><br><span class="line">        <span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line">        <span class="keyword">SELECT</span></span><br><span class="line">              date_format(c.trans_date,<span class="string">&#x27;%Y-%m&#x27;</span>) <span class="keyword">AS</span> <span class="keyword">month</span>,</span><br><span class="line">              t.country,</span><br><span class="line">              amount,</span><br><span class="line">              <span class="string">&#x27;chargeback&#x27;</span> <span class="keyword">AS</span> type</span><br><span class="line">         <span class="keyword">FROM</span> </span><br><span class="line">              <span class="number">58</span>_Transactions <span class="keyword">AS</span> t</span><br><span class="line">         <span class="keyword">INNER</span> <span class="keyword">JOIN</span></span><br><span class="line">              <span class="number">58</span>_Chargebacks <span class="keyword">AS</span> c </span><br><span class="line">         <span class="keyword">ON</span> t.id <span class="operator">=</span> c.trans_id</span><br><span class="line">         ) <span class="keyword">AS</span> tt</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> </span><br><span class="line">         tt.month,</span><br><span class="line">         tt.country;</span><br></pre></td></tr></table></figure>

<h2 id="59-锦标赛优胜者"><a href="#59-锦标赛优胜者" class="headerlink" title="59. 锦标赛优胜者"></a>59. 锦标赛优胜者</h2><p>需求一：编写一个 SQL 查询来查找每组中的获胜者。每组的获胜者是在组内得分最高的选手。如果平局，player_id 最小的的选手获胜。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>group_id</th>
<th>player_id</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>15</td>
</tr>
<tr>
<td>2</td>
<td>35</td>
</tr>
<tr>
<td>3</td>
<td>40</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">59</span>_Players (player_id <span class="type">int</span>, group_id <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">59</span>_Matches (match_id <span class="type">int</span>, first_player <span class="type">int</span>, second_player <span class="type">int</span>, first_score <span class="type">int</span>, second_score <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">59</span>_Players;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">59</span>_Players (player_id, group_id) <span class="keyword">values</span> (<span class="number">10</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">59</span>_Players (player_id, group_id) <span class="keyword">values</span> (<span class="number">15</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">59</span>_Players (player_id, group_id) <span class="keyword">values</span> (<span class="number">20</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">59</span>_Players (player_id, group_id) <span class="keyword">values</span> (<span class="number">25</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">59</span>_Players (player_id, group_id) <span class="keyword">values</span> (<span class="number">30</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">59</span>_Players (player_id, group_id) <span class="keyword">values</span> (<span class="number">35</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">59</span>_Players (player_id, group_id) <span class="keyword">values</span> (<span class="number">40</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">59</span>_Players (player_id, group_id) <span class="keyword">values</span> (<span class="number">45</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">59</span>_Players (player_id, group_id) <span class="keyword">values</span> (<span class="number">50</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">59</span>_Matches;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">59</span>_Matches (match_id, first_player, second_player, first_score, second_score) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">15</span>, <span class="number">45</span>, <span class="number">3</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">59</span>_Matches (match_id, first_player, second_player, first_score, second_score) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">30</span>, <span class="number">25</span>, <span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">59</span>_Matches (match_id, first_player, second_player, first_score, second_score) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">30</span>, <span class="number">15</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">59</span>_Matches (match_id, first_player, second_player, first_score, second_score) <span class="keyword">values</span> (<span class="number">4</span>, <span class="number">40</span>, <span class="number">20</span>, <span class="number">5</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">59</span>_Matches (match_id, first_player, second_player, first_score, second_score) <span class="keyword">values</span> (<span class="number">5</span>, <span class="number">35</span>, <span class="number">50</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">      group_id,</span><br><span class="line">      <span class="built_in">max</span>(total_scores) max_scores</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    (<span class="keyword">select</span> </span><br><span class="line">           group_id,</span><br><span class="line">           player_id,</span><br><span class="line">           <span class="built_in">sum</span>(</span><br><span class="line">               <span class="keyword">case</span></span><br><span class="line">                   <span class="keyword">when</span> player_id <span class="operator">=</span> first_player <span class="keyword">then</span> first_score</span><br><span class="line">                   <span class="keyword">when</span> player_id <span class="operator">=</span> second_player <span class="keyword">then</span> second_score</span><br><span class="line">               <span class="keyword">end</span></span><br><span class="line">               ) <span class="keyword">as</span> total_scores</span><br><span class="line">     <span class="keyword">from</span> </span><br><span class="line">          <span class="number">59</span>_Players p,</span><br><span class="line">          <span class="number">59</span>_Matches m</span><br><span class="line">     <span class="keyword">where</span></span><br><span class="line">          p.player_id <span class="operator">=</span> m.first_player <span class="keyword">or</span></span><br><span class="line">          p.player_id <span class="operator">=</span> m.second_player</span><br><span class="line">     <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">          group_id,</span><br><span class="line">          player_id</span><br><span class="line">     <span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">          group_id,</span><br><span class="line">          total_scores <span class="keyword">desc</span>,</span><br><span class="line">          player_id</span><br><span class="line">    ) <span class="keyword">as</span> temp</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">     group_id</span><br><span class="line"></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> </span><br><span class="line">     group_id,</span><br><span class="line">     total_scores <span class="keyword">desc</span>,</span><br><span class="line">     player_id;</span><br></pre></td></tr></table></figure>

<h2 id="60-最后一个能进入电梯的人"><a href="#60-最后一个能进入电梯的人" class="headerlink" title="60. 最后一个能进入电梯的人"></a>60. 最后一个能进入电梯的人</h2><p>需求：查找最后一个能进入电梯且不超过重量限制的 <code>person_name</code> 。题目确保队列中第一位的人可以进入电梯 。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>person_name</th>
</tr>
</thead>
<tbody><tr>
<td>Thomas Jefferson</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">60</span>_Queue (person_id <span class="type">int</span>, person_name <span class="type">varchar</span>(<span class="number">30</span>), weight <span class="type">int</span>, turn <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">60</span>_Queue;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">60</span>_Queue (person_id, person_name, weight, turn) <span class="keyword">values</span> (<span class="number">5</span>, <span class="string">&#x27;George Washington&#x27;</span>, <span class="number">250</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">60</span>_Queue (person_id, person_name, weight, turn) <span class="keyword">values</span> (<span class="number">4</span>, <span class="string">&#x27;Thomas Jefferson&#x27;</span>, <span class="number">175</span>, <span class="number">5</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">60</span>_Queue (person_id, person_name, weight, turn) <span class="keyword">values</span> (<span class="number">3</span>, <span class="string">&#x27;John Adams&#x27;</span>, <span class="number">350</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">60</span>_Queue (person_id, person_name, weight, turn) <span class="keyword">values</span> (<span class="number">6</span>, <span class="string">&#x27;Thomas Jefferson&#x27;</span>, <span class="number">400</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">60</span>_Queue (person_id, person_name, weight, turn) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;James Elephant&#x27;</span>, <span class="number">500</span>, <span class="number">6</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">60</span>_Queue (person_id, person_name, weight, turn) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;Will Johnliams&#x27;</span>, <span class="number">200</span>, <span class="number">4</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">      person_name</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      <span class="number">60</span>_Queue q1</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">     (<span class="keyword">select</span></span><br><span class="line">           <span class="built_in">sum</span>(weight)</span><br><span class="line">      <span class="keyword">from</span></span><br><span class="line">           <span class="number">60</span>_Queue q</span><br><span class="line">      <span class="keyword">where</span> turn <span class="operator">&lt;=</span> q1.turn) <span class="operator">&lt;=</span> <span class="number">1000</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> </span><br><span class="line">      turn <span class="keyword">desc</span> </span><br><span class="line">limit <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<h2 id=""><a href="#" class="headerlink" title=""></a></h2>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hf7751.gitee.io/2021/03/11/101-/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="hefei">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="元">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/03/11/101-/" class="post-title-link" itemprop="url">101-最后</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">نُشر في</span>
      

      <time title="أُنشأ: 2021-03-11 02:36:18 / عُدل: 03:43:09" itemprop="dateCreated datePublished" datetime="2021-03-11T02:36:18+08:00">2021-03-11</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="101-患某种疾病的患者"><a href="#101-患某种疾病的患者" class="headerlink" title="101. 患某种疾病的患者"></a>101. 患某种疾病的患者</h2><p>写一条 SQL 语句，查询患有 I 类糖尿病的患者 ID （patient_id）、患者姓名（patient_name）以及其患有的所有疾病代码（conditions）。I 类糖尿病的代码总是包含前缀 DIAB1 。</p>
<p>按任意顺序返回结果表。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+------------+--------------+--------------+</span><br><span class="line">| patient_id | patient_name | conditions   |</span><br><span class="line">+------------+--------------+--------------+</span><br><span class="line">| 3          | Bob          | DIAB100 MYOP |</span><br><span class="line">| 4          | George       | ACNE DIAB100 | </span><br><span class="line">+------------+--------------+--------------+</span><br><span class="line">Bob and George both have a condition that starts with DIAB1.</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">101</span>_Patients (patient_id <span class="type">int</span>, patient_name <span class="type">varchar</span>(<span class="number">30</span>), conditions <span class="type">varchar</span>(<span class="number">100</span>));</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">101</span>_Patients;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">101</span>_Patients (patient_id, patient_name, conditions) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Daniel&#x27;</span>, <span class="string">&#x27;YFEV COUGH&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">101</span>_Patients (patient_id, patient_name, conditions) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;Alice&#x27;</span>, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">101</span>_Patients (patient_id, patient_name, conditions) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;Bob&#x27;</span>, <span class="string">&#x27;DIAB100 MYOP&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">101</span>_Patients (patient_id, patient_name, conditions) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;George&#x27;</span>, <span class="string">&#x27;ACNE DIAB100&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">101</span>_Patients (patient_id, patient_name, conditions) <span class="keyword">values</span> (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;Alain&#x27;</span>, <span class="string">&#x27;DIAB201&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">     patient_id,</span><br><span class="line">     patient_name,</span><br><span class="line">     conditions </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">     Patients</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">     conditions <span class="keyword">like</span> <span class="string">&#x27;%DIAB1%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h2 id="102-最近的三笔订单"><a href="#102-最近的三笔订单" class="headerlink" title="102. 最近的三笔订单"></a>102. 最近的三笔订单</h2><p>写一个 SQL 语句，找到每个用户的最近三笔订单。如果用户的订单少于 3 笔，则返回他的全部订单。</p>
<p>返回的结果按照 customer_name 升序排列。如果排名有相同，则继续按照 customer_id 升序排列。如果排名还有相同，则继续按照 order_date 升序排列。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">+---------------+-------------+----------+------------+</span><br><span class="line">| customer_name | customer_id | order_id | order_date |</span><br><span class="line">+---------------+-------------+----------+------------+</span><br><span class="line">| Annabelle     | 3           | 7        | 2020-08-01 |</span><br><span class="line">| Annabelle     | 3           | 3        | 2020-07-31 |</span><br><span class="line">| Jonathan      | 2           | 9        | 2020-08-07 |</span><br><span class="line">| Jonathan      | 2           | 6        | 2020-08-01 |</span><br><span class="line">| Jonathan      | 2           | 2        | 2020-07-30 |</span><br><span class="line">| Marwan        | 4           | 4        | 2020-07-29 |</span><br><span class="line">| Winston       | 1           | 8        | 2020-08-03 |</span><br><span class="line">| Winston       | 1           | 1        | 2020-07-31 |</span><br><span class="line">| Winston       | 1           | 10       | 2020-07-15 |</span><br><span class="line">+---------------+-------------+----------+------------+</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">102</span>_Customers (customer_id <span class="type">int</span>, name <span class="type">varchar</span>(<span class="number">10</span>));</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">102</span>_Orders (order_id <span class="type">int</span>, order_date <span class="type">date</span>, customer_id <span class="type">int</span>, cost <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">102</span>_Customers;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">102</span>_Customers (customer_id, name) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Winston&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">102</span>_Customers (customer_id, name) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;Jonathan&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">102</span>_Customers (customer_id, name) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;Annabelle&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">102</span>_Customers (customer_id, name) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;Marwan&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">102</span>_Customers (customer_id, name) <span class="keyword">values</span> (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;Khaled&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">102</span>_Orders;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">102</span>_Orders (order_id, order_date, customer_id, cost) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2020-07-31&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;30&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">102</span>_Orders (order_id, order_date, customer_id, cost) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2020-7-30&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;40&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">102</span>_Orders (order_id, order_date, customer_id, cost) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2020-07-31&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;70&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">102</span>_Orders (order_id, order_date, customer_id, cost) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;2020-07-29&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;100&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">102</span>_Orders (order_id, order_date, customer_id, cost) <span class="keyword">values</span> (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;2020-06-10&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;1010&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">102</span>_Orders (order_id, order_date, customer_id, cost) <span class="keyword">values</span> (<span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;2020-08-01&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;102&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">102</span>_Orders (order_id, order_date, customer_id, cost) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;2020-08-01&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;111&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">102</span>_Orders (order_id, order_date, customer_id, cost) <span class="keyword">values</span> (<span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;2020-08-03&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;99&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">102</span>_Orders (order_id, order_date, customer_id, cost) <span class="keyword">values</span> (<span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;2020-08-07&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;32&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">102</span>_Orders (order_id, order_date, customer_id, cost) <span class="keyword">values</span> (<span class="string">&#x27;10&#x27;</span>, <span class="string">&#x27;2020-07-15&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">      C.name <span class="keyword">as</span> customer_name,</span><br><span class="line">      O.customer_id,</span><br><span class="line">      O.order_id,</span><br><span class="line">      O.order_date</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">      <span class="number">102</span>_customers C </span><br><span class="line"><span class="keyword">inner</span> <span class="keyword">join</span></span><br><span class="line">      <span class="number">102</span>_Orders O </span><br><span class="line"><span class="keyword">on</span></span><br><span class="line">      C.customer_id <span class="operator">=</span> O.customer_id</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">     (O.customer_id,O.order_date) <span class="keyword">in</span> (<span class="keyword">select</span></span><br><span class="line">                                            o1.customer_id,</span><br><span class="line">                                            o1.order_date</span><br><span class="line">                                      <span class="keyword">from</span> </span><br><span class="line">                                            <span class="number">102</span>_Orders o1 </span><br><span class="line">                                      <span class="keyword">inner</span> <span class="keyword">join</span></span><br><span class="line">                                            <span class="number">102</span>_Orders o2</span><br><span class="line">                                      <span class="keyword">on</span> </span><br><span class="line">                                            o1.customer_id <span class="operator">=</span> o2.customer_id </span><br><span class="line">                                            <span class="keyword">and</span></span><br><span class="line">                                            o1.order_date <span class="operator">&lt;=</span> o2.order_date</span><br><span class="line">                                      <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">                                            o1.customer_id,o1.order_date</span><br><span class="line">                                      <span class="keyword">having</span></span><br><span class="line">                                            <span class="built_in">count</span>(o2.order_date) <span class="operator">&lt;=</span> <span class="number">3</span>)</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> </span><br><span class="line">      customer_name,</span><br><span class="line">      O.customer_id,</span><br><span class="line">      O.order_date <span class="keyword">desc</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法二</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">     name customer_name, </span><br><span class="line">     customer_id,</span><br><span class="line">     order_id,</span><br><span class="line">     order_date</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    (<span class="keyword">select</span> </span><br><span class="line">          name ,</span><br><span class="line">          o.customer_id,</span><br><span class="line">          order_id,</span><br><span class="line">          order_date ,</span><br><span class="line">          <span class="built_in">rank</span>() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> o.customer_id <span class="keyword">order</span> <span class="keyword">by</span> order_date <span class="keyword">desc</span>) rk</span><br><span class="line">     <span class="keyword">from</span> </span><br><span class="line">          <span class="number">102</span>_Orders o </span><br><span class="line">     <span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">          <span class="number">102</span>_Customers c</span><br><span class="line">     <span class="keyword">on</span></span><br><span class="line">          o.customer_id<span class="operator">=</span>c.customer_id )t1</span><br><span class="line"><span class="keyword">where</span> rk <span class="operator">&lt;=</span><span class="number">3</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> customer_name ,customer_id,order_date <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure>

<h2 id="103-格式化产品名称"><a href="#103-格式化产品名称" class="headerlink" title="103. 格式化产品名称"></a>103. 格式化产品名称</h2><p>写一个 SQL 语句报告：</p>
<p>product_name 是小写字母且不包含前后空格</p>
<p>sale_date 格式为 (‘YYYY-MM’)</p>
<p>total 是产品在本月销售的次数</p>
<p>返回结果以 product_name 升序 排列，如果有排名相同, 再以 sale_date 升序 排列。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">+--------------+--------------+----------+</span><br><span class="line">| product_name | sale_date    | total    |</span><br><span class="line">+--------------+--------------+----------+</span><br><span class="line">| lckeychain   | 2000-02      | 2        |</span><br><span class="line">| lcphone      | 2000-01      | 2        | </span><br><span class="line">| lcphone      | 2000-02      | 1        | </span><br><span class="line">| matryoshka   | 2000-03      | 1        | </span><br><span class="line">+--------------+--------------+----------+</span><br><span class="line"></span><br><span class="line">In January, 2 LcPhones were sold, please note that the product names are not case sensitive and may contain spaces.</span><br><span class="line">In Februery, 2 LCKeychains and 1 LCPhone were sold.</span><br><span class="line">In March, 1 matryoshka was sold.</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">103</span>_Sales (sale_id <span class="type">int</span>, product_name <span class="type">varchar</span>(<span class="number">30</span>), sale_date <span class="type">date</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">103</span>_Sales;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">103</span>_Sales (sale_id, product_name, sale_date) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;LCPHONE&#x27;</span>, <span class="string">&#x27;2000-01-16&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">103</span>_Sales (sale_id, product_name, sale_date) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;LCPhone&#x27;</span>, <span class="string">&#x27;2000-01-17&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">103</span>_Sales (sale_id, product_name, sale_date) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;LcPhOnE&#x27;</span>, <span class="string">&#x27;2000-02-18&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">103</span>_Sales (sale_id, product_name, sale_date) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;LCKeyCHAiN&#x27;</span>, <span class="string">&#x27;2000-02-19&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">103</span>_Sales (sale_id, product_name, sale_date) <span class="keyword">values</span> (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;LCKeyChain&#x27;</span>, <span class="string">&#x27;2000-02-28&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">103</span>_Sales (sale_id, product_name, sale_date) <span class="keyword">values</span> (<span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;Matryoshka&#x27;</span>, <span class="string">&#x27;2000-03-31&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">     <span class="built_in">trim</span>(<span class="built_in">lower</span>(product_name)) <span class="keyword">as</span> product_name, </span><br><span class="line">     date_format(sale_date,<span class="string">&#x27;%Y-%m&#x27;</span>) <span class="keyword">as</span> sale_date,</span><br><span class="line">     <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> total </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">     <span class="number">103</span>_Sales </span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">     <span class="built_in">trim</span>(<span class="built_in">lower</span>(product_name)),</span><br><span class="line">     date_format(sale_date,<span class="string">&#x27;%Y-%m&#x27;</span>) </span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">     product_name <span class="keyword">asc</span>, </span><br><span class="line">     sale_date <span class="keyword">asc</span>;</span><br></pre></td></tr></table></figure>



<h2 id="104-每个商品最近的订单"><a href="#104-每个商品最近的订单" class="headerlink" title="104. 每个商品最近的订单"></a>104. 每个商品最近的订单</h2><p>编写一个SQL查询来查找每个产品的最新订单。返回按product_name升序排序的结果表，如果有并列，则按product_id升序排序。如果仍然存在并列，则按order_id升序对它们排序。</p>
<p>效果展示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">+--------------+------------+----------+------------+</span><br><span class="line">| product_name | product_id | order_id | order_date |</span><br><span class="line">+--------------+------------+----------+------------+</span><br><span class="line">| keyboard     | 1          | 6        | 2020-08-01 |</span><br><span class="line">| keyboard     | 1          | 7        | 2020-08-01 |</span><br><span class="line">| mouse        | 2          | 8        | 2020-08-03 |</span><br><span class="line">| screen       | 3          | 3        | 2020-08-29 |</span><br><span class="line">+--------------+------------+----------+------------+</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>建表语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">104</span>_Customers (customer_id <span class="type">int</span>, name <span class="type">varchar</span>(<span class="number">10</span>));</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">104</span>_Orders (order_id <span class="type">int</span>, order_date <span class="type">date</span>, customer_id <span class="type">int</span>, product_id <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">104</span>_Products (product_id <span class="type">int</span>, product_name <span class="type">varchar</span>(<span class="number">20</span>), price <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">104</span>_Customers;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">104</span>_Customers (customer_id, name) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Winston&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">104</span>_Customers (customer_id, name) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;Jonathan&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">104</span>_Customers (customer_id, name) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;Annabelle&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">104</span>_Customers (customer_id, name) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;Marwan&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">104</span>_Customers (customer_id, name) <span class="keyword">values</span> (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;Khaled&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">104</span>_Orders;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">104</span>_Orders (order_id, order_date, customer_id, product_id) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2020-07-31&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">104</span>_Orders (order_id, order_date, customer_id, product_id) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2020-7-30&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">104</span>_Orders (order_id, order_date, customer_id, product_id) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2020-08-29&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;3&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">104</span>_Orders (order_id, order_date, customer_id, product_id) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;2020-07-29&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">104</span>_Orders (order_id, order_date, customer_id, product_id) <span class="keyword">values</span> (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;2020-06-10&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">104</span>_Orders (order_id, order_date, customer_id, product_id) <span class="keyword">values</span> (<span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;2020-08-01&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">104</span>_Orders (order_id, order_date, customer_id, product_id) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;2020-08-01&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">104</span>_Orders (order_id, order_date, customer_id, product_id) <span class="keyword">values</span> (<span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;2020-08-03&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">104</span>_Orders (order_id, order_date, customer_id, product_id) <span class="keyword">values</span> (<span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;2020-08-07&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;3&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">104</span>_Orders (order_id, order_date, customer_id, product_id) <span class="keyword">values</span> (<span class="string">&#x27;10&#x27;</span>, <span class="string">&#x27;2020-07-15&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">104</span>_Products;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">104</span>_Products (product_id, product_name, price) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;keyboard&#x27;</span>, <span class="string">&#x27;120&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">104</span>_Products (product_id, product_name, price) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;mouse&#x27;</span>, <span class="string">&#x27;80&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">104</span>_Products (product_id, product_name, price) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;screen&#x27;</span>, <span class="string">&#x27;600&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">104</span>_Products (product_id, product_name, price) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;hard disk&#x27;</span>, <span class="string">&#x27;450&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">      p1.product_name,</span><br><span class="line">      o2.product_id,</span><br><span class="line">      o2.order_id,</span><br><span class="line">      o2.order_date</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">      <span class="number">104</span>_Products p1</span><br><span class="line"><span class="keyword">right</span> <span class="keyword">join</span></span><br><span class="line">     (<span class="keyword">select</span></span><br><span class="line">           o2.product_id,</span><br><span class="line">           o2.order_date,</span><br><span class="line">           o2.order_id</span><br><span class="line">      <span class="keyword">from</span></span><br><span class="line">           <span class="number">104</span>_Orders o2</span><br><span class="line">      <span class="keyword">join</span></span><br><span class="line">          (<span class="keyword">select</span></span><br><span class="line">                 o.product_id,</span><br><span class="line">                 <span class="built_in">max</span>(order_date) <span class="keyword">as</span> order_date,</span><br><span class="line">                 <span class="built_in">max</span>(order_id) <span class="keyword">as</span> order_id</span><br><span class="line">           <span class="keyword">from</span></span><br><span class="line">                 <span class="number">104</span>_Orders o</span><br><span class="line">           <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">                 product_id</span><br><span class="line">           ) o1</span><br><span class="line">       <span class="keyword">on</span></span><br><span class="line">           o2.order_date <span class="operator">=</span> o1.order_date </span><br><span class="line">           <span class="keyword">and</span></span><br><span class="line">           o2.product_id <span class="operator">=</span> o1.product_id</span><br><span class="line">       ) o2</span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">       p1.product_id <span class="operator">=</span> o2.product_id</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> </span><br><span class="line">       p1.product_name,</span><br><span class="line">       o2.product_id,</span><br><span class="line">       o2.order_id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法二</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">     product_name,</span><br><span class="line">     product_id,</span><br><span class="line">     order_id,</span><br><span class="line">     order_date</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    (<span class="keyword">select</span> </span><br><span class="line">          product_name,</span><br><span class="line">          o.product_id,</span><br><span class="line">          order_id,</span><br><span class="line">          order_date,</span><br><span class="line">          <span class="built_in">rank</span>() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> o.product_id <span class="keyword">order</span> <span class="keyword">by</span> order_date <span class="keyword">desc</span>) rk</span><br><span class="line">     <span class="keyword">from</span></span><br><span class="line">          <span class="number">104</span>_Orders o </span><br><span class="line">     <span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">          <span class="number">104</span>_Products p</span><br><span class="line">     <span class="keyword">on</span> </span><br><span class="line">          o.product_id <span class="operator">=</span>p.product_id )t1</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">     rk <span class="operator">=</span><span class="number">1</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> </span><br><span class="line">     product_name,</span><br><span class="line">     product_id,</span><br><span class="line">     order_id;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hf7751.gitee.io/2021/03/11/81-100/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="hefei">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="元">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/03/11/81-100/" class="post-title-link" itemprop="url">بدون عنوان</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">نُشر في</span>

      <time title="أُنشأ: 2021-03-11 02:36:18" itemprop="dateCreated datePublished" datetime="2021-03-11T02:36:18+08:00">2021-03-11</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">عُدل في</span>
        <time title="عُدل: 2021-03-04 15:48:57" itemprop="dateModified" datetime="2021-03-04T15:48:57+08:00">2021-03-04</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="81-获取最近第二次的活动"><a href="#81-获取最近第二次的活动" class="headerlink" title="81. 获取最近第二次的活动"></a>81. 获取最近第二次的活动</h2><p>写一条SQL查询展示每一位用户 <strong>最近第二次</strong> 的活动，如果用户仅有一次活动，返回该活动。一个用户不能同时进行超过一项活动，以 <strong>任意</strong> 顺序返回结果。</p>
<p>展示效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">+------------+--------------+-------------+-------------+</span><br><span class="line">| username   | activity     | startDate   | endDate     |</span><br><span class="line">+------------+--------------+-------------+-------------+</span><br><span class="line">| Alice      | Dancing      | 2020-02-21  | 2020-02-23  |</span><br><span class="line">| Bob        | Travel       | 2020-02-11  | 2020-02-18  |</span><br><span class="line">+------------+--------------+-------------+-------------+</span><br></pre></td></tr></table></figure>

<p>建表语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">81</span>_UserActivity (username <span class="type">varchar</span>(<span class="number">30</span>), activity <span class="type">varchar</span>(<span class="number">30</span>), startDate <span class="type">date</span>, endDate <span class="type">date</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">81</span>_UserActivity;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">81</span>_UserActivity (username, activity, startDate, endDate) <span class="keyword">values</span> (<span class="string">&#x27;Alice&#x27;</span>, <span class="string">&#x27;Travel&#x27;</span>, <span class="string">&#x27;2020-02-12&#x27;</span>, <span class="string">&#x27;2020-02-20&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">81</span>_UserActivity (username, activity, startDate, endDate) <span class="keyword">values</span> (<span class="string">&#x27;Alice&#x27;</span>, <span class="string">&#x27;Dancing&#x27;</span>, <span class="string">&#x27;2020-02-21&#x27;</span>, <span class="string">&#x27;2020-02-23&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">81</span>_UserActivity (username, activity, startDate, endDate) <span class="keyword">values</span> (<span class="string">&#x27;Alice&#x27;</span>, <span class="string">&#x27;Travel&#x27;</span>, <span class="string">&#x27;2020-02-24&#x27;</span>, <span class="string">&#x27;2020-02-28&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">81</span>_UserActivity (username, activity, startDate, endDate) <span class="keyword">values</span> (<span class="string">&#x27;Bob&#x27;</span>, <span class="string">&#x27;Travel&#x27;</span>, <span class="string">&#x27;2020-02-11&#x27;</span>, <span class="string">&#x27;2020-02-18&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">     <span class="built_in">max</span>(u1.username) username,</span><br><span class="line">     <span class="built_in">max</span>(u1.activity) activity,</span><br><span class="line">     <span class="built_in">max</span>(u1.startdate) startdate,</span><br><span class="line">     <span class="built_in">max</span>(u1.enddate) enddate</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">     <span class="number">81</span>_useractivity u1 </span><br><span class="line"><span class="keyword">join</span></span><br><span class="line">     <span class="number">81</span>_useractivity u2</span><br><span class="line"><span class="keyword">on</span></span><br><span class="line">     u1.username <span class="operator">=</span> u2.username</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">     u1.username, u1.startdate</span><br><span class="line"><span class="keyword">having</span></span><br><span class="line">     <span class="built_in">sum</span>(if(u2.startdate <span class="operator">&gt;</span> u1.startdate,<span class="number">1</span>,<span class="number">0</span>)) <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">     <span class="keyword">or</span></span><br><span class="line">     <span class="built_in">count</span>(<span class="number">1</span>) <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法二</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">     `username`,</span><br><span class="line">     activity,</span><br><span class="line">     startDate,</span><br><span class="line">     endDate </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    (<span class="keyword">select</span> </span><br><span class="line">          username,</span><br><span class="line">          activity,</span><br><span class="line">          startDate,</span><br><span class="line">          endDate ,</span><br><span class="line">          <span class="built_in">rank</span>() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> username <span class="keyword">order</span> <span class="keyword">by</span> startDate <span class="keyword">desc</span>) rk,</span><br><span class="line">          <span class="built_in">lag</span>(startDate ,<span class="number">1</span>, <span class="keyword">null</span>) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> username <span class="keyword">order</span> <span class="keyword">by</span> startDate ) lg</span><br><span class="line">     <span class="keyword">from</span> <span class="number">81</span>_UserActivity) t1</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">     rk<span class="operator">=</span><span class="number">2</span> <span class="keyword">or</span> (rk <span class="operator">=</span> <span class="number">1</span> <span class="keyword">and</span> lg <span class="keyword">is</span> <span class="keyword">null</span>)</span><br></pre></td></tr></table></figure>

<h2 id="82-使用唯一标识码替换员工ID"><a href="#82-使用唯一标识码替换员工ID" class="headerlink" title="82. 使用唯一标识码替换员工ID"></a>82. 使用唯一标识码替换员工ID</h2><p>写一段SQL查询来展示每位用户的 <strong>唯一标识码（unique ID ）</strong>；如果某位员工没有唯一标识码，使用 null 填充即可。你可以以 <strong>任意</strong> 顺序返回结果表。</p>
<p>展示效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">+-----------+----------+</span><br><span class="line">| unique_id | name     |</span><br><span class="line">+-----------+----------+</span><br><span class="line">| null      | Alice    |</span><br><span class="line">| null      | Bob      |</span><br><span class="line">| 2         | Meir     |</span><br><span class="line">| 3         | Winston  |</span><br><span class="line">| 1         | Jonathan |</span><br><span class="line">+-----------+----------+</span><br></pre></td></tr></table></figure>

<p>建表语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">82</span>_Employees (id <span class="type">int</span>, name <span class="type">varchar</span>(<span class="number">20</span>));</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">82</span>_EmployeeUNI (id <span class="type">int</span>, unique_id <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">82</span>_Employees;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">82</span>_Employees (id, name) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Alice&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">82</span>_Employees (id, name) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;Bob&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">82</span>_Employees (id, name) <span class="keyword">values</span> (<span class="string">&#x27;11&#x27;</span>, <span class="string">&#x27;Meir&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">82</span>_Employees (id, name) <span class="keyword">values</span> (<span class="string">&#x27;90&#x27;</span>, <span class="string">&#x27;Winston&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">82</span>_Employees (id, name) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;Jonathan&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">82</span>_EmployeeUNI;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">82</span>_EmployeeUNI (id, unique_id) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">82</span>_EmployeeUNI (id, unique_id) <span class="keyword">values</span> (<span class="string">&#x27;11&#x27;</span>, <span class="string">&#x27;2&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">82</span>_EmployeeUNI (id, unique_id) <span class="keyword">values</span> (<span class="string">&#x27;90&#x27;</span>, <span class="string">&#x27;3&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">     if(unique_id <span class="keyword">is</span> <span class="keyword">null</span>, <span class="keyword">null</span>, unique_id) <span class="keyword">as</span> unique_id,</span><br><span class="line">     e.name</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">     <span class="number">82</span>_Employees e </span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">     <span class="number">82</span>_EmployeeUNI u</span><br><span class="line"><span class="keyword">on</span></span><br><span class="line">     e.id <span class="operator">=</span> u.id;</span><br></pre></td></tr></table></figure>

<h2 id="83-按年度列出销售总额"><a href="#83-按年度列出销售总额" class="headerlink" title="83. 按年度列出销售总额"></a>83. 按年度列出销售总额</h2><p>编写一段SQL查询每个产品每年的总销售额，并包含 product_id, product_name 以及 report_year 等信息。销售年份的日期介于 2018 年到 2020 年之间。你返回的结果需要按 product_id 和 report_year <strong>排序</strong>。</p>
<p>展示效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">+------------+--------------+-------------+--------------+</span><br><span class="line">| product_id | product_name | report_year | total_amount |</span><br><span class="line">+------------+--------------+-------------+--------------+</span><br><span class="line">| 1          | LC Phone     |    2019     | 3500         |</span><br><span class="line">| 2          | LC T-Shirt   |    2018     | 310          |</span><br><span class="line">| 2          | LC T-Shirt   |    2019     | 3650         |</span><br><span class="line">| 2          | LC T-Shirt   |    2020     | 10           |</span><br><span class="line">| 3          | LC Keychain  |    2019     | 31           |</span><br><span class="line">| 3          | LC Keychain  |    2020     | 31           |</span><br><span class="line">+------------+--------------+-------------+--------------+</span><br><span class="line">LC Phone 在 2019-01-25 至 2019-02-28 期间销售，该产品销售时间总计35天。销售总额 35*100 &#x3D; 3500。</span><br><span class="line">LC T-shirt 在 2018-12-01 至 2020-01-01 期间销售，该产品在2018年、2019年、2020年的销售时间分别是31天、365天、1天，2018年、2019年、2020年的销售总额分别是31*10&#x3D;310、365*10&#x3D;3650、1*10&#x3D;10。</span><br><span class="line">LC Keychain 在 2019-12-01 至 2020-01-31 期间销售，该产品在2019年、2020年的销售时间分别是：31天、31天，2019年、2020年的销售总额分别是31*1&#x3D;31、31*1&#x3D;31。</span><br></pre></td></tr></table></figure>

<p>建表语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">83</span>_Product (product_id <span class="type">int</span>, product_name <span class="type">varchar</span>(<span class="number">30</span>));</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">83</span>_Sales (product_id <span class="type">varchar</span>(<span class="number">30</span>), period_start <span class="type">date</span>, period_end <span class="type">date</span>, average_daily_sales <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">83</span>_Product;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">83</span>_Product (product_id, product_name) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;LC Phone &#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">83</span>_Product (product_id, product_name) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;LC T-Shirt&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">83</span>_Product (product_id, product_name) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;LC Keychain&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">83</span>_Sales;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">83</span>_Sales (product_id, period_start, period_end, average_daily_sales) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2019-01-25&#x27;</span>, <span class="string">&#x27;2019-02-28&#x27;</span>, <span class="string">&#x27;100&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">83</span>_Sales (product_id, period_start, period_end, average_daily_sales) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2018-12-01&#x27;</span>, <span class="string">&#x27;2020-01-01&#x27;</span>, <span class="string">&#x27;10&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">83</span>_Sales (product_id, period_start, period_end, average_daily_sales) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2019-12-01&#x27;</span>, <span class="string">&#x27;2020-01-31&#x27;</span>, <span class="string">&#x27;1&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">    (<span class="keyword">select</span></span><br><span class="line">           s1.product_id,</span><br><span class="line">           product_name,</span><br><span class="line">          <span class="string">&#x27;2018&#x27;</span> <span class="keyword">as</span> <span class="string">&#x27;report_year&#x27;</span>, </span><br><span class="line">          if(period_start<span class="operator">&lt;</span><span class="string">&#x27;2019-01-01&#x27;</span>,(datediff(</span><br><span class="line">                                           if(period_end<span class="operator">&lt;</span><span class="string">&#x27;2019-01-01&#x27;</span>, period_end, <span class="type">date</span>(<span class="string">&#x27;2018-12-31&#x27;</span>)),</span><br><span class="line">                                           if(period_start<span class="operator">&gt;=</span><span class="string">&#x27;2018-01-01&#x27;</span>, period_start, <span class="type">date</span>(<span class="string">&#x27;2018-01-01&#x27;</span>))</span><br><span class="line">                                           )<span class="operator">+</span><span class="number">1</span></span><br><span class="line">                                        ) <span class="operator">*</span> average_daily_sales, <span class="number">0</span>) <span class="keyword">as</span> total_amount</span><br><span class="line">     <span class="keyword">from</span> </span><br><span class="line">          <span class="number">83</span>_Sales <span class="keyword">as</span> s1</span><br><span class="line">     <span class="keyword">join</span> </span><br><span class="line">          <span class="number">83</span>_Product <span class="keyword">as</span> p1</span><br><span class="line">     <span class="keyword">on</span> </span><br><span class="line">          s1.product_id <span class="operator">=</span> p1.product_id </span><br><span class="line">     <span class="keyword">having</span></span><br><span class="line">          total_amount<span class="operator">&gt;</span><span class="number">0</span> )</span><br><span class="line"><span class="keyword">union</span></span><br><span class="line">    (<span class="keyword">select</span></span><br><span class="line">          s2.product_id,</span><br><span class="line">          product_name,</span><br><span class="line">         <span class="string">&#x27;2019&#x27;</span> <span class="keyword">as</span> <span class="string">&#x27;report_year&#x27;</span>,</span><br><span class="line">         if( period_start<span class="operator">&lt;</span><span class="string">&#x27;2020-01-01&#x27;</span>, (datediff(</span><br><span class="line">                                             if(period_end<span class="operator">&lt;</span><span class="string">&#x27;2020-01-01&#x27;</span>, period_end, <span class="type">date</span>(<span class="string">&#x27;2019-12-31&#x27;</span>)),                                                            if(period_start<span class="operator">&gt;=</span><span class="string">&#x27;2019-01-01&#x27;</span>, period_start, <span class="type">date</span>(<span class="string">&#x27;2019-01-01&#x27;</span>))</span><br><span class="line">                                             )<span class="operator">+</span><span class="number">1</span></span><br><span class="line">                                        ) <span class="operator">*</span> average_daily_sales , <span class="number">0</span>) <span class="keyword">as</span> total_amount</span><br><span class="line">     <span class="keyword">from</span></span><br><span class="line">          <span class="number">83</span>_Sales <span class="keyword">as</span> s2</span><br><span class="line">     <span class="keyword">join</span></span><br><span class="line">          <span class="number">83</span>_Product <span class="keyword">as</span> p2</span><br><span class="line">     <span class="keyword">on</span></span><br><span class="line">         s2.product_id <span class="operator">=</span> p2.product_id </span><br><span class="line">     <span class="keyword">having</span>  total_amount<span class="operator">&gt;</span><span class="number">0</span>)</span><br><span class="line"><span class="keyword">union</span></span><br><span class="line">    (<span class="keyword">select</span> </span><br><span class="line">          s3.product_id,</span><br><span class="line">          product_name,</span><br><span class="line">          <span class="string">&#x27;2020&#x27;</span> <span class="keyword">as</span> <span class="string">&#x27;report_year&#x27;</span>, </span><br><span class="line">          (datediff(</span><br><span class="line">                   if(period_end<span class="operator">&lt;</span><span class="string">&#x27;2021-01-01&#x27;</span>, period_end, <span class="type">date</span>(<span class="string">&#x27;2020-12-31&#x27;</span>)),</span><br><span class="line">                   if(period_start<span class="operator">&gt;=</span><span class="string">&#x27;2020-01-01&#x27;</span>, period_start, <span class="type">date</span>(<span class="string">&#x27;2020-01-01&#x27;</span>))</span><br><span class="line">                   )<span class="operator">+</span><span class="number">1</span></span><br><span class="line">           ) <span class="operator">*</span> average_daily_sales <span class="keyword">as</span> total_amount</span><br><span class="line">     <span class="keyword">from</span> </span><br><span class="line">          <span class="number">83</span>_Sales <span class="keyword">as</span> s3 </span><br><span class="line">     <span class="keyword">join</span> </span><br><span class="line">          <span class="number">83</span>_Product <span class="keyword">as</span> p3</span><br><span class="line">     <span class="keyword">on</span> </span><br><span class="line">          s3.product_id <span class="operator">=</span> p3.product_id</span><br><span class="line">     <span class="keyword">having</span> total_amount<span class="operator">&gt;</span><span class="number">0</span> ) </span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> product_id, report_year</span><br></pre></td></tr></table></figure>



<h2 id="84-股票的资本损益"><a href="#84-股票的资本损益" class="headerlink" title="84. 股票的资本损益"></a>84. 股票的资本损益</h2><p>编写一个SQL查询来报告每支股票的资本损益。股票的资本损益是一次或多次买卖股票后的全部收益或损失。以任意顺序返回结果即可。</p>
<p>展示效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">+---------------+-------------------+</span><br><span class="line">| stock_name    | capital_gain_loss |</span><br><span class="line">+---------------+-------------------+</span><br><span class="line">| Corona Masks  | 9500              |</span><br><span class="line">| Leetcode      | 8000              |</span><br><span class="line">| Handbags      | -23000            |</span><br><span class="line">+---------------+-------------------+</span><br><span class="line">Leetcode 股票在第一天以1000美元的价格买入，在第五天以9000美元的价格卖出。资本收益&#x3D;9000-1000&#x3D;8000美元。</span><br><span class="line">Handbags 股票在第17天以30000美元的价格买入，在第29天以7000美元的价格卖出。资本损失&#x3D;7000-30000&#x3D;-23000美元。</span><br><span class="line">Corona Masks 股票在第1天以10美元的价格买入，在第3天以1010美元的价格卖出。在第4天以1000美元的价格再次购买，在第5天以500美元的价格出售。最后，它在第6天以1000美元的价格被买走，在第10天以10000美元的价格被卖掉。资本损益是每次（’Buy&#39;-&gt;&#39;Sell&#39;）操作资本收益或损失的和&#x3D;（1010-10）+（500-1000）+（10000-1000）&#x3D;1000-500+9000&#x3D;9500美元。</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">Table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">84</span>_Stocks(stock_name <span class="type">varchar</span>(<span class="number">15</span>),operation ENUM(<span class="string">&#x27;Sell&#x27;</span>, <span class="string">&#x27;Buy&#x27;</span>),operation_day <span class="type">int</span>, price <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">84</span>_Stocks;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">84</span>_Stocks (stock_name, operation, operation_day, price) <span class="keyword">values</span> (<span class="string">&#x27;Leetcode&#x27;</span>, <span class="string">&#x27;Buy&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;1000&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">84</span>_Stocks (stock_name, operation, operation_day, price) <span class="keyword">values</span> (<span class="string">&#x27;Corona Masks&#x27;</span>, <span class="string">&#x27;Buy&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;10&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">84</span>_Stocks (stock_name, operation, operation_day, price) <span class="keyword">values</span> (<span class="string">&#x27;Leetcode&#x27;</span>, <span class="string">&#x27;Sell&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;9000&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">84</span>_Stocks (stock_name, operation, operation_day, price) <span class="keyword">values</span> (<span class="string">&#x27;Handbags&#x27;</span>, <span class="string">&#x27;Buy&#x27;</span>, <span class="string">&#x27;17&#x27;</span>, <span class="string">&#x27;30000&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">84</span>_Stocks (stock_name, operation, operation_day, price) <span class="keyword">values</span> (<span class="string">&#x27;Corona Masks&#x27;</span>, <span class="string">&#x27;Sell&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;1010&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">84</span>_Stocks (stock_name, operation, operation_day, price) <span class="keyword">values</span> (<span class="string">&#x27;Corona Masks&#x27;</span>, <span class="string">&#x27;Buy&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;1000&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">84</span>_Stocks (stock_name, operation, operation_day, price) <span class="keyword">values</span> (<span class="string">&#x27;Corona Masks&#x27;</span>, <span class="string">&#x27;Sell&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;500&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">84</span>_Stocks (stock_name, operation, operation_day, price) <span class="keyword">values</span> (<span class="string">&#x27;Corona Masks&#x27;</span>, <span class="string">&#x27;Buy&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;1000&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">84</span>_Stocks (stock_name, operation, operation_day, price) <span class="keyword">values</span> (<span class="string">&#x27;Handbags&#x27;</span>, <span class="string">&#x27;Sell&#x27;</span>, <span class="string">&#x27;29&#x27;</span>, <span class="string">&#x27;7000&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">84</span>_Stocks (stock_name, operation, operation_day, price) <span class="keyword">values</span> (<span class="string">&#x27;Corona Masks&#x27;</span>, <span class="string">&#x27;Sell&#x27;</span>, <span class="string">&#x27;10&#x27;</span>, <span class="string">&#x27;10000&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">     s2.stock_name,</span><br><span class="line">     s2.sum_sell <span class="operator">-</span> s1.sum_buy <span class="keyword">as</span> capital_gain_loss</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    (<span class="keyword">select</span> </span><br><span class="line">           stock_name,</span><br><span class="line">           <span class="built_in">sum</span>(if(operation<span class="operator">=</span><span class="string">&#x27;Buy&#x27;</span>,price,<span class="number">0</span>)) <span class="keyword">as</span> sum_buy,</span><br><span class="line">           <span class="built_in">sum</span>(if(operation<span class="operator">=</span><span class="string">&#x27;Sell&#x27;</span>,price,<span class="number">0</span>)) <span class="keyword">as</span> sum_sell</span><br><span class="line">     <span class="keyword">from</span></span><br><span class="line">           <span class="number">84</span>_stocks</span><br><span class="line">     <span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">           stock_name, operation) s1</span><br><span class="line"><span class="keyword">join</span></span><br><span class="line">    (<span class="keyword">select</span> </span><br><span class="line">           stock_name,</span><br><span class="line">           <span class="built_in">sum</span>(if(operation<span class="operator">=</span><span class="string">&#x27;Buy&#x27;</span>,price,<span class="number">0</span>)) <span class="keyword">as</span> sum_buy,</span><br><span class="line">           <span class="built_in">sum</span>(if(operation<span class="operator">=</span><span class="string">&#x27;Sell&#x27;</span>,price,<span class="number">0</span>)) <span class="keyword">as</span> sum_sell</span><br><span class="line">     <span class="keyword">from</span></span><br><span class="line">           <span class="number">84</span>_stocks</span><br><span class="line">     <span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">           stock_name, operation) s2</span><br><span class="line"><span class="keyword">on</span></span><br><span class="line">    s1.stock_name <span class="operator">=</span> s2.stock_name</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">    s1.sum_buy <span class="operator">&lt;&gt;</span> <span class="number">0</span> </span><br><span class="line">    <span class="keyword">and</span></span><br><span class="line">    s2.sum_buy <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法二</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">     stock_name,sell<span class="operator">-</span>buy capital_gain_loss</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    (<span class="keyword">select</span></span><br><span class="line">          stock_name,</span><br><span class="line">          <span class="built_in">sum</span>(if(operation<span class="operator">=</span><span class="string">&#x27;Buy&#x27;</span>, price,<span class="number">0</span>))<span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> stock_name ) buy,</span><br><span class="line">          <span class="built_in">sum</span>(if(operation<span class="operator">=</span><span class="string">&#x27;Sell&#x27;</span>,price,<span class="number">0</span>))<span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> stock_name) sell</span><br><span class="line">     <span class="keyword">from</span></span><br><span class="line">          <span class="number">84</span>_Stocks s )t1</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">     stock_name,buy,sell;</span><br></pre></td></tr></table></figure>



<h2 id="85-购买了产品A和B却没有购买产品C的顾客"><a href="#85-购买了产品A和B却没有购买产品C的顾客" class="headerlink" title="85. 购买了产品A和B却没有购买产品C的顾客"></a>85. 购买了产品A和B却没有购买产品C的顾客</h2><p>请你设计 SQL 查询来报告购买了产品 A 和产品 B 却没有购买产品 C 的顾客的 ID 和姓名（ <code>customer_id</code> 和 <code>customer_name</code> ），我们将基于此结果为他们推荐产品 C 。<br>您返回的查询结果需要按照 <code>customer_id</code> <strong>排序</strong>。</p>
<p>展示效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+-------------+---------------+</span><br><span class="line">| customer_id | customer_name |</span><br><span class="line">+-------------+---------------+</span><br><span class="line">| 3           | Elizabeth     |</span><br><span class="line">+-------------+---------------+</span><br></pre></td></tr></table></figure>

<p>建表语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">85</span>_Customers (customer_id <span class="type">int</span>, customer_name <span class="type">varchar</span>(<span class="number">30</span>));</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">85</span>_Orders (order_id <span class="type">int</span>, customer_id <span class="type">int</span>, product_name <span class="type">varchar</span>(<span class="number">30</span>));</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">85</span>_Customers;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">85</span>_Customers (customer_id, customer_name) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Daniel&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">85</span>_Customers (customer_id, customer_name) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;Diana&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">85</span>_Customers (customer_id, customer_name) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;Elizabeth&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">85</span>_Customers (customer_id, customer_name) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;Jhon&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">85</span>_Orders;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">85</span>_Orders (order_id, customer_id, product_name) <span class="keyword">values</span> (<span class="string">&#x27;10&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;A&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">85</span>_Orders (order_id, customer_id, product_name) <span class="keyword">values</span> (<span class="string">&#x27;20&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;B&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">85</span>_Orders (order_id, customer_id, product_name) <span class="keyword">values</span> (<span class="string">&#x27;30&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;D&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">85</span>_Orders (order_id, customer_id, product_name) <span class="keyword">values</span> (<span class="string">&#x27;40&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;C&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">85</span>_Orders (order_id, customer_id, product_name) <span class="keyword">values</span> (<span class="string">&#x27;50&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;A&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">85</span>_Orders (order_id, customer_id, product_name) <span class="keyword">values</span> (<span class="string">&#x27;60&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;A&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">85</span>_Orders (order_id, customer_id, product_name) <span class="keyword">values</span> (<span class="string">&#x27;70&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;B&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">85</span>_Orders (order_id, customer_id, product_name) <span class="keyword">values</span> (<span class="string">&#x27;80&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;D&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">85</span>_Orders (order_id, customer_id, product_name) <span class="keyword">values</span> (<span class="string">&#x27;90&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;C&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">     o.customer_id,</span><br><span class="line">     customer_name </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">     <span class="number">85</span>_Orders o </span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">     <span class="number">85</span>_Customers c</span><br><span class="line"><span class="keyword">on</span></span><br><span class="line">     o.customer_id<span class="operator">=</span>c.customer_id</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">     customer_id</span><br><span class="line"><span class="keyword">having</span> </span><br><span class="line">     <span class="built_in">sum</span>(product_name <span class="operator">=</span><span class="string">&#x27;A&#x27;</span>)<span class="operator">&gt;=</span><span class="number">1</span> </span><br><span class="line">     <span class="keyword">and</span></span><br><span class="line">     <span class="built_in">sum</span>(product_name<span class="operator">=</span><span class="string">&#x27;B&#x27;</span>)<span class="operator">&gt;=</span><span class="number">1</span></span><br><span class="line">     <span class="keyword">and</span></span><br><span class="line">     <span class="built_in">sum</span>(product_name<span class="operator">=</span><span class="string">&#x27;C&#x27;</span>)<span class="operator">=</span><span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<h2 id="86-排名靠前的旅行者"><a href="#86-排名靠前的旅行者" class="headerlink" title="86. 排名靠前的旅行者"></a>86. 排名靠前的旅行者</h2><p>写一段 SQL , 报告每个用户的旅行距离。返回的结果表单, 以 <code>travelled_distance</code> 降序排列, 如果有两个或者更多的用户旅行了相同的距离, 那么再以 <code>name</code> 升序排列.</p>
<p>展示效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">+----------+--------------------+</span><br><span class="line">| name     | travelled_distance |</span><br><span class="line">+----------+--------------------+</span><br><span class="line">| Elvis    | 450                |</span><br><span class="line">| Lee      | 450                |</span><br><span class="line">| Bob      | 317                |</span><br><span class="line">| Jonathan | 312                |</span><br><span class="line">| Alex     | 222                |</span><br><span class="line">| Alice    | 120                |</span><br><span class="line">| Donald   | 0                  |</span><br><span class="line">+----------+--------------------+</span><br><span class="line">Elvis 和 Lee 旅行了 450 英里, Elvis 是排名靠前的旅行者, 因为他的名字在字母表上的排序比 Lee 更小.</span><br><span class="line">Bob, Jonathan, Alex 和 Alice 只有一次行程, 我们只按此次行程的全部距离对他们排序.</span><br><span class="line">Donald 没有任何行程, 他的旅行距离为 0.</span><br></pre></td></tr></table></figure>

<p>建表语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">Table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">86</span>_Users (id <span class="type">int</span>, name <span class="type">varchar</span>(<span class="number">30</span>));</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">Table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">86</span>_Rides (id <span class="type">int</span>, user_id <span class="type">int</span>, distance <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">86</span>_Users;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">86</span>_Users (id, name) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Alice&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">86</span>_Users (id, name) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;Bob&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">86</span>_Users (id, name) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;Alex&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">86</span>_Users (id, name) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;Donald&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">86</span>_Users (id, name) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;Lee&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">86</span>_Users (id, name) <span class="keyword">values</span> (<span class="string">&#x27;13&#x27;</span>, <span class="string">&#x27;Jonathan&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">86</span>_Users (id, name) <span class="keyword">values</span> (<span class="string">&#x27;19&#x27;</span>, <span class="string">&#x27;Elvis&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">86</span>_Rides;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">86</span>_Rides (id, user_id, distance) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;120&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">86</span>_Rides (id, user_id, distance) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;317&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">86</span>_Rides (id, user_id, distance) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;222&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">86</span>_Rides (id, user_id, distance) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;100&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">86</span>_Rides (id, user_id, distance) <span class="keyword">values</span> (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;13&#x27;</span>, <span class="string">&#x27;312&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">86</span>_Rides (id, user_id, distance) <span class="keyword">values</span> (<span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;19&#x27;</span>, <span class="string">&#x27;50&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">86</span>_Rides (id, user_id, distance) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;120&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">86</span>_Rides (id, user_id, distance) <span class="keyword">values</span> (<span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;19&#x27;</span>, <span class="string">&#x27;400&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">86</span>_Rides (id, user_id, distance) <span class="keyword">values</span> (<span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;230&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">      name,</span><br><span class="line">      <span class="built_in">sum</span>(ifnull(distance,<span class="number">0</span>)) travelled_distance </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      <span class="number">86</span>_Users u </span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> </span><br><span class="line">      <span class="number">86</span>_Rides r</span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">      u.id <span class="operator">=</span> r.user_id</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">      name</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">      travelled_distance  <span class="keyword">desc</span>, name;</span><br></pre></td></tr></table></figure>

<h2 id="87-查找成绩处于中游的学生"><a href="#87-查找成绩处于中游的学生" class="headerlink" title="87. 查找成绩处于中游的学生"></a>87. 查找成绩处于中游的学生</h2><p>写一个 SQL 语句，找出在所有测验中都处于中游的学生 <code>(student_id, student_name)</code>。成绩处于中游的学生是指至少参加了一次测验, 且得分既不是最高分也不是最低分的学生。不要返回从来没有参加过测验的学生。返回结果表按照 <code>student_id</code> 排序。</p>
<p>展示效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">+-------------+---------------+</span><br><span class="line">| student_id  | student_name  |</span><br><span class="line">+-------------+---------------+</span><br><span class="line">| 2           | Jade          |</span><br><span class="line">+-------------+---------------+</span><br><span class="line"></span><br><span class="line">对于测验 1: 学生 1 和 3 分别获得了最低分和最高分。</span><br><span class="line">对于测验 2: 学生 1 既获得了最高分, 也获得了最低分。</span><br><span class="line">对于测验 3 和 4: 学生 1 和 4 分别获得了最低分和最高分。</span><br><span class="line">学生 2 和 5 没有在任一场测验中获得了最高分或者最低分。</span><br><span class="line">因为学生 5 从来没有参加过任何测验, 所以他被排除于结果表。</span><br><span class="line">由此, 我们仅仅返回学生 2 的信息。</span><br></pre></td></tr></table></figure>

<p>建表语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">87</span>_Student (student_id <span class="type">int</span>, student_name <span class="type">varchar</span>(<span class="number">30</span>));</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">87</span>_Exam (exam_id <span class="type">int</span>, student_id <span class="type">int</span>, score <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">87</span>_Student;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">87</span>_Student (student_id, student_name) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Daniel&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">87</span>_Student (student_id, student_name) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;Jade&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">87</span>_Student (student_id, student_name) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;Stella&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">87</span>_Student (student_id, student_name) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;Jonathan&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">87</span>_Student (student_id, student_name) <span class="keyword">values</span> (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;Will&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">87</span>_Exam;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">87</span>_Exam (exam_id, student_id, score) <span class="keyword">values</span> (<span class="string">&#x27;10&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;70&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">87</span>_Exam (exam_id, student_id, score) <span class="keyword">values</span> (<span class="string">&#x27;10&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;80&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">87</span>_Exam (exam_id, student_id, score) <span class="keyword">values</span> (<span class="string">&#x27;10&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;90&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">87</span>_Exam (exam_id, student_id, score) <span class="keyword">values</span> (<span class="string">&#x27;20&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;80&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">87</span>_Exam (exam_id, student_id, score) <span class="keyword">values</span> (<span class="string">&#x27;30&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;70&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">87</span>_Exam (exam_id, student_id, score) <span class="keyword">values</span> (<span class="string">&#x27;30&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;80&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">87</span>_Exam (exam_id, student_id, score) <span class="keyword">values</span> (<span class="string">&#x27;30&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;90&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">87</span>_Exam (exam_id, student_id, score) <span class="keyword">values</span> (<span class="string">&#x27;40&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;60&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">87</span>_Exam (exam_id, student_id, score) <span class="keyword">values</span> (<span class="string">&#x27;40&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;70&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">87</span>_Exam (exam_id, student_id, score) <span class="keyword">values</span> (<span class="string">&#x27;40&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;80&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">      student_id,</span><br><span class="line">      student_name</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      <span class="number">87</span>_student</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">      student_id <span class="keyword">not</span> <span class="keyword">in</span>(</span><br><span class="line">                 <span class="keyword">select</span></span><br><span class="line">                       s1.student_id</span><br><span class="line">                 <span class="keyword">from</span> </span><br><span class="line">                       <span class="number">87</span>_student s1</span><br><span class="line">                 <span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">                       <span class="number">87</span>_exam e1</span><br><span class="line">                 <span class="keyword">on</span></span><br><span class="line">                       s1.student_id <span class="operator">=</span> e1.student_id</span><br><span class="line">                 <span class="keyword">join</span></span><br><span class="line">                      (<span class="keyword">select</span> <span class="built_in">max</span>(score) max_score, <span class="built_in">min</span>(score) min_score <span class="keyword">from</span> <span class="number">87</span>_Exam) m</span><br><span class="line">                 <span class="keyword">on</span> </span><br><span class="line">                       e1.score <span class="operator">=</span> m.max_score</span><br><span class="line">                       <span class="keyword">or</span></span><br><span class="line">                       e1.score <span class="operator">=</span> m.min_score</span><br><span class="line">                       <span class="keyword">or</span></span><br><span class="line">                       e1.score <span class="keyword">is</span> <span class="keyword">null</span>);</span><br><span class="line"><span class="comment">-- 方法二</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">      e.student_id,</span><br><span class="line">      student_name</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      <span class="number">87</span>_Exam e </span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">      <span class="number">87</span>_Student s</span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">      e.student_id<span class="operator">=</span>s.student_id</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">      e.student_id <span class="keyword">not</span> <span class="keyword">in</span>(<span class="keyword">select</span> </span><br><span class="line">                                student_id</span><br><span class="line">                          <span class="keyword">from</span></span><br><span class="line">                               (<span class="keyword">select</span> </span><br><span class="line">                                      student_id,</span><br><span class="line">                                      <span class="built_in">rank</span>() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> exam_id <span class="keyword">order</span> <span class="keyword">by</span> score <span class="keyword">desc</span>) rkmax,</span><br><span class="line">                                      <span class="built_in">rank</span>() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> exam_id <span class="keyword">order</span> <span class="keyword">by</span> score ) rkmin</span><br><span class="line">                                <span class="keyword">from</span> </span><br><span class="line">                                      <span class="number">87</span>_Exam )t1</span><br><span class="line">                          <span class="keyword">where</span> </span><br><span class="line">                                rkmax <span class="operator">=</span> <span class="number">1</span> <span class="keyword">or</span> rkmin <span class="operator">=</span><span class="number">1</span> )</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">      e.student_id,</span><br><span class="line">      student_name</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">      e.student_id;</span><br></pre></td></tr></table></figure>



<h2 id="88-净现值查询"><a href="#88-净现值查询" class="headerlink" title="88. 净现值查询"></a>88. 净现值查询</h2><p>写一个 SQL, 找到 Queries 表中每一次查询的净现值，结果表没有顺序要求.</p>
<p>展示效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">+------+--------+--------+</span><br><span class="line">| id   | year   | npv    |</span><br><span class="line">+------+--------+--------+</span><br><span class="line">| 1    | 2019   | 113    |</span><br><span class="line">| 2    | 2008   | 121    |</span><br><span class="line">| 3    | 2009   | 12     |</span><br><span class="line">| 7    | 2018   | 0      |</span><br><span class="line">| 7    | 2019   | 0      |</span><br><span class="line">| 7    | 2020   | 30     |</span><br><span class="line">| 13   | 2019   | 40     |</span><br><span class="line">+------+--------+--------+</span><br><span class="line"></span><br><span class="line">(7, 2018)的净现值不在 NPV 表中, 我们把它看作是 0.</span><br><span class="line">所有其它查询的净现值都能在 NPV 表中找到.</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">Table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">88</span>_NPV (id <span class="type">int</span>, <span class="keyword">year</span> <span class="type">int</span>, npv <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">Table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">88</span>_Queries (id <span class="type">int</span>, <span class="keyword">year</span> <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">88</span>_NPV;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">88</span>_NPV (id, <span class="keyword">year</span>, npv) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2018&#x27;</span>, <span class="string">&#x27;100&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">88</span>_NPV (id, <span class="keyword">year</span>, npv) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;2020&#x27;</span>, <span class="string">&#x27;30&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">88</span>_NPV (id, <span class="keyword">year</span>, npv) <span class="keyword">values</span> (<span class="string">&#x27;13&#x27;</span>, <span class="string">&#x27;2019&#x27;</span>, <span class="string">&#x27;40&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">88</span>_NPV (id, <span class="keyword">year</span>, npv) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2019&#x27;</span>, <span class="string">&#x27;113&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">88</span>_NPV (id, <span class="keyword">year</span>, npv) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2008&#x27;</span>, <span class="string">&#x27;121&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">88</span>_NPV (id, <span class="keyword">year</span>, npv) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2009&#x27;</span>, <span class="string">&#x27;21&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">88</span>_NPV (id, <span class="keyword">year</span>, npv) <span class="keyword">values</span> (<span class="string">&#x27;11&#x27;</span>, <span class="string">&#x27;2020&#x27;</span>, <span class="string">&#x27;99&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">88</span>_NPV (id, <span class="keyword">year</span>, npv) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;2019&#x27;</span>, <span class="string">&#x27;0&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">88</span>_Queries;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">88</span>_Queries (id, <span class="keyword">year</span>) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2019&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">88</span>_Queries (id, <span class="keyword">year</span>) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2008&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">88</span>_Queries (id, <span class="keyword">year</span>) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2009&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">88</span>_Queries (id, <span class="keyword">year</span>) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;2018&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">88</span>_Queries (id, <span class="keyword">year</span>) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;2019&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">88</span>_Queries (id, <span class="keyword">year</span>) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;2020&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">88</span>_Queries (id, <span class="keyword">year</span>) <span class="keyword">values</span> (<span class="string">&#x27;13&#x27;</span>, <span class="string">&#x27;2019&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">      q.id,</span><br><span class="line">      q.year,</span><br><span class="line">      ifnull(npv,<span class="number">0</span>) npv</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      <span class="number">88</span>_Queries q</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">      <span class="number">88</span>_NPV n</span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">      q.id <span class="operator">=</span> n.id </span><br><span class="line">      <span class="keyword">and</span></span><br><span class="line">      q.year <span class="operator">=</span> n.year;</span><br></pre></td></tr></table></figure>



<h2 id="89-制作会话柱状图"><a href="#89-制作会话柱状图" class="headerlink" title="89. 制作会话柱状图"></a>89. 制作会话柱状图</h2><p>你想知道用户在你的 app 上的访问时长情况。因此决定统计访问时长区间分别为 “[0-5&gt;”, “[5-10&gt;”, “[10-15&gt;” 和 “15 or more” （单位：分钟）的会话数量，并以此绘制柱状图。</p>
<p>写一个SQL查询来报告（访问时长区间，会话总数）。结果可用任何顺序呈现。</p>
<p> 展示效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">+--------------+--------------+</span><br><span class="line">| bin          | total        |</span><br><span class="line">+--------------+--------------+</span><br><span class="line">| [0-5&gt;        | 3            |</span><br><span class="line">| [5-10&gt;       | 1            |</span><br><span class="line">| [10-15&gt;      | 0            |</span><br><span class="line">| 15 or more   | 1            |</span><br><span class="line">+--------------+--------------+</span><br><span class="line"></span><br><span class="line">对于 session_id 1，2 和 3 ，它们的访问时间大于等于 0 分钟且小于 5 分钟。</span><br><span class="line">对于 session_id 4，它的访问时间大于等于 5 分钟且小于 10 分钟。</span><br><span class="line">没有会话的访问时间大于等于 10 分钟且小于 15 分钟。</span><br><span class="line">对于 session_id 5, 它的访问时间大于等于 15 分钟。</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">89</span>_Sessions (session_id <span class="type">int</span>, duration <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">89</span>_Sessions;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">89</span>_Sessions (session_id, duration) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;30&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">89</span>_Sessions (session_id, duration) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;199&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">89</span>_Sessions (session_id, duration) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;299&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">89</span>_Sessions (session_id, duration) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;580&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">89</span>_Sessions (session_id, duration) <span class="keyword">values</span> (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;1000&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一</span></span><br><span class="line"><span class="keyword">select</span> <span class="string">&#x27;[0-5&gt;&#x27;</span> <span class="keyword">as</span> bin, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> total <span class="keyword">from</span> <span class="number">89</span>_Sessions <span class="keyword">where</span> duration<span class="operator">/</span><span class="number">60</span><span class="operator">&gt;=</span><span class="number">0</span> <span class="keyword">and</span> duration<span class="operator">/</span><span class="number">60</span><span class="operator">&lt;</span><span class="number">5</span></span><br><span class="line"><span class="keyword">union</span></span><br><span class="line"><span class="keyword">select</span> <span class="string">&#x27;[5-10&gt;&#x27;</span> <span class="keyword">as</span> bin, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> total <span class="keyword">from</span> <span class="number">89</span>_Sessions <span class="keyword">where</span> duration<span class="operator">/</span><span class="number">60</span><span class="operator">&gt;=</span><span class="number">5</span> <span class="keyword">and</span> duration<span class="operator">/</span><span class="number">60</span><span class="operator">&lt;</span><span class="number">10</span></span><br><span class="line"><span class="keyword">union</span></span><br><span class="line"><span class="keyword">select</span> <span class="string">&#x27;[10-15&gt;&#x27;</span> <span class="keyword">as</span> bin, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> total <span class="keyword">from</span> <span class="number">89</span>_Sessions <span class="keyword">where</span> duration<span class="operator">/</span><span class="number">60</span><span class="operator">&gt;=</span><span class="number">10</span> <span class="keyword">and</span> duration<span class="operator">/</span><span class="number">60</span><span class="operator">&lt;</span><span class="number">15</span></span><br><span class="line"><span class="keyword">union</span></span><br><span class="line"><span class="keyword">select</span> <span class="string">&#x27;15 or more&#x27;</span><span class="keyword">as</span> bin, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> total <span class="keyword">from</span> <span class="number">89</span>_Sessions <span class="keyword">where</span> duration<span class="operator">/</span><span class="number">60</span><span class="operator">&gt;=</span><span class="number">15</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法二</span></span><br><span class="line"><span class="keyword">select</span> a.bin, <span class="built_in">count</span>(b.bin) <span class="keyword">as</span> total</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">(<span class="keyword">select</span> <span class="string">&#x27;[0-5&gt;&#x27;</span> <span class="keyword">as</span> bin <span class="keyword">union</span> <span class="keyword">select</span> <span class="string">&#x27;[5-10&gt;&#x27;</span> <span class="keyword">as</span> bin <span class="keyword">union</span> <span class="keyword">select</span> <span class="string">&#x27;[10-15&gt;&#x27;</span> <span class="keyword">as</span> bin <span class="keyword">union</span> <span class="keyword">select</span> <span class="string">&#x27;15 or more&#x27;</span> <span class="keyword">as</span> bin)a</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> </span><br><span class="line">(<span class="keyword">select</span> <span class="keyword">case</span></span><br><span class="line">        <span class="keyword">when</span> duration <span class="operator">&lt;</span> <span class="number">300</span> <span class="keyword">then</span> <span class="string">&#x27;[0-5&gt;&#x27;</span></span><br><span class="line">        <span class="keyword">when</span> duration <span class="operator">&gt;=</span> <span class="number">300</span> <span class="keyword">and</span> duration <span class="operator">&lt;</span> <span class="number">600</span> <span class="keyword">then</span> <span class="string">&#x27;[5-10&gt;&#x27;</span></span><br><span class="line">        <span class="keyword">when</span> duration <span class="operator">&gt;=</span> <span class="number">600</span> <span class="keyword">and</span> duration <span class="operator">&lt;</span> <span class="number">900</span> <span class="keyword">then</span> <span class="string">&#x27;[10-15&gt;&#x27;</span></span><br><span class="line">        <span class="keyword">else</span> <span class="string">&#x27;15 or more&#x27;</span></span><br><span class="line">        <span class="keyword">end</span> bin</span><br><span class="line">    <span class="keyword">from</span> <span class="number">89</span>_Sessions </span><br><span class="line">)b</span><br><span class="line"><span class="keyword">on</span> a.bin <span class="operator">=</span> b.bin</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> a.bin</span><br></pre></td></tr></table></figure>



<h2 id="90-计算布尔表达式的值"><a href="#90-计算布尔表达式的值" class="headerlink" title="90. 计算布尔表达式的值"></a>90. 计算布尔表达式的值</h2><p>写一个 SQL 查询, 以计算表 <code>Expressions</code> 中的布尔表达式，返回的结果表没有顺序要求.</p>
<p>展示效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">+--------------+----------+---------------+-------+</span><br><span class="line">| left_operand | operator | right_operand | value |</span><br><span class="line">+--------------+----------+---------------+-------+</span><br><span class="line">| x            | &gt;        | y             | false |</span><br><span class="line">| x            | &lt;        | y             | true  |</span><br><span class="line">| x            | &#x3D;        | y             | false |</span><br><span class="line">| y            | &gt;        | x             | true  |</span><br><span class="line">| y            | &lt;        | x             | false |</span><br><span class="line">| x            | &#x3D;        | x             | true  |</span><br><span class="line">+--------------+----------+---------------+-------+</span><br></pre></td></tr></table></figure>

<p>建表语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">Table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">90</span>_Variables (name <span class="type">varchar</span>(<span class="number">3</span>), <span class="keyword">value</span> <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">Table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">90</span>_Expressions (left_operand <span class="type">varchar</span>(<span class="number">3</span>), operator ENUM(<span class="string">&#x27;&gt;&#x27;</span>, <span class="string">&#x27;&lt;&#x27;</span>, <span class="string">&#x27;=&#x27;</span>), right_operand <span class="type">varchar</span>(<span class="number">3</span>));</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">90</span>_Variables;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">90</span>_Variables (name, <span class="keyword">value</span>) <span class="keyword">values</span> (<span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;66&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">90</span>_Variables (name, <span class="keyword">value</span>) <span class="keyword">values</span> (<span class="string">&#x27;y&#x27;</span>, <span class="string">&#x27;77&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">90</span>_Expressions;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">90</span>_Expressions (left_operand, operator, right_operand) <span class="keyword">values</span> (<span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;&gt;&#x27;</span>, <span class="string">&#x27;y&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">90</span>_Expressions (left_operand, operator, right_operand) <span class="keyword">values</span> (<span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;&lt;&#x27;</span>, <span class="string">&#x27;y&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">90</span>_Expressions (left_operand, operator, right_operand) <span class="keyword">values</span> (<span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;=&#x27;</span>, <span class="string">&#x27;y&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">90</span>_Expressions (left_operand, operator, right_operand) <span class="keyword">values</span> (<span class="string">&#x27;y&#x27;</span>, <span class="string">&#x27;&gt;&#x27;</span>, <span class="string">&#x27;x&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">90</span>_Expressions (left_operand, operator, right_operand) <span class="keyword">values</span> (<span class="string">&#x27;y&#x27;</span>, <span class="string">&#x27;&lt;&#x27;</span>, <span class="string">&#x27;x&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">90</span>_Expressions (left_operand, operator, right_operand) <span class="keyword">values</span> (<span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;=&#x27;</span>, <span class="string">&#x27;x&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">     e.left_operand,</span><br><span class="line">     e.operator,</span><br><span class="line">     e.right_operand,</span><br><span class="line">     <span class="keyword">case</span> e.operator</span><br><span class="line">              <span class="keyword">when</span> <span class="string">&#x27;&gt;&#x27;</span> <span class="keyword">then</span> if(v1.value<span class="operator">&gt;</span>v2.value,<span class="string">&#x27;true&#x27;</span>,<span class="string">&#x27;false&#x27;</span>)</span><br><span class="line">              <span class="keyword">when</span> <span class="string">&#x27;&lt;&#x27;</span> <span class="keyword">then</span> if(v1.value<span class="operator">&lt;</span>v2.value,<span class="string">&#x27;true&#x27;</span>,<span class="string">&#x27;false&#x27;</span>)</span><br><span class="line">              <span class="keyword">else</span> if(v1.value<span class="operator">=</span>v2.value,<span class="string">&#x27;true&#x27;</span>,<span class="string">&#x27;false&#x27;</span>)</span><br><span class="line">     <span class="keyword">end</span> <span class="keyword">value</span></span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">     <span class="number">90</span>_Expressions e</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">     <span class="number">90</span>_Variables v1 </span><br><span class="line"><span class="keyword">on</span></span><br><span class="line">     v1.name <span class="operator">=</span> e.left_operand </span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">     <span class="number">90</span>_Variables v2 </span><br><span class="line"><span class="keyword">on</span></span><br><span class="line">     v2.name <span class="operator">=</span> e.right_operand;</span><br></pre></td></tr></table></figure>



<h2 id="91-苹果和桔子"><a href="#91-苹果和桔子" class="headerlink" title="91. 苹果和桔子"></a>91. 苹果和桔子</h2><p>写一个 SQL 查询, 报告每一天 <strong>苹果</strong> 和 <strong>桔子</strong> 销售的数目的差异.返回的结果表, 按照格式为 (‘YYYY-MM-DD’) 的 <code>sale_date</code> 排序.</p>
<p>查询结果表如下例所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">+------------+--------------+</span><br><span class="line">| sale_date  | diff         |</span><br><span class="line">+------------+--------------+</span><br><span class="line">| 2020-05-01 | 2            |</span><br><span class="line">| 2020-05-02 | 0            |</span><br><span class="line">| 2020-05-03 | 20           |</span><br><span class="line">| 2020-05-04 | -1           |</span><br><span class="line">+------------+--------------+</span><br><span class="line"></span><br><span class="line">在 2020-05-01, 卖了 10 个苹果 和 8 个桔子 (差异为 10 - 8 &#x3D; 2).</span><br><span class="line">在 2020-05-02, 卖了 15 个苹果 和 15 个桔子 (差异为 15 - 15 &#x3D; 0).</span><br><span class="line">在 2020-05-03, 卖了 20 个苹果 和 0 个桔子 (差异为 20 - 0 &#x3D; 20).</span><br><span class="line">在 2020-05-04, 卖了 15 个苹果 和 16 个桔子 (差异为 15 - 16 &#x3D; -1).</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">91</span>_Sales (sale_date <span class="type">date</span>, fruit ENUM(<span class="string">&#x27;apples&#x27;</span>, <span class="string">&#x27;oranges&#x27;</span>), sold_num <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">91</span>_Sales;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">91</span>_Sales (sale_date, fruit, sold_num) <span class="keyword">values</span> (<span class="string">&#x27;2020-05-01&#x27;</span>, <span class="string">&#x27;apples&#x27;</span>, <span class="string">&#x27;10&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">91</span>_Sales (sale_date, fruit, sold_num) <span class="keyword">values</span> (<span class="string">&#x27;2020-05-01&#x27;</span>, <span class="string">&#x27;oranges&#x27;</span>, <span class="string">&#x27;8&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">91</span>_Sales (sale_date, fruit, sold_num) <span class="keyword">values</span> (<span class="string">&#x27;2020-05-02&#x27;</span>, <span class="string">&#x27;apples&#x27;</span>, <span class="string">&#x27;15&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">91</span>_Sales (sale_date, fruit, sold_num) <span class="keyword">values</span> (<span class="string">&#x27;2020-05-02&#x27;</span>, <span class="string">&#x27;oranges&#x27;</span>, <span class="string">&#x27;15&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">91</span>_Sales (sale_date, fruit, sold_num) <span class="keyword">values</span> (<span class="string">&#x27;2020-05-03&#x27;</span>, <span class="string">&#x27;apples&#x27;</span>, <span class="string">&#x27;20&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">91</span>_Sales (sale_date, fruit, sold_num) <span class="keyword">values</span> (<span class="string">&#x27;2020-05-03&#x27;</span>, <span class="string">&#x27;oranges&#x27;</span>, <span class="string">&#x27;0&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">91</span>_Sales (sale_date, fruit, sold_num) <span class="keyword">values</span> (<span class="string">&#x27;2020-05-04&#x27;</span>, <span class="string">&#x27;apples&#x27;</span>, <span class="string">&#x27;15&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">91</span>_Sales (sale_date, fruit, sold_num) <span class="keyword">values</span> (<span class="string">&#x27;2020-05-04&#x27;</span>, <span class="string">&#x27;oranges&#x27;</span>, <span class="string">&#x27;16&#x27;</span>);</span><br></pre></td></tr></table></figure>



<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">     s1.sale_date,</span><br><span class="line">     s1.sold_num <span class="operator">-</span> s2.sold_num <span class="keyword">as</span> diff</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">     <span class="number">91</span>_Sales s1</span><br><span class="line"><span class="keyword">join</span> </span><br><span class="line">     <span class="number">91</span>_Sales s2</span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">     s1.sale_date <span class="operator">=</span> s2.sale_date</span><br><span class="line">     <span class="keyword">and</span></span><br><span class="line">     s1.fruit <span class="operator">&lt;&gt;</span> s2.fruit</span><br><span class="line">     <span class="keyword">and</span> </span><br><span class="line">     s1.fruit <span class="operator">&lt;&gt;</span> <span class="string">&#x27;oranges&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法二</span></span><br><span class="line"><span class="keyword">select</span>  </span><br><span class="line">     sale_date,</span><br><span class="line">     sold_num <span class="operator">-</span> ld <span class="keyword">as</span> diff</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    (<span class="keyword">select</span></span><br><span class="line">          sale_date,</span><br><span class="line">          sold_num, </span><br><span class="line">          fruit,</span><br><span class="line">          <span class="built_in">lead</span>(sold_num ,<span class="number">1</span>,<span class="keyword">null</span>) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span>  sale_date ) ld</span><br><span class="line">     <span class="keyword">from</span> <span class="number">91</span>_Sales )t1</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">     fruit<span class="operator">=</span><span class="string">&#x27;apples&#x27;</span>;</span><br></pre></td></tr></table></figure>



<h2 id="92-活跃用户"><a href="#92-活跃用户" class="headerlink" title="92.  活跃用户"></a>92.  活跃用户</h2><p>写一个 SQL 查询, 找到活跃用户的 id 和 name，活跃用户是指那些至少连续 5 天登录账户的用户。返回的结果表按照 id 排序.</p>
<p>展示数据：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+----+----------+</span><br><span class="line">| id | name     |</span><br><span class="line">+----+----------+</span><br><span class="line">| 7  | Jonathan |</span><br><span class="line">+----+----------+</span><br><span class="line">id &#x3D; 1 的用户 Winston 仅仅在不同的 2 天内登录了 2 次, 所以, Winston 不是活跃用户.</span><br><span class="line">id &#x3D; 7 的用户 Jonathon 在不同的 6 天内登录了 7 次, , 6 天中有 5 天是连续的, 所以, Jonathan 是活跃用户.</span><br></pre></td></tr></table></figure>

<p> 建表语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">92</span>_Accounts (id <span class="type">int</span>, name <span class="type">varchar</span>(<span class="number">10</span>));</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">92</span>_Logins (id <span class="type">int</span>, login_date <span class="type">date</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">92</span>_Accounts;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">92</span>_Accounts (id, name) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Winston&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">92</span>_Accounts (id, name) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;Jonathan&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">92</span>_Logins;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">92</span>_Logins (id, login_date) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;2020-05-30&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">92</span>_Logins (id, login_date) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2020-05-30&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">92</span>_Logins (id, login_date) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;2020-05-31&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">92</span>_Logins (id, login_date) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;2020-06-01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">92</span>_Logins (id, login_date) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;2020-06-02&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">92</span>_Logins (id, login_date) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;2020-06-02&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">92</span>_Logins (id, login_date) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;2020-06-03&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">92</span>_Logins (id, login_date) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2020-06-07&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">92</span>_Logins (id, login_date) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;2020-06-10&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">      <span class="keyword">distinct</span> a.id,</span><br><span class="line">      a.name </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      <span class="number">92</span>_Accounts a,</span><br><span class="line">      <span class="number">92</span>_logins l1</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">      a.id<span class="operator">=</span>l1.id</span><br><span class="line">      <span class="keyword">and</span></span><br><span class="line">      (<span class="keyword">select</span></span><br><span class="line">             <span class="built_in">count</span>(<span class="keyword">distinct</span> l2.login_date)  </span><br><span class="line">       <span class="keyword">from</span> </span><br><span class="line">             <span class="number">92</span>_logins l2</span><br><span class="line">       <span class="keyword">where</span> </span><br><span class="line">             l1.id<span class="operator">=</span>l2.id</span><br><span class="line">             <span class="keyword">and</span> </span><br><span class="line">             datediff(l1.login_date,l2.login_date) <span class="keyword">between</span> <span class="number">0</span> <span class="keyword">and</span> <span class="number">4</span></span><br><span class="line">       )<span class="operator">&gt;=</span><span class="number">5</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法二</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">      <span class="keyword">distinct</span> a.id, a.name </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      <span class="number">92</span>_Accounts a</span><br><span class="line"><span class="keyword">join</span> </span><br><span class="line">      <span class="number">92</span>_Logins l1</span><br><span class="line"><span class="keyword">using</span>(id)</span><br><span class="line"><span class="keyword">join</span> </span><br><span class="line">      <span class="number">92</span>_Logins l2</span><br><span class="line"><span class="keyword">on</span></span><br><span class="line">      l1.id <span class="operator">=</span> l2.id</span><br><span class="line">      <span class="keyword">and</span></span><br><span class="line">      datediff(l2.login_date, l1.login_date) <span class="keyword">between</span> <span class="number">0</span> <span class="keyword">and</span> <span class="number">4</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">      a.id, a.name, l1.login_date</span><br><span class="line"><span class="keyword">having</span></span><br><span class="line">      <span class="built_in">count</span>(<span class="keyword">distinct</span> l2.login_date) <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法三</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">     t3.id,name</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    (<span class="keyword">select</span></span><br><span class="line">           <span class="keyword">distinct</span> id</span><br><span class="line">    <span class="keyword">from</span> </span><br><span class="line">          (<span class="keyword">select</span></span><br><span class="line">                 id,</span><br><span class="line">                 login_date,</span><br><span class="line">                 <span class="built_in">lead</span>(login_date,<span class="number">4</span>,<span class="keyword">null</span>) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> id <span class="keyword">order</span> <span class="keyword">by</span> login_date) ld</span><br><span class="line">           <span class="keyword">from</span> </span><br><span class="line">               (<span class="keyword">select</span></span><br><span class="line">                     id,</span><br><span class="line">                     login_date </span><br><span class="line">                <span class="keyword">from</span> </span><br><span class="line">                     <span class="number">92</span>_Logins</span><br><span class="line">                <span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">                     id,login_date</span><br><span class="line">               )t1</span><br><span class="line">           )t2</span><br><span class="line">    <span class="keyword">where</span> datediff(ld,login_date)<span class="operator">=</span><span class="number">4</span> </span><br><span class="line">    )t3</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">      <span class="number">92</span>_Accounts a</span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">      t3.id <span class="operator">=</span> a.id;</span><br></pre></td></tr></table></figure>

<h2 id="93-矩形面积"><a href="#93-矩形面积" class="headerlink" title="93. 矩形面积"></a>93. 矩形面积</h2><p>写一个 SQL 语句, 报告由表中任意两点可以形成的所有可能的矩形. </p>
<p>结果表中的每一行包含三列 (p1, p2, area) 如下:</p>
<ul>
<li><strong>p1</strong> 和 <strong>p2</strong> 是矩形两个对角的 id 且 p1 &lt; p2.</li>
<li>矩形的面积由列 <strong>area</strong> 表示. </li>
</ul>
<p>请按照面积大小降序排列，如果面积相同的话, 则按照 p1 和 p2 升序对结果表排序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">+----------+-------------+-------------+</span><br><span class="line">| p1       | p2          | area        |</span><br><span class="line">+----------+-------------+-------------+</span><br><span class="line">| 2        | 3           | 6           |</span><br><span class="line">| 1        | 2           | 2           |</span><br><span class="line">+----------+-------------+-------------+</span><br><span class="line"></span><br><span class="line">p1 应该小于 p2 并且面积大于 0.</span><br><span class="line">p1 &#x3D; 1 且 p2 &#x3D; 2 时, 面积等于 |2-4| * |8-7| &#x3D; 2.</span><br><span class="line">p1 &#x3D; 2 且 p2 &#x3D; 3 时, 面积等于 |4-2| * |7-10| &#x3D; 6.</span><br><span class="line">p1 &#x3D; 1 且 p2 &#x3D; 3 时, 是不可能为矩形的, 因为面积等于 0.</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">93</span>_Points (id <span class="type">int</span>, x_value <span class="type">int</span>, y_value <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">93</span>_Points;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">93</span>_Points (id, x_value, y_value) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;8&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">93</span>_Points (id, x_value, y_value) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;7&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">93</span>_Points (id, x_value, y_value) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;10&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">      a.id P1,</span><br><span class="line">      b.id P2,</span><br><span class="line">      <span class="built_in">abs</span>(a.x_value<span class="operator">-</span>b.x_value)<span class="operator">*</span><span class="built_in">abs</span>(a.y_value<span class="operator">-</span>b.y_value) <span class="keyword">as</span> area</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      Points a,Points b</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">      a.id<span class="operator">&lt;</span>b.id </span><br><span class="line">      <span class="keyword">and</span> </span><br><span class="line">      a.x_value <span class="operator">!=</span> b.x_value</span><br><span class="line">      <span class="keyword">and</span></span><br><span class="line">      a.y_value <span class="operator">!=</span> b.y_value</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">      area <span class="keyword">desc</span>,P1 ,P2 </span><br></pre></td></tr></table></figure>

<h2 id="94-计算税后工资"><a href="#94-计算税后工资" class="headerlink" title="94. 计算税后工资"></a>94. 计算税后工资</h2><p>写一条查询 SQL 来查找每个员工的税后工资</p>
<p>每个公司的税率计算依照以下规则</p>
<ul>
<li>如果这个公司员工最高工资不到 1000 ，税率为 0%</li>
<li>如果这个公司员工最高工资在 1000 到 10000 之间，税率为 24%</li>
<li>如果这个公司员工最高工资大于 10000 ，税率为 49%</li>
</ul>
<p>按任意顺序返回结果，税后工资结果取整</p>
<p>结果表格式如下例所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">+------------+-------------+---------------+--------+</span><br><span class="line">| company_id | employee_id | employee_name | salary |</span><br><span class="line">+------------+-------------+---------------+--------+</span><br><span class="line">| 1          | 1           | Tony          | 1020   |</span><br><span class="line">| 1          | 2           | Pronub        | 10863  |</span><br><span class="line">| 1          | 3           | Tyrrox        | 5508   |</span><br><span class="line">| 2          | 1           | Pam           | 300    |</span><br><span class="line">| 2          | 7           | Bassem        | 450    |</span><br><span class="line">| 2          | 9           | Hermione      | 700    |</span><br><span class="line">| 3          | 7           | Bocaben       | 76     |</span><br><span class="line">| 3          | 2           | Ognjen        | 1672   |</span><br><span class="line">| 3          | 13          | Nyancat       | 2508   |</span><br><span class="line">| 3          | 15          | Morninngcat   | 5911   |</span><br><span class="line">+------------+-------------+---------------+--------+</span><br><span class="line">对于公司 1 ，最高工资是 21300 ，其每个员工的税率为 49%</span><br><span class="line">对于公司 2 ，最高工资是 700 ，其每个员工税率为 0%</span><br><span class="line">对于公司 3 ，最高工资是 7777 ，其每个员工税率是 24%</span><br><span class="line">税后工资计算 &#x3D; 工资 - ( 税率 &#x2F; 100）*工资</span><br><span class="line">对于上述案例，Morninngcat 的税后工资 &#x3D; 7777 - 7777 * ( 24 &#x2F; 100) &#x3D; 7777 - 1866.48 &#x3D; 5910.52 ，取整为 5911</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">94</span>_Salaries (company_id <span class="type">int</span>, employee_id <span class="type">int</span>, employee_name <span class="type">varchar</span>(<span class="number">13</span>), salary <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">94</span>_Salaries;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">94</span>_Salaries (company_id, employee_id, employee_name, salary) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Tony&#x27;</span>, <span class="string">&#x27;2000&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">94</span>_Salaries (company_id, employee_id, employee_name, salary) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;Pronub&#x27;</span>, <span class="string">&#x27;21300&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">94</span>_Salaries (company_id, employee_id, employee_name, salary) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;Tyrrox&#x27;</span>, <span class="string">&#x27;10800&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">94</span>_Salaries (company_id, employee_id, employee_name, salary) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Pam&#x27;</span>, <span class="string">&#x27;300&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">94</span>_Salaries (company_id, employee_id, employee_name, salary) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;Bassem&#x27;</span>, <span class="string">&#x27;450&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">94</span>_Salaries (company_id, employee_id, employee_name, salary) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;Hermione&#x27;</span>, <span class="string">&#x27;700&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">94</span>_Salaries (company_id, employee_id, employee_name, salary) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;Bocaben&#x27;</span>, <span class="string">&#x27;100&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">94</span>_Salaries (company_id, employee_id, employee_name, salary) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;Ognjen&#x27;</span>, <span class="string">&#x27;2200&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">94</span>_Salaries (company_id, employee_id, employee_name, salary) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;13&#x27;</span>, <span class="string">&#x27;Nyancat&#x27;</span>, <span class="string">&#x27;3300&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">94</span>_Salaries (company_id, employee_id, employee_name, salary) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;15&#x27;</span>, <span class="string">&#x27;Morninngcat&#x27;</span>, <span class="string">&#x27;7777&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">     s1.company_id,</span><br><span class="line">     s1.employee_id,</span><br><span class="line">     s1.employee_name,</span><br><span class="line">     round(<span class="keyword">case</span></span><br><span class="line">               <span class="keyword">when</span> m.max_salary<span class="operator">&lt;</span><span class="number">1000</span> <span class="keyword">then</span> salary</span><br><span class="line">               <span class="keyword">when</span> m.maxsalary<span class="operator">&lt;</span><span class="number">10000</span> <span class="keyword">then</span> salary<span class="operator">*</span>(<span class="number">1</span><span class="number">-0.24</span>)</span><br><span class="line">               <span class="keyword">else</span> salary<span class="operator">*</span>(<span class="number">1</span><span class="number">-0.49</span>)</span><br><span class="line">           <span class="keyword">end</span> ,<span class="number">0</span>) salary</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">     <span class="number">94</span>_Salaries s1</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">    (<span class="keyword">select</span> </span><br><span class="line">           s2.company_id,</span><br><span class="line">           <span class="built_in">max</span>(s2.salary) max_salary</span><br><span class="line">     <span class="keyword">from</span></span><br><span class="line">           <span class="number">94</span>_Salaries s2</span><br><span class="line">     <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">           company_id</span><br><span class="line">     ) m</span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">     m.company_id <span class="operator">=</span> s1.conpany_id;</span><br><span class="line">     </span><br><span class="line"><span class="comment">-- 方法二</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">     company_id,</span><br><span class="line">     employee_id,</span><br><span class="line">     employee_name,</span><br><span class="line">     round(<span class="keyword">case</span></span><br><span class="line">               <span class="keyword">when</span> maxsalary<span class="operator">&lt;</span><span class="number">1000</span> <span class="keyword">then</span> salary</span><br><span class="line">               <span class="keyword">when</span> maxsalary<span class="operator">&lt;</span><span class="number">10000</span> <span class="keyword">then</span> salary<span class="operator">*</span>(<span class="number">1</span><span class="number">-0.24</span>)</span><br><span class="line">               <span class="keyword">else</span> salary<span class="operator">*</span>(<span class="number">1</span><span class="number">-0.49</span>)</span><br><span class="line">           <span class="keyword">end</span> ,<span class="number">0</span>) salary</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    (<span class="keyword">select</span> </span><br><span class="line">          <span class="operator">*</span>,</span><br><span class="line">          <span class="built_in">max</span>(salary) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> company_id ) maxsalary</span><br><span class="line">    <span class="keyword">from</span> Salaries )t1 ;</span><br></pre></td></tr></table></figure>

<h2 id="95-周内每天的销售情况"><a href="#95-周内每天的销售情况" class="headerlink" title="95. 周内每天的销售情况"></a>95. 周内每天的销售情况</h2><p>写一个SQL语句，报告 <strong>周内每天</strong> 每个商品类别下订购了多少单位。返回结果表单 <strong>按商品类别排序</strong> 。</p>
<p>查询结果格式如下例所示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">+------------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+</span><br><span class="line">| Category   | Monday    | Tuesday   | Wednesday | Thursday  | Friday    | Saturday  | Sunday    |</span><br><span class="line">+------------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+</span><br><span class="line">| Book       | 20        | 5         | 0         | 0         | 10        | 0         | 0         |</span><br><span class="line">| Glasses    | 0         | 0         | 0         | 0         | 5         | 0         | 0         |</span><br><span class="line">| Phone      | 0         | 0         | 5         | 1         | 0         | 0         | 10        |</span><br><span class="line">| T-Shirt    | 0         | 0         | 0         | 0         | 0         | 0         | 0         |</span><br><span class="line">+------------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+</span><br><span class="line">在周一(2020-06-01, 2020-06-08)，Book分类(ids: 1, 2)下，总共销售了20个单位(10 + 10)</span><br><span class="line">在周二(2020-06-02)，Book分类(ids: 1, 2)下，总共销售了5个单位</span><br><span class="line">在周三(2020-06-03)，Phone分类(ids: 3, 4)下，总共销售了5个单位</span><br><span class="line">在周四(2020-06-04)，Phone分类(ids: 3, 4)下，总共销售了1个单位</span><br><span class="line">在周五(2020-06-05)，Book分类(ids: 1, 2)下，总共销售了10个单位，Glasses分类(ids: 5)下，总共销售了5个单位</span><br><span class="line">在周六, 没有商品销售</span><br><span class="line">在周天(2020-06-14, 2020-06-21)，Phone分类(ids: 3, 4)下，总共销售了10个单位(5 + 5)</span><br><span class="line">没有销售 T-Shirt 类别的商品</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">95</span>_Orders (order_id <span class="type">int</span>, customer_id <span class="type">int</span>, order_date <span class="type">date</span>, item_id <span class="type">varchar</span>(<span class="number">30</span>), quantity <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">95</span>_Items (item_id <span class="type">varchar</span>(<span class="number">30</span>), item_name <span class="type">varchar</span>(<span class="number">30</span>), item_category <span class="type">varchar</span>(<span class="number">30</span>));</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">95</span>_Orders;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">95</span>_Orders (order_id, customer_id, order_date, item_id, quantity) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2020-06-01&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;10&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">95</span>_Orders (order_id, customer_id, order_date, item_id, quantity) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2020-06-08&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;10&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">95</span>_Orders (order_id, customer_id, order_date, item_id, quantity) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2020-06-02&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;5&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">95</span>_Orders (order_id, customer_id, order_date, item_id, quantity) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2020-06-03&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;5&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">95</span>_Orders (order_id, customer_id, order_date, item_id, quantity) <span class="keyword">values</span> (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;2020-06-04&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">95</span>_Orders (order_id, customer_id, order_date, item_id, quantity) <span class="keyword">values</span> (<span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;2020-06-05&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;5&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">95</span>_Orders (order_id, customer_id, order_date, item_id, quantity) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;2020-06-05&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;10&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">95</span>_Orders (order_id, customer_id, order_date, item_id, quantity) <span class="keyword">values</span> (<span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;2020-06-14&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;5&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">95</span>_Orders (order_id, customer_id, order_date, item_id, quantity) <span class="keyword">values</span> (<span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;2020-06-21&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;5&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">95</span>_Items;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">95</span>_Items (item_id, item_name, item_category) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;LC Alg. Book&#x27;</span>, <span class="string">&#x27;Book&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">95</span>_Items (item_id, item_name, item_category) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;LC DB. Book&#x27;</span>, <span class="string">&#x27;Book&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">95</span>_Items (item_id, item_name, item_category) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;LC SmarthPhone&#x27;</span>, <span class="string">&#x27;Phone&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">95</span>_Items (item_id, item_name, item_category) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;LC Phone 2020&#x27;</span>, <span class="string">&#x27;Phone&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">95</span>_Items (item_id, item_name, item_category) <span class="keyword">values</span> (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;LC SmartGlass&#x27;</span>, <span class="string">&#x27;Glasses&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">95</span>_Items (item_id, item_name, item_category) <span class="keyword">values</span> (<span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;LC T-Shirt XL&#x27;</span>, <span class="string">&#x27;T-shirt&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">     item_category <span class="keyword">as</span> category, </span><br><span class="line">     <span class="built_in">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> num <span class="operator">=</span> <span class="number">2</span> <span class="keyword">then</span> quantity <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span> Monday,</span><br><span class="line">     <span class="built_in">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> num <span class="operator">=</span> <span class="number">3</span> <span class="keyword">then</span> quantity <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span> Tuesday,</span><br><span class="line">     <span class="built_in">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> num <span class="operator">=</span> <span class="number">4</span> <span class="keyword">then</span> quantity <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span> Wednesday,</span><br><span class="line">     <span class="built_in">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> num <span class="operator">=</span> <span class="number">5</span> <span class="keyword">then</span> quantity <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span> Thursday,</span><br><span class="line">     <span class="built_in">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> num <span class="operator">=</span> <span class="number">6</span> <span class="keyword">then</span> quantity <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span> Friday,</span><br><span class="line">     <span class="built_in">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> num <span class="operator">=</span> <span class="number">7</span> <span class="keyword">then</span> quantity <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span> Saturday,</span><br><span class="line">     <span class="built_in">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> num <span class="operator">=</span> <span class="number">1</span> <span class="keyword">then</span> quantity <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span> Sunday</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    (<span class="keyword">select</span></span><br><span class="line">          item_category,</span><br><span class="line">          quantity,</span><br><span class="line">          dayofweek(order_date) <span class="keyword">as</span> num</span><br><span class="line">     <span class="keyword">from</span> </span><br><span class="line">          <span class="number">95</span>_items i</span><br><span class="line">     <span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">          <span class="number">95</span>_orders o </span><br><span class="line">     <span class="keyword">on</span> </span><br><span class="line">          i.item_id<span class="operator">=</span>o.item_id) t</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">     item_category</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">     item_category;</span><br></pre></td></tr></table></figure>

<h2 id="96-按日期分组销售产品"><a href="#96-按日期分组销售产品" class="headerlink" title="96. 按日期分组销售产品"></a>96. 按日期分组销售产品</h2><p>编写一个 SQL 查询来查找每个日期、销售的不同产品的数量及其名称。<br>每个日期的销售产品名称应按词典序排列。<br>返回按 <code>sell_date</code> 排序的结果表。</p>
<p>查询结果格式如下例所示。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">+------------+----------+------------------------------+</span><br><span class="line">| sell_date  | num_sold | products                     |</span><br><span class="line">+------------+----------+------------------------------+</span><br><span class="line">| 2020-05-30 | 3        | Basketball,Headphone,T-shirt |</span><br><span class="line">| 2020-06-01 | 2        | Bible,Pencil                 |</span><br><span class="line">| 2020-06-02 | 1        | Mask                         |</span><br><span class="line">+------------+----------+------------------------------+</span><br><span class="line">对于2020-05-30，出售的物品是 (Headphone, Basketball, T-shirt)，按词典序排列，并用逗号 &#39;,&#39; 分隔。</span><br><span class="line">对于2020-06-01，出售的物品是 (Pencil, Bible)，按词典序排列，并用逗号分隔。</span><br><span class="line">对于2020-06-02，出售的物品是 (Mask)，只需返回该物品名。</span><br></pre></td></tr></table></figure>

<p>建表语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">96</span>_Activities (sell_date <span class="type">date</span>, product <span class="type">varchar</span>(<span class="number">20</span>));</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">96</span>_Activities;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">96</span>_Activities (sell_date, product) <span class="keyword">values</span> (<span class="string">&#x27;2020-05-30&#x27;</span>, <span class="string">&#x27;Headphone&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">96</span>_Activities (sell_date, product) <span class="keyword">values</span> (<span class="string">&#x27;2020-06-01&#x27;</span>, <span class="string">&#x27;Pencil&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">96</span>_Activities (sell_date, product) <span class="keyword">values</span> (<span class="string">&#x27;2020-06-02&#x27;</span>, <span class="string">&#x27;Mask&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">96</span>_Activities (sell_date, product) <span class="keyword">values</span> (<span class="string">&#x27;2020-05-30&#x27;</span>, <span class="string">&#x27;Basketball&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">96</span>_Activities (sell_date, product) <span class="keyword">values</span> (<span class="string">&#x27;2020-06-01&#x27;</span>, <span class="string">&#x27;Bible&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">96</span>_Activities (sell_date, product) <span class="keyword">values</span> (<span class="string">&#x27;2020-06-02&#x27;</span>, <span class="string">&#x27;Mask&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">96</span>_Activities (sell_date, product) <span class="keyword">values</span> (<span class="string">&#x27;2020-05-30&#x27;</span>, <span class="string">&#x27;T-Shirt&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">     sell_date,</span><br><span class="line">     <span class="built_in">count</span>(<span class="keyword">distinct</span> product) num_sold, </span><br><span class="line">     group_concat(<span class="keyword">distinct</span> product <span class="keyword">order</span> <span class="keyword">by</span> product) products</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">     Activities</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">     sell_date;</span><br></pre></td></tr></table></figure>



<h2 id="97-上月播放的儿童适宜电影"><a href="#97-上月播放的儿童适宜电影" class="headerlink" title="97. 上月播放的儿童适宜电影"></a>97. 上月播放的儿童适宜电影</h2><p>写一个 SQL 语句, 报告在 2020 年 6 月份播放的儿童适宜电影的去重电影名.返回的结果表单没有顺序要求.</p>
<p>查询结果的格式如下例所示.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">+--------------+</span><br><span class="line">| title        |</span><br><span class="line">+--------------+</span><br><span class="line">| Aladdin      |</span><br><span class="line">+--------------+</span><br><span class="line">&quot;Leetcode Movie&quot; 是儿童不宜的电影.</span><br><span class="line">&quot;Alg. for Kids&quot; 不是电影.</span><br><span class="line">&quot;Database Sols&quot; 不是电影</span><br><span class="line">&quot;Alladin&quot; 是电影, 儿童适宜, 并且在 2020 年 6 月份播放.</span><br><span class="line">&quot;Cinderella&quot; 不在 2020 年 6 月份播放.</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">97</span>_TVProgram (program_date <span class="type">date</span>, content_id <span class="type">int</span>, channel <span class="type">varchar</span>(<span class="number">30</span>));</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">97</span>_Content (content_id <span class="type">varchar</span>(<span class="number">30</span>), title <span class="type">varchar</span>(<span class="number">30</span>), Kids_content ENUM(<span class="string">&#x27;Y&#x27;</span>, <span class="string">&#x27;N&#x27;</span>), content_type <span class="type">varchar</span>(<span class="number">30</span>));</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">97</span>_TVProgram;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">97</span>_TVProgram (program_date, content_id, channel) <span class="keyword">values</span> (<span class="string">&#x27;2020-06-10 08:00&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;LC-Channel&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">97</span>_TVProgram (program_date, content_id, channel) <span class="keyword">values</span> (<span class="string">&#x27;2020-05-11 12:00&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;LC-Channel&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">97</span>_TVProgram (program_date, content_id, channel) <span class="keyword">values</span> (<span class="string">&#x27;2020-05-12 12:00&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;LC-Channel&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">97</span>_TVProgram (program_date, content_id, channel) <span class="keyword">values</span> (<span class="string">&#x27;2020-05-13 14:00&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;Disney Ch&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">97</span>_TVProgram (program_date, content_id, channel) <span class="keyword">values</span> (<span class="string">&#x27;2020-06-18 14:00&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;Disney Ch&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">97</span>_TVProgram (program_date, content_id, channel) <span class="keyword">values</span> (<span class="string">&#x27;2020-07-15 16:00&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;Disney Ch&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">97</span>_Content;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">97</span>_Content (content_id, title, Kids_content, content_type) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Leetcode Movie&#x27;</span>, <span class="string">&#x27;N&#x27;</span>, <span class="string">&#x27;Movies&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">97</span>_Content (content_id, title, Kids_content, content_type) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;Alg. for Kids&#x27;</span>, <span class="string">&#x27;Y&#x27;</span>, <span class="string">&#x27;Series&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">97</span>_Content (content_id, title, Kids_content, content_type) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;Database Sols&#x27;</span>, <span class="string">&#x27;N&#x27;</span>, <span class="string">&#x27;Series&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">97</span>_Content (content_id, title, Kids_content, content_type) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;Aladdin&#x27;</span>, <span class="string">&#x27;Y&#x27;</span>, <span class="string">&#x27;Movies&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">97</span>_Content (content_id, title, Kids_content, content_type) <span class="keyword">values</span> (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;Cinderella&#x27;</span>, <span class="string">&#x27;Y&#x27;</span>, <span class="string">&#x27;Movies&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">     <span class="keyword">distinct</span> title   </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">     <span class="number">97</span>_TVProgram t </span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">     <span class="number">97</span>_Content c</span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">     t.content_id  <span class="operator">=</span> c.content_id </span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">     Kids_content <span class="operator">=</span><span class="string">&#x27;Y&#x27;</span> </span><br><span class="line">     <span class="keyword">and</span></span><br><span class="line">     date_format(program_date ,<span class="string">&#x27;%Y-%m&#x27;</span>)<span class="operator">=</span><span class="string">&#x27;2020-06&#x27;</span></span><br><span class="line">     <span class="keyword">and</span></span><br><span class="line">     content_type<span class="operator">=</span><span class="string">&#x27;Movies&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h2 id="98-可以放心投资的国家"><a href="#98-可以放心投资的国家" class="headerlink" title="98. 可以放心投资的国家"></a>98. 可以放心投资的国家</h2><p>写一段 SQL, 找到所有该公司可以投资的国家（该国的平均通话时长要严格地大于全球平均通话时长）.返回的结果表没有顺序要求.</p>
<p>查询的结果格式如下例所示.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">+----------+</span><br><span class="line">| country  |</span><br><span class="line">+----------+</span><br><span class="line">| Peru     |</span><br><span class="line">+----------+</span><br><span class="line">国家Peru的平均通话时长是 (102 + 102 + 330 + 330 + 5 + 5) &#x2F; 6 &#x3D; 145.666667</span><br><span class="line">国家Israel的平均通话时长是 (33 + 4 + 13 + 13 + 3 + 1 + 1 + 7) &#x2F; 8 &#x3D; 9.37500</span><br><span class="line">国家Morocco的平均通话时长是 (33 + 4 + 59 + 59 + 3 + 7) &#x2F; 6 &#x3D; 27.5000 </span><br><span class="line">全球平均通话时长 &#x3D; (2 * (33 + 3 + 59 + 102 + 330 + 5 + 13 + 3 + 1 + 7)) &#x2F; 20 &#x3D; 55.70000</span><br><span class="line">所以, Peru是唯一的平均通话时长大于全球平均通话时长的国家, 也是唯一的推荐投资的国家.</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">98</span>_Person (id <span class="type">int</span>, name <span class="type">varchar</span>(<span class="number">15</span>), phone_number <span class="type">varchar</span>(<span class="number">11</span>));</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">98</span>_Country (name <span class="type">varchar</span>(<span class="number">15</span>), country_code <span class="type">varchar</span>(<span class="number">3</span>));</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">98</span>_Calls (caller_id <span class="type">int</span>, callee_id <span class="type">int</span>, duration <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">98</span>_Person;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">98</span>_Person (id, name, phone_number) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;Jonathan&#x27;</span>, <span class="string">&#x27;051-1234567&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">98</span>_Person (id, name, phone_number) <span class="keyword">values</span> (<span class="string">&#x27;12&#x27;</span>, <span class="string">&#x27;Elvis&#x27;</span>, <span class="string">&#x27;051-7654321&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">98</span>_Person (id, name, phone_number) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Moncef&#x27;</span>, <span class="string">&#x27;212-1234567&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">98</span>_Person (id, name, phone_number) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;Maroua&#x27;</span>, <span class="string">&#x27;212-6523651&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">98</span>_Person (id, name, phone_number) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;Meir&#x27;</span>, <span class="string">&#x27;972-1234567&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">98</span>_Person (id, name, phone_number) <span class="keyword">values</span> (<span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;Rachel&#x27;</span>, <span class="string">&#x27;972-0011100&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">98</span>_Country;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">98</span>_Country (name, country_code) <span class="keyword">values</span> (<span class="string">&#x27;Peru&#x27;</span>, <span class="string">&#x27;051&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">98</span>_Country (name, country_code) <span class="keyword">values</span> (<span class="string">&#x27;Israel&#x27;</span>, <span class="string">&#x27;972&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">98</span>_Country (name, country_code) <span class="keyword">values</span> (<span class="string">&#x27;Morocco&#x27;</span>, <span class="string">&#x27;212&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">98</span>_Country (name, country_code) <span class="keyword">values</span> (<span class="string">&#x27;Germany&#x27;</span>, <span class="string">&#x27;049&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">98</span>_Country (name, country_code) <span class="keyword">values</span> (<span class="string">&#x27;Ethiopia&#x27;</span>, <span class="string">&#x27;251&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">98</span>_Calls;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">98</span>_Calls (caller_id, callee_id, duration) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;33&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">98</span>_Calls (caller_id, callee_id, duration) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;4&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">98</span>_Calls (caller_id, callee_id, duration) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;59&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">98</span>_Calls (caller_id, callee_id, duration) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;12&#x27;</span>, <span class="string">&#x27;102&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">98</span>_Calls (caller_id, callee_id, duration) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;12&#x27;</span>, <span class="string">&#x27;330&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">98</span>_Calls (caller_id, callee_id, duration) <span class="keyword">values</span> (<span class="string">&#x27;12&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;5&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">98</span>_Calls (caller_id, callee_id, duration) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;13&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">98</span>_Calls (caller_id, callee_id, duration) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;3&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">98</span>_Calls (caller_id, callee_id, duration) <span class="keyword">values</span> (<span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">98</span>_Calls (caller_id, callee_id, duration) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;7&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">     c2.name <span class="keyword">as</span> country </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">     <span class="number">98</span>_Calls c1,</span><br><span class="line">     <span class="number">98</span>_Person p,</span><br><span class="line">     <span class="number">98</span>_Country c2</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    (p.id<span class="operator">=</span>c1.caller_id <span class="keyword">or</span> p.id<span class="operator">=</span>c1.callee_id) </span><br><span class="line">     <span class="keyword">and</span></span><br><span class="line">     c2.country_code<span class="operator">=</span><span class="keyword">left</span>(p.phone_number,<span class="number">3</span>)</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">     c2.name </span><br><span class="line"><span class="keyword">having</span></span><br><span class="line">     <span class="built_in">avg</span>(duration)<span class="operator">&gt;</span>(<span class="keyword">select</span> <span class="built_in">avg</span>(duration) <span class="keyword">from</span> <span class="number">98</span>_Calls);</span><br></pre></td></tr></table></figure>



<h2 id="99-消费者下单频率"><a href="#99-消费者下单频率" class="headerlink" title="99. 消费者下单频率"></a>99. 消费者下单频率</h2><p>写一个 SQL 语句, 报告消费者的 id 和名字, 其中消费者在 2020 年 6 月和 7 月, 每月至少花费了$100.结果表无顺序要求.</p>
<p>查询结果格式如下例所示.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">+--------------+------------+</span><br><span class="line">| customer_id  | name       |  </span><br><span class="line">+--------------+------------+</span><br><span class="line">| 1            | Winston    |</span><br><span class="line">+--------------+------------+ </span><br><span class="line">Winston 在2020年6月花费了$300(300 * 1), 在7月花费了$100(10 * 1 + 45 * 2).</span><br><span class="line">Jonathan 在2020年6月花费了$600(300 * 2), 在7月花费了$20(2 * 10).</span><br><span class="line">Moustafa 在2020年6月花费了$110 (10 * 2 + 45 * 2), 在7月花费了$0.</span><br></pre></td></tr></table></figure>

<p>建表语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">99</span>_Customers (customer_id <span class="type">int</span>, name <span class="type">varchar</span>(<span class="number">30</span>), country <span class="type">varchar</span>(<span class="number">30</span>));</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">99</span>_Product (product_id <span class="type">int</span>, description <span class="type">varchar</span>(<span class="number">30</span>), price <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">99</span>_Orders (order_id <span class="type">int</span>, customer_id <span class="type">int</span>, product_id <span class="type">int</span>, order_date <span class="type">date</span>, quantity <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">99</span>_Customers;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">99</span>_Customers (customer_id, name, country) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Winston&#x27;</span>, <span class="string">&#x27;USA&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">99</span>_Customers (customer_id, name, country) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;Jonathan&#x27;</span>, <span class="string">&#x27;Peru&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">99</span>_Customers (customer_id, name, country) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;Moustafa&#x27;</span>, <span class="string">&#x27;Egypt&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">99</span>_Product;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">99</span>_Product (product_id, description, price) <span class="keyword">values</span> (<span class="string">&#x27;10&#x27;</span>, <span class="string">&#x27;LC Phone&#x27;</span>, <span class="string">&#x27;300&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">99</span>_Product (product_id, description, price) <span class="keyword">values</span> (<span class="string">&#x27;20&#x27;</span>, <span class="string">&#x27;LC T-Shirt&#x27;</span>, <span class="string">&#x27;10&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">99</span>_Product (product_id, description, price) <span class="keyword">values</span> (<span class="string">&#x27;30&#x27;</span>, <span class="string">&#x27;LC Book&#x27;</span>, <span class="string">&#x27;45&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">99</span>_Product (product_id, description, price) <span class="keyword">values</span> (<span class="string">&#x27;40&#x27;</span>, <span class="string">&#x27;LC Keychain&#x27;</span>, <span class="string">&#x27;2&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">99</span>_Orders;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">99</span>_Orders (order_id, customer_id, product_id, order_date, quantity) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;10&#x27;</span>, <span class="string">&#x27;2020-06-10&#x27;</span>, <span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">99</span>_Orders (order_id, customer_id, product_id, order_date, quantity) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;20&#x27;</span>, <span class="string">&#x27;2020-07-01&#x27;</span>, <span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">99</span>_Orders (order_id, customer_id, product_id, order_date, quantity) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;30&#x27;</span>, <span class="string">&#x27;2020-07-08&#x27;</span>, <span class="string">&#x27;2&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">99</span>_Orders (order_id, customer_id, product_id, order_date, quantity) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;10&#x27;</span>, <span class="string">&#x27;2020-06-15&#x27;</span>, <span class="string">&#x27;2&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">99</span>_Orders (order_id, customer_id, product_id, order_date, quantity) <span class="keyword">values</span> (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;40&#x27;</span>, <span class="string">&#x27;2020-07-01&#x27;</span>, <span class="string">&#x27;10&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">99</span>_Orders (order_id, customer_id, product_id, order_date, quantity) <span class="keyword">values</span> (<span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;20&#x27;</span>, <span class="string">&#x27;2020-06-24&#x27;</span>, <span class="string">&#x27;2&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">99</span>_Orders (order_id, customer_id, product_id, order_date, quantity) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;30&#x27;</span>, <span class="string">&#x27;2020-06-25&#x27;</span>, <span class="string">&#x27;2&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">99</span>_Orders (order_id, customer_id, product_id, order_date, quantity) <span class="keyword">values</span> (<span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;30&#x27;</span>, <span class="string">&#x27;2020-05-08&#x27;</span>, <span class="string">&#x27;3&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">     customer_id,name</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">     Customers</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">     customer_id <span class="keyword">in</span> (<span class="keyword">select</span></span><br><span class="line">                          customer_id</span><br><span class="line">                     <span class="keyword">from</span></span><br><span class="line">                         (<span class="keyword">select</span> </span><br><span class="line">                                customer_id,</span><br><span class="line">                                <span class="keyword">month</span>(order_date) <span class="keyword">as</span> <span class="keyword">month</span>,</span><br><span class="line">                                <span class="built_in">sum</span>(quantity<span class="operator">*</span>price) <span class="keyword">as</span> total</span><br><span class="line">                          <span class="keyword">from</span> </span><br><span class="line">                                Orders o </span><br><span class="line">                          <span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">                                Product p</span><br><span class="line">                          <span class="keyword">on</span> </span><br><span class="line">                                o.product_id <span class="operator">=</span> p.product_id</span><br><span class="line">                          <span class="keyword">where</span></span><br><span class="line">                                <span class="keyword">month</span>(order_date) <span class="operator">=</span> <span class="number">6</span> <span class="keyword">or</span> <span class="keyword">month</span>(order_date)<span class="operator">=</span><span class="number">7</span></span><br><span class="line">                          <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">                                customer_id,<span class="keyword">month</span>(order_date)</span><br><span class="line">                          ) <span class="keyword">as</span> t1</span><br><span class="line">                    <span class="keyword">where</span> </span><br><span class="line">                          total <span class="operator">&gt;=</span><span class="number">100</span></span><br><span class="line">                    <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">                          customer_id</span><br><span class="line">                    <span class="keyword">having</span></span><br><span class="line">                          <span class="built_in">count</span>(<span class="operator">*</span>)<span class="operator">&gt;=</span><span class="number">2</span> );</span><br></pre></td></tr></table></figure>



<h2 id="100-查找拥有有效邮箱的用户"><a href="#100-查找拥有有效邮箱的用户" class="headerlink" title="100. 查找拥有有效邮箱的用户"></a>100. 查找拥有有效邮箱的用户</h2><p>Write an SQL query to find the users who have <strong>valid emails</strong>.</p>
<p>A valid e-mail has a prefix name and a domain where: </p>
<ul>
<li><strong>The prefix name</strong> is a string that may contain letters (upper or lower case), digits, underscore <code>&#39;_&#39;</code>, period <code>&#39;.&#39;</code> and/or dash <code>&#39;-&#39;</code>. The prefix name <strong>must</strong> start with a letter.</li>
<li><strong>The domain</strong> is <code>&#39;@leetcode.com&#39;</code>.</li>
</ul>
<p>Return the result table in any order.</p>
<p>The query result format is in the following example.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">+---------+-----------+-------------------------+</span><br><span class="line">| user_id | name      | mail                    |</span><br><span class="line">+---------+-----------+-------------------------+</span><br><span class="line">| 1       | Winston   | winston@leetcode.com    |</span><br><span class="line">| 3       | Annabelle | bella-@leetcode.com     |</span><br><span class="line">| 4       | Sally     | sally.come@leetcode.com |</span><br><span class="line">+---------+-----------+-------------------------+</span><br><span class="line">The mail of user 2 doesn&#39;t have a domain.</span><br><span class="line">The mail of user 5 has # sign which is not allowed.</span><br><span class="line">The mail of user 6 doesn&#39;t have leetcode domain.</span><br><span class="line">The mail of user 7 starts with a period.</span><br></pre></td></tr></table></figure>

<p>建表语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">100</span>_Users (user_id <span class="type">int</span>, name <span class="type">varchar</span>(<span class="number">30</span>), mail <span class="type">varchar</span>(<span class="number">50</span>));</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">100</span>_Users;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">100</span>_Users (user_id, name, mail) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Winston&#x27;</span>, <span class="string">&#x27;winston@leetcode.com&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">100</span>_Users (user_id, name, mail) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;Jonathan&#x27;</span>, <span class="string">&#x27;jonathanisgreat&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">100</span>_Users (user_id, name, mail) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;Annabelle&#x27;</span>, <span class="string">&#x27;bella-@leetcode.com&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">100</span>_Users (user_id, name, mail) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;Sally&#x27;</span>, <span class="string">&#x27;sally.come@leetcode.com&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">100</span>_Users (user_id, name, mail) <span class="keyword">values</span> (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;Marwan&#x27;</span>, <span class="string">&#x27;quarz#2020@leetcode.com&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">100</span>_Users (user_id, name, mail) <span class="keyword">values</span> (<span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;David&#x27;</span>, <span class="string">&#x27;david69@gmail.com&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">100</span>_Users (user_id, name, mail) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;Shapiro&#x27;</span>, <span class="string">&#x27;.shapo@leetcode.com&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">      <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">      <span class="number">100</span>_Users</span><br><span class="line"><span class="keyword">WHERE</span> </span><br><span class="line">      mail REGEXP <span class="string">&#x27;^[a-zA-Z]+[\\w_\\.\\-]*@leetcode.com$&#x27;</span>   </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">      user_id;</span><br></pre></td></tr></table></figure>

<h2 id=""><a href="#" class="headerlink" title=""></a></h2>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hf7751.gitee.io/2021/03/11/61-80/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="hefei">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="元">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/03/11/61-80/" class="post-title-link" itemprop="url">بدون عنوان</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">نُشر في</span>

      <time title="أُنشأ: 2021-03-11 02:36:18" itemprop="dateCreated datePublished" datetime="2021-03-11T02:36:18+08:00">2021-03-11</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">عُدل في</span>
        <time title="عُدل: 2021-03-04 15:48:33" itemprop="dateModified" datetime="2021-03-04T15:48:33+08:00">2021-03-04</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="61-查询结果的质量和占比"><a href="#61-查询结果的质量和占比" class="headerlink" title="61. 查询结果的质量和占比"></a>61. 查询结果的质量和占比</h2><p>需求：编写一组 SQL 来查找每次查询的<code>名称</code>(<code>query_name</code>)、<code>质量</code>(<code>quality</code>) 和 <code>劣质查询百分比</code>(<code>poor_query_percentage</code>)。</p>
<p><code>质量</code>(<code>quality</code>) 和<code>劣质查询百分比</code>(<code>poor_query_percentage</code>) 都应四舍五入到小数点后两位。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>query_name</th>
<th>quality</th>
<th>poor_query_percentage</th>
</tr>
</thead>
<tbody><tr>
<td>Dog</td>
<td>2.50</td>
<td>33.33</td>
</tr>
<tr>
<td>Cat</td>
<td>0.66</td>
<td>33.33</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">61</span>_Queries (query_name <span class="type">varchar</span>(<span class="number">30</span>), <span class="keyword">result</span> <span class="type">varchar</span>(<span class="number">50</span>), position <span class="type">int</span>, rating <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">61</span>_Queries;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">61</span>_Queries (query_name, <span class="keyword">result</span>, position, rating) <span class="keyword">values</span> (<span class="string">&#x27;Dog&#x27;</span>, <span class="string">&#x27;Golden Retriever&#x27;</span>, <span class="number">1</span>, <span class="number">5</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">61</span>_Queries (query_name, <span class="keyword">result</span>, position, rating) <span class="keyword">values</span> (<span class="string">&#x27;Dog&#x27;</span>, <span class="string">&#x27;German Shepherd&#x27;</span>, <span class="number">2</span>, <span class="number">5</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">61</span>_Queries (query_name, <span class="keyword">result</span>, position, rating) <span class="keyword">values</span> (<span class="string">&#x27;Dog&#x27;</span>, <span class="string">&#x27;Mule&#x27;</span>, <span class="string">&#x27;200&#x27;</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">61</span>_Queries (query_name, <span class="keyword">result</span>, position, rating) <span class="keyword">values</span> (<span class="string">&#x27;Cat&#x27;</span>, <span class="string">&#x27;Shirazi&#x27;</span>, <span class="number">5</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">61</span>_Queries (query_name, <span class="keyword">result</span>, position, rating) <span class="keyword">values</span> (<span class="string">&#x27;Cat&#x27;</span>, <span class="string">&#x27;Siamese&#x27;</span>, <span class="number">3</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">61</span>_Queries (query_name, <span class="keyword">result</span>, position, rating) <span class="keyword">values</span> (<span class="string">&#x27;Cat&#x27;</span>, <span class="string">&#x27;Sphynx&#x27;</span>, <span class="number">7</span>, <span class="number">4</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">      query_name,</span><br><span class="line">      round(<span class="built_in">avg</span>(rating<span class="operator">/</span>position), <span class="number">2</span>) <span class="keyword">as</span> quality ,</span><br><span class="line">      round((<span class="built_in">count</span>(if(rating<span class="operator">&lt;</span><span class="number">3</span>, <span class="literal">True</span>, <span class="keyword">null</span>)) <span class="operator">/</span> <span class="built_in">count</span>(query_name)) <span class="operator">*</span><span class="number">100</span> , <span class="number">2</span>) <span class="keyword">as</span> poor_query_percentage</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">      <span class="number">61</span>_Queries</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">      query_name</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> query_name <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure>

<h2 id="62-查询球队积分"><a href="#62-查询球队积分" class="headerlink" title="62. 查询球队积分"></a>62. 查询球队积分</h2><p>需求一：写出一条SQL语句以查询每个队的 <strong>team_id</strong>，<strong>team_name</strong> 和 <strong>num_points</strong>。结果根据 num_points <strong>降序排序</strong>，如果有两队积分相同，那么这两队按 team_id <strong>升序排序</strong>。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>team_id</th>
<th>team_name</th>
<th>num_points</th>
</tr>
</thead>
<tbody><tr>
<td>10</td>
<td>Leetcode FC</td>
<td>7</td>
</tr>
<tr>
<td>20</td>
<td>NewYork FC</td>
<td>3</td>
</tr>
<tr>
<td>50</td>
<td>Toronto FC</td>
<td>3</td>
</tr>
<tr>
<td>30</td>
<td>Atlanta FC</td>
<td>1</td>
</tr>
<tr>
<td>40</td>
<td>Chicago FC</td>
<td>0</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">62</span>_Teams (team_id <span class="type">int</span>, team_name <span class="type">varchar</span>(<span class="number">30</span>));</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">62</span>_Matches (match_id <span class="type">int</span>, host_team <span class="type">int</span>, guest_team <span class="type">int</span>, host_goals <span class="type">int</span>, guest_goals <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">62</span>_Teams;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">62</span>_Teams (team_id, team_name) <span class="keyword">values</span> (<span class="number">10</span>, <span class="string">&#x27;Leetcode FC&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">62</span>_Teams (team_id, team_name) <span class="keyword">values</span> (<span class="number">20</span>, <span class="string">&#x27;NewYork FC&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">62</span>_Teams (team_id, team_name) <span class="keyword">values</span> (<span class="number">30</span>, <span class="string">&#x27;Atlanta FC&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">62</span>_Teams (team_id, team_name) <span class="keyword">values</span> (<span class="number">40</span>, <span class="string">&#x27;Chicago FC&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">62</span>_Teams (team_id, team_name) <span class="keyword">values</span> (<span class="number">50</span>, <span class="string">&#x27;Toronto FC&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">62</span>_Matches;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">62</span>_Matches (match_id, host_team, guest_team, host_goals, guest_goals) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">62</span>_Matches (match_id, host_team, guest_team, host_goals, guest_goals) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">30</span>, <span class="number">10</span>, <span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">62</span>_Matches (match_id, host_team, guest_team, host_goals, guest_goals) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">5</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">62</span>_Matches (match_id, host_team, guest_team, host_goals, guest_goals) <span class="keyword">values</span> (<span class="number">4</span>, <span class="number">20</span>, <span class="number">30</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">62</span>_Matches (match_id, host_team, guest_team, host_goals, guest_goals) <span class="keyword">values</span> (<span class="number">5</span>, <span class="number">50</span>, <span class="number">30</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">     <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    (<span class="keyword">SELECT</span> </span><br><span class="line">           a.team_id,</span><br><span class="line">           <span class="built_in">MAX</span>(team_name) <span class="keyword">AS</span> team_name,</span><br><span class="line">           <span class="built_in">SUM</span>(</span><br><span class="line">                <span class="keyword">CASE</span> </span><br><span class="line">			        <span class="keyword">WHEN</span> a.team_id <span class="operator">=</span> b.host_team <span class="keyword">THEN</span> </span><br><span class="line">				    <span class="keyword">CASE</span> </span><br><span class="line">					    <span class="keyword">WHEN</span> b.host_goals <span class="operator">&gt;</span> b.guest_goals <span class="keyword">THEN</span> <span class="number">3</span></span><br><span class="line">					    <span class="keyword">WHEN</span> b.host_goals <span class="operator">=</span> b.guest_goals <span class="keyword">THEN</span> <span class="number">1</span></span><br><span class="line">			            <span class="keyword">ELSE</span> <span class="number">0</span></span><br><span class="line">				    <span class="keyword">END</span></span><br><span class="line">			        <span class="keyword">WHEN</span> a.team_id <span class="operator">=</span> b.guest_team <span class="keyword">THEN</span> </span><br><span class="line">				    <span class="keyword">CASE</span> </span><br><span class="line">					    <span class="keyword">WHEN</span> b.host_goals <span class="operator">&lt;</span> b.guest_goals <span class="keyword">THEN</span> <span class="number">3</span></span><br><span class="line">					    <span class="keyword">WHEN</span> b.host_goals <span class="operator">=</span> b.guest_goals <span class="keyword">THEN</span> <span class="number">1</span></span><br><span class="line">					    <span class="keyword">ELSE</span> <span class="number">0</span></span><br><span class="line">				    <span class="keyword">END</span></span><br><span class="line">			        <span class="keyword">ELSE</span> <span class="number">0</span></span><br><span class="line">		       <span class="keyword">END</span></span><br><span class="line">           ) <span class="keyword">AS</span> num_points</span><br><span class="line">	<span class="keyword">FROM</span> </span><br><span class="line">         <span class="number">62</span>_Teams a</span><br><span class="line">    <span class="keyword">LEFT</span> <span class="keyword">JOIN</span></span><br><span class="line">         <span class="number">62</span>_Matches b</span><br><span class="line">    <span class="keyword">ON</span> </span><br><span class="line">         a.team_id <span class="operator">=</span> b.host_team <span class="keyword">OR</span> </span><br><span class="line">         a.team_id <span class="operator">=</span> b.guest_team</span><br><span class="line">	<span class="keyword">GROUP</span> <span class="keyword">BY</span> a.team_id</span><br><span class="line">    ) a </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">    a.num_points <span class="keyword">DESC</span>,</span><br><span class="line">    a.team_id;</span><br></pre></td></tr></table></figure>

<h2 id="63-报告系统状态的连续日期"><a href="#63-报告系统状态的连续日期" class="headerlink" title="63. 报告系统状态的连续日期"></a>63. 报告系统状态的连续日期</h2><p>需求：系统 每天 运行一个任务。每个任务都独立于先前的任务。任务的状态可以是失败或是成功。编写一个 SQL 查询 2019-01-01 到 2019-12-31 期间任务连续同状态 period_state 的起止日期（start_date 和 end_date）。即如果任务失败了，就是失败状态的起止日期，如果任务成功了，就是成功状态的起止日期。最后结果按照起始日期 start_date 排序。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>period_state</th>
<th>start date</th>
<th>end date</th>
</tr>
</thead>
<tbody><tr>
<td>present</td>
<td>2019-01-01</td>
<td>2019-01-03</td>
</tr>
<tr>
<td>missing</td>
<td>2019-01-04</td>
<td>2019-01-05</td>
</tr>
<tr>
<td>present</td>
<td>2019-01-06</td>
<td>2019-01-06</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">63</span>_Failed (fail_date <span class="type">date</span>);</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">63</span>_Succeeded (success_date <span class="type">date</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">63</span>_Failed;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">63</span>_Failed (fail_date) <span class="keyword">values</span> (<span class="string">&#x27;2018-12-28&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">63</span>_Failed (fail_date) <span class="keyword">values</span> (<span class="string">&#x27;2018-12-29&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">63</span>_Failed (fail_date) <span class="keyword">values</span> (<span class="string">&#x27;2019-01-04&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">63</span>_Failed (fail_date) <span class="keyword">values</span> (<span class="string">&#x27;2019-01-05&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">63</span>_Succeeded;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">63</span>_Succeeded (success_date) <span class="keyword">values</span> (<span class="string">&#x27;2018-12-30&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">63</span>_Succeeded (success_date) <span class="keyword">values</span> (<span class="string">&#x27;2018-12-31&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">63</span>_Succeeded (success_date) <span class="keyword">values</span> (<span class="string">&#x27;2019-01-01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">63</span>_Succeeded (success_date) <span class="keyword">values</span> (<span class="string">&#x27;2019-01-02&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">63</span>_Succeeded (success_date) <span class="keyword">values</span> (<span class="string">&#x27;2019-01-03&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">63</span>_Succeeded (success_date) <span class="keyword">values</span> (<span class="string">&#x27;2019-01-06&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">      if(str<span class="operator">=</span><span class="number">1</span>,<span class="string">&#x27;succeeded&#x27;</span>,<span class="string">&#x27;failed&#x27;</span>) <span class="keyword">as</span> period_state ,</span><br><span class="line">      <span class="built_in">min</span>(<span class="type">date</span>) <span class="keyword">as</span> start_date,</span><br><span class="line">      <span class="built_in">max</span>(<span class="type">date</span>) <span class="keyword">as</span> end_date</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">     (<span class="keyword">select</span> </span><br><span class="line">            <span class="variable">@diff</span> :<span class="operator">=</span> <span class="variable">@diff</span><span class="operator">+</span> if(num <span class="operator">=</span> <span class="number">1</span> , <span class="number">1</span>,<span class="number">0</span>) <span class="keyword">as</span> diff,</span><br><span class="line">            <span class="type">date</span>,</span><br><span class="line">            str</span><br><span class="line">      <span class="keyword">from</span></span><br><span class="line">           (<span class="keyword">select</span> </span><br><span class="line">                  <span class="keyword">case</span> </span><br><span class="line">                      <span class="keyword">when</span> <span class="variable">@str</span> <span class="operator">=</span> str <span class="keyword">and</span>  date_add(<span class="variable">@pre</span>,<span class="type">interval</span> <span class="number">1</span> <span class="keyword">day</span>) <span class="operator">=</span> <span class="type">date</span>  <span class="keyword">then</span> <span class="variable">@num</span> :<span class="operator">=</span> <span class="variable">@num</span> <span class="operator">+</span><span class="number">1</span></span><br><span class="line">                      <span class="keyword">when</span> <span class="variable">@str</span>:<span class="operator">=</span>str <span class="keyword">then</span>  <span class="variable">@num</span> :<span class="operator">=</span> <span class="number">1</span></span><br><span class="line">                      <span class="keyword">else</span> <span class="variable">@num</span> :<span class="operator">=</span> <span class="number">1</span></span><br><span class="line">                  <span class="keyword">end</span> <span class="keyword">as</span> num,</span><br><span class="line">                  <span class="variable">@pre</span> :<span class="operator">=</span> <span class="type">date</span>,</span><br><span class="line">                  <span class="type">date</span>,</span><br><span class="line">                  str</span><br><span class="line">            <span class="keyword">from</span> </span><br><span class="line">                 (<span class="keyword">select</span> </span><br><span class="line">                        fail_date <span class="keyword">as</span> <span class="type">date</span> ,</span><br><span class="line">                        <span class="number">0</span> <span class="keyword">as</span> <span class="string">&#x27;str&#x27;</span></span><br><span class="line">                  <span class="keyword">from</span> </span><br><span class="line">                        <span class="number">63</span>_Failed </span><br><span class="line">                  <span class="keyword">union</span>  </span><br><span class="line">                  <span class="keyword">select</span></span><br><span class="line">                        success_date,</span><br><span class="line">                        <span class="number">1</span></span><br><span class="line">                  <span class="keyword">from</span> </span><br><span class="line">                        <span class="number">63</span>_Succeeded </span><br><span class="line">                 ) s,</span><br><span class="line">                 (<span class="keyword">select</span> <span class="variable">@pre</span>:<span class="operator">=</span><span class="keyword">null</span>,<span class="variable">@num</span>:<span class="operator">=</span><span class="number">0</span>,<span class="variable">@str</span> :<span class="operator">=</span> <span class="keyword">null</span>) s1</span><br><span class="line">            <span class="keyword">where</span> </span><br><span class="line">                  <span class="type">date</span> <span class="keyword">between</span> <span class="string">&#x27;2019-01-01&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2019-12-31&#x27;</span></span><br><span class="line">            <span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">                  <span class="type">date</span> </span><br><span class="line">           ) s,</span><br><span class="line">           (<span class="keyword">select</span> <span class="variable">@diff</span>:<span class="operator">=</span><span class="number">0</span>)  s1</span><br><span class="line">     ) ys</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> diff, str;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法二</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">      <span class="string">&#x27;fail&#x27;</span> <span class="keyword">as</span> period_state,</span><br><span class="line">      <span class="built_in">min</span>(f1.fail_date) start_date,</span><br><span class="line">      <span class="built_in">min</span>(f2.fail_date) end_date</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">     (<span class="keyword">select</span> </span><br><span class="line">            fail_date </span><br><span class="line">      <span class="keyword">from</span> </span><br><span class="line">            <span class="number">63</span>_failed</span><br><span class="line">      <span class="keyword">where</span></span><br><span class="line">            fail_date <span class="keyword">between</span> <span class="string">&#x27;2019-01-01&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2019-12-31&#x27;</span></span><br><span class="line">            <span class="keyword">and</span></span><br><span class="line">            date_add(fail_date, <span class="type">interval</span> <span class="number">-1</span> <span class="keyword">day</span>) <span class="keyword">not</span> <span class="keyword">in</span>(<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="number">63</span>_failed )</span><br><span class="line">     ) f1</span><br><span class="line"> <span class="keyword">join</span> </span><br><span class="line">     (<span class="keyword">select</span> </span><br><span class="line">            fail_date </span><br><span class="line">      <span class="keyword">from</span> </span><br><span class="line">            <span class="number">63</span>_failed</span><br><span class="line">      <span class="keyword">where</span> </span><br><span class="line">            fail_date <span class="keyword">between</span> <span class="string">&#x27;2019-01-01&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2019-12-31&#x27;</span></span><br><span class="line">            <span class="keyword">and</span></span><br><span class="line">            date_add(fail_date, <span class="type">interval</span> <span class="number">1</span> <span class="keyword">day</span>) <span class="keyword">not</span> <span class="keyword">in</span>(<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="number">63</span>_failed )</span><br><span class="line">      ) f2</span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">      f1.fail_date <span class="operator">&lt;=</span> f2.fail_date</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">      f1.fail_date</span><br><span class="line"><span class="keyword">union</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">      <span class="string">&#x27;success&#x27;</span> <span class="keyword">as</span> period_state,</span><br><span class="line">      <span class="built_in">min</span>(s1.success_date) start_date,</span><br><span class="line">      <span class="built_in">min</span>(s2.success_date) end_date</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">     (<span class="keyword">select</span> </span><br><span class="line">            success_date </span><br><span class="line">      <span class="keyword">from</span></span><br><span class="line">            <span class="number">63</span>_succeeded</span><br><span class="line">      <span class="keyword">where</span> </span><br><span class="line">            success_date <span class="keyword">between</span> <span class="string">&#x27;2019-01-01&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2019-12-31&#x27;</span></span><br><span class="line">            <span class="keyword">and</span> date_add(success_date, <span class="type">interval</span> <span class="number">-1</span> <span class="keyword">day</span>) <span class="keyword">not</span> <span class="keyword">in</span>(<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="number">63</span>_succeeded <span class="keyword">where</span> success_date <span class="keyword">between</span> <span class="string">&#x27;2019-01-01&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2019-12-31&#x27;</span>)) s1</span><br><span class="line"><span class="keyword">join</span></span><br><span class="line">     (<span class="keyword">select</span></span><br><span class="line">            success_date</span><br><span class="line">      <span class="keyword">from</span> </span><br><span class="line">            <span class="number">63</span>_succeeded </span><br><span class="line">      <span class="keyword">where</span></span><br><span class="line">            success_date <span class="keyword">between</span> <span class="string">&#x27;2019-01-01&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2019-12-31&#x27;</span> </span><br><span class="line">            <span class="keyword">and</span></span><br><span class="line">            date_add(success_date, <span class="type">interval</span> <span class="number">1</span> <span class="keyword">day</span>) <span class="keyword">not</span> <span class="keyword">in</span>(<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="number">63</span>_succeeded <span class="keyword">where</span> success_date <span class="keyword">between</span> <span class="string">&#x27;2019-01-01&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2019-12-31&#x27;</span>)) s2</span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">      s1.success_date <span class="operator">&lt;=</span> s2.success_date</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">      s1.success_date</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> </span><br><span class="line">      start_date;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法三</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">     type <span class="keyword">as</span> period_state,</span><br><span class="line">     <span class="built_in">min</span>(<span class="type">date</span>) <span class="keyword">as</span> start_date,</span><br><span class="line">     <span class="built_in">max</span>(<span class="type">date</span>) <span class="keyword">as</span> end_date</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    (<span class="keyword">select</span> </span><br><span class="line">           type, </span><br><span class="line">           `<span class="type">date</span>`,</span><br><span class="line">           subdate(`<span class="type">date</span>`,<span class="built_in">row_number</span>()<span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> type <span class="keyword">order</span> <span class="keyword">by</span> `<span class="type">date</span>`)) <span class="keyword">as</span> diff</span><br><span class="line">     <span class="keyword">from</span></span><br><span class="line">          (<span class="keyword">select</span> <span class="string">&#x27;failed&#x27;</span> <span class="keyword">as</span> type, fail_date <span class="keyword">as</span> `<span class="type">date</span>` <span class="keyword">from</span> <span class="number">63</span>_Failed</span><br><span class="line">           <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">           <span class="keyword">select</span> <span class="string">&#x27;succeeded&#x27;</span> <span class="keyword">as</span> type, success_date <span class="keyword">as</span> `<span class="type">date</span>` <span class="keyword">from</span> <span class="number">63</span>_Succeeded</span><br><span class="line">          ) a1</span><br><span class="line">      )a2</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">    `<span class="type">date</span>` <span class="keyword">between</span> <span class="string">&#x27;2019-01-01&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2019-12-31&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">     type,diff</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">     start_date;</span><br></pre></td></tr></table></figure>

<h2 id="64-每个帖子的评论数"><a href="#64-每个帖子的评论数" class="headerlink" title="64. 每个帖子的评论数"></a>64. 每个帖子的评论数</h2><p>需求一：编写 SQL 语句以查找每个帖子的评论数。结果表应包含帖子的 post_id 和对应的评论数 number_of_comments 并且按 post_id 升序排列。Submissions 可能包含重复的评论。您应该计算每个帖子的唯一评论数。Submissions 可能包含重复的帖子。您应该将它们视为一个帖子。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>post_id</th>
<th>number_of_comments</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>3</td>
</tr>
<tr>
<td>2</td>
<td>2</td>
</tr>
<tr>
<td>12</td>
<td>0</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">64</span>_Submissions (sub_id <span class="type">int</span>, parent_id <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">64</span>_Submissions;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">64</span>_Submissions (sub_id, parent_id) <span class="keyword">values</span> (<span class="number">1</span>, <span class="keyword">null</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">64</span>_Submissions (sub_id, parent_id) <span class="keyword">values</span> (<span class="number">2</span>, <span class="keyword">null</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">64</span>_Submissions (sub_id, parent_id) <span class="keyword">values</span> (<span class="number">1</span>, <span class="keyword">null</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">64</span>_Submissions (sub_id, parent_id) <span class="keyword">values</span> (<span class="number">12</span>, <span class="keyword">null</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">64</span>_Submissions (sub_id, parent_id) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">64</span>_Submissions (sub_id, parent_id) <span class="keyword">values</span> (<span class="number">5</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">64</span>_Submissions (sub_id, parent_id) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">64</span>_Submissions (sub_id, parent_id) <span class="keyword">values</span> (<span class="number">4</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">64</span>_Submissions (sub_id, parent_id) <span class="keyword">values</span> (<span class="number">9</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">64</span>_Submissions (sub_id, parent_id) <span class="keyword">values</span> (<span class="number">10</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">64</span>_Submissions (sub_id, parent_id) <span class="keyword">values</span> (<span class="number">6</span>, <span class="number">7</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">	  post_id,</span><br><span class="line">	  <span class="built_in">COUNT</span>( <span class="keyword">DISTINCT</span> S2.sub_id ) <span class="keyword">AS</span> number_of_comments </span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">	(<span class="keyword">SELECT</span></span><br><span class="line">           <span class="keyword">DISTINCT</span> sub_id <span class="keyword">AS</span> post_id </span><br><span class="line">     <span class="keyword">FROM</span> </span><br><span class="line">           <span class="number">64</span>_Submissions</span><br><span class="line">     <span class="keyword">WHERE</span> </span><br><span class="line">           parent_id <span class="keyword">IS</span> <span class="keyword">NULL</span></span><br><span class="line">    ) S1</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span></span><br><span class="line">     <span class="number">64</span>_Submissions S2</span><br><span class="line"><span class="keyword">ON</span></span><br><span class="line">     S1.post_id <span class="operator">=</span> S2.parent_id </span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">     S1.post_id;</span><br></pre></td></tr></table></figure>

<h2 id="65-平均售价"><a href="#65-平均售价" class="headerlink" title="65. 平均售价"></a>65. 平均售价</h2><p>需求一： 编写SQL查询以查找每种产品的平均售价。<br><code>average_price</code> 应该四舍五入到小数点后两位。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>product_id</th>
<th>average_price</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>6.96</td>
</tr>
<tr>
<td>2</td>
<td>16.96</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">65</span>_Prices (product_id <span class="type">int</span>, start_date <span class="type">date</span>, end_date <span class="type">date</span>, price <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">65</span>_UnitsSold (product_id <span class="type">int</span>, purchase_date <span class="type">date</span>, units <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">65</span>_Prices;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">65</span>_Prices (product_id, start_date, end_date, price) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;2019-02-17&#x27;</span>, <span class="string">&#x27;2019-02-28&#x27;</span>, <span class="number">5</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">65</span>_Prices (product_id, start_date, end_date, price) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;2019-03-01&#x27;</span>, <span class="string">&#x27;2019-03-22&#x27;</span>, <span class="number">20</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">65</span>_Prices (product_id, start_date, end_date, price) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;2019-02-01&#x27;</span>, <span class="string">&#x27;2019-02-20&#x27;</span>, <span class="number">15</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">65</span>_Prices (product_id, start_date, end_date, price) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;2019-02-21&#x27;</span>, <span class="string">&#x27;2019-03-31&#x27;</span>, <span class="number">30</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">65</span>_UnitsSold;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">65</span>_UnitsSold (product_id, purchase_date, units) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;2019-02-25&#x27;</span>, <span class="number">100</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">65</span>_UnitsSold (product_id, purchase_date, units) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;2019-03-01&#x27;</span>, <span class="number">15</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">65</span>_UnitsSold (product_id, purchase_date, units) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;2019-02-10&#x27;</span>, <span class="number">200</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">65</span>_UnitsSold (product_id, purchase_date, units) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;2019-03-22&#x27;</span>, <span class="number">30</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">      product_id,</span><br><span class="line">      round(<span class="built_in">sum</span>(a)<span class="operator">/</span><span class="built_in">sum</span>(units),<span class="number">2</span>) <span class="keyword">as</span> average_price</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">   (<span class="keyword">select</span> </span><br><span class="line">          p.product_id <span class="keyword">as</span> product_id,</span><br><span class="line">          price,units,</span><br><span class="line">          price <span class="operator">*</span> units <span class="keyword">as</span> a</span><br><span class="line">    <span class="keyword">from</span> </span><br><span class="line">          <span class="number">65</span>_Prices p </span><br><span class="line">    <span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">          <span class="number">65</span>_UnitsSold u</span><br><span class="line">    <span class="keyword">on</span> </span><br><span class="line">          p.product_id<span class="operator">=</span>u.product_id <span class="keyword">and</span> </span><br><span class="line">          purchase_date<span class="operator">&lt;=</span>end_date <span class="keyword">and</span> </span><br><span class="line">          purchase_date<span class="operator">&gt;=</span>start_date</span><br><span class="line">   )t</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">    product_id;</span><br></pre></td></tr></table></figure>

<h2 id="66-页面推荐"><a href="#66-页面推荐" class="headerlink" title="66. 页面推荐"></a>66. 页面推荐</h2><p>需求一： 写一段 SQL  向<code>user_id</code> = 1 的用户，推荐其朋友们喜欢的页面。不要推荐该用户已经喜欢的页面。 </p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>recommended_page</th>
</tr>
</thead>
<tbody><tr>
<td>23</td>
</tr>
<tr>
<td>24</td>
</tr>
<tr>
<td>56</td>
</tr>
<tr>
<td>33</td>
</tr>
<tr>
<td>77</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">66</span>_Friendship (user1_id <span class="type">int</span>, user2_id <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">66</span>_Likes (user_id <span class="type">int</span>, page_id <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">66</span>_Friendship;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">66</span>_Friendship (user1_id, user2_id) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">66</span>_Friendship (user1_id, user2_id) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">66</span>_Friendship (user1_id, user2_id) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">4</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">66</span>_Friendship (user1_id, user2_id) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">66</span>_Friendship (user1_id, user2_id) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">4</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">66</span>_Friendship (user1_id, user2_id) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">5</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">66</span>_Friendship (user1_id, user2_id) <span class="keyword">values</span> (<span class="number">6</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">66</span>_Likes;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">66</span>_Likes (user_id, page_id) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">88</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">66</span>_Likes (user_id, page_id) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">23</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">66</span>_Likes (user_id, page_id) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">24</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">66</span>_Likes (user_id, page_id) <span class="keyword">values</span> (<span class="number">4</span>, <span class="number">56</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">66</span>_Likes (user_id, page_id) <span class="keyword">values</span> (<span class="number">5</span>, <span class="number">11</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">66</span>_Likes (user_id, page_id) <span class="keyword">values</span> (<span class="number">6</span>, <span class="number">33</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">66</span>_Likes (user_id, page_id) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">77</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">66</span>_Likes (user_id, page_id) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">77</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">66</span>_Likes (user_id, page_id) <span class="keyword">values</span> (<span class="number">6</span>, <span class="number">88</span>);</span><br></pre></td></tr></table></figure>

<p>解释：</p>
<p>用户1同 用户2, 3, 4, 6 是朋友关系。</p>
<p>推荐页面为： 页面23 来自于 用户2, 页面24 来自于 用户3, 页面56 来自于 用户3 以及 页面33 来自于 用户6。<br>页面77 同时被 用户2 和 用户3 推荐。<br>页面88 没有被推荐，因为 用户1 已经喜欢了它。</p>
<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">      <span class="keyword">distinct</span> page_id <span class="keyword">as</span> recommended_page</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      <span class="number">66</span>_Likes,</span><br><span class="line">      <span class="number">66</span>_friendship</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">      page_id <span class="keyword">not</span> <span class="keyword">in</span>(<span class="keyword">select</span> page_id <span class="keyword">from</span> <span class="number">66</span>_likes <span class="keyword">where</span> user_id<span class="operator">=</span><span class="number">1</span>)</span><br><span class="line">      <span class="keyword">and</span></span><br><span class="line">      user_id <span class="keyword">in</span> (<span class="keyword">select</span> user1_id <span class="keyword">from</span> <span class="number">66</span>_friendship <span class="keyword">where</span> user2_id<span class="operator">=</span><span class="number">1</span>) </span><br><span class="line">      <span class="keyword">or</span></span><br><span class="line">      user_id <span class="keyword">in</span> (<span class="keyword">select</span> user2_id <span class="keyword">from</span> <span class="number">66</span>_friendship <span class="keyword">where</span> user1_id<span class="operator">=</span><span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<h2 id="67-汇报工作"><a href="#67-汇报工作" class="headerlink" title="67. 汇报工作"></a>67. 汇报工作</h2><p>需求：用 SQL 查询出所有直接或间接向公司 CEO 汇报工作的职工的 employee_id 。由于公司规模较小，经理之间的间接关系不超过 3 个经理。可以以任何顺序返回的结果，不需要去重。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>employee_id</th>
</tr>
</thead>
<tbody><tr>
<td>2</td>
</tr>
<tr>
<td>4</td>
</tr>
<tr>
<td>7</td>
</tr>
<tr>
<td>77</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">67</span>_Employees (employee_id <span class="type">int</span>, employee_name <span class="type">varchar</span>(<span class="number">30</span>), manager_id <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">67</span>_Employees;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">67</span>_Employees (employee_id, employee_name, manager_id) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;Boss&#x27;</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">67</span>_Employees (employee_id, employee_name, manager_id) <span class="keyword">values</span> (<span class="number">3</span>, <span class="string">&#x27;Alice&#x27;</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">67</span>_Employees (employee_id, employee_name, manager_id) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;Bob&#x27;</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">67</span>_Employees (employee_id, employee_name, manager_id) <span class="keyword">values</span> (<span class="number">4</span>, <span class="string">&#x27;Daniel&#x27;</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">67</span>_Employees (employee_id, employee_name, manager_id) <span class="keyword">values</span> (<span class="number">7</span>, <span class="string">&#x27;Luis&#x27;</span>, <span class="number">4</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">67</span>_Employees (employee_id, employee_name, manager_id) <span class="keyword">values</span> (<span class="number">8</span>, <span class="string">&#x27;John&#x27;</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">67</span>_Employees (employee_id, employee_name, manager_id) <span class="keyword">values</span> (<span class="number">9</span>, <span class="string">&#x27;Angela&#x27;</span>, <span class="number">8</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">67</span>_Employees (employee_id, employee_name, manager_id) <span class="keyword">values</span> (<span class="number">77</span>, <span class="string">&#x27;Robert&#x27;</span>, <span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<p>提示：</p>
<p>公司 CEO 的 employee_id 是 1.</p>
<p>employee_id 是 2 和 77 的职员直接汇报给公司 CEO。</p>
<p>employee_id 是 4 的职员间接汇报给公司 CEO 4 –&gt; 2 –&gt; 1 。</p>
<p>employee_id 是 7 的职员间接汇报给公司 CEO 7 –&gt; 4 –&gt; 2 –&gt; 1 。</p>
<p>employee_id 是 3, 8 ，9 的职员不会直接或间接的汇报给公司 CEO。 </p>
<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">      employee_id EMPLOYEE_ID</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      <span class="number">67</span>_Employees</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">      manager_id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> </span><br><span class="line">      employee_id<span class="operator">!=</span><span class="number">1</span></span><br><span class="line"><span class="keyword">union</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">      a1.employee_id</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      <span class="number">67</span>_Employees a1,</span><br><span class="line">     (<span class="keyword">select</span> </span><br><span class="line">            employee_id</span><br><span class="line">      <span class="keyword">from</span></span><br><span class="line">            <span class="number">67</span>_Employees</span><br><span class="line">      <span class="keyword">where</span></span><br><span class="line">            manager_id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span></span><br><span class="line">            employee_id<span class="operator">!=</span><span class="number">1</span></span><br><span class="line">     ) a</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">     manager_id<span class="operator">=</span>a.employee_id</span><br><span class="line"><span class="keyword">union</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">     a2.employee_id</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">     <span class="number">67</span>_Employees a2,</span><br><span class="line">    (<span class="keyword">select</span></span><br><span class="line">           a1.employee_id employee_id</span><br><span class="line">    <span class="keyword">from</span> </span><br><span class="line">           <span class="number">67</span>_Employees a1,</span><br><span class="line">           (<span class="keyword">select</span> </span><br><span class="line">                  employee_id</span><br><span class="line">            <span class="keyword">from</span></span><br><span class="line">                  <span class="number">67</span>_Employees</span><br><span class="line">            <span class="keyword">where</span></span><br><span class="line">                  manager_id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span></span><br><span class="line">                  employee_id<span class="operator">!=</span><span class="number">1</span></span><br><span class="line">           ) a</span><br><span class="line">    <span class="keyword">where</span> </span><br><span class="line">           manager_id<span class="operator">=</span>a.employee_id</span><br><span class="line">    ) a3</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">    manager_id<span class="operator">=</span>a3.employee_id</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> </span><br><span class="line">    employee_id;</span><br></pre></td></tr></table></figure>

<h2 id="68-学生们参加各科测试的次数"><a href="#68-学生们参加各科测试的次数" class="headerlink" title="68. 学生们参加各科测试的次数"></a>68. 学生们参加各科测试的次数</h2><p> 需求：写一段 SQL 语句，查询出每个学生参加每一门科目测试的次数，结果按 <code>student_id</code> 和 <code>subject_name</code> 排序。 </p>
<p>展示效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">+------------+--------------+--------------+----------------+</span><br><span class="line">| student_id | student_name | subject_name | attended_exams |</span><br><span class="line">+------------+--------------+--------------+----------------+</span><br><span class="line">| 1          | Alice        | Math         | 3              |</span><br><span class="line">| 1          | Alice        | Physics      | 2              |</span><br><span class="line">| 1          | Alice        | Programming  | 1              |</span><br><span class="line">| 2          | Bob          | Math         | 1              |</span><br><span class="line">| 2          | Bob          | Physics      | 0              |</span><br><span class="line">| 2          | Bob          | Programming  | 1              |</span><br><span class="line">| 6          | Alex         | Math         | 0              |</span><br><span class="line">| 6          | Alex         | Physics      | 0              |</span><br><span class="line">| 6          | Alex         | Programming  | 0              |</span><br><span class="line">| 13         | John         | Math         | 1              |</span><br><span class="line">| 13         | John         | Physics      | 1              |</span><br><span class="line">| 13         | John         | Programming  | 1              |</span><br><span class="line">+------------+--------------+--------------+----------------+</span><br></pre></td></tr></table></figure>

<p>建表语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">68</span>_Students (student_id <span class="type">int</span>, student_name <span class="type">varchar</span>(<span class="number">20</span>));</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">68</span>_Subjects (subject_name <span class="type">varchar</span>(<span class="number">20</span>));</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">68</span>_Examinations (student_id <span class="type">int</span>, subject_name <span class="type">varchar</span>(<span class="number">20</span>));</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">68</span>_Students;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">68</span>_Students (student_id, student_name) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Alice&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">68</span>_Students (student_id, student_name) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;Bob&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">68</span>_Students (student_id, student_name) <span class="keyword">values</span> (<span class="string">&#x27;13&#x27;</span>, <span class="string">&#x27;John&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">68</span>_Students (student_id, student_name) <span class="keyword">values</span> (<span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;Alex&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">68</span>_Subjects;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">68</span>_Subjects (subject_name) <span class="keyword">values</span> (<span class="string">&#x27;Math&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">68</span>_Subjects (subject_name) <span class="keyword">values</span> (<span class="string">&#x27;Physics&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">68</span>_Subjects (subject_name) <span class="keyword">values</span> (<span class="string">&#x27;Programming&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">68</span>_Examinations;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">68</span>_Examinations (student_id, subject_name) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Math&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">68</span>_Examinations (student_id, subject_name) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Physics&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">68</span>_Examinations (student_id, subject_name) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Programming&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">68</span>_Examinations (student_id, subject_name) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;Programming&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">68</span>_Examinations (student_id, subject_name) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Physics&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">68</span>_Examinations (student_id, subject_name) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Math&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">68</span>_Examinations (student_id, subject_name) <span class="keyword">values</span> (<span class="string">&#x27;13&#x27;</span>, <span class="string">&#x27;Math&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">68</span>_Examinations (student_id, subject_name) <span class="keyword">values</span> (<span class="string">&#x27;13&#x27;</span>, <span class="string">&#x27;Programming&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">68</span>_Examinations (student_id, subject_name) <span class="keyword">values</span> (<span class="string">&#x27;13&#x27;</span>, <span class="string">&#x27;Physics&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">68</span>_Examinations (student_id, subject_name) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;Math&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">68</span>_Examinations (student_id, subject_name) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Math&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终sql：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">     a.student_id,</span><br><span class="line">     a.student_name,</span><br><span class="line">     b.subject_name,</span><br><span class="line">     <span class="built_in">COUNT</span>(e.subject_name) <span class="keyword">AS</span> attended_exams</span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">     <span class="number">68</span>_Students a </span><br><span class="line"><span class="keyword">CROSS</span> <span class="keyword">JOIN</span></span><br><span class="line">     <span class="number">68</span>_Subjects b</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span></span><br><span class="line">     <span class="number">68</span>_Examinations e </span><br><span class="line"><span class="keyword">ON</span> </span><br><span class="line">     a.student_id <span class="operator">=</span> e.student_id </span><br><span class="line">     <span class="keyword">AND</span></span><br><span class="line">     b.subject_name <span class="operator">=</span> e.subject_name</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> </span><br><span class="line">     a.student_id, b.subject_name</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">     a.student_id, b.subject_name;</span><br></pre></td></tr></table></figure>

<h2 id="69-找到连续区间的开始和结束数字"><a href="#69-找到连续区间的开始和结束数字" class="headerlink" title="69. 找到连续区间的开始和结束数字"></a>69. 找到连续区间的开始和结束数字</h2><p> 需求：编写一个 SQL 查询得到 <code>Logs</code> 表中的连续区间的开始数字和结束数字。 </p>
<p>展示效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+------------+--------------+</span><br><span class="line">| start_id   | end_id       |</span><br><span class="line">+------------+--------------+</span><br><span class="line">| 1          | 3            |</span><br><span class="line">| 7          | 8            |</span><br><span class="line">| 10         | 10           |</span><br><span class="line">+------------+--------------+</span><br></pre></td></tr></table></figure>

<p>建表语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">69</span>_Logs (log_id <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">69</span>_Logs;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">69</span>_Logs (log_id) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">69</span>_Logs (log_id) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">69</span>_Logs (log_id) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">69</span>_Logs (log_id) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">69</span>_Logs (log_id) <span class="keyword">values</span> (<span class="string">&#x27;8&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">69</span>_Logs (log_id) <span class="keyword">values</span> (<span class="string">&#x27;10&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终sql：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="built_in">min</span>(log_id) start_id,</span><br><span class="line">    <span class="built_in">max</span>(log_id) end_id</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">	(<span class="keyword">SELECT</span></span><br><span class="line">		log_id,</span><br><span class="line">		<span class="keyword">CASE</span> <span class="keyword">WHEN</span> <span class="variable">@id</span> <span class="operator">=</span> log_id <span class="operator">-</span> <span class="number">1</span> <span class="keyword">THEN</span> <span class="variable">@num</span> :<span class="operator">=</span> <span class="variable">@num</span></span><br><span class="line">		<span class="keyword">ELSE</span> <span class="variable">@num</span> :<span class="operator">=</span> <span class="variable">@num</span> <span class="operator">+</span> <span class="number">1</span></span><br><span class="line">		<span class="keyword">END</span> num, <span class="variable">@id</span> :<span class="operator">=</span> log_id</span><br><span class="line">	 <span class="keyword">FROM</span> </span><br><span class="line">         <span class="number">69</span>_Logs,</span><br><span class="line">         (<span class="keyword">SELECT</span> <span class="variable">@num</span> :<span class="operator">=</span> <span class="number">0</span>, <span class="variable">@id</span> :<span class="operator">=</span> <span class="keyword">NULL</span>) a</span><br><span class="line">	) x</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> num;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法二</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">     a.log_id <span class="keyword">as</span> start_id,</span><br><span class="line">     <span class="built_in">min</span>(b.log_id) <span class="keyword">as</span> end_id</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    (<span class="keyword">select</span> log_id <span class="keyword">from</span> <span class="number">69</span>_logs <span class="keyword">where</span> log_id<span class="number">-1</span> <span class="keyword">not</span> <span class="keyword">in</span> (<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="number">69</span>_logs)) a,</span><br><span class="line">    (<span class="keyword">select</span> log_id <span class="keyword">from</span> <span class="number">69</span>_logs <span class="keyword">where</span> log_id<span class="operator">+</span><span class="number">1</span> <span class="keyword">not</span> <span class="keyword">in</span> (<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="number">69</span>_logs)) b</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">     b.log_id<span class="operator">&gt;=</span>a.log_id</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">     a.log_id;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法三</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="built_in">MIN</span>(log_id) start_id,</span><br><span class="line">    <span class="built_in">MAX</span>(log_id) end_id</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    (<span class="keyword">SELECT</span></span><br><span class="line">        log_id, </span><br><span class="line">        log_id <span class="operator">-</span> <span class="built_in">row_number</span>() <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> log_id) <span class="keyword">as</span> diff</span><br><span class="line">     <span class="keyword">FROM</span> </span><br><span class="line">        <span class="number">69</span>_Logs ) t</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> diff;</span><br></pre></td></tr></table></figure>

<h2 id="70-不同国家的天气类型"><a href="#70-不同国家的天气类型" class="headerlink" title="70. 不同国家的天气类型"></a>70. 不同国家的天气类型</h2><p>需求：写一段 SQL 来找到表中每个国家在 2019 年 11 月的天气类型。</p>
<p>天气类型的定义如下：当 weather_state 的平均值小于或等于15返回 <strong>Cold</strong>，当 weather_state 的平均值大于或等于 25 返回 <strong>Hot</strong>，否则返回 <strong>Warm</strong>。</p>
<p>展示效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">+--------------+--------------+</span><br><span class="line">| country_name | weather_type |</span><br><span class="line">+--------------+--------------+</span><br><span class="line">| USA          | Cold         |</span><br><span class="line">| Austraila    | Cold         |</span><br><span class="line">| Peru         | Hot          |</span><br><span class="line">| China        | Warm         |</span><br><span class="line">| Morocco      | Hot          |</span><br><span class="line">+--------------+--------------+</span><br></pre></td></tr></table></figure>

<p>建表语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">70</span>_Countries (country_id <span class="type">int</span>, country_name <span class="type">varchar</span>(<span class="number">20</span>));</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">70</span>_Weather (country_id <span class="type">int</span>, weather_state <span class="type">int</span>, <span class="keyword">day</span> <span class="type">date</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">70</span>_Countries;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">70</span>_Countries (country_id, country_name) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;USA&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">70</span>_Countries (country_id, country_name) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;Australia&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">70</span>_Countries (country_id, country_name) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;Peru&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">70</span>_Countries (country_id, country_name) <span class="keyword">values</span> (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;China&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">70</span>_Countries (country_id, country_name) <span class="keyword">values</span> (<span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;Morocco&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">70</span>_Countries (country_id, country_name) <span class="keyword">values</span> (<span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;Spain&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">70</span>_Weather;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">70</span>_Weather (country_id, weather_state, <span class="keyword">day</span>) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;15&#x27;</span>, <span class="string">&#x27;2019-11-01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">70</span>_Weather (country_id, weather_state, <span class="keyword">day</span>) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;12&#x27;</span>, <span class="string">&#x27;2019-10-28&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">70</span>_Weather (country_id, weather_state, <span class="keyword">day</span>) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;12&#x27;</span>, <span class="string">&#x27;2019-10-27&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">70</span>_Weather (country_id, weather_state, <span class="keyword">day</span>) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;-2&#x27;</span>, <span class="string">&#x27;2019-11-10&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">70</span>_Weather (country_id, weather_state, <span class="keyword">day</span>) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;2019-11-11&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">70</span>_Weather (country_id, weather_state, <span class="keyword">day</span>) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2019-11-12&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">70</span>_Weather (country_id, weather_state, <span class="keyword">day</span>) <span class="keyword">values</span> (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;16&#x27;</span>, <span class="string">&#x27;2019-11-07&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">70</span>_Weather (country_id, weather_state, <span class="keyword">day</span>) <span class="keyword">values</span> (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;18&#x27;</span>, <span class="string">&#x27;2019-11-09&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">70</span>_Weather (country_id, weather_state, <span class="keyword">day</span>) <span class="keyword">values</span> (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;21&#x27;</span>, <span class="string">&#x27;2019-11-23&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">70</span>_Weather (country_id, weather_state, <span class="keyword">day</span>) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;25&#x27;</span>, <span class="string">&#x27;2019-11-28&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">70</span>_Weather (country_id, weather_state, <span class="keyword">day</span>) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;22&#x27;</span>, <span class="string">&#x27;2019-12-01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">70</span>_Weather (country_id, weather_state, <span class="keyword">day</span>) <span class="keyword">values</span> (<span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;25&#x27;</span>, <span class="string">&#x27;2019-11-05&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">70</span>_Weather (country_id, weather_state, <span class="keyword">day</span>) <span class="keyword">values</span> (<span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;27&#x27;</span>, <span class="string">&#x27;2019-11-15&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">70</span>_Weather (country_id, weather_state, <span class="keyword">day</span>) <span class="keyword">values</span> (<span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;31&#x27;</span>, <span class="string">&#x27;2019-11-25&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">70</span>_Weather (country_id, weather_state, <span class="keyword">day</span>) <span class="keyword">values</span> (<span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;2019-10-23&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">70</span>_Weather (country_id, weather_state, <span class="keyword">day</span>) <span class="keyword">values</span> (<span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2019-12-23&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终sql：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    country_name,</span><br><span class="line">    (<span class="keyword">case</span> </span><br><span class="line">         <span class="keyword">when</span> <span class="built_in">avg</span>(weather_state)<span class="operator">&lt;=</span><span class="number">15</span> <span class="keyword">then</span> <span class="string">&#x27;Cold&#x27;</span></span><br><span class="line">         <span class="keyword">when</span> <span class="built_in">avg</span>(weather_state)<span class="operator">&gt;=</span><span class="number">25</span> <span class="keyword">then</span> <span class="string">&#x27;Hot&#x27;</span></span><br><span class="line">         <span class="keyword">else</span> <span class="string">&#x27;Warm&#x27;</span></span><br><span class="line">     <span class="keyword">end</span> ) weather_type</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    <span class="number">70</span>_Countries c </span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> </span><br><span class="line">    <span class="number">70</span>_Weather w</span><br><span class="line"><span class="keyword">on</span></span><br><span class="line">    c.country_id <span class="operator">=</span> w.country_id</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    date_format(<span class="keyword">day</span>,&quot;%Y-%m&quot;)<span class="operator">=</span><span class="string">&#x27;2019-11&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> country_name;</span><br></pre></td></tr></table></figure>

<h2 id="71-求团队人数"><a href="#71-求团队人数" class="headerlink" title="71. 求团队人数"></a>71. 求团队人数</h2><p>编写一个 SQL 查询，以求得每个员工所在团队的总人数。查询结果中的顺序无特定要求。</p>
<p>展示效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">+-------------+------------+</span><br><span class="line">| employee_id | team_size  |</span><br><span class="line">+-------------+------------+</span><br><span class="line">|     1       |     3      |</span><br><span class="line">|     2       |     3      |</span><br><span class="line">|     3       |     3      |</span><br><span class="line">|     4       |     1      |</span><br><span class="line">|     5       |     2      |</span><br><span class="line">|     6       |     2      |</span><br><span class="line">+-------------+------------+</span><br></pre></td></tr></table></figure>

<p>建表语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">71</span>_Employee (employee_id <span class="type">int</span>, team_id <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">71</span>_Employee;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">71</span>_Employee (employee_id, team_id) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;8&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">71</span>_Employee (employee_id, team_id) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;8&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">71</span>_Employee (employee_id, team_id) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;8&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">71</span>_Employee (employee_id, team_id) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;7&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">71</span>_Employee (employee_id, team_id) <span class="keyword">values</span> (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;9&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">71</span>_Employee (employee_id, team_id) <span class="keyword">values</span> (<span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;9&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终sql：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">     employee_id,</span><br><span class="line">    (<span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> <span class="number">71</span>_employee e2 <span class="keyword">WHERE</span> e1.team_id <span class="operator">=</span> e2.team_id) <span class="keyword">AS</span> team_size</span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">     <span class="number">71</span>_Employee e1</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">     e1.employee_id;</span><br><span class="line">     </span><br><span class="line"><span class="comment">-- 方法二</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">     e1.employee_id, </span><br><span class="line">     <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> team_size</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">     <span class="number">71</span>_Employee e1</span><br><span class="line"><span class="keyword">JOIN</span></span><br><span class="line">     <span class="number">71</span>_Employee e2 </span><br><span class="line"><span class="keyword">USING</span>(team_id)</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">     e1.employee_id</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> </span><br><span class="line">     e1.employee_id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法三</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    employee_id,</span><br><span class="line">    <span class="built_in">COUNT</span>(employee_id) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> team_id) <span class="keyword">AS</span> team_size</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    <span class="number">71</span>_Employee</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">    employee_id;</span><br></pre></td></tr></table></figure>

<h2 id="72-不同性别每日分数总计"><a href="#72-不同性别每日分数总计" class="headerlink" title="72. 不同性别每日分数总计"></a>72. 不同性别每日分数总计</h2><p>写一条SQL语句查询每种性别在每一天的总分，并按性别和日期对查询结果排序</p>
<p>展示效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">+--------+------------+-------+</span><br><span class="line">| gender | day        | total |</span><br><span class="line">+--------+------------+-------+</span><br><span class="line">| F      | 2019-12-30 | 17    |</span><br><span class="line">| F      | 2019-12-31 | 40    |</span><br><span class="line">| F      | 2020-01-01 | 57    |</span><br><span class="line">| F      | 2020-01-07 | 80    |</span><br><span class="line">| M      | 2019-12-18 | 2     |</span><br><span class="line">| M      | 2019-12-25 | 13    |</span><br><span class="line">| M      | 2019-12-30 | 26    |</span><br><span class="line">| M      | 2019-12-31 | 29    |</span><br><span class="line">| M      | 2020-01-07 | 36    |</span><br><span class="line">+--------+------------+-------+</span><br></pre></td></tr></table></figure>

<p>建表语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">72</span>_Scores (player_name <span class="type">varchar</span>(<span class="number">20</span>), gender <span class="type">varchar</span>(<span class="number">1</span>), <span class="keyword">day</span> <span class="type">date</span>, score_points <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">72</span>_Scores;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">72</span>_Scores (player_name, gender, <span class="keyword">day</span>, score_points) <span class="keyword">values</span> (<span class="string">&#x27;Aron&#x27;</span>, <span class="string">&#x27;F&#x27;</span>, <span class="string">&#x27;2020-01-01&#x27;</span>, <span class="string">&#x27;17&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">72</span>_Scores (player_name, gender, <span class="keyword">day</span>, score_points) <span class="keyword">values</span> (<span class="string">&#x27;Alice&#x27;</span>, <span class="string">&#x27;F&#x27;</span>, <span class="string">&#x27;2020-01-07&#x27;</span>, <span class="string">&#x27;23&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">72</span>_Scores (player_name, gender, <span class="keyword">day</span>, score_points) <span class="keyword">values</span> (<span class="string">&#x27;Bajrang&#x27;</span>, <span class="string">&#x27;M&#x27;</span>, <span class="string">&#x27;2020-01-07&#x27;</span>, <span class="string">&#x27;7&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">72</span>_Scores (player_name, gender, <span class="keyword">day</span>, score_points) <span class="keyword">values</span> (<span class="string">&#x27;Khali&#x27;</span>, <span class="string">&#x27;M&#x27;</span>, <span class="string">&#x27;2019-12-25&#x27;</span>, <span class="string">&#x27;11&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">72</span>_Scores (player_name, gender, <span class="keyword">day</span>, score_points) <span class="keyword">values</span> (<span class="string">&#x27;Slaman&#x27;</span>, <span class="string">&#x27;M&#x27;</span>, <span class="string">&#x27;2019-12-30&#x27;</span>, <span class="string">&#x27;13&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">72</span>_Scores (player_name, gender, <span class="keyword">day</span>, score_points) <span class="keyword">values</span> (<span class="string">&#x27;Joe&#x27;</span>, <span class="string">&#x27;M&#x27;</span>, <span class="string">&#x27;2019-12-31&#x27;</span>, <span class="string">&#x27;3&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">72</span>_Scores (player_name, gender, <span class="keyword">day</span>, score_points) <span class="keyword">values</span> (<span class="string">&#x27;Jose&#x27;</span>, <span class="string">&#x27;M&#x27;</span>, <span class="string">&#x27;2019-12-18&#x27;</span>, <span class="string">&#x27;2&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">72</span>_Scores (player_name, gender, <span class="keyword">day</span>, score_points) <span class="keyword">values</span> (<span class="string">&#x27;Priya&#x27;</span>, <span class="string">&#x27;F&#x27;</span>, <span class="string">&#x27;2019-12-31&#x27;</span>, <span class="string">&#x27;23&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">72</span>_Scores (player_name, gender, <span class="keyword">day</span>, score_points) <span class="keyword">values</span> (<span class="string">&#x27;Priyanka&#x27;</span>, <span class="string">&#x27;F&#x27;</span>, <span class="string">&#x27;2019-12-30&#x27;</span>, <span class="string">&#x27;17&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">     s1.gender,</span><br><span class="line">     s1.day,</span><br><span class="line">     <span class="built_in">SUM</span>(s2.score_points) <span class="keyword">AS</span> total</span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">     Scores <span class="keyword">AS</span> s1 </span><br><span class="line"><span class="keyword">JOIN</span> </span><br><span class="line">     Scores <span class="keyword">AS</span> s2</span><br><span class="line"><span class="keyword">ON</span> </span><br><span class="line">     s1.gender <span class="operator">=</span> s2.gender </span><br><span class="line">     <span class="keyword">AND</span></span><br><span class="line">     s1.day <span class="operator">&gt;=</span> s2.day</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> </span><br><span class="line">     s1.gender, s1.day</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> </span><br><span class="line">     s1.gender, s1.day;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法二</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">     gender,</span><br><span class="line">     <span class="keyword">day</span>,</span><br><span class="line">     <span class="built_in">SUM</span>(score_points) <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> gender <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">day</span>) <span class="keyword">AS</span> total</span><br><span class="line"><span class="keyword">FROM</span> Scores;</span><br></pre></td></tr></table></figure>



<h2 id="73-餐馆营业额变化增长"><a href="#73-餐馆营业额变化增长" class="headerlink" title="73. 餐馆营业额变化增长"></a>73. 餐馆营业额变化增长</h2><p>写一条 SQL 查询计算以 7 天（某日期 + 该日期前的 6 天）为一个时间段的顾客消费平均值</p>
<p>查询结果格式的例子如下：</p>
<ul>
<li>查询结果按 <code>visited_on</code> 排序</li>
<li><code>average_amount</code> 要 <strong>保留两位小数</strong>，日期数据的格式为 (‘YYYY-MM-DD’)</li>
</ul>
<p>展示效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">+---------------+--------+----------------+</span><br><span class="line">| visited_on    | amount | average_amount |</span><br><span class="line">+---------------+--------+----------------+</span><br><span class="line">| 2019-01-07    |    860 |         122.86 |</span><br><span class="line">| 2019-01-08    |    840 |         120.00 |</span><br><span class="line">| 2019-01-09    |    840 |         120.00 |</span><br><span class="line">| 2019-01-10    |   1000 |         142.86 |</span><br><span class="line">+---------------+--------+----------------+</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">73</span>_Customer (customer_id <span class="type">int</span>, name <span class="type">varchar</span>(<span class="number">20</span>), visited_on <span class="type">date</span>, amount <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">73</span>_Customer;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">73</span>_Customer (customer_id, name, visited_on, amount) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Jhon&#x27;</span>, <span class="string">&#x27;2019-01-01&#x27;</span>, <span class="string">&#x27;100&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">73</span>_Customer (customer_id, name, visited_on, amount) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;Daniel&#x27;</span>, <span class="string">&#x27;2019-01-02&#x27;</span>, <span class="string">&#x27;110&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">73</span>_Customer (customer_id, name, visited_on, amount) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;Jade&#x27;</span>, <span class="string">&#x27;2019-01-03&#x27;</span>, <span class="string">&#x27;120&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">73</span>_Customer (customer_id, name, visited_on, amount) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;Khaled&#x27;</span>, <span class="string">&#x27;2019-01-04&#x27;</span>, <span class="string">&#x27;130&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">73</span>_Customer (customer_id, name, visited_on, amount) <span class="keyword">values</span> (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;Winston&#x27;</span>, <span class="string">&#x27;2019-01-05&#x27;</span>, <span class="string">&#x27;110&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">73</span>_Customer (customer_id, name, visited_on, amount) <span class="keyword">values</span> (<span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;Elvis&#x27;</span>, <span class="string">&#x27;2019-01-06&#x27;</span>, <span class="string">&#x27;140&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">73</span>_Customer (customer_id, name, visited_on, amount) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;Anna&#x27;</span>, <span class="string">&#x27;2019-01-07&#x27;</span>, <span class="string">&#x27;150&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">73</span>_Customer (customer_id, name, visited_on, amount) <span class="keyword">values</span> (<span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;Maria&#x27;</span>, <span class="string">&#x27;2019-01-08&#x27;</span>, <span class="string">&#x27;80&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">73</span>_Customer (customer_id, name, visited_on, amount) <span class="keyword">values</span> (<span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;Jaze&#x27;</span>, <span class="string">&#x27;2019-01-09&#x27;</span>, <span class="string">&#x27;110&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">73</span>_Customer (customer_id, name, visited_on, amount) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Jhon&#x27;</span>, <span class="string">&#x27;2019-01-10&#x27;</span>, <span class="string">&#x27;130&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">73</span>_Customer (customer_id, name, visited_on, amount) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;Jade&#x27;</span>, <span class="string">&#x27;2019-01-10&#x27;</span>, <span class="string">&#x27;150&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终sql：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    s.visited_on,</span><br><span class="line">    <span class="built_in">sum</span>(c.amount) <span class="keyword">as</span> &quot;amount&quot;,</span><br><span class="line">    round(<span class="built_in">sum</span>(c.amount) <span class="operator">/</span> <span class="number">7</span>, <span class="number">2</span>) <span class="keyword">as</span> &quot;average_amount&quot;</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    <span class="number">73</span>_Customer c </span><br><span class="line"><span class="keyword">inner</span> <span class="keyword">join</span> </span><br><span class="line">   (<span class="keyword">select</span></span><br><span class="line">         <span class="keyword">distinct</span> visited_on</span><br><span class="line">    <span class="keyword">from</span></span><br><span class="line">         <span class="number">73</span>_Customer c </span><br><span class="line">    <span class="keyword">where</span> </span><br><span class="line">         visited_on <span class="operator">&gt;=</span> (<span class="keyword">select</span></span><br><span class="line">                              <span class="keyword">distinct</span> visited_on</span><br><span class="line">                        <span class="keyword">from</span></span><br><span class="line">                              <span class="number">73</span>_customer </span><br><span class="line">                        <span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">                              visited_on <span class="keyword">asc</span></span><br><span class="line">                        limit <span class="number">1</span> <span class="keyword">offset</span> <span class="number">6</span>)</span><br><span class="line">   ) s </span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">   datediff(s.visited_on, c.visited_on) <span class="operator">&gt;=</span> <span class="number">0</span> </span><br><span class="line">   <span class="keyword">and</span></span><br><span class="line">   datediff(s.visited_on, c.visited_on) <span class="operator">&lt;</span> <span class="number">7</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">   s.visited_on;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法二</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">     visited_on,</span><br><span class="line">     amount,</span><br><span class="line">     round(amount<span class="operator">/</span><span class="number">7</span>,<span class="number">2</span>) average_amount</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    (<span class="keyword">select</span></span><br><span class="line">          visited_on,</span><br><span class="line">          ant,</span><br><span class="line">          <span class="built_in">lag</span>(visited_on,<span class="number">6</span>,<span class="keyword">null</span>) <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> visited_on) lg,</span><br><span class="line">          <span class="built_in">sum</span>(ant) <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> visited_on <span class="keyword">rows</span> <span class="keyword">between</span> <span class="number">6</span> PRECEDING <span class="keyword">and</span> <span class="keyword">current</span> <span class="type">row</span>) amount</span><br><span class="line">     <span class="keyword">from</span></span><br><span class="line">         (<span class="keyword">select</span> </span><br><span class="line">                visited_on,</span><br><span class="line">                <span class="built_in">sum</span>(amount) ant</span><br><span class="line">          <span class="keyword">from</span> </span><br><span class="line">                <span class="number">73</span>_Customer</span><br><span class="line">          <span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">                visited_on)t1</span><br><span class="line">          )t2</span><br><span class="line"><span class="keyword">where</span> lg <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>扩展：从起始日期查询七天内，每天的平均收入，不满足七天的按实际天数求平均值。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">     c2_visited_on <span class="keyword">as</span> visited_on,</span><br><span class="line">     <span class="built_in">sum</span>(amount) amount,</span><br><span class="line">     round(<span class="built_in">sum</span>(amount)<span class="operator">/</span><span class="built_in">count</span>(<span class="keyword">distinct</span> c1_visited_on),<span class="number">2</span>) <span class="keyword">as</span> average_amount</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    (<span class="keyword">select</span></span><br><span class="line">          c1.amount,</span><br><span class="line">          c1.visited_on <span class="keyword">as</span> c1_visited_on,</span><br><span class="line">          c2.visited_on <span class="keyword">as</span> c2_visited_on</span><br><span class="line">     <span class="keyword">from</span></span><br><span class="line">          <span class="number">73</span>_Customer c1</span><br><span class="line">     <span class="keyword">join</span></span><br><span class="line">         (<span class="keyword">select</span> <span class="keyword">distinct</span> visited_on <span class="keyword">from</span> <span class="number">73</span>_Customer) c2</span><br><span class="line">     <span class="keyword">on</span></span><br><span class="line">          datediff(c2.visited_on, c1.visited_on) <span class="operator">&lt;=</span> <span class="number">6</span></span><br><span class="line">          <span class="keyword">and</span></span><br><span class="line">          datediff(c2.visited_on, c1.visited_on) <span class="operator">&gt;=</span> <span class="number">0</span></span><br><span class="line">     ) tmp</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">     tmp.c2_visited_on;</span><br></pre></td></tr></table></figure>



<h2 id="74-广告效果"><a href="#74-广告效果" class="headerlink" title="74. 广告效果"></a>74. 广告效果</h2><p>写一条SQL语句来查询每一条广告的 <code>ctr</code> ， <code>ctr</code> 要保留两位小数。结果需要按 <code>ctr</code> <strong>降序</strong>、按 <code>ad_id</code> <strong>升序</strong> 进行排序。</p>
<p>广告效果用点击通过率（Click-Through Rate：CTR）来衡量，公式如下:</p>
<p><img src="https://assets.leetcode-cn.com/aliyun-lc-upload/uploads/2020/03/06/sql1.png" alt="img"></p>
<p>展示效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">+-------+-------+</span><br><span class="line">| ad_id | ctr   |</span><br><span class="line">+-------+-------+</span><br><span class="line">| 1     | 66.67 |</span><br><span class="line">| 3     | 50.00 |</span><br><span class="line">| 2     | 33.33 |</span><br><span class="line">| 5     | 0.00  |</span><br><span class="line">+-------+-------+</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">74</span>_Ads (ad_id <span class="type">int</span>, user_id <span class="type">int</span>, action ENUM(<span class="string">&#x27;Clicked&#x27;</span>, <span class="string">&#x27;Viewed&#x27;</span>, <span class="string">&#x27;Ignored&#x27;</span>));</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">74</span>_Ads;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">74</span>_Ads (ad_id, user_id, action) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Clicked&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">74</span>_Ads (ad_id, user_id, action) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;Clicked&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">74</span>_Ads (ad_id, user_id, action) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;Viewed&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">74</span>_Ads (ad_id, user_id, action) <span class="keyword">values</span> (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;Ignored&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">74</span>_Ads (ad_id, user_id, action) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;Ignored&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">74</span>_Ads (ad_id, user_id, action) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;Viewed&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">74</span>_Ads (ad_id, user_id, action) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;Clicked&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">74</span>_Ads (ad_id, user_id, action) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;Viewed&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">74</span>_Ads (ad_id, user_id, action) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;11&#x27;</span>, <span class="string">&#x27;Viewed&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">74</span>_Ads (ad_id, user_id, action) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;Clicked&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">     ad_id,</span><br><span class="line">     ROUND(IFNULL(<span class="built_in">SUM</span>(action <span class="operator">=</span> <span class="string">&#x27;Clicked&#x27;</span>)</span><br><span class="line">                    <span class="operator">/</span></span><br><span class="line">             (<span class="built_in">SUM</span>(action <span class="operator">=</span> <span class="string">&#x27;Clicked&#x27;</span>) <span class="operator">+</span> <span class="built_in">SUM</span>(action <span class="operator">=</span> <span class="string">&#x27;Viewed&#x27;</span>)) <span class="operator">*</span> <span class="number">100</span>, <span class="number">0</span>), <span class="number">2</span>) <span class="keyword">AS</span> ctr</span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">    <span class="number">74</span>_Ads</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">    ad_id</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">    ctr <span class="keyword">DESC</span>,</span><br><span class="line">    ad_id <span class="keyword">ASC</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法二</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">     ad_id,</span><br><span class="line">     ifnull(round((Clicked<span class="operator">/</span>(Viewed <span class="operator">+</span> Clicked))<span class="operator">*</span><span class="number">100</span>,<span class="number">2</span>),<span class="number">0</span>) <span class="keyword">as</span> ctr</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    (<span class="keyword">select</span></span><br><span class="line">           ad_id,</span><br><span class="line">           <span class="built_in">count</span>(<span class="keyword">case</span> <span class="keyword">when</span> action <span class="operator">=</span> <span class="string">&#x27;Clicked&#x27;</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">end</span>) <span class="keyword">as</span> Clicked,</span><br><span class="line">           <span class="built_in">count</span>(<span class="keyword">case</span> <span class="keyword">when</span> action <span class="operator">=</span> <span class="string">&#x27;Viewed&#x27;</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">end</span>) <span class="keyword">as</span> Viewed</span><br><span class="line">     <span class="keyword">from</span> <span class="number">74</span>_Ads </span><br><span class="line">     <span class="keyword">group</span> <span class="keyword">by</span> ad_id ) a </span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> </span><br><span class="line">     ctr <span class="keyword">desc</span>,</span><br><span class="line">     ad_id <span class="keyword">asc</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法三</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">     a.ad_id,</span><br><span class="line">     ifnull(ctr,<span class="number">0</span>) ctr</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">     <span class="number">74</span>_Ads a</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> </span><br><span class="line">     (<span class="keyword">select</span></span><br><span class="line">           ad_id,</span><br><span class="line">           round(<span class="built_in">sum</span>(if(action<span class="operator">=</span><span class="string">&#x27;Clicked&#x27;</span>,<span class="number">1</span>,<span class="number">0</span>))<span class="operator">/</span><span class="built_in">count</span>(<span class="operator">*</span>)<span class="operator">*</span><span class="number">100</span>,<span class="number">2</span>) ctr </span><br><span class="line">      <span class="keyword">from</span> <span class="number">74</span>_Ads </span><br><span class="line">      <span class="keyword">where</span> action <span class="operator">!=</span><span class="string">&#x27;Ignored&#x27;</span></span><br><span class="line">      <span class="keyword">group</span> <span class="keyword">by</span> ad_id )t1 </span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">      a.ad_id<span class="operator">=</span> t1.ad_id</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">      ad_id,ctr</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">      ctr <span class="keyword">desc</span>,ad_id;</span><br></pre></td></tr></table></figure>

<h2 id="75-列出指定时间段内所有的下单产品"><a href="#75-列出指定时间段内所有的下单产品" class="headerlink" title="75. 列出指定时间段内所有的下单产品"></a>75. 列出指定时间段内所有的下单产品</h2><p>写一个 SQL 语句，要求获取在 2020 年 2 月份下单的数量不少于 100 的产品的名字和数目。返回结果表单的顺序无要求。</p>
<p>展示效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">+--------------------+---------+</span><br><span class="line">| product_name       | unit    |</span><br><span class="line">+--------------------+---------+</span><br><span class="line">| Leetcode Solutions | 130     |</span><br><span class="line">| Leetcode Kit       | 100     |</span><br><span class="line">+--------------------+---------+</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">75</span>_Products (product_id <span class="type">int</span>, product_name <span class="type">varchar</span>(<span class="number">40</span>), product_category <span class="type">varchar</span>(<span class="number">40</span>));</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">75</span>_Orders (product_id <span class="type">int</span>, order_date <span class="type">date</span>, unit <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">75</span>_Products;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">75</span>_Products (product_id, product_name, product_category) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Leetcode Solutions&#x27;</span>, <span class="string">&#x27;Book&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">75</span>_Products (product_id, product_name, product_category) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;Jewels of Stringology&#x27;</span>, <span class="string">&#x27;Book&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">75</span>_Products (product_id, product_name, product_category) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;HP&#x27;</span>, <span class="string">&#x27;Laptop&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">75</span>_Products (product_id, product_name, product_category) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;Lenovo&#x27;</span>, <span class="string">&#x27;Laptop&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">75</span>_Products (product_id, product_name, product_category) <span class="keyword">values</span> (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;Leetcode Kit&#x27;</span>, <span class="string">&#x27;T-shirt&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">75</span>_Orders;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">75</span>_Orders (product_id, order_date, unit) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2020-02-05&#x27;</span>, <span class="string">&#x27;60&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">75</span>_Orders (product_id, order_date, unit) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2020-02-10&#x27;</span>, <span class="string">&#x27;70&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">75</span>_Orders (product_id, order_date, unit) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2020-01-18&#x27;</span>, <span class="string">&#x27;30&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">75</span>_Orders (product_id, order_date, unit) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2020-02-11&#x27;</span>, <span class="string">&#x27;80&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">75</span>_Orders (product_id, order_date, unit) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2020-02-17&#x27;</span>, <span class="string">&#x27;2&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">75</span>_Orders (product_id, order_date, unit) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2020-02-24&#x27;</span>, <span class="string">&#x27;3&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">75</span>_Orders (product_id, order_date, unit) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;2020-03-01&#x27;</span>, <span class="string">&#x27;20&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">75</span>_Orders (product_id, order_date, unit) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;2020-03-04&#x27;</span>, <span class="string">&#x27;30&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">75</span>_Orders (product_id, order_date, unit) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;2020-03-04&#x27;</span>, <span class="string">&#x27;60&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">75</span>_Orders (product_id, order_date, unit) <span class="keyword">values</span> (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;2020-02-25&#x27;</span>, <span class="string">&#x27;50&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">75</span>_Orders (product_id, order_date, unit) <span class="keyword">values</span> (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;2020-02-27&#x27;</span>, <span class="string">&#x27;50&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">75</span>_Orders (product_id, order_date, unit) <span class="keyword">values</span> (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;2020-03-01&#x27;</span>, <span class="string">&#x27;50&#x27;</span>);</span><br></pre></td></tr></table></figure>



<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">    p.product_name,</span><br><span class="line">    <span class="built_in">sum</span>(o.unit) <span class="keyword">as</span> unit</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    <span class="number">75</span>_Products p</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">    <span class="number">75</span>_Orders o </span><br><span class="line"><span class="keyword">on</span></span><br><span class="line">    p.product_id<span class="operator">=</span>o.product_id</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    order_date <span class="keyword">between</span> <span class="string">&#x27;2020-02-01&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2020-02-29&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">    p.product_name</span><br><span class="line"><span class="keyword">having</span></span><br><span class="line">    <span class="built_in">sum</span>(o.unit)<span class="operator">&gt;=</span><span class="number">100</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">    <span class="built_in">sum</span>(o.unit);</span><br><span class="line">    </span><br><span class="line"><span class="comment">-- 方法二 </span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">     product_name, </span><br><span class="line">     <span class="built_in">SUM</span>(unit) <span class="keyword">AS</span> unit</span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">     <span class="number">75</span>_Products </span><br><span class="line"><span class="keyword">JOIN</span> </span><br><span class="line">     <span class="number">75</span>_Orders <span class="keyword">USING</span> (product_id)</span><br><span class="line"><span class="keyword">WHERE</span> </span><br><span class="line">     order_date <span class="keyword">LIKE</span> &quot;2020-02%&quot;</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">     product_name</span><br><span class="line"><span class="keyword">HAVING</span></span><br><span class="line">     unit <span class="operator">&gt;=</span> <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法三</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">     T.product_name,</span><br><span class="line">     T.unit</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    (<span class="keyword">select</span></span><br><span class="line">          p.product_name,</span><br><span class="line">          <span class="built_in">sum</span>(unit) <span class="keyword">as</span> unit</span><br><span class="line">     <span class="keyword">from</span></span><br><span class="line">          <span class="number">75</span>_Orders o</span><br><span class="line">     <span class="keyword">join</span></span><br><span class="line">          <span class="number">75</span>_Products p</span><br><span class="line">     <span class="keyword">on</span> </span><br><span class="line">          o.product_id <span class="operator">=</span> p.product_id</span><br><span class="line">     <span class="keyword">where</span></span><br><span class="line">         order_date <span class="keyword">like</span> &quot;2020-02%&quot;</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">         p.product_id</span><br><span class="line">    ) <span class="keyword">as</span> T</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    T.unit<span class="operator">&gt;=</span> <span class="number">100</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="76-每次访问的交易次数"><a href="#76-每次访问的交易次数" class="headerlink" title="76. 每次访问的交易次数"></a>76. 每次访问的交易次数</h2><p>写一条 SQL 查询多少客户访问了银行但没有进行任何交易，多少客户访问了银行进行了一次交易等等</p>
<p>结果包含两列：</p>
<ul>
<li><code>transactions_count：</code> 客户在一次访问中的交易次数</li>
<li><code>visits_count：</code> 在 <code>transactions_count</code> 交易次数下相应的一次访问时的客户数量</li>
</ul>
<p>展示效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">+--------------------+--------------+</span><br><span class="line">| transactions_count | visits_count |</span><br><span class="line">+--------------------+--------------+</span><br><span class="line">| 0                  | 4            |</span><br><span class="line">| 1                  | 5            |</span><br><span class="line">| 2                  | 0            |</span><br><span class="line">| 3                  | 1            |</span><br><span class="line">+--------------------+--------------+</span><br></pre></td></tr></table></figure>

<p>提示：</p>
<ul>
<li>对于 transactions_count = 0, visits 中 (1, “2020-01-01”), (2, “2020-01-02”), (12, “2020-01-01”) 和 (19, “2020-01-03”) 没有进行交易，所以 visits_count = 4 。</li>
<li>对于 transactions_count = 1, visits 中 (2, “2020-01-03”), (7, “2020-01-11”), (8, “2020-01-28”), (1, “2020-01-02”) 和 (1, “2020-01-04”) 进行了一次交易，所以 visits_count = 5 。</li>
<li>对于 transactions_count = 2, 没有客户访问银行进行了两次交易，所以 visits_count = 0 。</li>
<li>对于 transactions_count = 3, visits 中 (9, “2020-01-25”) 进行了三次交易，所以 visits_count = 1 。</li>
<li>对于 transactions_count &gt;= 4, 没有客户访问银行进行了超过3次交易，所以我们停止在 transactions_count = 3 。</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">76</span>_Visits (user_id <span class="type">int</span>, visit_date <span class="type">date</span>);</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">76</span>_Transactions (user_id <span class="type">int</span>, transaction_date <span class="type">date</span>, amount <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">76</span>_Visits;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">76</span>_Visits (user_id, visit_date) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2020-01-01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">76</span>_Visits (user_id, visit_date) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2020-01-02&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">76</span>_Visits (user_id, visit_date) <span class="keyword">values</span> (<span class="string">&#x27;12&#x27;</span>, <span class="string">&#x27;2020-01-01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">76</span>_Visits (user_id, visit_date) <span class="keyword">values</span> (<span class="string">&#x27;19&#x27;</span>, <span class="string">&#x27;2020-01-03&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">76</span>_Visits (user_id, visit_date) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2020-01-02&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">76</span>_Visits (user_id, visit_date) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2020-01-03&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">76</span>_Visits (user_id, visit_date) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2020-01-04&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">76</span>_Visits (user_id, visit_date) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;2020-01-11&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">76</span>_Visits (user_id, visit_date) <span class="keyword">values</span> (<span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;2020-01-25&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">76</span>_Visits (user_id, visit_date) <span class="keyword">values</span> (<span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;2020-01-28&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">76</span>_Transactions;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">76</span>_Transactions (user_id, transaction_date, amount) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2020-01-02&#x27;</span>, <span class="string">&#x27;120&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">76</span>_Transactions (user_id, transaction_date, amount) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2020-01-03&#x27;</span>, <span class="string">&#x27;22&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">76</span>_Transactions (user_id, transaction_date, amount) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;2020-01-11&#x27;</span>, <span class="string">&#x27;232&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">76</span>_Transactions (user_id, transaction_date, amount) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2020-01-04&#x27;</span>, <span class="string">&#x27;7&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">76</span>_Transactions (user_id, transaction_date, amount) <span class="keyword">values</span> (<span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;2020-01-25&#x27;</span>, <span class="string">&#x27;33&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">76</span>_Transactions (user_id, transaction_date, amount) <span class="keyword">values</span> (<span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;2020-01-25&#x27;</span>, <span class="string">&#x27;66&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">76</span>_Transactions (user_id, transaction_date, amount) <span class="keyword">values</span> (<span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;2020-01-28&#x27;</span>, <span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">76</span>_Transactions (user_id, transaction_date, amount) <span class="keyword">values</span> (<span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;2020-01-25&#x27;</span>, <span class="string">&#x27;99&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">     tmp.user_visits_num transactions_count,</span><br><span class="line">     <span class="built_in">count</span>(<span class="number">1</span>) visits_count</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    (<span class="keyword">select</span> </span><br><span class="line">          <span class="built_in">sum</span>(if(amount <span class="keyword">is</span> <span class="keyword">null</span>, <span class="number">0</span>, <span class="number">1</span>)) user_visits_num</span><br><span class="line">     <span class="keyword">from</span> </span><br><span class="line">          <span class="number">76</span>_Visits v1</span><br><span class="line">     <span class="keyword">left</span> <span class="keyword">join</span> </span><br><span class="line">          <span class="number">76</span>_Transactions t1</span><br><span class="line">     <span class="keyword">on</span> </span><br><span class="line">          v1.user_id <span class="operator">=</span> t1.user_id </span><br><span class="line">          <span class="keyword">and</span></span><br><span class="line">          v1.visit_date <span class="operator">=</span> t1.transaction_date</span><br><span class="line">     <span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">          v1.user_id, v1.visit_date</span><br><span class="line">    ) tmp</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> tmp.user_visits_num;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法二</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">     <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">     (<span class="keyword">SELECT</span></span><br><span class="line">            t5.rnb <span class="keyword">AS</span> transactions_count,</span><br><span class="line">            IFNULL(visits_count, <span class="number">0</span>) <span class="keyword">AS</span> visits_count</span><br><span class="line">      <span class="keyword">FROM</span></span><br><span class="line">           (<span class="keyword">SELECT</span></span><br><span class="line">                 <span class="number">0</span> <span class="keyword">AS</span> rnb</span><br><span class="line">            <span class="keyword">UNION</span></span><br><span class="line">            <span class="keyword">SELECT</span></span><br><span class="line">                 <span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span> () <span class="keyword">AS</span> rnb</span><br><span class="line">            <span class="keyword">FROM</span></span><br><span class="line">                 <span class="number">76</span>_Transactions</span><br><span class="line">            ) t5</span><br><span class="line">      <span class="keyword">LEFT</span> <span class="keyword">JOIN</span></span><br><span class="line">           (<span class="keyword">SELECT</span></span><br><span class="line">                 cnt <span class="keyword">AS</span> transactions_count,</span><br><span class="line">                 <span class="built_in">COUNT</span>(user_id) <span class="keyword">AS</span> visits_count</span><br><span class="line">            <span class="keyword">FROM</span></span><br><span class="line">                (<span class="keyword">SELECT</span></span><br><span class="line">                      t1.user_id, </span><br><span class="line">                      <span class="built_in">COUNT</span>(t2.amount) <span class="keyword">AS</span> cnt</span><br><span class="line">                 <span class="keyword">FROM</span></span><br><span class="line">                      <span class="number">76</span>_Visits t1</span><br><span class="line">                 <span class="keyword">LEFT</span> <span class="keyword">JOIN</span></span><br><span class="line">                      <span class="number">76</span>_Transactions t2</span><br><span class="line">                 <span class="keyword">ON</span> </span><br><span class="line">                      t1.user_id <span class="operator">=</span> t2.user_id</span><br><span class="line">                      <span class="keyword">AND</span></span><br><span class="line">                      t1.visit_date <span class="operator">=</span> t2.transaction_date</span><br><span class="line">                 <span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">                      user_id, </span><br><span class="line">                      visit_date ) t3</span><br><span class="line">             <span class="keyword">GROUP</span> <span class="keyword">BY</span> cnt ) t4</span><br><span class="line">       <span class="keyword">ON</span> t5.rnb <span class="operator">=</span> t4.transactions_count) t6</span><br><span class="line"><span class="keyword">WHERE</span> transactions_count <span class="operator">&lt;=</span> (<span class="keyword">SELECT</span></span><br><span class="line">                                   <span class="built_in">COUNT</span>(t2.amount) <span class="keyword">AS</span> cnt</span><br><span class="line">                              <span class="keyword">FROM</span> </span><br><span class="line">                                   <span class="number">76</span>_Visits t1</span><br><span class="line">                              <span class="keyword">LEFT</span> <span class="keyword">JOIN</span></span><br><span class="line">                                   <span class="number">76</span>_Transactions t2</span><br><span class="line">                              <span class="keyword">ON</span></span><br><span class="line">                                   t1.user_id <span class="operator">=</span> t2.user_id</span><br><span class="line">                                   <span class="keyword">AND</span></span><br><span class="line">                                   t1.visit_date <span class="operator">=</span> t2.transaction_date</span><br><span class="line">                              <span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">                                   t1.user_id, visit_date</span><br><span class="line">                              <span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">                                   cnt <span class="keyword">DESC</span></span><br><span class="line">                              LIMIT <span class="number">1</span>);</span><br></pre></td></tr></table></figure>



<h2 id="77-电影评分"><a href="#77-电影评分" class="headerlink" title="77. 电影评分"></a>77. 电影评分</h2><p>请你编写一组 SQL 查询：查找评论电影数量最多的用户名，如果出现平局，返回字典序较小的用户名。查找在2020 年 2 月 平均评分最高的电影名称，如果出现平局，返回字典序较小的电影名称。</p>
<p>展示效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">+--------------+</span><br><span class="line">| results      |</span><br><span class="line">+--------------+</span><br><span class="line">| Daniel       |</span><br><span class="line">| Frozen 2     |</span><br><span class="line">+--------------+</span><br></pre></td></tr></table></figure>

<p>建表语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">77</span>_Movies (movie_id <span class="type">int</span>, title <span class="type">varchar</span>(<span class="number">30</span>));</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">77</span>_Users (user_id <span class="type">int</span>, name <span class="type">varchar</span>(<span class="number">30</span>));</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">77</span>_Movie_Rating (movie_id <span class="type">int</span>, user_id <span class="type">int</span>, rating <span class="type">int</span>, created_at <span class="type">date</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">77</span>_Movies;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">77</span>_Movies (movie_id, title) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Avengers&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">77</span>_Movies (movie_id, title) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;Frozen 2&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">77</span>_Movies (movie_id, title) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;Joker&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">77</span>_Users;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">77</span>_Users (user_id, name) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Daniel&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">77</span>_Users (user_id, name) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;Monica&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">77</span>_Users (user_id, name) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;Maria&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">77</span>_Users (user_id, name) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;James&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">77</span>_Movie_Rating;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">77</span>_Movie_Rating (movie_id, user_id, rating, created_at) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2020-01-12&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">77</span>_Movie_Rating (movie_id, user_id, rating, created_at) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;2020-02-11&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">77</span>_Movie_Rating (movie_id, user_id, rating, created_at) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2020-02-12&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">77</span>_Movie_Rating (movie_id, user_id, rating, created_at) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2020-01-01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">77</span>_Movie_Rating (movie_id, user_id, rating, created_at) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;2020-02-17&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">77</span>_Movie_Rating (movie_id, user_id, rating, created_at) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2020-02-01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">77</span>_Movie_Rating (movie_id, user_id, rating, created_at) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2020-03-01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">77</span>_Movie_Rating (movie_id, user_id, rating, created_at) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2020-02-22&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">77</span>_Movie_Rating (movie_id, user_id, rating, created_at) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;2020-02-25&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">     name results </span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    (<span class="keyword">select</span></span><br><span class="line">          m.user_id,</span><br><span class="line">          u.name </span><br><span class="line">    <span class="keyword">from</span></span><br><span class="line">          <span class="number">77</span>_Movie_Rating m </span><br><span class="line">    <span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">          <span class="number">77</span>_Users u </span><br><span class="line">    <span class="keyword">on</span></span><br><span class="line">          m.user_id <span class="operator">=</span> u.user_id</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">          user_id</span><br><span class="line">    <span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">          <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">desc</span>,name</span><br><span class="line">    limit <span class="number">1</span>)t1</span><br><span class="line">    </span><br><span class="line"><span class="keyword">union</span> </span><br><span class="line">    (<span class="keyword">select</span></span><br><span class="line">          title results</span><br><span class="line">     <span class="keyword">from</span> </span><br><span class="line">          <span class="number">77</span>_Movie_Rating r </span><br><span class="line">     <span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">          <span class="number">77</span>_Movies m</span><br><span class="line">     <span class="keyword">on</span></span><br><span class="line">          r.movie_id <span class="operator">=</span>m.movie_id </span><br><span class="line">     <span class="keyword">where</span></span><br><span class="line">         date_format(created_at,<span class="string">&#x27;%Y-%m&#x27;</span>)<span class="operator">=</span><span class="string">&#x27;2020-02&#x27;</span></span><br><span class="line">     <span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">         r.movie_id</span><br><span class="line">     <span class="keyword">order</span> <span class="keyword">by</span> </span><br><span class="line">         <span class="built_in">avg</span>(rating) <span class="keyword">desc</span>,title </span><br><span class="line">     limit <span class="number">1</span>);</span><br></pre></td></tr></table></figure>



<h2 id="78-院系无效的学生"><a href="#78-院系无效的学生" class="headerlink" title="78. 院系无效的学生"></a>78. 院系无效的学生</h2><p>写一条 SQL 语句以查询那些所在院系不存在的学生的 id 和姓名，可以以任何顺序返回结果</p>
<p>展示效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">+------+----------+</span><br><span class="line">| id   | name     |</span><br><span class="line">+------+----------+</span><br><span class="line">| 2    | John     |</span><br><span class="line">| 7    | Daiana   |</span><br><span class="line">| 4    | Jasmine  |</span><br><span class="line">| 3    | Steve    |</span><br><span class="line">+------+----------+</span><br></pre></td></tr></table></figure>

<p>建表语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">78</span>_Departments (id <span class="type">int</span>, name <span class="type">varchar</span>(<span class="number">30</span>));</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">78</span>_Students (id <span class="type">int</span>, name <span class="type">varchar</span>(<span class="number">30</span>), department_id <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">78</span>_Departments;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">78</span>_Departments (id, name) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Electrical Engineering&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">78</span>_Departments (id, name) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;Computer Engineering&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">78</span>_Departments (id, name) <span class="keyword">values</span> (<span class="string">&#x27;13&#x27;</span>, <span class="string">&#x27;Bussiness Administration&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">78</span>_Students;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">78</span>_Students (id, name, department_id) <span class="keyword">values</span> (<span class="string">&#x27;23&#x27;</span>, <span class="string">&#x27;Alice&#x27;</span>, <span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">78</span>_Students (id, name, department_id) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Bob&#x27;</span>, <span class="string">&#x27;7&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">78</span>_Students (id, name, department_id) <span class="keyword">values</span> (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;Jennifer&#x27;</span>, <span class="string">&#x27;13&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">78</span>_Students (id, name, department_id) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;John&#x27;</span>, <span class="string">&#x27;14&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">78</span>_Students (id, name, department_id) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;Jasmine&#x27;</span>, <span class="string">&#x27;77&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">78</span>_Students (id, name, department_id) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;Steve&#x27;</span>, <span class="string">&#x27;74&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">78</span>_Students (id, name, department_id) <span class="keyword">values</span> (<span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;Luis&#x27;</span>, <span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">78</span>_Students (id, name, department_id) <span class="keyword">values</span> (<span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;Jonathan&#x27;</span>, <span class="string">&#x27;7&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">78</span>_Students (id, name, department_id) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;Daiana&#x27;</span>, <span class="string">&#x27;33&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">78</span>_Students (id, name, department_id) <span class="keyword">values</span> (<span class="string">&#x27;11&#x27;</span>, <span class="string">&#x27;Madelynn&#x27;</span>, <span class="string">&#x27;1&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">     id,</span><br><span class="line">     name  </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">     <span class="number">78</span>_Students </span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">     department_id <span class="keyword">not</span> <span class="keyword">in</span> (<span class="keyword">select</span> id <span class="keyword">from</span> <span class="number">78</span>_Departments)</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">     id <span class="keyword">asc</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法二</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">     s.id,</span><br><span class="line">     s.name</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">     <span class="number">78</span>_students s </span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> </span><br><span class="line">     <span class="number">78</span>_Departments d</span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">     s.department_id<span class="operator">=</span>d.id</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">     d.id <span class="keyword">is</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="79-活动参与者"><a href="#79-活动参与者" class="headerlink" title="79. 活动参与者"></a>79. 活动参与者</h2><p>写一条 SQL 查询那些既没有最多，也没有最少参与者的活动的名字，可以以任何顺序返回结果，Activities 表的每项活动的参与者都来自 Friends 表</p>
<p>展示效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+--------------+</span><br><span class="line">| activity     |</span><br><span class="line">+--------------+</span><br><span class="line">| Singing      |</span><br><span class="line">+--------------+</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">79</span>_Friends (id <span class="type">int</span>, name <span class="type">varchar</span>(<span class="number">30</span>), activity <span class="type">varchar</span>(<span class="number">30</span>));</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">79</span>_Activities (id <span class="type">int</span>, name <span class="type">varchar</span>(<span class="number">30</span>));</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">79</span>_Friends;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">79</span>_Friends (id, name, activity) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Jonathan D.&#x27;</span>, <span class="string">&#x27;Eating&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">79</span>_Friends (id, name, activity) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;Jade W.&#x27;</span>, <span class="string">&#x27;Singing&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">79</span>_Friends (id, name, activity) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;Victor J.&#x27;</span>, <span class="string">&#x27;Singing&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">79</span>_Friends (id, name, activity) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;Elvis Q.&#x27;</span>, <span class="string">&#x27;Eating&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">79</span>_Friends (id, name, activity) <span class="keyword">values</span> (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;Daniel A.&#x27;</span>, <span class="string">&#x27;Eating&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">79</span>_Friends (id, name, activity) <span class="keyword">values</span> (<span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;Bob B.&#x27;</span>, <span class="string">&#x27;Horse Riding&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">79</span>_Activities;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">79</span>_Activities (id, name) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Eating&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">79</span>_Activities (id, name) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;Singing&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">79</span>_Activities (id, name) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;Horse Riding&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>提示：</p>
<p>​    Eating 活动有三个人参加, 是最多人参加的活动 (Jonathan D. , Elvis Q. and Daniel A.)</p>
<p>​    Horse Riding 活动有一个人参加, 是最少人参加的活动 (Bob B.)</p>
<p>​    Singing 活动有两个人参加 (Victor J. and Jade W.)</p>
<p>最终SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">     activity <span class="keyword">as</span> ACTIVITY</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">     <span class="number">79</span>_friends</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">     activity</span><br><span class="line"><span class="keyword">having</span></span><br><span class="line">     <span class="built_in">count</span>(<span class="operator">*</span>) <span class="operator">&gt;</span> <span class="keyword">any</span>(<span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> <span class="number">79</span>_friends <span class="keyword">group</span> <span class="keyword">by</span> activity)</span><br><span class="line">     <span class="keyword">and</span></span><br><span class="line">     <span class="built_in">count</span>(<span class="operator">*</span>) <span class="operator">&lt;</span> <span class="keyword">any</span> (<span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> <span class="number">79</span>_friends <span class="keyword">group</span> <span class="keyword">by</span> activity);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法二</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">     activity</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">     <span class="number">79</span>_Friends</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">having</span> </span><br><span class="line">     <span class="built_in">count</span>(<span class="keyword">distinct</span> id) <span class="operator">&gt;</span> <span class="keyword">some</span>(<span class="keyword">select</span> <span class="built_in">count</span>(<span class="keyword">distinct</span> id) <span class="keyword">from</span> <span class="number">79</span>_Friends <span class="keyword">group</span> <span class="keyword">by</span> activity)</span><br><span class="line">     <span class="keyword">and</span></span><br><span class="line">     <span class="built_in">count</span>(<span class="keyword">distinct</span> id) <span class="operator">&lt;</span> <span class="keyword">some</span>(<span class="keyword">select</span> <span class="built_in">count</span>(<span class="keyword">distinct</span> id) <span class="keyword">from</span> <span class="number">79</span>_Friends <span class="keyword">group</span> <span class="keyword">by</span> activity);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法三</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">     tempAct.activity <span class="keyword">AS</span> <span class="string">&#x27;ACTIVITY&#x27;</span></span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">    (<span class="keyword">SELECT</span></span><br><span class="line">          activity,</span><br><span class="line">          <span class="built_in">COUNT</span>(id) <span class="keyword">AS</span> theTimes</span><br><span class="line">     <span class="keyword">FROM</span></span><br><span class="line">          <span class="number">79</span>_Friends </span><br><span class="line">     <span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">          activity </span><br><span class="line">     <span class="keyword">HAVING</span> </span><br><span class="line">          theTimes <span class="keyword">NOT</span> <span class="keyword">IN</span> (</span><br><span class="line">            (<span class="keyword">SELECT</span> <span class="built_in">MAX</span>(tMax.countTimes) <span class="keyword">AS</span> maxCount </span><br><span class="line">             <span class="keyword">FROM</span> </span><br><span class="line">                (<span class="keyword">SELECT</span> activity, <span class="built_in">COUNT</span>(id) <span class="keyword">AS</span> countTimes</span><br><span class="line">                 <span class="keyword">FROM</span> <span class="number">79</span>_Friends </span><br><span class="line">                 <span class="keyword">GROUP</span> <span class="keyword">BY</span> activity)<span class="keyword">AS</span> tMax),</span><br><span class="line">            (<span class="keyword">SELECT</span> <span class="built_in">MIN</span>(tMin.countTimes) <span class="keyword">AS</span> minCount </span><br><span class="line">             <span class="keyword">FROM</span> </span><br><span class="line">                (<span class="keyword">SELECT</span> activity, <span class="built_in">COUNT</span>(id) <span class="keyword">AS</span> countTimes</span><br><span class="line">                 <span class="keyword">FROM</span> <span class="number">79</span>_Friends </span><br><span class="line">                 <span class="keyword">GROUP</span> <span class="keyword">BY</span> activity)<span class="keyword">AS</span> tMin))</span><br><span class="line">    ) <span class="keyword">AS</span> tempAct</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法四</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">     activity</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    (<span class="keyword">select</span></span><br><span class="line">          activity,</span><br><span class="line">          <span class="built_in">rank</span>()<span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> cnt) rk1,</span><br><span class="line">          <span class="built_in">rank</span>()<span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> cnt <span class="keyword">desc</span>) rk2</span><br><span class="line">     <span class="keyword">from</span></span><br><span class="line">         (<span class="keyword">select</span></span><br><span class="line">               activity,</span><br><span class="line">               <span class="built_in">count</span>(<span class="operator">*</span>) cnt</span><br><span class="line">          <span class="keyword">from</span> </span><br><span class="line">               <span class="number">79</span>_Friends</span><br><span class="line">          <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">               activity )t1</span><br><span class="line">    )t2</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">    rk1 <span class="operator">!=</span> <span class="number">1</span> <span class="keyword">and</span> rk2 <span class="operator">!=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>提示： </p>
<p>​         1.any关键词可以理解为“对于子查询返回的列中的任一数值，如果比较结果为true，则返回true。 </p>
<p>​         2.all的意思是“对于子查询返回的列中的所有值，如果比较结果为true，则返回true” </p>
<pre><code>     3.any 和some 具有同等含义，用法也一致。
</code></pre>
<h2 id="80-顾客的可信联系人数量"><a href="#80-顾客的可信联系人数量" class="headerlink" title="80. 顾客的可信联系人数量"></a>80. 顾客的可信联系人数量</h2><p>为每张发票 <code>invoice_id</code> 编写一个SQL查询以查找以下内容：</p>
<ul>
<li><code>customer_name</code>：与发票相关的顾客名称。</li>
<li><code>price</code>：发票的价格。</li>
<li><code>contacts_cnt</code>：该顾客的联系人数量。</li>
<li><code>trusted_contacts_cnt</code>：可信联系人的数量：既是该顾客的联系人又是商店顾客的联系人数量（即：可信联系人的电子邮件存在于客户表中）。</li>
</ul>
<p>将查询的结果按照 <code>invoice_id</code> 排序。</p>
<p>展示效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">+------------+---------------+-------+--------------+----------------------+</span><br><span class="line">| invoice_id | customer_name | price | contacts_cnt | trusted_contacts_cnt |</span><br><span class="line">+------------+---------------+-------+--------------+----------------------+</span><br><span class="line">| 44         | Alex          | 60    | 1            | 1                    |</span><br><span class="line">| 55         | John          | 500   | 0            | 0                    |</span><br><span class="line">| 66         | Bob           | 400   | 2            | 0                    |</span><br><span class="line">| 77         | Alice         | 100   | 3            | 2                    |</span><br><span class="line">| 88         | Alice         | 200   | 3            | 2                    |</span><br><span class="line">| 99         | Bob           | 300   | 2            | 0                    |</span><br><span class="line">+------------+---------------+-------+--------------+----------------------+</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">80</span>_Customers (customer_id <span class="type">int</span>, customer_name <span class="type">varchar</span>(<span class="number">20</span>), email <span class="type">varchar</span>(<span class="number">30</span>));</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">80</span>_Contacts (user_id <span class="type">int</span>, contact_name <span class="type">varchar</span>(<span class="number">20</span>), contact_email <span class="type">varchar</span>(<span class="number">30</span>));</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">80</span>_80_Invoices (invoice_id <span class="type">int</span>, price <span class="type">int</span>, user_id <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">80</span>_Customers;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">80</span>_Customers (customer_id, customer_name, email) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Alice&#x27;</span>, <span class="string">&#x27;alice@leetcode.com&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">80</span>_Customers (customer_id, customer_name, email) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;Bob&#x27;</span>, <span class="string">&#x27;bob@leetcode.com&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">80</span>_Customers (customer_id, customer_name, email) <span class="keyword">values</span> (<span class="string">&#x27;13&#x27;</span>, <span class="string">&#x27;John&#x27;</span>, <span class="string">&#x27;john@leetcode.com&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">80</span>_Customers (customer_id, customer_name, email) <span class="keyword">values</span> (<span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;Alex&#x27;</span>, <span class="string">&#x27;alex@leetcode.com&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">80</span>_Contacts;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">80</span>_Contacts (user_id, contact_name, contact_email) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Bob&#x27;</span>, <span class="string">&#x27;bob@leetcode.com&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">80</span>_Contacts (user_id, contact_name, contact_email) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;John&#x27;</span>, <span class="string">&#x27;john@leetcode.com&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">80</span>_Contacts (user_id, contact_name, contact_email) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Jal&#x27;</span>, <span class="string">&#x27;jal@leetcode.com&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">80</span>_Contacts (user_id, contact_name, contact_email) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;Omar&#x27;</span>, <span class="string">&#x27;omar@leetcode.com&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">80</span>_Contacts (user_id, contact_name, contact_email) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;Meir&#x27;</span>, <span class="string">&#x27;meir@leetcode.com&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">80</span>_Contacts (user_id, contact_name, contact_email) <span class="keyword">values</span> (<span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;Alice&#x27;</span>, <span class="string">&#x27;alice@leetcode.com&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">80</span>_Invoices;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">80</span>_Invoices (invoice_id, price, user_id) <span class="keyword">values</span> (<span class="string">&#x27;77&#x27;</span>, <span class="string">&#x27;100&#x27;</span>, <span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">80</span>_Invoices (invoice_id, price, user_id) <span class="keyword">values</span> (<span class="string">&#x27;88&#x27;</span>, <span class="string">&#x27;200&#x27;</span>, <span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">80</span>_Invoices (invoice_id, price, user_id) <span class="keyword">values</span> (<span class="string">&#x27;99&#x27;</span>, <span class="string">&#x27;300&#x27;</span>, <span class="string">&#x27;2&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">80</span>_Invoices (invoice_id, price, user_id) <span class="keyword">values</span> (<span class="string">&#x27;66&#x27;</span>, <span class="string">&#x27;400&#x27;</span>, <span class="string">&#x27;2&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">80</span>_Invoices (invoice_id, price, user_id) <span class="keyword">values</span> (<span class="string">&#x27;55&#x27;</span>, <span class="string">&#x27;500&#x27;</span>, <span class="string">&#x27;13&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">80</span>_Invoices (invoice_id, price, user_id) <span class="keyword">values</span> (<span class="string">&#x27;44&#x27;</span>, <span class="string">&#x27;60&#x27;</span>, <span class="string">&#x27;6&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">     invoice_id, </span><br><span class="line">     customer_name,</span><br><span class="line">     price,</span><br><span class="line">     ifnull(cnt,<span class="number">0</span>) contacts_cnt,</span><br><span class="line">     ifnull(bc,<span class="number">0</span>) trusted_contacts_cnt </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">     <span class="number">80</span>_Invoices i</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">     (<span class="keyword">select</span></span><br><span class="line">           user_id, </span><br><span class="line">           <span class="built_in">count</span>(<span class="operator">*</span>) cnt</span><br><span class="line">      <span class="keyword">from</span></span><br><span class="line">           <span class="number">80</span>_Contacts</span><br><span class="line">      <span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">           user_id ) t1</span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">      i.user_id<span class="operator">=</span>t1.user_id</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">     (<span class="keyword">select</span></span><br><span class="line">            user_id, </span><br><span class="line">            <span class="built_in">count</span>(<span class="operator">*</span>) bc</span><br><span class="line">      <span class="keyword">from</span> </span><br><span class="line">            <span class="number">80</span>_Contacts</span><br><span class="line">      <span class="keyword">where</span> </span><br><span class="line">            contact_name <span class="keyword">in</span>(<span class="keyword">select</span> customer_name <span class="keyword">from</span> <span class="number">80</span>_Customers )</span><br><span class="line">      <span class="keyword">group</span> <span class="keyword">by</span> user_id )t2</span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">      i.user_id <span class="operator">=</span> t2.user_id</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> </span><br><span class="line">      <span class="number">80</span>_Customers c</span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">      i.user_id<span class="operator">=</span> c.customer_id</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> </span><br><span class="line">      invoice_id;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hf7751.gitee.io/2021/03/11/hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="hefei">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="元">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/03/11/hello-world/" class="post-title-link" itemprop="url">Hello World</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">نُشر في</span>

      <time title="أُنشأ: 2021-03-11 01:48:12" itemprop="dateCreated datePublished" datetime="2021-03-11T01:48:12+08:00">2021-03-11</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Welcome to <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a target="_blank" rel="noopener" href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a target="_blank" rel="noopener" href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>






<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">hefei</span>
</div>
  <div class="powered-by">تطبيق الموقع <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
