<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.loli.net/css?family=Noto+Serif+SC:300,300italic,400,400italic,700,700italic%7CMa+Shan+Zheng:300,300italic,400,400italic,700,700italic%7CJetBrains+Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.2/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"hf7751.gitee.io","root":"/","images":"/images","scheme":"Muse","version":"8.2.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"بحث...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}};
  </script>
<meta name="description" content="81. 获取最近第二次的活动写一条SQL查询展示每一位用户 最近第二次 的活动，如果用户仅有一次活动，返回该活动。一个用户不能同时进行超过一项活动，以 任意 顺序返回结果。 展示效果： 123456+------------+--------------+-------------+-------------+| username   | activity     | startDate   |">
<meta property="og:type" content="article">
<meta property="og:title" content="元">
<meta property="og:url" content="https://hf7751.gitee.io/2021/03/11/81-100/index.html">
<meta property="og:site_name" content="元">
<meta property="og:description" content="81. 获取最近第二次的活动写一条SQL查询展示每一位用户 最近第二次 的活动，如果用户仅有一次活动，返回该活动。一个用户不能同时进行超过一项活动，以 任意 顺序返回结果。 展示效果： 123456+------------+--------------+-------------+-------------+| username   | activity     | startDate   |">
<meta property="og:locale">
<meta property="article:published_time" content="2021-03-10T18:36:18.662Z">
<meta property="article:modified_time" content="2021-03-04T07:48:57.654Z">
<meta property="article:author" content="hefei">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://hf7751.gitee.io/2021/03/11/81-100/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-Hans'
  };
</script>
<title> | 元</title>
  




  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="تشغيل شريط التصفح" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">元</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          المحتويات
        </li>
        <li class="sidebar-nav-overview">
          عام
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#81-%E8%8E%B7%E5%8F%96%E6%9C%80%E8%BF%91%E7%AC%AC%E4%BA%8C%E6%AC%A1%E7%9A%84%E6%B4%BB%E5%8A%A8"><span class="nav-number">1.</span> <span class="nav-text">81. 获取最近第二次的活动</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#82-%E4%BD%BF%E7%94%A8%E5%94%AF%E4%B8%80%E6%A0%87%E8%AF%86%E7%A0%81%E6%9B%BF%E6%8D%A2%E5%91%98%E5%B7%A5ID"><span class="nav-number">2.</span> <span class="nav-text">82. 使用唯一标识码替换员工ID</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#83-%E6%8C%89%E5%B9%B4%E5%BA%A6%E5%88%97%E5%87%BA%E9%94%80%E5%94%AE%E6%80%BB%E9%A2%9D"><span class="nav-number">3.</span> <span class="nav-text">83. 按年度列出销售总额</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#84-%E8%82%A1%E7%A5%A8%E7%9A%84%E8%B5%84%E6%9C%AC%E6%8D%9F%E7%9B%8A"><span class="nav-number">4.</span> <span class="nav-text">84. 股票的资本损益</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#85-%E8%B4%AD%E4%B9%B0%E4%BA%86%E4%BA%A7%E5%93%81A%E5%92%8CB%E5%8D%B4%E6%B2%A1%E6%9C%89%E8%B4%AD%E4%B9%B0%E4%BA%A7%E5%93%81C%E7%9A%84%E9%A1%BE%E5%AE%A2"><span class="nav-number">5.</span> <span class="nav-text">85. 购买了产品A和B却没有购买产品C的顾客</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#86-%E6%8E%92%E5%90%8D%E9%9D%A0%E5%89%8D%E7%9A%84%E6%97%85%E8%A1%8C%E8%80%85"><span class="nav-number">6.</span> <span class="nav-text">86. 排名靠前的旅行者</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#87-%E6%9F%A5%E6%89%BE%E6%88%90%E7%BB%A9%E5%A4%84%E4%BA%8E%E4%B8%AD%E6%B8%B8%E7%9A%84%E5%AD%A6%E7%94%9F"><span class="nav-number">7.</span> <span class="nav-text">87. 查找成绩处于中游的学生</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#88-%E5%87%80%E7%8E%B0%E5%80%BC%E6%9F%A5%E8%AF%A2"><span class="nav-number">8.</span> <span class="nav-text">88. 净现值查询</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#89-%E5%88%B6%E4%BD%9C%E4%BC%9A%E8%AF%9D%E6%9F%B1%E7%8A%B6%E5%9B%BE"><span class="nav-number">9.</span> <span class="nav-text">89. 制作会话柱状图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#90-%E8%AE%A1%E7%AE%97%E5%B8%83%E5%B0%94%E8%A1%A8%E8%BE%BE%E5%BC%8F%E7%9A%84%E5%80%BC"><span class="nav-number">10.</span> <span class="nav-text">90. 计算布尔表达式的值</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#91-%E8%8B%B9%E6%9E%9C%E5%92%8C%E6%A1%94%E5%AD%90"><span class="nav-number">11.</span> <span class="nav-text">91. 苹果和桔子</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#92-%E6%B4%BB%E8%B7%83%E7%94%A8%E6%88%B7"><span class="nav-number">12.</span> <span class="nav-text">92.  活跃用户</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#93-%E7%9F%A9%E5%BD%A2%E9%9D%A2%E7%A7%AF"><span class="nav-number">13.</span> <span class="nav-text">93. 矩形面积</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#94-%E8%AE%A1%E7%AE%97%E7%A8%8E%E5%90%8E%E5%B7%A5%E8%B5%84"><span class="nav-number">14.</span> <span class="nav-text">94. 计算税后工资</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#95-%E5%91%A8%E5%86%85%E6%AF%8F%E5%A4%A9%E7%9A%84%E9%94%80%E5%94%AE%E6%83%85%E5%86%B5"><span class="nav-number">15.</span> <span class="nav-text">95. 周内每天的销售情况</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#96-%E6%8C%89%E6%97%A5%E6%9C%9F%E5%88%86%E7%BB%84%E9%94%80%E5%94%AE%E4%BA%A7%E5%93%81"><span class="nav-number">16.</span> <span class="nav-text">96. 按日期分组销售产品</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#97-%E4%B8%8A%E6%9C%88%E6%92%AD%E6%94%BE%E7%9A%84%E5%84%BF%E7%AB%A5%E9%80%82%E5%AE%9C%E7%94%B5%E5%BD%B1"><span class="nav-number">17.</span> <span class="nav-text">97. 上月播放的儿童适宜电影</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#98-%E5%8F%AF%E4%BB%A5%E6%94%BE%E5%BF%83%E6%8A%95%E8%B5%84%E7%9A%84%E5%9B%BD%E5%AE%B6"><span class="nav-number">18.</span> <span class="nav-text">98. 可以放心投资的国家</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#99-%E6%B6%88%E8%B4%B9%E8%80%85%E4%B8%8B%E5%8D%95%E9%A2%91%E7%8E%87"><span class="nav-number">19.</span> <span class="nav-text">99. 消费者下单频率</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#100-%E6%9F%A5%E6%89%BE%E6%8B%A5%E6%9C%89%E6%9C%89%E6%95%88%E9%82%AE%E7%AE%B1%E7%9A%84%E7%94%A8%E6%88%B7"><span class="nav-number">20.</span> <span class="nav-text">100. 查找拥有有效邮箱的用户</span></a></li><li class="nav-item nav-level-2"><a class="nav-link"><span class="nav-number">21.</span> <span class="nav-text"></span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">hefei</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">7</span>
          <span class="site-state-item-name">المقالات</span>
        </a>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://hf7751.gitee.io/2021/03/11/81-100/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="hefei">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="元">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">نُشر في</span>

      <time title="أُنشأ: 2021-03-11 02:36:18" itemprop="dateCreated datePublished" datetime="2021-03-11T02:36:18+08:00">2021-03-11</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">عُدل في</span>
        <time title="عُدل: 2021-03-04 15:48:57" itemprop="dateModified" datetime="2021-03-04T15:48:57+08:00">2021-03-04</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h2 id="81-获取最近第二次的活动"><a href="#81-获取最近第二次的活动" class="headerlink" title="81. 获取最近第二次的活动"></a>81. 获取最近第二次的活动</h2><p>写一条SQL查询展示每一位用户 <strong>最近第二次</strong> 的活动，如果用户仅有一次活动，返回该活动。一个用户不能同时进行超过一项活动，以 <strong>任意</strong> 顺序返回结果。</p>
<p>展示效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">+------------+--------------+-------------+-------------+</span><br><span class="line">| username   | activity     | startDate   | endDate     |</span><br><span class="line">+------------+--------------+-------------+-------------+</span><br><span class="line">| Alice      | Dancing      | 2020-02-21  | 2020-02-23  |</span><br><span class="line">| Bob        | Travel       | 2020-02-11  | 2020-02-18  |</span><br><span class="line">+------------+--------------+-------------+-------------+</span><br></pre></td></tr></table></figure>

<p>建表语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">81</span>_UserActivity (username <span class="type">varchar</span>(<span class="number">30</span>), activity <span class="type">varchar</span>(<span class="number">30</span>), startDate <span class="type">date</span>, endDate <span class="type">date</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">81</span>_UserActivity;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">81</span>_UserActivity (username, activity, startDate, endDate) <span class="keyword">values</span> (<span class="string">&#x27;Alice&#x27;</span>, <span class="string">&#x27;Travel&#x27;</span>, <span class="string">&#x27;2020-02-12&#x27;</span>, <span class="string">&#x27;2020-02-20&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">81</span>_UserActivity (username, activity, startDate, endDate) <span class="keyword">values</span> (<span class="string">&#x27;Alice&#x27;</span>, <span class="string">&#x27;Dancing&#x27;</span>, <span class="string">&#x27;2020-02-21&#x27;</span>, <span class="string">&#x27;2020-02-23&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">81</span>_UserActivity (username, activity, startDate, endDate) <span class="keyword">values</span> (<span class="string">&#x27;Alice&#x27;</span>, <span class="string">&#x27;Travel&#x27;</span>, <span class="string">&#x27;2020-02-24&#x27;</span>, <span class="string">&#x27;2020-02-28&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">81</span>_UserActivity (username, activity, startDate, endDate) <span class="keyword">values</span> (<span class="string">&#x27;Bob&#x27;</span>, <span class="string">&#x27;Travel&#x27;</span>, <span class="string">&#x27;2020-02-11&#x27;</span>, <span class="string">&#x27;2020-02-18&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">     <span class="built_in">max</span>(u1.username) username,</span><br><span class="line">     <span class="built_in">max</span>(u1.activity) activity,</span><br><span class="line">     <span class="built_in">max</span>(u1.startdate) startdate,</span><br><span class="line">     <span class="built_in">max</span>(u1.enddate) enddate</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">     <span class="number">81</span>_useractivity u1 </span><br><span class="line"><span class="keyword">join</span></span><br><span class="line">     <span class="number">81</span>_useractivity u2</span><br><span class="line"><span class="keyword">on</span></span><br><span class="line">     u1.username <span class="operator">=</span> u2.username</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">     u1.username, u1.startdate</span><br><span class="line"><span class="keyword">having</span></span><br><span class="line">     <span class="built_in">sum</span>(if(u2.startdate <span class="operator">&gt;</span> u1.startdate,<span class="number">1</span>,<span class="number">0</span>)) <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">     <span class="keyword">or</span></span><br><span class="line">     <span class="built_in">count</span>(<span class="number">1</span>) <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法二</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">     `username`,</span><br><span class="line">     activity,</span><br><span class="line">     startDate,</span><br><span class="line">     endDate </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    (<span class="keyword">select</span> </span><br><span class="line">          username,</span><br><span class="line">          activity,</span><br><span class="line">          startDate,</span><br><span class="line">          endDate ,</span><br><span class="line">          <span class="built_in">rank</span>() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> username <span class="keyword">order</span> <span class="keyword">by</span> startDate <span class="keyword">desc</span>) rk,</span><br><span class="line">          <span class="built_in">lag</span>(startDate ,<span class="number">1</span>, <span class="keyword">null</span>) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> username <span class="keyword">order</span> <span class="keyword">by</span> startDate ) lg</span><br><span class="line">     <span class="keyword">from</span> <span class="number">81</span>_UserActivity) t1</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">     rk<span class="operator">=</span><span class="number">2</span> <span class="keyword">or</span> (rk <span class="operator">=</span> <span class="number">1</span> <span class="keyword">and</span> lg <span class="keyword">is</span> <span class="keyword">null</span>)</span><br></pre></td></tr></table></figure>

<h2 id="82-使用唯一标识码替换员工ID"><a href="#82-使用唯一标识码替换员工ID" class="headerlink" title="82. 使用唯一标识码替换员工ID"></a>82. 使用唯一标识码替换员工ID</h2><p>写一段SQL查询来展示每位用户的 <strong>唯一标识码（unique ID ）</strong>；如果某位员工没有唯一标识码，使用 null 填充即可。你可以以 <strong>任意</strong> 顺序返回结果表。</p>
<p>展示效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">+-----------+----------+</span><br><span class="line">| unique_id | name     |</span><br><span class="line">+-----------+----------+</span><br><span class="line">| null      | Alice    |</span><br><span class="line">| null      | Bob      |</span><br><span class="line">| 2         | Meir     |</span><br><span class="line">| 3         | Winston  |</span><br><span class="line">| 1         | Jonathan |</span><br><span class="line">+-----------+----------+</span><br></pre></td></tr></table></figure>

<p>建表语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">82</span>_Employees (id <span class="type">int</span>, name <span class="type">varchar</span>(<span class="number">20</span>));</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">82</span>_EmployeeUNI (id <span class="type">int</span>, unique_id <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">82</span>_Employees;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">82</span>_Employees (id, name) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Alice&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">82</span>_Employees (id, name) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;Bob&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">82</span>_Employees (id, name) <span class="keyword">values</span> (<span class="string">&#x27;11&#x27;</span>, <span class="string">&#x27;Meir&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">82</span>_Employees (id, name) <span class="keyword">values</span> (<span class="string">&#x27;90&#x27;</span>, <span class="string">&#x27;Winston&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">82</span>_Employees (id, name) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;Jonathan&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">82</span>_EmployeeUNI;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">82</span>_EmployeeUNI (id, unique_id) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">82</span>_EmployeeUNI (id, unique_id) <span class="keyword">values</span> (<span class="string">&#x27;11&#x27;</span>, <span class="string">&#x27;2&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">82</span>_EmployeeUNI (id, unique_id) <span class="keyword">values</span> (<span class="string">&#x27;90&#x27;</span>, <span class="string">&#x27;3&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">     if(unique_id <span class="keyword">is</span> <span class="keyword">null</span>, <span class="keyword">null</span>, unique_id) <span class="keyword">as</span> unique_id,</span><br><span class="line">     e.name</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">     <span class="number">82</span>_Employees e </span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">     <span class="number">82</span>_EmployeeUNI u</span><br><span class="line"><span class="keyword">on</span></span><br><span class="line">     e.id <span class="operator">=</span> u.id;</span><br></pre></td></tr></table></figure>

<h2 id="83-按年度列出销售总额"><a href="#83-按年度列出销售总额" class="headerlink" title="83. 按年度列出销售总额"></a>83. 按年度列出销售总额</h2><p>编写一段SQL查询每个产品每年的总销售额，并包含 product_id, product_name 以及 report_year 等信息。销售年份的日期介于 2018 年到 2020 年之间。你返回的结果需要按 product_id 和 report_year <strong>排序</strong>。</p>
<p>展示效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">+------------+--------------+-------------+--------------+</span><br><span class="line">| product_id | product_name | report_year | total_amount |</span><br><span class="line">+------------+--------------+-------------+--------------+</span><br><span class="line">| 1          | LC Phone     |    2019     | 3500         |</span><br><span class="line">| 2          | LC T-Shirt   |    2018     | 310          |</span><br><span class="line">| 2          | LC T-Shirt   |    2019     | 3650         |</span><br><span class="line">| 2          | LC T-Shirt   |    2020     | 10           |</span><br><span class="line">| 3          | LC Keychain  |    2019     | 31           |</span><br><span class="line">| 3          | LC Keychain  |    2020     | 31           |</span><br><span class="line">+------------+--------------+-------------+--------------+</span><br><span class="line">LC Phone 在 2019-01-25 至 2019-02-28 期间销售，该产品销售时间总计35天。销售总额 35*100 &#x3D; 3500。</span><br><span class="line">LC T-shirt 在 2018-12-01 至 2020-01-01 期间销售，该产品在2018年、2019年、2020年的销售时间分别是31天、365天、1天，2018年、2019年、2020年的销售总额分别是31*10&#x3D;310、365*10&#x3D;3650、1*10&#x3D;10。</span><br><span class="line">LC Keychain 在 2019-12-01 至 2020-01-31 期间销售，该产品在2019年、2020年的销售时间分别是：31天、31天，2019年、2020年的销售总额分别是31*1&#x3D;31、31*1&#x3D;31。</span><br></pre></td></tr></table></figure>

<p>建表语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">83</span>_Product (product_id <span class="type">int</span>, product_name <span class="type">varchar</span>(<span class="number">30</span>));</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">83</span>_Sales (product_id <span class="type">varchar</span>(<span class="number">30</span>), period_start <span class="type">date</span>, period_end <span class="type">date</span>, average_daily_sales <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">83</span>_Product;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">83</span>_Product (product_id, product_name) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;LC Phone &#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">83</span>_Product (product_id, product_name) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;LC T-Shirt&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">83</span>_Product (product_id, product_name) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;LC Keychain&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">83</span>_Sales;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">83</span>_Sales (product_id, period_start, period_end, average_daily_sales) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2019-01-25&#x27;</span>, <span class="string">&#x27;2019-02-28&#x27;</span>, <span class="string">&#x27;100&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">83</span>_Sales (product_id, period_start, period_end, average_daily_sales) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2018-12-01&#x27;</span>, <span class="string">&#x27;2020-01-01&#x27;</span>, <span class="string">&#x27;10&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">83</span>_Sales (product_id, period_start, period_end, average_daily_sales) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2019-12-01&#x27;</span>, <span class="string">&#x27;2020-01-31&#x27;</span>, <span class="string">&#x27;1&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">    (<span class="keyword">select</span></span><br><span class="line">           s1.product_id,</span><br><span class="line">           product_name,</span><br><span class="line">          <span class="string">&#x27;2018&#x27;</span> <span class="keyword">as</span> <span class="string">&#x27;report_year&#x27;</span>, </span><br><span class="line">          if(period_start<span class="operator">&lt;</span><span class="string">&#x27;2019-01-01&#x27;</span>,(datediff(</span><br><span class="line">                                           if(period_end<span class="operator">&lt;</span><span class="string">&#x27;2019-01-01&#x27;</span>, period_end, <span class="type">date</span>(<span class="string">&#x27;2018-12-31&#x27;</span>)),</span><br><span class="line">                                           if(period_start<span class="operator">&gt;=</span><span class="string">&#x27;2018-01-01&#x27;</span>, period_start, <span class="type">date</span>(<span class="string">&#x27;2018-01-01&#x27;</span>))</span><br><span class="line">                                           )<span class="operator">+</span><span class="number">1</span></span><br><span class="line">                                        ) <span class="operator">*</span> average_daily_sales, <span class="number">0</span>) <span class="keyword">as</span> total_amount</span><br><span class="line">     <span class="keyword">from</span> </span><br><span class="line">          <span class="number">83</span>_Sales <span class="keyword">as</span> s1</span><br><span class="line">     <span class="keyword">join</span> </span><br><span class="line">          <span class="number">83</span>_Product <span class="keyword">as</span> p1</span><br><span class="line">     <span class="keyword">on</span> </span><br><span class="line">          s1.product_id <span class="operator">=</span> p1.product_id </span><br><span class="line">     <span class="keyword">having</span></span><br><span class="line">          total_amount<span class="operator">&gt;</span><span class="number">0</span> )</span><br><span class="line"><span class="keyword">union</span></span><br><span class="line">    (<span class="keyword">select</span></span><br><span class="line">          s2.product_id,</span><br><span class="line">          product_name,</span><br><span class="line">         <span class="string">&#x27;2019&#x27;</span> <span class="keyword">as</span> <span class="string">&#x27;report_year&#x27;</span>,</span><br><span class="line">         if( period_start<span class="operator">&lt;</span><span class="string">&#x27;2020-01-01&#x27;</span>, (datediff(</span><br><span class="line">                                             if(period_end<span class="operator">&lt;</span><span class="string">&#x27;2020-01-01&#x27;</span>, period_end, <span class="type">date</span>(<span class="string">&#x27;2019-12-31&#x27;</span>)),                                                            if(period_start<span class="operator">&gt;=</span><span class="string">&#x27;2019-01-01&#x27;</span>, period_start, <span class="type">date</span>(<span class="string">&#x27;2019-01-01&#x27;</span>))</span><br><span class="line">                                             )<span class="operator">+</span><span class="number">1</span></span><br><span class="line">                                        ) <span class="operator">*</span> average_daily_sales , <span class="number">0</span>) <span class="keyword">as</span> total_amount</span><br><span class="line">     <span class="keyword">from</span></span><br><span class="line">          <span class="number">83</span>_Sales <span class="keyword">as</span> s2</span><br><span class="line">     <span class="keyword">join</span></span><br><span class="line">          <span class="number">83</span>_Product <span class="keyword">as</span> p2</span><br><span class="line">     <span class="keyword">on</span></span><br><span class="line">         s2.product_id <span class="operator">=</span> p2.product_id </span><br><span class="line">     <span class="keyword">having</span>  total_amount<span class="operator">&gt;</span><span class="number">0</span>)</span><br><span class="line"><span class="keyword">union</span></span><br><span class="line">    (<span class="keyword">select</span> </span><br><span class="line">          s3.product_id,</span><br><span class="line">          product_name,</span><br><span class="line">          <span class="string">&#x27;2020&#x27;</span> <span class="keyword">as</span> <span class="string">&#x27;report_year&#x27;</span>, </span><br><span class="line">          (datediff(</span><br><span class="line">                   if(period_end<span class="operator">&lt;</span><span class="string">&#x27;2021-01-01&#x27;</span>, period_end, <span class="type">date</span>(<span class="string">&#x27;2020-12-31&#x27;</span>)),</span><br><span class="line">                   if(period_start<span class="operator">&gt;=</span><span class="string">&#x27;2020-01-01&#x27;</span>, period_start, <span class="type">date</span>(<span class="string">&#x27;2020-01-01&#x27;</span>))</span><br><span class="line">                   )<span class="operator">+</span><span class="number">1</span></span><br><span class="line">           ) <span class="operator">*</span> average_daily_sales <span class="keyword">as</span> total_amount</span><br><span class="line">     <span class="keyword">from</span> </span><br><span class="line">          <span class="number">83</span>_Sales <span class="keyword">as</span> s3 </span><br><span class="line">     <span class="keyword">join</span> </span><br><span class="line">          <span class="number">83</span>_Product <span class="keyword">as</span> p3</span><br><span class="line">     <span class="keyword">on</span> </span><br><span class="line">          s3.product_id <span class="operator">=</span> p3.product_id</span><br><span class="line">     <span class="keyword">having</span> total_amount<span class="operator">&gt;</span><span class="number">0</span> ) </span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> product_id, report_year</span><br></pre></td></tr></table></figure>



<h2 id="84-股票的资本损益"><a href="#84-股票的资本损益" class="headerlink" title="84. 股票的资本损益"></a>84. 股票的资本损益</h2><p>编写一个SQL查询来报告每支股票的资本损益。股票的资本损益是一次或多次买卖股票后的全部收益或损失。以任意顺序返回结果即可。</p>
<p>展示效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">+---------------+-------------------+</span><br><span class="line">| stock_name    | capital_gain_loss |</span><br><span class="line">+---------------+-------------------+</span><br><span class="line">| Corona Masks  | 9500              |</span><br><span class="line">| Leetcode      | 8000              |</span><br><span class="line">| Handbags      | -23000            |</span><br><span class="line">+---------------+-------------------+</span><br><span class="line">Leetcode 股票在第一天以1000美元的价格买入，在第五天以9000美元的价格卖出。资本收益&#x3D;9000-1000&#x3D;8000美元。</span><br><span class="line">Handbags 股票在第17天以30000美元的价格买入，在第29天以7000美元的价格卖出。资本损失&#x3D;7000-30000&#x3D;-23000美元。</span><br><span class="line">Corona Masks 股票在第1天以10美元的价格买入，在第3天以1010美元的价格卖出。在第4天以1000美元的价格再次购买，在第5天以500美元的价格出售。最后，它在第6天以1000美元的价格被买走，在第10天以10000美元的价格被卖掉。资本损益是每次（’Buy&#39;-&gt;&#39;Sell&#39;）操作资本收益或损失的和&#x3D;（1010-10）+（500-1000）+（10000-1000）&#x3D;1000-500+9000&#x3D;9500美元。</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">Table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">84</span>_Stocks(stock_name <span class="type">varchar</span>(<span class="number">15</span>),operation ENUM(<span class="string">&#x27;Sell&#x27;</span>, <span class="string">&#x27;Buy&#x27;</span>),operation_day <span class="type">int</span>, price <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">84</span>_Stocks;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">84</span>_Stocks (stock_name, operation, operation_day, price) <span class="keyword">values</span> (<span class="string">&#x27;Leetcode&#x27;</span>, <span class="string">&#x27;Buy&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;1000&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">84</span>_Stocks (stock_name, operation, operation_day, price) <span class="keyword">values</span> (<span class="string">&#x27;Corona Masks&#x27;</span>, <span class="string">&#x27;Buy&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;10&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">84</span>_Stocks (stock_name, operation, operation_day, price) <span class="keyword">values</span> (<span class="string">&#x27;Leetcode&#x27;</span>, <span class="string">&#x27;Sell&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;9000&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">84</span>_Stocks (stock_name, operation, operation_day, price) <span class="keyword">values</span> (<span class="string">&#x27;Handbags&#x27;</span>, <span class="string">&#x27;Buy&#x27;</span>, <span class="string">&#x27;17&#x27;</span>, <span class="string">&#x27;30000&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">84</span>_Stocks (stock_name, operation, operation_day, price) <span class="keyword">values</span> (<span class="string">&#x27;Corona Masks&#x27;</span>, <span class="string">&#x27;Sell&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;1010&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">84</span>_Stocks (stock_name, operation, operation_day, price) <span class="keyword">values</span> (<span class="string">&#x27;Corona Masks&#x27;</span>, <span class="string">&#x27;Buy&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;1000&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">84</span>_Stocks (stock_name, operation, operation_day, price) <span class="keyword">values</span> (<span class="string">&#x27;Corona Masks&#x27;</span>, <span class="string">&#x27;Sell&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;500&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">84</span>_Stocks (stock_name, operation, operation_day, price) <span class="keyword">values</span> (<span class="string">&#x27;Corona Masks&#x27;</span>, <span class="string">&#x27;Buy&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;1000&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">84</span>_Stocks (stock_name, operation, operation_day, price) <span class="keyword">values</span> (<span class="string">&#x27;Handbags&#x27;</span>, <span class="string">&#x27;Sell&#x27;</span>, <span class="string">&#x27;29&#x27;</span>, <span class="string">&#x27;7000&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">84</span>_Stocks (stock_name, operation, operation_day, price) <span class="keyword">values</span> (<span class="string">&#x27;Corona Masks&#x27;</span>, <span class="string">&#x27;Sell&#x27;</span>, <span class="string">&#x27;10&#x27;</span>, <span class="string">&#x27;10000&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">     s2.stock_name,</span><br><span class="line">     s2.sum_sell <span class="operator">-</span> s1.sum_buy <span class="keyword">as</span> capital_gain_loss</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    (<span class="keyword">select</span> </span><br><span class="line">           stock_name,</span><br><span class="line">           <span class="built_in">sum</span>(if(operation<span class="operator">=</span><span class="string">&#x27;Buy&#x27;</span>,price,<span class="number">0</span>)) <span class="keyword">as</span> sum_buy,</span><br><span class="line">           <span class="built_in">sum</span>(if(operation<span class="operator">=</span><span class="string">&#x27;Sell&#x27;</span>,price,<span class="number">0</span>)) <span class="keyword">as</span> sum_sell</span><br><span class="line">     <span class="keyword">from</span></span><br><span class="line">           <span class="number">84</span>_stocks</span><br><span class="line">     <span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">           stock_name, operation) s1</span><br><span class="line"><span class="keyword">join</span></span><br><span class="line">    (<span class="keyword">select</span> </span><br><span class="line">           stock_name,</span><br><span class="line">           <span class="built_in">sum</span>(if(operation<span class="operator">=</span><span class="string">&#x27;Buy&#x27;</span>,price,<span class="number">0</span>)) <span class="keyword">as</span> sum_buy,</span><br><span class="line">           <span class="built_in">sum</span>(if(operation<span class="operator">=</span><span class="string">&#x27;Sell&#x27;</span>,price,<span class="number">0</span>)) <span class="keyword">as</span> sum_sell</span><br><span class="line">     <span class="keyword">from</span></span><br><span class="line">           <span class="number">84</span>_stocks</span><br><span class="line">     <span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">           stock_name, operation) s2</span><br><span class="line"><span class="keyword">on</span></span><br><span class="line">    s1.stock_name <span class="operator">=</span> s2.stock_name</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">    s1.sum_buy <span class="operator">&lt;&gt;</span> <span class="number">0</span> </span><br><span class="line">    <span class="keyword">and</span></span><br><span class="line">    s2.sum_buy <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法二</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">     stock_name,sell<span class="operator">-</span>buy capital_gain_loss</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    (<span class="keyword">select</span></span><br><span class="line">          stock_name,</span><br><span class="line">          <span class="built_in">sum</span>(if(operation<span class="operator">=</span><span class="string">&#x27;Buy&#x27;</span>, price,<span class="number">0</span>))<span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> stock_name ) buy,</span><br><span class="line">          <span class="built_in">sum</span>(if(operation<span class="operator">=</span><span class="string">&#x27;Sell&#x27;</span>,price,<span class="number">0</span>))<span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> stock_name) sell</span><br><span class="line">     <span class="keyword">from</span></span><br><span class="line">          <span class="number">84</span>_Stocks s )t1</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">     stock_name,buy,sell;</span><br></pre></td></tr></table></figure>



<h2 id="85-购买了产品A和B却没有购买产品C的顾客"><a href="#85-购买了产品A和B却没有购买产品C的顾客" class="headerlink" title="85. 购买了产品A和B却没有购买产品C的顾客"></a>85. 购买了产品A和B却没有购买产品C的顾客</h2><p>请你设计 SQL 查询来报告购买了产品 A 和产品 B 却没有购买产品 C 的顾客的 ID 和姓名（ <code>customer_id</code> 和 <code>customer_name</code> ），我们将基于此结果为他们推荐产品 C 。<br>您返回的查询结果需要按照 <code>customer_id</code> <strong>排序</strong>。</p>
<p>展示效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+-------------+---------------+</span><br><span class="line">| customer_id | customer_name |</span><br><span class="line">+-------------+---------------+</span><br><span class="line">| 3           | Elizabeth     |</span><br><span class="line">+-------------+---------------+</span><br></pre></td></tr></table></figure>

<p>建表语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">85</span>_Customers (customer_id <span class="type">int</span>, customer_name <span class="type">varchar</span>(<span class="number">30</span>));</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">85</span>_Orders (order_id <span class="type">int</span>, customer_id <span class="type">int</span>, product_name <span class="type">varchar</span>(<span class="number">30</span>));</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">85</span>_Customers;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">85</span>_Customers (customer_id, customer_name) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Daniel&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">85</span>_Customers (customer_id, customer_name) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;Diana&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">85</span>_Customers (customer_id, customer_name) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;Elizabeth&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">85</span>_Customers (customer_id, customer_name) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;Jhon&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">85</span>_Orders;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">85</span>_Orders (order_id, customer_id, product_name) <span class="keyword">values</span> (<span class="string">&#x27;10&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;A&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">85</span>_Orders (order_id, customer_id, product_name) <span class="keyword">values</span> (<span class="string">&#x27;20&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;B&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">85</span>_Orders (order_id, customer_id, product_name) <span class="keyword">values</span> (<span class="string">&#x27;30&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;D&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">85</span>_Orders (order_id, customer_id, product_name) <span class="keyword">values</span> (<span class="string">&#x27;40&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;C&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">85</span>_Orders (order_id, customer_id, product_name) <span class="keyword">values</span> (<span class="string">&#x27;50&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;A&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">85</span>_Orders (order_id, customer_id, product_name) <span class="keyword">values</span> (<span class="string">&#x27;60&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;A&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">85</span>_Orders (order_id, customer_id, product_name) <span class="keyword">values</span> (<span class="string">&#x27;70&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;B&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">85</span>_Orders (order_id, customer_id, product_name) <span class="keyword">values</span> (<span class="string">&#x27;80&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;D&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">85</span>_Orders (order_id, customer_id, product_name) <span class="keyword">values</span> (<span class="string">&#x27;90&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;C&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">     o.customer_id,</span><br><span class="line">     customer_name </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">     <span class="number">85</span>_Orders o </span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">     <span class="number">85</span>_Customers c</span><br><span class="line"><span class="keyword">on</span></span><br><span class="line">     o.customer_id<span class="operator">=</span>c.customer_id</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">     customer_id</span><br><span class="line"><span class="keyword">having</span> </span><br><span class="line">     <span class="built_in">sum</span>(product_name <span class="operator">=</span><span class="string">&#x27;A&#x27;</span>)<span class="operator">&gt;=</span><span class="number">1</span> </span><br><span class="line">     <span class="keyword">and</span></span><br><span class="line">     <span class="built_in">sum</span>(product_name<span class="operator">=</span><span class="string">&#x27;B&#x27;</span>)<span class="operator">&gt;=</span><span class="number">1</span></span><br><span class="line">     <span class="keyword">and</span></span><br><span class="line">     <span class="built_in">sum</span>(product_name<span class="operator">=</span><span class="string">&#x27;C&#x27;</span>)<span class="operator">=</span><span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<h2 id="86-排名靠前的旅行者"><a href="#86-排名靠前的旅行者" class="headerlink" title="86. 排名靠前的旅行者"></a>86. 排名靠前的旅行者</h2><p>写一段 SQL , 报告每个用户的旅行距离。返回的结果表单, 以 <code>travelled_distance</code> 降序排列, 如果有两个或者更多的用户旅行了相同的距离, 那么再以 <code>name</code> 升序排列.</p>
<p>展示效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">+----------+--------------------+</span><br><span class="line">| name     | travelled_distance |</span><br><span class="line">+----------+--------------------+</span><br><span class="line">| Elvis    | 450                |</span><br><span class="line">| Lee      | 450                |</span><br><span class="line">| Bob      | 317                |</span><br><span class="line">| Jonathan | 312                |</span><br><span class="line">| Alex     | 222                |</span><br><span class="line">| Alice    | 120                |</span><br><span class="line">| Donald   | 0                  |</span><br><span class="line">+----------+--------------------+</span><br><span class="line">Elvis 和 Lee 旅行了 450 英里, Elvis 是排名靠前的旅行者, 因为他的名字在字母表上的排序比 Lee 更小.</span><br><span class="line">Bob, Jonathan, Alex 和 Alice 只有一次行程, 我们只按此次行程的全部距离对他们排序.</span><br><span class="line">Donald 没有任何行程, 他的旅行距离为 0.</span><br></pre></td></tr></table></figure>

<p>建表语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">Table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">86</span>_Users (id <span class="type">int</span>, name <span class="type">varchar</span>(<span class="number">30</span>));</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">Table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">86</span>_Rides (id <span class="type">int</span>, user_id <span class="type">int</span>, distance <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">86</span>_Users;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">86</span>_Users (id, name) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Alice&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">86</span>_Users (id, name) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;Bob&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">86</span>_Users (id, name) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;Alex&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">86</span>_Users (id, name) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;Donald&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">86</span>_Users (id, name) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;Lee&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">86</span>_Users (id, name) <span class="keyword">values</span> (<span class="string">&#x27;13&#x27;</span>, <span class="string">&#x27;Jonathan&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">86</span>_Users (id, name) <span class="keyword">values</span> (<span class="string">&#x27;19&#x27;</span>, <span class="string">&#x27;Elvis&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">86</span>_Rides;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">86</span>_Rides (id, user_id, distance) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;120&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">86</span>_Rides (id, user_id, distance) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;317&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">86</span>_Rides (id, user_id, distance) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;222&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">86</span>_Rides (id, user_id, distance) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;100&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">86</span>_Rides (id, user_id, distance) <span class="keyword">values</span> (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;13&#x27;</span>, <span class="string">&#x27;312&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">86</span>_Rides (id, user_id, distance) <span class="keyword">values</span> (<span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;19&#x27;</span>, <span class="string">&#x27;50&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">86</span>_Rides (id, user_id, distance) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;120&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">86</span>_Rides (id, user_id, distance) <span class="keyword">values</span> (<span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;19&#x27;</span>, <span class="string">&#x27;400&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">86</span>_Rides (id, user_id, distance) <span class="keyword">values</span> (<span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;230&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">      name,</span><br><span class="line">      <span class="built_in">sum</span>(ifnull(distance,<span class="number">0</span>)) travelled_distance </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      <span class="number">86</span>_Users u </span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> </span><br><span class="line">      <span class="number">86</span>_Rides r</span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">      u.id <span class="operator">=</span> r.user_id</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">      name</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">      travelled_distance  <span class="keyword">desc</span>, name;</span><br></pre></td></tr></table></figure>

<h2 id="87-查找成绩处于中游的学生"><a href="#87-查找成绩处于中游的学生" class="headerlink" title="87. 查找成绩处于中游的学生"></a>87. 查找成绩处于中游的学生</h2><p>写一个 SQL 语句，找出在所有测验中都处于中游的学生 <code>(student_id, student_name)</code>。成绩处于中游的学生是指至少参加了一次测验, 且得分既不是最高分也不是最低分的学生。不要返回从来没有参加过测验的学生。返回结果表按照 <code>student_id</code> 排序。</p>
<p>展示效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">+-------------+---------------+</span><br><span class="line">| student_id  | student_name  |</span><br><span class="line">+-------------+---------------+</span><br><span class="line">| 2           | Jade          |</span><br><span class="line">+-------------+---------------+</span><br><span class="line"></span><br><span class="line">对于测验 1: 学生 1 和 3 分别获得了最低分和最高分。</span><br><span class="line">对于测验 2: 学生 1 既获得了最高分, 也获得了最低分。</span><br><span class="line">对于测验 3 和 4: 学生 1 和 4 分别获得了最低分和最高分。</span><br><span class="line">学生 2 和 5 没有在任一场测验中获得了最高分或者最低分。</span><br><span class="line">因为学生 5 从来没有参加过任何测验, 所以他被排除于结果表。</span><br><span class="line">由此, 我们仅仅返回学生 2 的信息。</span><br></pre></td></tr></table></figure>

<p>建表语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">87</span>_Student (student_id <span class="type">int</span>, student_name <span class="type">varchar</span>(<span class="number">30</span>));</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">87</span>_Exam (exam_id <span class="type">int</span>, student_id <span class="type">int</span>, score <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">87</span>_Student;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">87</span>_Student (student_id, student_name) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Daniel&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">87</span>_Student (student_id, student_name) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;Jade&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">87</span>_Student (student_id, student_name) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;Stella&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">87</span>_Student (student_id, student_name) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;Jonathan&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">87</span>_Student (student_id, student_name) <span class="keyword">values</span> (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;Will&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">87</span>_Exam;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">87</span>_Exam (exam_id, student_id, score) <span class="keyword">values</span> (<span class="string">&#x27;10&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;70&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">87</span>_Exam (exam_id, student_id, score) <span class="keyword">values</span> (<span class="string">&#x27;10&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;80&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">87</span>_Exam (exam_id, student_id, score) <span class="keyword">values</span> (<span class="string">&#x27;10&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;90&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">87</span>_Exam (exam_id, student_id, score) <span class="keyword">values</span> (<span class="string">&#x27;20&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;80&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">87</span>_Exam (exam_id, student_id, score) <span class="keyword">values</span> (<span class="string">&#x27;30&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;70&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">87</span>_Exam (exam_id, student_id, score) <span class="keyword">values</span> (<span class="string">&#x27;30&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;80&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">87</span>_Exam (exam_id, student_id, score) <span class="keyword">values</span> (<span class="string">&#x27;30&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;90&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">87</span>_Exam (exam_id, student_id, score) <span class="keyword">values</span> (<span class="string">&#x27;40&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;60&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">87</span>_Exam (exam_id, student_id, score) <span class="keyword">values</span> (<span class="string">&#x27;40&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;70&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">87</span>_Exam (exam_id, student_id, score) <span class="keyword">values</span> (<span class="string">&#x27;40&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;80&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">      student_id,</span><br><span class="line">      student_name</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      <span class="number">87</span>_student</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">      student_id <span class="keyword">not</span> <span class="keyword">in</span>(</span><br><span class="line">                 <span class="keyword">select</span></span><br><span class="line">                       s1.student_id</span><br><span class="line">                 <span class="keyword">from</span> </span><br><span class="line">                       <span class="number">87</span>_student s1</span><br><span class="line">                 <span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">                       <span class="number">87</span>_exam e1</span><br><span class="line">                 <span class="keyword">on</span></span><br><span class="line">                       s1.student_id <span class="operator">=</span> e1.student_id</span><br><span class="line">                 <span class="keyword">join</span></span><br><span class="line">                      (<span class="keyword">select</span> <span class="built_in">max</span>(score) max_score, <span class="built_in">min</span>(score) min_score <span class="keyword">from</span> <span class="number">87</span>_Exam) m</span><br><span class="line">                 <span class="keyword">on</span> </span><br><span class="line">                       e1.score <span class="operator">=</span> m.max_score</span><br><span class="line">                       <span class="keyword">or</span></span><br><span class="line">                       e1.score <span class="operator">=</span> m.min_score</span><br><span class="line">                       <span class="keyword">or</span></span><br><span class="line">                       e1.score <span class="keyword">is</span> <span class="keyword">null</span>);</span><br><span class="line"><span class="comment">-- 方法二</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">      e.student_id,</span><br><span class="line">      student_name</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      <span class="number">87</span>_Exam e </span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">      <span class="number">87</span>_Student s</span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">      e.student_id<span class="operator">=</span>s.student_id</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">      e.student_id <span class="keyword">not</span> <span class="keyword">in</span>(<span class="keyword">select</span> </span><br><span class="line">                                student_id</span><br><span class="line">                          <span class="keyword">from</span></span><br><span class="line">                               (<span class="keyword">select</span> </span><br><span class="line">                                      student_id,</span><br><span class="line">                                      <span class="built_in">rank</span>() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> exam_id <span class="keyword">order</span> <span class="keyword">by</span> score <span class="keyword">desc</span>) rkmax,</span><br><span class="line">                                      <span class="built_in">rank</span>() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> exam_id <span class="keyword">order</span> <span class="keyword">by</span> score ) rkmin</span><br><span class="line">                                <span class="keyword">from</span> </span><br><span class="line">                                      <span class="number">87</span>_Exam )t1</span><br><span class="line">                          <span class="keyword">where</span> </span><br><span class="line">                                rkmax <span class="operator">=</span> <span class="number">1</span> <span class="keyword">or</span> rkmin <span class="operator">=</span><span class="number">1</span> )</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">      e.student_id,</span><br><span class="line">      student_name</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">      e.student_id;</span><br></pre></td></tr></table></figure>



<h2 id="88-净现值查询"><a href="#88-净现值查询" class="headerlink" title="88. 净现值查询"></a>88. 净现值查询</h2><p>写一个 SQL, 找到 Queries 表中每一次查询的净现值，结果表没有顺序要求.</p>
<p>展示效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">+------+--------+--------+</span><br><span class="line">| id   | year   | npv    |</span><br><span class="line">+------+--------+--------+</span><br><span class="line">| 1    | 2019   | 113    |</span><br><span class="line">| 2    | 2008   | 121    |</span><br><span class="line">| 3    | 2009   | 12     |</span><br><span class="line">| 7    | 2018   | 0      |</span><br><span class="line">| 7    | 2019   | 0      |</span><br><span class="line">| 7    | 2020   | 30     |</span><br><span class="line">| 13   | 2019   | 40     |</span><br><span class="line">+------+--------+--------+</span><br><span class="line"></span><br><span class="line">(7, 2018)的净现值不在 NPV 表中, 我们把它看作是 0.</span><br><span class="line">所有其它查询的净现值都能在 NPV 表中找到.</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">Table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">88</span>_NPV (id <span class="type">int</span>, <span class="keyword">year</span> <span class="type">int</span>, npv <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">Table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">88</span>_Queries (id <span class="type">int</span>, <span class="keyword">year</span> <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">88</span>_NPV;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">88</span>_NPV (id, <span class="keyword">year</span>, npv) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2018&#x27;</span>, <span class="string">&#x27;100&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">88</span>_NPV (id, <span class="keyword">year</span>, npv) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;2020&#x27;</span>, <span class="string">&#x27;30&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">88</span>_NPV (id, <span class="keyword">year</span>, npv) <span class="keyword">values</span> (<span class="string">&#x27;13&#x27;</span>, <span class="string">&#x27;2019&#x27;</span>, <span class="string">&#x27;40&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">88</span>_NPV (id, <span class="keyword">year</span>, npv) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2019&#x27;</span>, <span class="string">&#x27;113&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">88</span>_NPV (id, <span class="keyword">year</span>, npv) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2008&#x27;</span>, <span class="string">&#x27;121&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">88</span>_NPV (id, <span class="keyword">year</span>, npv) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2009&#x27;</span>, <span class="string">&#x27;21&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">88</span>_NPV (id, <span class="keyword">year</span>, npv) <span class="keyword">values</span> (<span class="string">&#x27;11&#x27;</span>, <span class="string">&#x27;2020&#x27;</span>, <span class="string">&#x27;99&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">88</span>_NPV (id, <span class="keyword">year</span>, npv) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;2019&#x27;</span>, <span class="string">&#x27;0&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">88</span>_Queries;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">88</span>_Queries (id, <span class="keyword">year</span>) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2019&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">88</span>_Queries (id, <span class="keyword">year</span>) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2008&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">88</span>_Queries (id, <span class="keyword">year</span>) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2009&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">88</span>_Queries (id, <span class="keyword">year</span>) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;2018&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">88</span>_Queries (id, <span class="keyword">year</span>) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;2019&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">88</span>_Queries (id, <span class="keyword">year</span>) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;2020&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">88</span>_Queries (id, <span class="keyword">year</span>) <span class="keyword">values</span> (<span class="string">&#x27;13&#x27;</span>, <span class="string">&#x27;2019&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">      q.id,</span><br><span class="line">      q.year,</span><br><span class="line">      ifnull(npv,<span class="number">0</span>) npv</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      <span class="number">88</span>_Queries q</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">      <span class="number">88</span>_NPV n</span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">      q.id <span class="operator">=</span> n.id </span><br><span class="line">      <span class="keyword">and</span></span><br><span class="line">      q.year <span class="operator">=</span> n.year;</span><br></pre></td></tr></table></figure>



<h2 id="89-制作会话柱状图"><a href="#89-制作会话柱状图" class="headerlink" title="89. 制作会话柱状图"></a>89. 制作会话柱状图</h2><p>你想知道用户在你的 app 上的访问时长情况。因此决定统计访问时长区间分别为 “[0-5&gt;”, “[5-10&gt;”, “[10-15&gt;” 和 “15 or more” （单位：分钟）的会话数量，并以此绘制柱状图。</p>
<p>写一个SQL查询来报告（访问时长区间，会话总数）。结果可用任何顺序呈现。</p>
<p> 展示效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">+--------------+--------------+</span><br><span class="line">| bin          | total        |</span><br><span class="line">+--------------+--------------+</span><br><span class="line">| [0-5&gt;        | 3            |</span><br><span class="line">| [5-10&gt;       | 1            |</span><br><span class="line">| [10-15&gt;      | 0            |</span><br><span class="line">| 15 or more   | 1            |</span><br><span class="line">+--------------+--------------+</span><br><span class="line"></span><br><span class="line">对于 session_id 1，2 和 3 ，它们的访问时间大于等于 0 分钟且小于 5 分钟。</span><br><span class="line">对于 session_id 4，它的访问时间大于等于 5 分钟且小于 10 分钟。</span><br><span class="line">没有会话的访问时间大于等于 10 分钟且小于 15 分钟。</span><br><span class="line">对于 session_id 5, 它的访问时间大于等于 15 分钟。</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">89</span>_Sessions (session_id <span class="type">int</span>, duration <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">89</span>_Sessions;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">89</span>_Sessions (session_id, duration) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;30&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">89</span>_Sessions (session_id, duration) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;199&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">89</span>_Sessions (session_id, duration) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;299&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">89</span>_Sessions (session_id, duration) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;580&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">89</span>_Sessions (session_id, duration) <span class="keyword">values</span> (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;1000&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一</span></span><br><span class="line"><span class="keyword">select</span> <span class="string">&#x27;[0-5&gt;&#x27;</span> <span class="keyword">as</span> bin, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> total <span class="keyword">from</span> <span class="number">89</span>_Sessions <span class="keyword">where</span> duration<span class="operator">/</span><span class="number">60</span><span class="operator">&gt;=</span><span class="number">0</span> <span class="keyword">and</span> duration<span class="operator">/</span><span class="number">60</span><span class="operator">&lt;</span><span class="number">5</span></span><br><span class="line"><span class="keyword">union</span></span><br><span class="line"><span class="keyword">select</span> <span class="string">&#x27;[5-10&gt;&#x27;</span> <span class="keyword">as</span> bin, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> total <span class="keyword">from</span> <span class="number">89</span>_Sessions <span class="keyword">where</span> duration<span class="operator">/</span><span class="number">60</span><span class="operator">&gt;=</span><span class="number">5</span> <span class="keyword">and</span> duration<span class="operator">/</span><span class="number">60</span><span class="operator">&lt;</span><span class="number">10</span></span><br><span class="line"><span class="keyword">union</span></span><br><span class="line"><span class="keyword">select</span> <span class="string">&#x27;[10-15&gt;&#x27;</span> <span class="keyword">as</span> bin, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> total <span class="keyword">from</span> <span class="number">89</span>_Sessions <span class="keyword">where</span> duration<span class="operator">/</span><span class="number">60</span><span class="operator">&gt;=</span><span class="number">10</span> <span class="keyword">and</span> duration<span class="operator">/</span><span class="number">60</span><span class="operator">&lt;</span><span class="number">15</span></span><br><span class="line"><span class="keyword">union</span></span><br><span class="line"><span class="keyword">select</span> <span class="string">&#x27;15 or more&#x27;</span><span class="keyword">as</span> bin, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> total <span class="keyword">from</span> <span class="number">89</span>_Sessions <span class="keyword">where</span> duration<span class="operator">/</span><span class="number">60</span><span class="operator">&gt;=</span><span class="number">15</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法二</span></span><br><span class="line"><span class="keyword">select</span> a.bin, <span class="built_in">count</span>(b.bin) <span class="keyword">as</span> total</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">(<span class="keyword">select</span> <span class="string">&#x27;[0-5&gt;&#x27;</span> <span class="keyword">as</span> bin <span class="keyword">union</span> <span class="keyword">select</span> <span class="string">&#x27;[5-10&gt;&#x27;</span> <span class="keyword">as</span> bin <span class="keyword">union</span> <span class="keyword">select</span> <span class="string">&#x27;[10-15&gt;&#x27;</span> <span class="keyword">as</span> bin <span class="keyword">union</span> <span class="keyword">select</span> <span class="string">&#x27;15 or more&#x27;</span> <span class="keyword">as</span> bin)a</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> </span><br><span class="line">(<span class="keyword">select</span> <span class="keyword">case</span></span><br><span class="line">        <span class="keyword">when</span> duration <span class="operator">&lt;</span> <span class="number">300</span> <span class="keyword">then</span> <span class="string">&#x27;[0-5&gt;&#x27;</span></span><br><span class="line">        <span class="keyword">when</span> duration <span class="operator">&gt;=</span> <span class="number">300</span> <span class="keyword">and</span> duration <span class="operator">&lt;</span> <span class="number">600</span> <span class="keyword">then</span> <span class="string">&#x27;[5-10&gt;&#x27;</span></span><br><span class="line">        <span class="keyword">when</span> duration <span class="operator">&gt;=</span> <span class="number">600</span> <span class="keyword">and</span> duration <span class="operator">&lt;</span> <span class="number">900</span> <span class="keyword">then</span> <span class="string">&#x27;[10-15&gt;&#x27;</span></span><br><span class="line">        <span class="keyword">else</span> <span class="string">&#x27;15 or more&#x27;</span></span><br><span class="line">        <span class="keyword">end</span> bin</span><br><span class="line">    <span class="keyword">from</span> <span class="number">89</span>_Sessions </span><br><span class="line">)b</span><br><span class="line"><span class="keyword">on</span> a.bin <span class="operator">=</span> b.bin</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> a.bin</span><br></pre></td></tr></table></figure>



<h2 id="90-计算布尔表达式的值"><a href="#90-计算布尔表达式的值" class="headerlink" title="90. 计算布尔表达式的值"></a>90. 计算布尔表达式的值</h2><p>写一个 SQL 查询, 以计算表 <code>Expressions</code> 中的布尔表达式，返回的结果表没有顺序要求.</p>
<p>展示效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">+--------------+----------+---------------+-------+</span><br><span class="line">| left_operand | operator | right_operand | value |</span><br><span class="line">+--------------+----------+---------------+-------+</span><br><span class="line">| x            | &gt;        | y             | false |</span><br><span class="line">| x            | &lt;        | y             | true  |</span><br><span class="line">| x            | &#x3D;        | y             | false |</span><br><span class="line">| y            | &gt;        | x             | true  |</span><br><span class="line">| y            | &lt;        | x             | false |</span><br><span class="line">| x            | &#x3D;        | x             | true  |</span><br><span class="line">+--------------+----------+---------------+-------+</span><br></pre></td></tr></table></figure>

<p>建表语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">Table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">90</span>_Variables (name <span class="type">varchar</span>(<span class="number">3</span>), <span class="keyword">value</span> <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">Table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">90</span>_Expressions (left_operand <span class="type">varchar</span>(<span class="number">3</span>), operator ENUM(<span class="string">&#x27;&gt;&#x27;</span>, <span class="string">&#x27;&lt;&#x27;</span>, <span class="string">&#x27;=&#x27;</span>), right_operand <span class="type">varchar</span>(<span class="number">3</span>));</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">90</span>_Variables;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">90</span>_Variables (name, <span class="keyword">value</span>) <span class="keyword">values</span> (<span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;66&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">90</span>_Variables (name, <span class="keyword">value</span>) <span class="keyword">values</span> (<span class="string">&#x27;y&#x27;</span>, <span class="string">&#x27;77&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">90</span>_Expressions;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">90</span>_Expressions (left_operand, operator, right_operand) <span class="keyword">values</span> (<span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;&gt;&#x27;</span>, <span class="string">&#x27;y&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">90</span>_Expressions (left_operand, operator, right_operand) <span class="keyword">values</span> (<span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;&lt;&#x27;</span>, <span class="string">&#x27;y&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">90</span>_Expressions (left_operand, operator, right_operand) <span class="keyword">values</span> (<span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;=&#x27;</span>, <span class="string">&#x27;y&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">90</span>_Expressions (left_operand, operator, right_operand) <span class="keyword">values</span> (<span class="string">&#x27;y&#x27;</span>, <span class="string">&#x27;&gt;&#x27;</span>, <span class="string">&#x27;x&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">90</span>_Expressions (left_operand, operator, right_operand) <span class="keyword">values</span> (<span class="string">&#x27;y&#x27;</span>, <span class="string">&#x27;&lt;&#x27;</span>, <span class="string">&#x27;x&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">90</span>_Expressions (left_operand, operator, right_operand) <span class="keyword">values</span> (<span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;=&#x27;</span>, <span class="string">&#x27;x&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">     e.left_operand,</span><br><span class="line">     e.operator,</span><br><span class="line">     e.right_operand,</span><br><span class="line">     <span class="keyword">case</span> e.operator</span><br><span class="line">              <span class="keyword">when</span> <span class="string">&#x27;&gt;&#x27;</span> <span class="keyword">then</span> if(v1.value<span class="operator">&gt;</span>v2.value,<span class="string">&#x27;true&#x27;</span>,<span class="string">&#x27;false&#x27;</span>)</span><br><span class="line">              <span class="keyword">when</span> <span class="string">&#x27;&lt;&#x27;</span> <span class="keyword">then</span> if(v1.value<span class="operator">&lt;</span>v2.value,<span class="string">&#x27;true&#x27;</span>,<span class="string">&#x27;false&#x27;</span>)</span><br><span class="line">              <span class="keyword">else</span> if(v1.value<span class="operator">=</span>v2.value,<span class="string">&#x27;true&#x27;</span>,<span class="string">&#x27;false&#x27;</span>)</span><br><span class="line">     <span class="keyword">end</span> <span class="keyword">value</span></span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">     <span class="number">90</span>_Expressions e</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">     <span class="number">90</span>_Variables v1 </span><br><span class="line"><span class="keyword">on</span></span><br><span class="line">     v1.name <span class="operator">=</span> e.left_operand </span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">     <span class="number">90</span>_Variables v2 </span><br><span class="line"><span class="keyword">on</span></span><br><span class="line">     v2.name <span class="operator">=</span> e.right_operand;</span><br></pre></td></tr></table></figure>



<h2 id="91-苹果和桔子"><a href="#91-苹果和桔子" class="headerlink" title="91. 苹果和桔子"></a>91. 苹果和桔子</h2><p>写一个 SQL 查询, 报告每一天 <strong>苹果</strong> 和 <strong>桔子</strong> 销售的数目的差异.返回的结果表, 按照格式为 (‘YYYY-MM-DD’) 的 <code>sale_date</code> 排序.</p>
<p>查询结果表如下例所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">+------------+--------------+</span><br><span class="line">| sale_date  | diff         |</span><br><span class="line">+------------+--------------+</span><br><span class="line">| 2020-05-01 | 2            |</span><br><span class="line">| 2020-05-02 | 0            |</span><br><span class="line">| 2020-05-03 | 20           |</span><br><span class="line">| 2020-05-04 | -1           |</span><br><span class="line">+------------+--------------+</span><br><span class="line"></span><br><span class="line">在 2020-05-01, 卖了 10 个苹果 和 8 个桔子 (差异为 10 - 8 &#x3D; 2).</span><br><span class="line">在 2020-05-02, 卖了 15 个苹果 和 15 个桔子 (差异为 15 - 15 &#x3D; 0).</span><br><span class="line">在 2020-05-03, 卖了 20 个苹果 和 0 个桔子 (差异为 20 - 0 &#x3D; 20).</span><br><span class="line">在 2020-05-04, 卖了 15 个苹果 和 16 个桔子 (差异为 15 - 16 &#x3D; -1).</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">91</span>_Sales (sale_date <span class="type">date</span>, fruit ENUM(<span class="string">&#x27;apples&#x27;</span>, <span class="string">&#x27;oranges&#x27;</span>), sold_num <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">91</span>_Sales;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">91</span>_Sales (sale_date, fruit, sold_num) <span class="keyword">values</span> (<span class="string">&#x27;2020-05-01&#x27;</span>, <span class="string">&#x27;apples&#x27;</span>, <span class="string">&#x27;10&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">91</span>_Sales (sale_date, fruit, sold_num) <span class="keyword">values</span> (<span class="string">&#x27;2020-05-01&#x27;</span>, <span class="string">&#x27;oranges&#x27;</span>, <span class="string">&#x27;8&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">91</span>_Sales (sale_date, fruit, sold_num) <span class="keyword">values</span> (<span class="string">&#x27;2020-05-02&#x27;</span>, <span class="string">&#x27;apples&#x27;</span>, <span class="string">&#x27;15&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">91</span>_Sales (sale_date, fruit, sold_num) <span class="keyword">values</span> (<span class="string">&#x27;2020-05-02&#x27;</span>, <span class="string">&#x27;oranges&#x27;</span>, <span class="string">&#x27;15&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">91</span>_Sales (sale_date, fruit, sold_num) <span class="keyword">values</span> (<span class="string">&#x27;2020-05-03&#x27;</span>, <span class="string">&#x27;apples&#x27;</span>, <span class="string">&#x27;20&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">91</span>_Sales (sale_date, fruit, sold_num) <span class="keyword">values</span> (<span class="string">&#x27;2020-05-03&#x27;</span>, <span class="string">&#x27;oranges&#x27;</span>, <span class="string">&#x27;0&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">91</span>_Sales (sale_date, fruit, sold_num) <span class="keyword">values</span> (<span class="string">&#x27;2020-05-04&#x27;</span>, <span class="string">&#x27;apples&#x27;</span>, <span class="string">&#x27;15&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">91</span>_Sales (sale_date, fruit, sold_num) <span class="keyword">values</span> (<span class="string">&#x27;2020-05-04&#x27;</span>, <span class="string">&#x27;oranges&#x27;</span>, <span class="string">&#x27;16&#x27;</span>);</span><br></pre></td></tr></table></figure>



<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">     s1.sale_date,</span><br><span class="line">     s1.sold_num <span class="operator">-</span> s2.sold_num <span class="keyword">as</span> diff</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">     <span class="number">91</span>_Sales s1</span><br><span class="line"><span class="keyword">join</span> </span><br><span class="line">     <span class="number">91</span>_Sales s2</span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">     s1.sale_date <span class="operator">=</span> s2.sale_date</span><br><span class="line">     <span class="keyword">and</span></span><br><span class="line">     s1.fruit <span class="operator">&lt;&gt;</span> s2.fruit</span><br><span class="line">     <span class="keyword">and</span> </span><br><span class="line">     s1.fruit <span class="operator">&lt;&gt;</span> <span class="string">&#x27;oranges&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法二</span></span><br><span class="line"><span class="keyword">select</span>  </span><br><span class="line">     sale_date,</span><br><span class="line">     sold_num <span class="operator">-</span> ld <span class="keyword">as</span> diff</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    (<span class="keyword">select</span></span><br><span class="line">          sale_date,</span><br><span class="line">          sold_num, </span><br><span class="line">          fruit,</span><br><span class="line">          <span class="built_in">lead</span>(sold_num ,<span class="number">1</span>,<span class="keyword">null</span>) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span>  sale_date ) ld</span><br><span class="line">     <span class="keyword">from</span> <span class="number">91</span>_Sales )t1</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">     fruit<span class="operator">=</span><span class="string">&#x27;apples&#x27;</span>;</span><br></pre></td></tr></table></figure>



<h2 id="92-活跃用户"><a href="#92-活跃用户" class="headerlink" title="92.  活跃用户"></a>92.  活跃用户</h2><p>写一个 SQL 查询, 找到活跃用户的 id 和 name，活跃用户是指那些至少连续 5 天登录账户的用户。返回的结果表按照 id 排序.</p>
<p>展示数据：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+----+----------+</span><br><span class="line">| id | name     |</span><br><span class="line">+----+----------+</span><br><span class="line">| 7  | Jonathan |</span><br><span class="line">+----+----------+</span><br><span class="line">id &#x3D; 1 的用户 Winston 仅仅在不同的 2 天内登录了 2 次, 所以, Winston 不是活跃用户.</span><br><span class="line">id &#x3D; 7 的用户 Jonathon 在不同的 6 天内登录了 7 次, , 6 天中有 5 天是连续的, 所以, Jonathan 是活跃用户.</span><br></pre></td></tr></table></figure>

<p> 建表语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">92</span>_Accounts (id <span class="type">int</span>, name <span class="type">varchar</span>(<span class="number">10</span>));</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">92</span>_Logins (id <span class="type">int</span>, login_date <span class="type">date</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">92</span>_Accounts;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">92</span>_Accounts (id, name) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Winston&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">92</span>_Accounts (id, name) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;Jonathan&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">92</span>_Logins;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">92</span>_Logins (id, login_date) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;2020-05-30&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">92</span>_Logins (id, login_date) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2020-05-30&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">92</span>_Logins (id, login_date) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;2020-05-31&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">92</span>_Logins (id, login_date) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;2020-06-01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">92</span>_Logins (id, login_date) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;2020-06-02&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">92</span>_Logins (id, login_date) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;2020-06-02&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">92</span>_Logins (id, login_date) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;2020-06-03&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">92</span>_Logins (id, login_date) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2020-06-07&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">92</span>_Logins (id, login_date) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;2020-06-10&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">      <span class="keyword">distinct</span> a.id,</span><br><span class="line">      a.name </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      <span class="number">92</span>_Accounts a,</span><br><span class="line">      <span class="number">92</span>_logins l1</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">      a.id<span class="operator">=</span>l1.id</span><br><span class="line">      <span class="keyword">and</span></span><br><span class="line">      (<span class="keyword">select</span></span><br><span class="line">             <span class="built_in">count</span>(<span class="keyword">distinct</span> l2.login_date)  </span><br><span class="line">       <span class="keyword">from</span> </span><br><span class="line">             <span class="number">92</span>_logins l2</span><br><span class="line">       <span class="keyword">where</span> </span><br><span class="line">             l1.id<span class="operator">=</span>l2.id</span><br><span class="line">             <span class="keyword">and</span> </span><br><span class="line">             datediff(l1.login_date,l2.login_date) <span class="keyword">between</span> <span class="number">0</span> <span class="keyword">and</span> <span class="number">4</span></span><br><span class="line">       )<span class="operator">&gt;=</span><span class="number">5</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法二</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">      <span class="keyword">distinct</span> a.id, a.name </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      <span class="number">92</span>_Accounts a</span><br><span class="line"><span class="keyword">join</span> </span><br><span class="line">      <span class="number">92</span>_Logins l1</span><br><span class="line"><span class="keyword">using</span>(id)</span><br><span class="line"><span class="keyword">join</span> </span><br><span class="line">      <span class="number">92</span>_Logins l2</span><br><span class="line"><span class="keyword">on</span></span><br><span class="line">      l1.id <span class="operator">=</span> l2.id</span><br><span class="line">      <span class="keyword">and</span></span><br><span class="line">      datediff(l2.login_date, l1.login_date) <span class="keyword">between</span> <span class="number">0</span> <span class="keyword">and</span> <span class="number">4</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">      a.id, a.name, l1.login_date</span><br><span class="line"><span class="keyword">having</span></span><br><span class="line">      <span class="built_in">count</span>(<span class="keyword">distinct</span> l2.login_date) <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法三</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">     t3.id,name</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    (<span class="keyword">select</span></span><br><span class="line">           <span class="keyword">distinct</span> id</span><br><span class="line">    <span class="keyword">from</span> </span><br><span class="line">          (<span class="keyword">select</span></span><br><span class="line">                 id,</span><br><span class="line">                 login_date,</span><br><span class="line">                 <span class="built_in">lead</span>(login_date,<span class="number">4</span>,<span class="keyword">null</span>) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> id <span class="keyword">order</span> <span class="keyword">by</span> login_date) ld</span><br><span class="line">           <span class="keyword">from</span> </span><br><span class="line">               (<span class="keyword">select</span></span><br><span class="line">                     id,</span><br><span class="line">                     login_date </span><br><span class="line">                <span class="keyword">from</span> </span><br><span class="line">                     <span class="number">92</span>_Logins</span><br><span class="line">                <span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">                     id,login_date</span><br><span class="line">               )t1</span><br><span class="line">           )t2</span><br><span class="line">    <span class="keyword">where</span> datediff(ld,login_date)<span class="operator">=</span><span class="number">4</span> </span><br><span class="line">    )t3</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">      <span class="number">92</span>_Accounts a</span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">      t3.id <span class="operator">=</span> a.id;</span><br></pre></td></tr></table></figure>

<h2 id="93-矩形面积"><a href="#93-矩形面积" class="headerlink" title="93. 矩形面积"></a>93. 矩形面积</h2><p>写一个 SQL 语句, 报告由表中任意两点可以形成的所有可能的矩形. </p>
<p>结果表中的每一行包含三列 (p1, p2, area) 如下:</p>
<ul>
<li><strong>p1</strong> 和 <strong>p2</strong> 是矩形两个对角的 id 且 p1 &lt; p2.</li>
<li>矩形的面积由列 <strong>area</strong> 表示. </li>
</ul>
<p>请按照面积大小降序排列，如果面积相同的话, 则按照 p1 和 p2 升序对结果表排序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">+----------+-------------+-------------+</span><br><span class="line">| p1       | p2          | area        |</span><br><span class="line">+----------+-------------+-------------+</span><br><span class="line">| 2        | 3           | 6           |</span><br><span class="line">| 1        | 2           | 2           |</span><br><span class="line">+----------+-------------+-------------+</span><br><span class="line"></span><br><span class="line">p1 应该小于 p2 并且面积大于 0.</span><br><span class="line">p1 &#x3D; 1 且 p2 &#x3D; 2 时, 面积等于 |2-4| * |8-7| &#x3D; 2.</span><br><span class="line">p1 &#x3D; 2 且 p2 &#x3D; 3 时, 面积等于 |4-2| * |7-10| &#x3D; 6.</span><br><span class="line">p1 &#x3D; 1 且 p2 &#x3D; 3 时, 是不可能为矩形的, 因为面积等于 0.</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">93</span>_Points (id <span class="type">int</span>, x_value <span class="type">int</span>, y_value <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">93</span>_Points;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">93</span>_Points (id, x_value, y_value) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;8&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">93</span>_Points (id, x_value, y_value) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;7&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">93</span>_Points (id, x_value, y_value) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;10&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">      a.id P1,</span><br><span class="line">      b.id P2,</span><br><span class="line">      <span class="built_in">abs</span>(a.x_value<span class="operator">-</span>b.x_value)<span class="operator">*</span><span class="built_in">abs</span>(a.y_value<span class="operator">-</span>b.y_value) <span class="keyword">as</span> area</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      Points a,Points b</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">      a.id<span class="operator">&lt;</span>b.id </span><br><span class="line">      <span class="keyword">and</span> </span><br><span class="line">      a.x_value <span class="operator">!=</span> b.x_value</span><br><span class="line">      <span class="keyword">and</span></span><br><span class="line">      a.y_value <span class="operator">!=</span> b.y_value</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">      area <span class="keyword">desc</span>,P1 ,P2 </span><br></pre></td></tr></table></figure>

<h2 id="94-计算税后工资"><a href="#94-计算税后工资" class="headerlink" title="94. 计算税后工资"></a>94. 计算税后工资</h2><p>写一条查询 SQL 来查找每个员工的税后工资</p>
<p>每个公司的税率计算依照以下规则</p>
<ul>
<li>如果这个公司员工最高工资不到 1000 ，税率为 0%</li>
<li>如果这个公司员工最高工资在 1000 到 10000 之间，税率为 24%</li>
<li>如果这个公司员工最高工资大于 10000 ，税率为 49%</li>
</ul>
<p>按任意顺序返回结果，税后工资结果取整</p>
<p>结果表格式如下例所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">+------------+-------------+---------------+--------+</span><br><span class="line">| company_id | employee_id | employee_name | salary |</span><br><span class="line">+------------+-------------+---------------+--------+</span><br><span class="line">| 1          | 1           | Tony          | 1020   |</span><br><span class="line">| 1          | 2           | Pronub        | 10863  |</span><br><span class="line">| 1          | 3           | Tyrrox        | 5508   |</span><br><span class="line">| 2          | 1           | Pam           | 300    |</span><br><span class="line">| 2          | 7           | Bassem        | 450    |</span><br><span class="line">| 2          | 9           | Hermione      | 700    |</span><br><span class="line">| 3          | 7           | Bocaben       | 76     |</span><br><span class="line">| 3          | 2           | Ognjen        | 1672   |</span><br><span class="line">| 3          | 13          | Nyancat       | 2508   |</span><br><span class="line">| 3          | 15          | Morninngcat   | 5911   |</span><br><span class="line">+------------+-------------+---------------+--------+</span><br><span class="line">对于公司 1 ，最高工资是 21300 ，其每个员工的税率为 49%</span><br><span class="line">对于公司 2 ，最高工资是 700 ，其每个员工税率为 0%</span><br><span class="line">对于公司 3 ，最高工资是 7777 ，其每个员工税率是 24%</span><br><span class="line">税后工资计算 &#x3D; 工资 - ( 税率 &#x2F; 100）*工资</span><br><span class="line">对于上述案例，Morninngcat 的税后工资 &#x3D; 7777 - 7777 * ( 24 &#x2F; 100) &#x3D; 7777 - 1866.48 &#x3D; 5910.52 ，取整为 5911</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">94</span>_Salaries (company_id <span class="type">int</span>, employee_id <span class="type">int</span>, employee_name <span class="type">varchar</span>(<span class="number">13</span>), salary <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">94</span>_Salaries;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">94</span>_Salaries (company_id, employee_id, employee_name, salary) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Tony&#x27;</span>, <span class="string">&#x27;2000&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">94</span>_Salaries (company_id, employee_id, employee_name, salary) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;Pronub&#x27;</span>, <span class="string">&#x27;21300&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">94</span>_Salaries (company_id, employee_id, employee_name, salary) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;Tyrrox&#x27;</span>, <span class="string">&#x27;10800&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">94</span>_Salaries (company_id, employee_id, employee_name, salary) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Pam&#x27;</span>, <span class="string">&#x27;300&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">94</span>_Salaries (company_id, employee_id, employee_name, salary) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;Bassem&#x27;</span>, <span class="string">&#x27;450&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">94</span>_Salaries (company_id, employee_id, employee_name, salary) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;Hermione&#x27;</span>, <span class="string">&#x27;700&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">94</span>_Salaries (company_id, employee_id, employee_name, salary) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;Bocaben&#x27;</span>, <span class="string">&#x27;100&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">94</span>_Salaries (company_id, employee_id, employee_name, salary) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;Ognjen&#x27;</span>, <span class="string">&#x27;2200&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">94</span>_Salaries (company_id, employee_id, employee_name, salary) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;13&#x27;</span>, <span class="string">&#x27;Nyancat&#x27;</span>, <span class="string">&#x27;3300&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">94</span>_Salaries (company_id, employee_id, employee_name, salary) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;15&#x27;</span>, <span class="string">&#x27;Morninngcat&#x27;</span>, <span class="string">&#x27;7777&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">     s1.company_id,</span><br><span class="line">     s1.employee_id,</span><br><span class="line">     s1.employee_name,</span><br><span class="line">     round(<span class="keyword">case</span></span><br><span class="line">               <span class="keyword">when</span> m.max_salary<span class="operator">&lt;</span><span class="number">1000</span> <span class="keyword">then</span> salary</span><br><span class="line">               <span class="keyword">when</span> m.maxsalary<span class="operator">&lt;</span><span class="number">10000</span> <span class="keyword">then</span> salary<span class="operator">*</span>(<span class="number">1</span><span class="number">-0.24</span>)</span><br><span class="line">               <span class="keyword">else</span> salary<span class="operator">*</span>(<span class="number">1</span><span class="number">-0.49</span>)</span><br><span class="line">           <span class="keyword">end</span> ,<span class="number">0</span>) salary</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">     <span class="number">94</span>_Salaries s1</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">    (<span class="keyword">select</span> </span><br><span class="line">           s2.company_id,</span><br><span class="line">           <span class="built_in">max</span>(s2.salary) max_salary</span><br><span class="line">     <span class="keyword">from</span></span><br><span class="line">           <span class="number">94</span>_Salaries s2</span><br><span class="line">     <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">           company_id</span><br><span class="line">     ) m</span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">     m.company_id <span class="operator">=</span> s1.conpany_id;</span><br><span class="line">     </span><br><span class="line"><span class="comment">-- 方法二</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">     company_id,</span><br><span class="line">     employee_id,</span><br><span class="line">     employee_name,</span><br><span class="line">     round(<span class="keyword">case</span></span><br><span class="line">               <span class="keyword">when</span> maxsalary<span class="operator">&lt;</span><span class="number">1000</span> <span class="keyword">then</span> salary</span><br><span class="line">               <span class="keyword">when</span> maxsalary<span class="operator">&lt;</span><span class="number">10000</span> <span class="keyword">then</span> salary<span class="operator">*</span>(<span class="number">1</span><span class="number">-0.24</span>)</span><br><span class="line">               <span class="keyword">else</span> salary<span class="operator">*</span>(<span class="number">1</span><span class="number">-0.49</span>)</span><br><span class="line">           <span class="keyword">end</span> ,<span class="number">0</span>) salary</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    (<span class="keyword">select</span> </span><br><span class="line">          <span class="operator">*</span>,</span><br><span class="line">          <span class="built_in">max</span>(salary) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> company_id ) maxsalary</span><br><span class="line">    <span class="keyword">from</span> Salaries )t1 ;</span><br></pre></td></tr></table></figure>

<h2 id="95-周内每天的销售情况"><a href="#95-周内每天的销售情况" class="headerlink" title="95. 周内每天的销售情况"></a>95. 周内每天的销售情况</h2><p>写一个SQL语句，报告 <strong>周内每天</strong> 每个商品类别下订购了多少单位。返回结果表单 <strong>按商品类别排序</strong> 。</p>
<p>查询结果格式如下例所示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">+------------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+</span><br><span class="line">| Category   | Monday    | Tuesday   | Wednesday | Thursday  | Friday    | Saturday  | Sunday    |</span><br><span class="line">+------------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+</span><br><span class="line">| Book       | 20        | 5         | 0         | 0         | 10        | 0         | 0         |</span><br><span class="line">| Glasses    | 0         | 0         | 0         | 0         | 5         | 0         | 0         |</span><br><span class="line">| Phone      | 0         | 0         | 5         | 1         | 0         | 0         | 10        |</span><br><span class="line">| T-Shirt    | 0         | 0         | 0         | 0         | 0         | 0         | 0         |</span><br><span class="line">+------------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+</span><br><span class="line">在周一(2020-06-01, 2020-06-08)，Book分类(ids: 1, 2)下，总共销售了20个单位(10 + 10)</span><br><span class="line">在周二(2020-06-02)，Book分类(ids: 1, 2)下，总共销售了5个单位</span><br><span class="line">在周三(2020-06-03)，Phone分类(ids: 3, 4)下，总共销售了5个单位</span><br><span class="line">在周四(2020-06-04)，Phone分类(ids: 3, 4)下，总共销售了1个单位</span><br><span class="line">在周五(2020-06-05)，Book分类(ids: 1, 2)下，总共销售了10个单位，Glasses分类(ids: 5)下，总共销售了5个单位</span><br><span class="line">在周六, 没有商品销售</span><br><span class="line">在周天(2020-06-14, 2020-06-21)，Phone分类(ids: 3, 4)下，总共销售了10个单位(5 + 5)</span><br><span class="line">没有销售 T-Shirt 类别的商品</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">95</span>_Orders (order_id <span class="type">int</span>, customer_id <span class="type">int</span>, order_date <span class="type">date</span>, item_id <span class="type">varchar</span>(<span class="number">30</span>), quantity <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">95</span>_Items (item_id <span class="type">varchar</span>(<span class="number">30</span>), item_name <span class="type">varchar</span>(<span class="number">30</span>), item_category <span class="type">varchar</span>(<span class="number">30</span>));</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">95</span>_Orders;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">95</span>_Orders (order_id, customer_id, order_date, item_id, quantity) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2020-06-01&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;10&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">95</span>_Orders (order_id, customer_id, order_date, item_id, quantity) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2020-06-08&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;10&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">95</span>_Orders (order_id, customer_id, order_date, item_id, quantity) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2020-06-02&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;5&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">95</span>_Orders (order_id, customer_id, order_date, item_id, quantity) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2020-06-03&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;5&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">95</span>_Orders (order_id, customer_id, order_date, item_id, quantity) <span class="keyword">values</span> (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;2020-06-04&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">95</span>_Orders (order_id, customer_id, order_date, item_id, quantity) <span class="keyword">values</span> (<span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;2020-06-05&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;5&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">95</span>_Orders (order_id, customer_id, order_date, item_id, quantity) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;2020-06-05&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;10&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">95</span>_Orders (order_id, customer_id, order_date, item_id, quantity) <span class="keyword">values</span> (<span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;2020-06-14&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;5&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">95</span>_Orders (order_id, customer_id, order_date, item_id, quantity) <span class="keyword">values</span> (<span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;2020-06-21&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;5&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">95</span>_Items;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">95</span>_Items (item_id, item_name, item_category) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;LC Alg. Book&#x27;</span>, <span class="string">&#x27;Book&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">95</span>_Items (item_id, item_name, item_category) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;LC DB. Book&#x27;</span>, <span class="string">&#x27;Book&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">95</span>_Items (item_id, item_name, item_category) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;LC SmarthPhone&#x27;</span>, <span class="string">&#x27;Phone&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">95</span>_Items (item_id, item_name, item_category) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;LC Phone 2020&#x27;</span>, <span class="string">&#x27;Phone&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">95</span>_Items (item_id, item_name, item_category) <span class="keyword">values</span> (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;LC SmartGlass&#x27;</span>, <span class="string">&#x27;Glasses&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">95</span>_Items (item_id, item_name, item_category) <span class="keyword">values</span> (<span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;LC T-Shirt XL&#x27;</span>, <span class="string">&#x27;T-shirt&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">     item_category <span class="keyword">as</span> category, </span><br><span class="line">     <span class="built_in">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> num <span class="operator">=</span> <span class="number">2</span> <span class="keyword">then</span> quantity <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span> Monday,</span><br><span class="line">     <span class="built_in">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> num <span class="operator">=</span> <span class="number">3</span> <span class="keyword">then</span> quantity <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span> Tuesday,</span><br><span class="line">     <span class="built_in">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> num <span class="operator">=</span> <span class="number">4</span> <span class="keyword">then</span> quantity <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span> Wednesday,</span><br><span class="line">     <span class="built_in">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> num <span class="operator">=</span> <span class="number">5</span> <span class="keyword">then</span> quantity <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span> Thursday,</span><br><span class="line">     <span class="built_in">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> num <span class="operator">=</span> <span class="number">6</span> <span class="keyword">then</span> quantity <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span> Friday,</span><br><span class="line">     <span class="built_in">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> num <span class="operator">=</span> <span class="number">7</span> <span class="keyword">then</span> quantity <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span> Saturday,</span><br><span class="line">     <span class="built_in">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> num <span class="operator">=</span> <span class="number">1</span> <span class="keyword">then</span> quantity <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span> Sunday</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    (<span class="keyword">select</span></span><br><span class="line">          item_category,</span><br><span class="line">          quantity,</span><br><span class="line">          dayofweek(order_date) <span class="keyword">as</span> num</span><br><span class="line">     <span class="keyword">from</span> </span><br><span class="line">          <span class="number">95</span>_items i</span><br><span class="line">     <span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">          <span class="number">95</span>_orders o </span><br><span class="line">     <span class="keyword">on</span> </span><br><span class="line">          i.item_id<span class="operator">=</span>o.item_id) t</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">     item_category</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">     item_category;</span><br></pre></td></tr></table></figure>

<h2 id="96-按日期分组销售产品"><a href="#96-按日期分组销售产品" class="headerlink" title="96. 按日期分组销售产品"></a>96. 按日期分组销售产品</h2><p>编写一个 SQL 查询来查找每个日期、销售的不同产品的数量及其名称。<br>每个日期的销售产品名称应按词典序排列。<br>返回按 <code>sell_date</code> 排序的结果表。</p>
<p>查询结果格式如下例所示。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">+------------+----------+------------------------------+</span><br><span class="line">| sell_date  | num_sold | products                     |</span><br><span class="line">+------------+----------+------------------------------+</span><br><span class="line">| 2020-05-30 | 3        | Basketball,Headphone,T-shirt |</span><br><span class="line">| 2020-06-01 | 2        | Bible,Pencil                 |</span><br><span class="line">| 2020-06-02 | 1        | Mask                         |</span><br><span class="line">+------------+----------+------------------------------+</span><br><span class="line">对于2020-05-30，出售的物品是 (Headphone, Basketball, T-shirt)，按词典序排列，并用逗号 &#39;,&#39; 分隔。</span><br><span class="line">对于2020-06-01，出售的物品是 (Pencil, Bible)，按词典序排列，并用逗号分隔。</span><br><span class="line">对于2020-06-02，出售的物品是 (Mask)，只需返回该物品名。</span><br></pre></td></tr></table></figure>

<p>建表语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">96</span>_Activities (sell_date <span class="type">date</span>, product <span class="type">varchar</span>(<span class="number">20</span>));</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">96</span>_Activities;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">96</span>_Activities (sell_date, product) <span class="keyword">values</span> (<span class="string">&#x27;2020-05-30&#x27;</span>, <span class="string">&#x27;Headphone&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">96</span>_Activities (sell_date, product) <span class="keyword">values</span> (<span class="string">&#x27;2020-06-01&#x27;</span>, <span class="string">&#x27;Pencil&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">96</span>_Activities (sell_date, product) <span class="keyword">values</span> (<span class="string">&#x27;2020-06-02&#x27;</span>, <span class="string">&#x27;Mask&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">96</span>_Activities (sell_date, product) <span class="keyword">values</span> (<span class="string">&#x27;2020-05-30&#x27;</span>, <span class="string">&#x27;Basketball&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">96</span>_Activities (sell_date, product) <span class="keyword">values</span> (<span class="string">&#x27;2020-06-01&#x27;</span>, <span class="string">&#x27;Bible&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">96</span>_Activities (sell_date, product) <span class="keyword">values</span> (<span class="string">&#x27;2020-06-02&#x27;</span>, <span class="string">&#x27;Mask&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">96</span>_Activities (sell_date, product) <span class="keyword">values</span> (<span class="string">&#x27;2020-05-30&#x27;</span>, <span class="string">&#x27;T-Shirt&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">     sell_date,</span><br><span class="line">     <span class="built_in">count</span>(<span class="keyword">distinct</span> product) num_sold, </span><br><span class="line">     group_concat(<span class="keyword">distinct</span> product <span class="keyword">order</span> <span class="keyword">by</span> product) products</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">     Activities</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">     sell_date;</span><br></pre></td></tr></table></figure>



<h2 id="97-上月播放的儿童适宜电影"><a href="#97-上月播放的儿童适宜电影" class="headerlink" title="97. 上月播放的儿童适宜电影"></a>97. 上月播放的儿童适宜电影</h2><p>写一个 SQL 语句, 报告在 2020 年 6 月份播放的儿童适宜电影的去重电影名.返回的结果表单没有顺序要求.</p>
<p>查询结果的格式如下例所示.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">+--------------+</span><br><span class="line">| title        |</span><br><span class="line">+--------------+</span><br><span class="line">| Aladdin      |</span><br><span class="line">+--------------+</span><br><span class="line">&quot;Leetcode Movie&quot; 是儿童不宜的电影.</span><br><span class="line">&quot;Alg. for Kids&quot; 不是电影.</span><br><span class="line">&quot;Database Sols&quot; 不是电影</span><br><span class="line">&quot;Alladin&quot; 是电影, 儿童适宜, 并且在 2020 年 6 月份播放.</span><br><span class="line">&quot;Cinderella&quot; 不在 2020 年 6 月份播放.</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">97</span>_TVProgram (program_date <span class="type">date</span>, content_id <span class="type">int</span>, channel <span class="type">varchar</span>(<span class="number">30</span>));</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">97</span>_Content (content_id <span class="type">varchar</span>(<span class="number">30</span>), title <span class="type">varchar</span>(<span class="number">30</span>), Kids_content ENUM(<span class="string">&#x27;Y&#x27;</span>, <span class="string">&#x27;N&#x27;</span>), content_type <span class="type">varchar</span>(<span class="number">30</span>));</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">97</span>_TVProgram;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">97</span>_TVProgram (program_date, content_id, channel) <span class="keyword">values</span> (<span class="string">&#x27;2020-06-10 08:00&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;LC-Channel&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">97</span>_TVProgram (program_date, content_id, channel) <span class="keyword">values</span> (<span class="string">&#x27;2020-05-11 12:00&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;LC-Channel&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">97</span>_TVProgram (program_date, content_id, channel) <span class="keyword">values</span> (<span class="string">&#x27;2020-05-12 12:00&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;LC-Channel&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">97</span>_TVProgram (program_date, content_id, channel) <span class="keyword">values</span> (<span class="string">&#x27;2020-05-13 14:00&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;Disney Ch&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">97</span>_TVProgram (program_date, content_id, channel) <span class="keyword">values</span> (<span class="string">&#x27;2020-06-18 14:00&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;Disney Ch&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">97</span>_TVProgram (program_date, content_id, channel) <span class="keyword">values</span> (<span class="string">&#x27;2020-07-15 16:00&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;Disney Ch&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">97</span>_Content;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">97</span>_Content (content_id, title, Kids_content, content_type) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Leetcode Movie&#x27;</span>, <span class="string">&#x27;N&#x27;</span>, <span class="string">&#x27;Movies&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">97</span>_Content (content_id, title, Kids_content, content_type) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;Alg. for Kids&#x27;</span>, <span class="string">&#x27;Y&#x27;</span>, <span class="string">&#x27;Series&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">97</span>_Content (content_id, title, Kids_content, content_type) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;Database Sols&#x27;</span>, <span class="string">&#x27;N&#x27;</span>, <span class="string">&#x27;Series&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">97</span>_Content (content_id, title, Kids_content, content_type) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;Aladdin&#x27;</span>, <span class="string">&#x27;Y&#x27;</span>, <span class="string">&#x27;Movies&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">97</span>_Content (content_id, title, Kids_content, content_type) <span class="keyword">values</span> (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;Cinderella&#x27;</span>, <span class="string">&#x27;Y&#x27;</span>, <span class="string">&#x27;Movies&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">     <span class="keyword">distinct</span> title   </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">     <span class="number">97</span>_TVProgram t </span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">     <span class="number">97</span>_Content c</span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">     t.content_id  <span class="operator">=</span> c.content_id </span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">     Kids_content <span class="operator">=</span><span class="string">&#x27;Y&#x27;</span> </span><br><span class="line">     <span class="keyword">and</span></span><br><span class="line">     date_format(program_date ,<span class="string">&#x27;%Y-%m&#x27;</span>)<span class="operator">=</span><span class="string">&#x27;2020-06&#x27;</span></span><br><span class="line">     <span class="keyword">and</span></span><br><span class="line">     content_type<span class="operator">=</span><span class="string">&#x27;Movies&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h2 id="98-可以放心投资的国家"><a href="#98-可以放心投资的国家" class="headerlink" title="98. 可以放心投资的国家"></a>98. 可以放心投资的国家</h2><p>写一段 SQL, 找到所有该公司可以投资的国家（该国的平均通话时长要严格地大于全球平均通话时长）.返回的结果表没有顺序要求.</p>
<p>查询的结果格式如下例所示.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">+----------+</span><br><span class="line">| country  |</span><br><span class="line">+----------+</span><br><span class="line">| Peru     |</span><br><span class="line">+----------+</span><br><span class="line">国家Peru的平均通话时长是 (102 + 102 + 330 + 330 + 5 + 5) &#x2F; 6 &#x3D; 145.666667</span><br><span class="line">国家Israel的平均通话时长是 (33 + 4 + 13 + 13 + 3 + 1 + 1 + 7) &#x2F; 8 &#x3D; 9.37500</span><br><span class="line">国家Morocco的平均通话时长是 (33 + 4 + 59 + 59 + 3 + 7) &#x2F; 6 &#x3D; 27.5000 </span><br><span class="line">全球平均通话时长 &#x3D; (2 * (33 + 3 + 59 + 102 + 330 + 5 + 13 + 3 + 1 + 7)) &#x2F; 20 &#x3D; 55.70000</span><br><span class="line">所以, Peru是唯一的平均通话时长大于全球平均通话时长的国家, 也是唯一的推荐投资的国家.</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">98</span>_Person (id <span class="type">int</span>, name <span class="type">varchar</span>(<span class="number">15</span>), phone_number <span class="type">varchar</span>(<span class="number">11</span>));</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">98</span>_Country (name <span class="type">varchar</span>(<span class="number">15</span>), country_code <span class="type">varchar</span>(<span class="number">3</span>));</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">98</span>_Calls (caller_id <span class="type">int</span>, callee_id <span class="type">int</span>, duration <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">98</span>_Person;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">98</span>_Person (id, name, phone_number) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;Jonathan&#x27;</span>, <span class="string">&#x27;051-1234567&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">98</span>_Person (id, name, phone_number) <span class="keyword">values</span> (<span class="string">&#x27;12&#x27;</span>, <span class="string">&#x27;Elvis&#x27;</span>, <span class="string">&#x27;051-7654321&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">98</span>_Person (id, name, phone_number) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Moncef&#x27;</span>, <span class="string">&#x27;212-1234567&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">98</span>_Person (id, name, phone_number) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;Maroua&#x27;</span>, <span class="string">&#x27;212-6523651&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">98</span>_Person (id, name, phone_number) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;Meir&#x27;</span>, <span class="string">&#x27;972-1234567&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">98</span>_Person (id, name, phone_number) <span class="keyword">values</span> (<span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;Rachel&#x27;</span>, <span class="string">&#x27;972-0011100&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">98</span>_Country;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">98</span>_Country (name, country_code) <span class="keyword">values</span> (<span class="string">&#x27;Peru&#x27;</span>, <span class="string">&#x27;051&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">98</span>_Country (name, country_code) <span class="keyword">values</span> (<span class="string">&#x27;Israel&#x27;</span>, <span class="string">&#x27;972&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">98</span>_Country (name, country_code) <span class="keyword">values</span> (<span class="string">&#x27;Morocco&#x27;</span>, <span class="string">&#x27;212&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">98</span>_Country (name, country_code) <span class="keyword">values</span> (<span class="string">&#x27;Germany&#x27;</span>, <span class="string">&#x27;049&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">98</span>_Country (name, country_code) <span class="keyword">values</span> (<span class="string">&#x27;Ethiopia&#x27;</span>, <span class="string">&#x27;251&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">98</span>_Calls;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">98</span>_Calls (caller_id, callee_id, duration) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;33&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">98</span>_Calls (caller_id, callee_id, duration) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;4&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">98</span>_Calls (caller_id, callee_id, duration) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;59&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">98</span>_Calls (caller_id, callee_id, duration) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;12&#x27;</span>, <span class="string">&#x27;102&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">98</span>_Calls (caller_id, callee_id, duration) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;12&#x27;</span>, <span class="string">&#x27;330&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">98</span>_Calls (caller_id, callee_id, duration) <span class="keyword">values</span> (<span class="string">&#x27;12&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;5&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">98</span>_Calls (caller_id, callee_id, duration) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;13&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">98</span>_Calls (caller_id, callee_id, duration) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;3&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">98</span>_Calls (caller_id, callee_id, duration) <span class="keyword">values</span> (<span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">98</span>_Calls (caller_id, callee_id, duration) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;7&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">     c2.name <span class="keyword">as</span> country </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">     <span class="number">98</span>_Calls c1,</span><br><span class="line">     <span class="number">98</span>_Person p,</span><br><span class="line">     <span class="number">98</span>_Country c2</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    (p.id<span class="operator">=</span>c1.caller_id <span class="keyword">or</span> p.id<span class="operator">=</span>c1.callee_id) </span><br><span class="line">     <span class="keyword">and</span></span><br><span class="line">     c2.country_code<span class="operator">=</span><span class="keyword">left</span>(p.phone_number,<span class="number">3</span>)</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">     c2.name </span><br><span class="line"><span class="keyword">having</span></span><br><span class="line">     <span class="built_in">avg</span>(duration)<span class="operator">&gt;</span>(<span class="keyword">select</span> <span class="built_in">avg</span>(duration) <span class="keyword">from</span> <span class="number">98</span>_Calls);</span><br></pre></td></tr></table></figure>



<h2 id="99-消费者下单频率"><a href="#99-消费者下单频率" class="headerlink" title="99. 消费者下单频率"></a>99. 消费者下单频率</h2><p>写一个 SQL 语句, 报告消费者的 id 和名字, 其中消费者在 2020 年 6 月和 7 月, 每月至少花费了$100.结果表无顺序要求.</p>
<p>查询结果格式如下例所示.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">+--------------+------------+</span><br><span class="line">| customer_id  | name       |  </span><br><span class="line">+--------------+------------+</span><br><span class="line">| 1            | Winston    |</span><br><span class="line">+--------------+------------+ </span><br><span class="line">Winston 在2020年6月花费了$300(300 * 1), 在7月花费了$100(10 * 1 + 45 * 2).</span><br><span class="line">Jonathan 在2020年6月花费了$600(300 * 2), 在7月花费了$20(2 * 10).</span><br><span class="line">Moustafa 在2020年6月花费了$110 (10 * 2 + 45 * 2), 在7月花费了$0.</span><br></pre></td></tr></table></figure>

<p>建表语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">99</span>_Customers (customer_id <span class="type">int</span>, name <span class="type">varchar</span>(<span class="number">30</span>), country <span class="type">varchar</span>(<span class="number">30</span>));</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">99</span>_Product (product_id <span class="type">int</span>, description <span class="type">varchar</span>(<span class="number">30</span>), price <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">99</span>_Orders (order_id <span class="type">int</span>, customer_id <span class="type">int</span>, product_id <span class="type">int</span>, order_date <span class="type">date</span>, quantity <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">99</span>_Customers;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">99</span>_Customers (customer_id, name, country) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Winston&#x27;</span>, <span class="string">&#x27;USA&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">99</span>_Customers (customer_id, name, country) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;Jonathan&#x27;</span>, <span class="string">&#x27;Peru&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">99</span>_Customers (customer_id, name, country) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;Moustafa&#x27;</span>, <span class="string">&#x27;Egypt&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">99</span>_Product;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">99</span>_Product (product_id, description, price) <span class="keyword">values</span> (<span class="string">&#x27;10&#x27;</span>, <span class="string">&#x27;LC Phone&#x27;</span>, <span class="string">&#x27;300&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">99</span>_Product (product_id, description, price) <span class="keyword">values</span> (<span class="string">&#x27;20&#x27;</span>, <span class="string">&#x27;LC T-Shirt&#x27;</span>, <span class="string">&#x27;10&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">99</span>_Product (product_id, description, price) <span class="keyword">values</span> (<span class="string">&#x27;30&#x27;</span>, <span class="string">&#x27;LC Book&#x27;</span>, <span class="string">&#x27;45&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">99</span>_Product (product_id, description, price) <span class="keyword">values</span> (<span class="string">&#x27;40&#x27;</span>, <span class="string">&#x27;LC Keychain&#x27;</span>, <span class="string">&#x27;2&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">99</span>_Orders;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">99</span>_Orders (order_id, customer_id, product_id, order_date, quantity) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;10&#x27;</span>, <span class="string">&#x27;2020-06-10&#x27;</span>, <span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">99</span>_Orders (order_id, customer_id, product_id, order_date, quantity) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;20&#x27;</span>, <span class="string">&#x27;2020-07-01&#x27;</span>, <span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">99</span>_Orders (order_id, customer_id, product_id, order_date, quantity) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;30&#x27;</span>, <span class="string">&#x27;2020-07-08&#x27;</span>, <span class="string">&#x27;2&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">99</span>_Orders (order_id, customer_id, product_id, order_date, quantity) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;10&#x27;</span>, <span class="string">&#x27;2020-06-15&#x27;</span>, <span class="string">&#x27;2&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">99</span>_Orders (order_id, customer_id, product_id, order_date, quantity) <span class="keyword">values</span> (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;40&#x27;</span>, <span class="string">&#x27;2020-07-01&#x27;</span>, <span class="string">&#x27;10&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">99</span>_Orders (order_id, customer_id, product_id, order_date, quantity) <span class="keyword">values</span> (<span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;20&#x27;</span>, <span class="string">&#x27;2020-06-24&#x27;</span>, <span class="string">&#x27;2&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">99</span>_Orders (order_id, customer_id, product_id, order_date, quantity) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;30&#x27;</span>, <span class="string">&#x27;2020-06-25&#x27;</span>, <span class="string">&#x27;2&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">99</span>_Orders (order_id, customer_id, product_id, order_date, quantity) <span class="keyword">values</span> (<span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;30&#x27;</span>, <span class="string">&#x27;2020-05-08&#x27;</span>, <span class="string">&#x27;3&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">     customer_id,name</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">     Customers</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">     customer_id <span class="keyword">in</span> (<span class="keyword">select</span></span><br><span class="line">                          customer_id</span><br><span class="line">                     <span class="keyword">from</span></span><br><span class="line">                         (<span class="keyword">select</span> </span><br><span class="line">                                customer_id,</span><br><span class="line">                                <span class="keyword">month</span>(order_date) <span class="keyword">as</span> <span class="keyword">month</span>,</span><br><span class="line">                                <span class="built_in">sum</span>(quantity<span class="operator">*</span>price) <span class="keyword">as</span> total</span><br><span class="line">                          <span class="keyword">from</span> </span><br><span class="line">                                Orders o </span><br><span class="line">                          <span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">                                Product p</span><br><span class="line">                          <span class="keyword">on</span> </span><br><span class="line">                                o.product_id <span class="operator">=</span> p.product_id</span><br><span class="line">                          <span class="keyword">where</span></span><br><span class="line">                                <span class="keyword">month</span>(order_date) <span class="operator">=</span> <span class="number">6</span> <span class="keyword">or</span> <span class="keyword">month</span>(order_date)<span class="operator">=</span><span class="number">7</span></span><br><span class="line">                          <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">                                customer_id,<span class="keyword">month</span>(order_date)</span><br><span class="line">                          ) <span class="keyword">as</span> t1</span><br><span class="line">                    <span class="keyword">where</span> </span><br><span class="line">                          total <span class="operator">&gt;=</span><span class="number">100</span></span><br><span class="line">                    <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">                          customer_id</span><br><span class="line">                    <span class="keyword">having</span></span><br><span class="line">                          <span class="built_in">count</span>(<span class="operator">*</span>)<span class="operator">&gt;=</span><span class="number">2</span> );</span><br></pre></td></tr></table></figure>



<h2 id="100-查找拥有有效邮箱的用户"><a href="#100-查找拥有有效邮箱的用户" class="headerlink" title="100. 查找拥有有效邮箱的用户"></a>100. 查找拥有有效邮箱的用户</h2><p>Write an SQL query to find the users who have <strong>valid emails</strong>.</p>
<p>A valid e-mail has a prefix name and a domain where: </p>
<ul>
<li><strong>The prefix name</strong> is a string that may contain letters (upper or lower case), digits, underscore <code>&#39;_&#39;</code>, period <code>&#39;.&#39;</code> and/or dash <code>&#39;-&#39;</code>. The prefix name <strong>must</strong> start with a letter.</li>
<li><strong>The domain</strong> is <code>&#39;@leetcode.com&#39;</code>.</li>
</ul>
<p>Return the result table in any order.</p>
<p>The query result format is in the following example.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">+---------+-----------+-------------------------+</span><br><span class="line">| user_id | name      | mail                    |</span><br><span class="line">+---------+-----------+-------------------------+</span><br><span class="line">| 1       | Winston   | winston@leetcode.com    |</span><br><span class="line">| 3       | Annabelle | bella-@leetcode.com     |</span><br><span class="line">| 4       | Sally     | sally.come@leetcode.com |</span><br><span class="line">+---------+-----------+-------------------------+</span><br><span class="line">The mail of user 2 doesn&#39;t have a domain.</span><br><span class="line">The mail of user 5 has # sign which is not allowed.</span><br><span class="line">The mail of user 6 doesn&#39;t have leetcode domain.</span><br><span class="line">The mail of user 7 starts with a period.</span><br></pre></td></tr></table></figure>

<p>建表语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">100</span>_Users (user_id <span class="type">int</span>, name <span class="type">varchar</span>(<span class="number">30</span>), mail <span class="type">varchar</span>(<span class="number">50</span>));</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">100</span>_Users;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">100</span>_Users (user_id, name, mail) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Winston&#x27;</span>, <span class="string">&#x27;winston@leetcode.com&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">100</span>_Users (user_id, name, mail) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;Jonathan&#x27;</span>, <span class="string">&#x27;jonathanisgreat&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">100</span>_Users (user_id, name, mail) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;Annabelle&#x27;</span>, <span class="string">&#x27;bella-@leetcode.com&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">100</span>_Users (user_id, name, mail) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;Sally&#x27;</span>, <span class="string">&#x27;sally.come@leetcode.com&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">100</span>_Users (user_id, name, mail) <span class="keyword">values</span> (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;Marwan&#x27;</span>, <span class="string">&#x27;quarz#2020@leetcode.com&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">100</span>_Users (user_id, name, mail) <span class="keyword">values</span> (<span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;David&#x27;</span>, <span class="string">&#x27;david69@gmail.com&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">100</span>_Users (user_id, name, mail) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;Shapiro&#x27;</span>, <span class="string">&#x27;.shapo@leetcode.com&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">      <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">      <span class="number">100</span>_Users</span><br><span class="line"><span class="keyword">WHERE</span> </span><br><span class="line">      mail REGEXP <span class="string">&#x27;^[a-zA-Z]+[\\w_\\.\\-]*@leetcode.com$&#x27;</span>   </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">      user_id;</span><br></pre></td></tr></table></figure>

<h2 id=""><a href="#" class="headerlink" title=""></a></h2>
    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/03/11/61-80/" rel="prev" title="">
                  <i class="fa fa-chevron-left"></i> 
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2021/03/11/101-/" rel="next" title="101-最后">
                  101-最后 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>







<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">hefei</span>
</div>
  <div class="powered-by">تطبيق الموقع <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
