<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.loli.net/css?family=Noto+Serif+SC:300,300italic,400,400italic,700,700italic%7CMa+Shan+Zheng:300,300italic,400,400italic,700,700italic%7CJetBrains+Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.2/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"hf7751.gitee.io","root":"/","images":"/images","scheme":"Muse","version":"8.2.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"بحث...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}};
  </script>
<meta name="description" content="61. 查询结果的质量和占比需求：编写一组 SQL 来查找每次查询的名称(query_name)、质量(quality) 和 劣质查询百分比(poor_query_percentage)。 质量(quality) 和劣质查询百分比(poor_query_percentage) 都应四舍五入到小数点后两位。 展示效果：    query_name quality poor_query_percent">
<meta property="og:type" content="article">
<meta property="og:title" content="元">
<meta property="og:url" content="https://hf7751.gitee.io/2021/03/11/61-80/index.html">
<meta property="og:site_name" content="元">
<meta property="og:description" content="61. 查询结果的质量和占比需求：编写一组 SQL 来查找每次查询的名称(query_name)、质量(quality) 和 劣质查询百分比(poor_query_percentage)。 质量(quality) 和劣质查询百分比(poor_query_percentage) 都应四舍五入到小数点后两位。 展示效果：    query_name quality poor_query_percent">
<meta property="og:locale">
<meta property="og:image" content="https://assets.leetcode-cn.com/aliyun-lc-upload/uploads/2020/03/06/sql1.png">
<meta property="article:published_time" content="2021-03-10T18:36:18.648Z">
<meta property="article:modified_time" content="2021-03-04T07:48:33.772Z">
<meta property="article:author" content="hefei">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://assets.leetcode-cn.com/aliyun-lc-upload/uploads/2020/03/06/sql1.png">


<link rel="canonical" href="https://hf7751.gitee.io/2021/03/11/61-80/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-Hans'
  };
</script>
<title> | 元</title>
  




  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="تشغيل شريط التصفح" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">元</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          المحتويات
        </li>
        <li class="sidebar-nav-overview">
          عام
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#61-%E6%9F%A5%E8%AF%A2%E7%BB%93%E6%9E%9C%E7%9A%84%E8%B4%A8%E9%87%8F%E5%92%8C%E5%8D%A0%E6%AF%94"><span class="nav-number">1.</span> <span class="nav-text">61. 查询结果的质量和占比</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#62-%E6%9F%A5%E8%AF%A2%E7%90%83%E9%98%9F%E7%A7%AF%E5%88%86"><span class="nav-number">2.</span> <span class="nav-text">62. 查询球队积分</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#63-%E6%8A%A5%E5%91%8A%E7%B3%BB%E7%BB%9F%E7%8A%B6%E6%80%81%E7%9A%84%E8%BF%9E%E7%BB%AD%E6%97%A5%E6%9C%9F"><span class="nav-number">3.</span> <span class="nav-text">63. 报告系统状态的连续日期</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#64-%E6%AF%8F%E4%B8%AA%E5%B8%96%E5%AD%90%E7%9A%84%E8%AF%84%E8%AE%BA%E6%95%B0"><span class="nav-number">4.</span> <span class="nav-text">64. 每个帖子的评论数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#65-%E5%B9%B3%E5%9D%87%E5%94%AE%E4%BB%B7"><span class="nav-number">5.</span> <span class="nav-text">65. 平均售价</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#66-%E9%A1%B5%E9%9D%A2%E6%8E%A8%E8%8D%90"><span class="nav-number">6.</span> <span class="nav-text">66. 页面推荐</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#67-%E6%B1%87%E6%8A%A5%E5%B7%A5%E4%BD%9C"><span class="nav-number">7.</span> <span class="nav-text">67. 汇报工作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#68-%E5%AD%A6%E7%94%9F%E4%BB%AC%E5%8F%82%E5%8A%A0%E5%90%84%E7%A7%91%E6%B5%8B%E8%AF%95%E7%9A%84%E6%AC%A1%E6%95%B0"><span class="nav-number">8.</span> <span class="nav-text">68. 学生们参加各科测试的次数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#69-%E6%89%BE%E5%88%B0%E8%BF%9E%E7%BB%AD%E5%8C%BA%E9%97%B4%E7%9A%84%E5%BC%80%E5%A7%8B%E5%92%8C%E7%BB%93%E6%9D%9F%E6%95%B0%E5%AD%97"><span class="nav-number">9.</span> <span class="nav-text">69. 找到连续区间的开始和结束数字</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#70-%E4%B8%8D%E5%90%8C%E5%9B%BD%E5%AE%B6%E7%9A%84%E5%A4%A9%E6%B0%94%E7%B1%BB%E5%9E%8B"><span class="nav-number">10.</span> <span class="nav-text">70. 不同国家的天气类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#71-%E6%B1%82%E5%9B%A2%E9%98%9F%E4%BA%BA%E6%95%B0"><span class="nav-number">11.</span> <span class="nav-text">71. 求团队人数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#72-%E4%B8%8D%E5%90%8C%E6%80%A7%E5%88%AB%E6%AF%8F%E6%97%A5%E5%88%86%E6%95%B0%E6%80%BB%E8%AE%A1"><span class="nav-number">12.</span> <span class="nav-text">72. 不同性别每日分数总计</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#73-%E9%A4%90%E9%A6%86%E8%90%A5%E4%B8%9A%E9%A2%9D%E5%8F%98%E5%8C%96%E5%A2%9E%E9%95%BF"><span class="nav-number">13.</span> <span class="nav-text">73. 餐馆营业额变化增长</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#74-%E5%B9%BF%E5%91%8A%E6%95%88%E6%9E%9C"><span class="nav-number">14.</span> <span class="nav-text">74. 广告效果</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#75-%E5%88%97%E5%87%BA%E6%8C%87%E5%AE%9A%E6%97%B6%E9%97%B4%E6%AE%B5%E5%86%85%E6%89%80%E6%9C%89%E7%9A%84%E4%B8%8B%E5%8D%95%E4%BA%A7%E5%93%81"><span class="nav-number">15.</span> <span class="nav-text">75. 列出指定时间段内所有的下单产品</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#76-%E6%AF%8F%E6%AC%A1%E8%AE%BF%E9%97%AE%E7%9A%84%E4%BA%A4%E6%98%93%E6%AC%A1%E6%95%B0"><span class="nav-number">16.</span> <span class="nav-text">76. 每次访问的交易次数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#77-%E7%94%B5%E5%BD%B1%E8%AF%84%E5%88%86"><span class="nav-number">17.</span> <span class="nav-text">77. 电影评分</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#78-%E9%99%A2%E7%B3%BB%E6%97%A0%E6%95%88%E7%9A%84%E5%AD%A6%E7%94%9F"><span class="nav-number">18.</span> <span class="nav-text">78. 院系无效的学生</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#79-%E6%B4%BB%E5%8A%A8%E5%8F%82%E4%B8%8E%E8%80%85"><span class="nav-number">19.</span> <span class="nav-text">79. 活动参与者</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#80-%E9%A1%BE%E5%AE%A2%E7%9A%84%E5%8F%AF%E4%BF%A1%E8%81%94%E7%B3%BB%E4%BA%BA%E6%95%B0%E9%87%8F"><span class="nav-number">20.</span> <span class="nav-text">80. 顾客的可信联系人数量</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">hefei</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">7</span>
          <span class="site-state-item-name">المقالات</span>
        </a>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://hf7751.gitee.io/2021/03/11/61-80/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="hefei">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="元">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">نُشر في</span>

      <time title="أُنشأ: 2021-03-11 02:36:18" itemprop="dateCreated datePublished" datetime="2021-03-11T02:36:18+08:00">2021-03-11</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">عُدل في</span>
        <time title="عُدل: 2021-03-04 15:48:33" itemprop="dateModified" datetime="2021-03-04T15:48:33+08:00">2021-03-04</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h2 id="61-查询结果的质量和占比"><a href="#61-查询结果的质量和占比" class="headerlink" title="61. 查询结果的质量和占比"></a>61. 查询结果的质量和占比</h2><p>需求：编写一组 SQL 来查找每次查询的<code>名称</code>(<code>query_name</code>)、<code>质量</code>(<code>quality</code>) 和 <code>劣质查询百分比</code>(<code>poor_query_percentage</code>)。</p>
<p><code>质量</code>(<code>quality</code>) 和<code>劣质查询百分比</code>(<code>poor_query_percentage</code>) 都应四舍五入到小数点后两位。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>query_name</th>
<th>quality</th>
<th>poor_query_percentage</th>
</tr>
</thead>
<tbody><tr>
<td>Dog</td>
<td>2.50</td>
<td>33.33</td>
</tr>
<tr>
<td>Cat</td>
<td>0.66</td>
<td>33.33</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">61</span>_Queries (query_name <span class="type">varchar</span>(<span class="number">30</span>), <span class="keyword">result</span> <span class="type">varchar</span>(<span class="number">50</span>), position <span class="type">int</span>, rating <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">61</span>_Queries;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">61</span>_Queries (query_name, <span class="keyword">result</span>, position, rating) <span class="keyword">values</span> (<span class="string">&#x27;Dog&#x27;</span>, <span class="string">&#x27;Golden Retriever&#x27;</span>, <span class="number">1</span>, <span class="number">5</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">61</span>_Queries (query_name, <span class="keyword">result</span>, position, rating) <span class="keyword">values</span> (<span class="string">&#x27;Dog&#x27;</span>, <span class="string">&#x27;German Shepherd&#x27;</span>, <span class="number">2</span>, <span class="number">5</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">61</span>_Queries (query_name, <span class="keyword">result</span>, position, rating) <span class="keyword">values</span> (<span class="string">&#x27;Dog&#x27;</span>, <span class="string">&#x27;Mule&#x27;</span>, <span class="string">&#x27;200&#x27;</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">61</span>_Queries (query_name, <span class="keyword">result</span>, position, rating) <span class="keyword">values</span> (<span class="string">&#x27;Cat&#x27;</span>, <span class="string">&#x27;Shirazi&#x27;</span>, <span class="number">5</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">61</span>_Queries (query_name, <span class="keyword">result</span>, position, rating) <span class="keyword">values</span> (<span class="string">&#x27;Cat&#x27;</span>, <span class="string">&#x27;Siamese&#x27;</span>, <span class="number">3</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">61</span>_Queries (query_name, <span class="keyword">result</span>, position, rating) <span class="keyword">values</span> (<span class="string">&#x27;Cat&#x27;</span>, <span class="string">&#x27;Sphynx&#x27;</span>, <span class="number">7</span>, <span class="number">4</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">      query_name,</span><br><span class="line">      round(<span class="built_in">avg</span>(rating<span class="operator">/</span>position), <span class="number">2</span>) <span class="keyword">as</span> quality ,</span><br><span class="line">      round((<span class="built_in">count</span>(if(rating<span class="operator">&lt;</span><span class="number">3</span>, <span class="literal">True</span>, <span class="keyword">null</span>)) <span class="operator">/</span> <span class="built_in">count</span>(query_name)) <span class="operator">*</span><span class="number">100</span> , <span class="number">2</span>) <span class="keyword">as</span> poor_query_percentage</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">      <span class="number">61</span>_Queries</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">      query_name</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> query_name <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure>

<h2 id="62-查询球队积分"><a href="#62-查询球队积分" class="headerlink" title="62. 查询球队积分"></a>62. 查询球队积分</h2><p>需求一：写出一条SQL语句以查询每个队的 <strong>team_id</strong>，<strong>team_name</strong> 和 <strong>num_points</strong>。结果根据 num_points <strong>降序排序</strong>，如果有两队积分相同，那么这两队按 team_id <strong>升序排序</strong>。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>team_id</th>
<th>team_name</th>
<th>num_points</th>
</tr>
</thead>
<tbody><tr>
<td>10</td>
<td>Leetcode FC</td>
<td>7</td>
</tr>
<tr>
<td>20</td>
<td>NewYork FC</td>
<td>3</td>
</tr>
<tr>
<td>50</td>
<td>Toronto FC</td>
<td>3</td>
</tr>
<tr>
<td>30</td>
<td>Atlanta FC</td>
<td>1</td>
</tr>
<tr>
<td>40</td>
<td>Chicago FC</td>
<td>0</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">62</span>_Teams (team_id <span class="type">int</span>, team_name <span class="type">varchar</span>(<span class="number">30</span>));</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">62</span>_Matches (match_id <span class="type">int</span>, host_team <span class="type">int</span>, guest_team <span class="type">int</span>, host_goals <span class="type">int</span>, guest_goals <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">62</span>_Teams;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">62</span>_Teams (team_id, team_name) <span class="keyword">values</span> (<span class="number">10</span>, <span class="string">&#x27;Leetcode FC&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">62</span>_Teams (team_id, team_name) <span class="keyword">values</span> (<span class="number">20</span>, <span class="string">&#x27;NewYork FC&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">62</span>_Teams (team_id, team_name) <span class="keyword">values</span> (<span class="number">30</span>, <span class="string">&#x27;Atlanta FC&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">62</span>_Teams (team_id, team_name) <span class="keyword">values</span> (<span class="number">40</span>, <span class="string">&#x27;Chicago FC&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">62</span>_Teams (team_id, team_name) <span class="keyword">values</span> (<span class="number">50</span>, <span class="string">&#x27;Toronto FC&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">62</span>_Matches;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">62</span>_Matches (match_id, host_team, guest_team, host_goals, guest_goals) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">62</span>_Matches (match_id, host_team, guest_team, host_goals, guest_goals) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">30</span>, <span class="number">10</span>, <span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">62</span>_Matches (match_id, host_team, guest_team, host_goals, guest_goals) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">5</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">62</span>_Matches (match_id, host_team, guest_team, host_goals, guest_goals) <span class="keyword">values</span> (<span class="number">4</span>, <span class="number">20</span>, <span class="number">30</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">62</span>_Matches (match_id, host_team, guest_team, host_goals, guest_goals) <span class="keyword">values</span> (<span class="number">5</span>, <span class="number">50</span>, <span class="number">30</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">     <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    (<span class="keyword">SELECT</span> </span><br><span class="line">           a.team_id,</span><br><span class="line">           <span class="built_in">MAX</span>(team_name) <span class="keyword">AS</span> team_name,</span><br><span class="line">           <span class="built_in">SUM</span>(</span><br><span class="line">                <span class="keyword">CASE</span> </span><br><span class="line">			        <span class="keyword">WHEN</span> a.team_id <span class="operator">=</span> b.host_team <span class="keyword">THEN</span> </span><br><span class="line">				    <span class="keyword">CASE</span> </span><br><span class="line">					    <span class="keyword">WHEN</span> b.host_goals <span class="operator">&gt;</span> b.guest_goals <span class="keyword">THEN</span> <span class="number">3</span></span><br><span class="line">					    <span class="keyword">WHEN</span> b.host_goals <span class="operator">=</span> b.guest_goals <span class="keyword">THEN</span> <span class="number">1</span></span><br><span class="line">			            <span class="keyword">ELSE</span> <span class="number">0</span></span><br><span class="line">				    <span class="keyword">END</span></span><br><span class="line">			        <span class="keyword">WHEN</span> a.team_id <span class="operator">=</span> b.guest_team <span class="keyword">THEN</span> </span><br><span class="line">				    <span class="keyword">CASE</span> </span><br><span class="line">					    <span class="keyword">WHEN</span> b.host_goals <span class="operator">&lt;</span> b.guest_goals <span class="keyword">THEN</span> <span class="number">3</span></span><br><span class="line">					    <span class="keyword">WHEN</span> b.host_goals <span class="operator">=</span> b.guest_goals <span class="keyword">THEN</span> <span class="number">1</span></span><br><span class="line">					    <span class="keyword">ELSE</span> <span class="number">0</span></span><br><span class="line">				    <span class="keyword">END</span></span><br><span class="line">			        <span class="keyword">ELSE</span> <span class="number">0</span></span><br><span class="line">		       <span class="keyword">END</span></span><br><span class="line">           ) <span class="keyword">AS</span> num_points</span><br><span class="line">	<span class="keyword">FROM</span> </span><br><span class="line">         <span class="number">62</span>_Teams a</span><br><span class="line">    <span class="keyword">LEFT</span> <span class="keyword">JOIN</span></span><br><span class="line">         <span class="number">62</span>_Matches b</span><br><span class="line">    <span class="keyword">ON</span> </span><br><span class="line">         a.team_id <span class="operator">=</span> b.host_team <span class="keyword">OR</span> </span><br><span class="line">         a.team_id <span class="operator">=</span> b.guest_team</span><br><span class="line">	<span class="keyword">GROUP</span> <span class="keyword">BY</span> a.team_id</span><br><span class="line">    ) a </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">    a.num_points <span class="keyword">DESC</span>,</span><br><span class="line">    a.team_id;</span><br></pre></td></tr></table></figure>

<h2 id="63-报告系统状态的连续日期"><a href="#63-报告系统状态的连续日期" class="headerlink" title="63. 报告系统状态的连续日期"></a>63. 报告系统状态的连续日期</h2><p>需求：系统 每天 运行一个任务。每个任务都独立于先前的任务。任务的状态可以是失败或是成功。编写一个 SQL 查询 2019-01-01 到 2019-12-31 期间任务连续同状态 period_state 的起止日期（start_date 和 end_date）。即如果任务失败了，就是失败状态的起止日期，如果任务成功了，就是成功状态的起止日期。最后结果按照起始日期 start_date 排序。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>period_state</th>
<th>start date</th>
<th>end date</th>
</tr>
</thead>
<tbody><tr>
<td>present</td>
<td>2019-01-01</td>
<td>2019-01-03</td>
</tr>
<tr>
<td>missing</td>
<td>2019-01-04</td>
<td>2019-01-05</td>
</tr>
<tr>
<td>present</td>
<td>2019-01-06</td>
<td>2019-01-06</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">63</span>_Failed (fail_date <span class="type">date</span>);</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">63</span>_Succeeded (success_date <span class="type">date</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">63</span>_Failed;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">63</span>_Failed (fail_date) <span class="keyword">values</span> (<span class="string">&#x27;2018-12-28&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">63</span>_Failed (fail_date) <span class="keyword">values</span> (<span class="string">&#x27;2018-12-29&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">63</span>_Failed (fail_date) <span class="keyword">values</span> (<span class="string">&#x27;2019-01-04&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">63</span>_Failed (fail_date) <span class="keyword">values</span> (<span class="string">&#x27;2019-01-05&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">63</span>_Succeeded;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">63</span>_Succeeded (success_date) <span class="keyword">values</span> (<span class="string">&#x27;2018-12-30&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">63</span>_Succeeded (success_date) <span class="keyword">values</span> (<span class="string">&#x27;2018-12-31&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">63</span>_Succeeded (success_date) <span class="keyword">values</span> (<span class="string">&#x27;2019-01-01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">63</span>_Succeeded (success_date) <span class="keyword">values</span> (<span class="string">&#x27;2019-01-02&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">63</span>_Succeeded (success_date) <span class="keyword">values</span> (<span class="string">&#x27;2019-01-03&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">63</span>_Succeeded (success_date) <span class="keyword">values</span> (<span class="string">&#x27;2019-01-06&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">      if(str<span class="operator">=</span><span class="number">1</span>,<span class="string">&#x27;succeeded&#x27;</span>,<span class="string">&#x27;failed&#x27;</span>) <span class="keyword">as</span> period_state ,</span><br><span class="line">      <span class="built_in">min</span>(<span class="type">date</span>) <span class="keyword">as</span> start_date,</span><br><span class="line">      <span class="built_in">max</span>(<span class="type">date</span>) <span class="keyword">as</span> end_date</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">     (<span class="keyword">select</span> </span><br><span class="line">            <span class="variable">@diff</span> :<span class="operator">=</span> <span class="variable">@diff</span><span class="operator">+</span> if(num <span class="operator">=</span> <span class="number">1</span> , <span class="number">1</span>,<span class="number">0</span>) <span class="keyword">as</span> diff,</span><br><span class="line">            <span class="type">date</span>,</span><br><span class="line">            str</span><br><span class="line">      <span class="keyword">from</span></span><br><span class="line">           (<span class="keyword">select</span> </span><br><span class="line">                  <span class="keyword">case</span> </span><br><span class="line">                      <span class="keyword">when</span> <span class="variable">@str</span> <span class="operator">=</span> str <span class="keyword">and</span>  date_add(<span class="variable">@pre</span>,<span class="type">interval</span> <span class="number">1</span> <span class="keyword">day</span>) <span class="operator">=</span> <span class="type">date</span>  <span class="keyword">then</span> <span class="variable">@num</span> :<span class="operator">=</span> <span class="variable">@num</span> <span class="operator">+</span><span class="number">1</span></span><br><span class="line">                      <span class="keyword">when</span> <span class="variable">@str</span>:<span class="operator">=</span>str <span class="keyword">then</span>  <span class="variable">@num</span> :<span class="operator">=</span> <span class="number">1</span></span><br><span class="line">                      <span class="keyword">else</span> <span class="variable">@num</span> :<span class="operator">=</span> <span class="number">1</span></span><br><span class="line">                  <span class="keyword">end</span> <span class="keyword">as</span> num,</span><br><span class="line">                  <span class="variable">@pre</span> :<span class="operator">=</span> <span class="type">date</span>,</span><br><span class="line">                  <span class="type">date</span>,</span><br><span class="line">                  str</span><br><span class="line">            <span class="keyword">from</span> </span><br><span class="line">                 (<span class="keyword">select</span> </span><br><span class="line">                        fail_date <span class="keyword">as</span> <span class="type">date</span> ,</span><br><span class="line">                        <span class="number">0</span> <span class="keyword">as</span> <span class="string">&#x27;str&#x27;</span></span><br><span class="line">                  <span class="keyword">from</span> </span><br><span class="line">                        <span class="number">63</span>_Failed </span><br><span class="line">                  <span class="keyword">union</span>  </span><br><span class="line">                  <span class="keyword">select</span></span><br><span class="line">                        success_date,</span><br><span class="line">                        <span class="number">1</span></span><br><span class="line">                  <span class="keyword">from</span> </span><br><span class="line">                        <span class="number">63</span>_Succeeded </span><br><span class="line">                 ) s,</span><br><span class="line">                 (<span class="keyword">select</span> <span class="variable">@pre</span>:<span class="operator">=</span><span class="keyword">null</span>,<span class="variable">@num</span>:<span class="operator">=</span><span class="number">0</span>,<span class="variable">@str</span> :<span class="operator">=</span> <span class="keyword">null</span>) s1</span><br><span class="line">            <span class="keyword">where</span> </span><br><span class="line">                  <span class="type">date</span> <span class="keyword">between</span> <span class="string">&#x27;2019-01-01&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2019-12-31&#x27;</span></span><br><span class="line">            <span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">                  <span class="type">date</span> </span><br><span class="line">           ) s,</span><br><span class="line">           (<span class="keyword">select</span> <span class="variable">@diff</span>:<span class="operator">=</span><span class="number">0</span>)  s1</span><br><span class="line">     ) ys</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> diff, str;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法二</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">      <span class="string">&#x27;fail&#x27;</span> <span class="keyword">as</span> period_state,</span><br><span class="line">      <span class="built_in">min</span>(f1.fail_date) start_date,</span><br><span class="line">      <span class="built_in">min</span>(f2.fail_date) end_date</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">     (<span class="keyword">select</span> </span><br><span class="line">            fail_date </span><br><span class="line">      <span class="keyword">from</span> </span><br><span class="line">            <span class="number">63</span>_failed</span><br><span class="line">      <span class="keyword">where</span></span><br><span class="line">            fail_date <span class="keyword">between</span> <span class="string">&#x27;2019-01-01&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2019-12-31&#x27;</span></span><br><span class="line">            <span class="keyword">and</span></span><br><span class="line">            date_add(fail_date, <span class="type">interval</span> <span class="number">-1</span> <span class="keyword">day</span>) <span class="keyword">not</span> <span class="keyword">in</span>(<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="number">63</span>_failed )</span><br><span class="line">     ) f1</span><br><span class="line"> <span class="keyword">join</span> </span><br><span class="line">     (<span class="keyword">select</span> </span><br><span class="line">            fail_date </span><br><span class="line">      <span class="keyword">from</span> </span><br><span class="line">            <span class="number">63</span>_failed</span><br><span class="line">      <span class="keyword">where</span> </span><br><span class="line">            fail_date <span class="keyword">between</span> <span class="string">&#x27;2019-01-01&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2019-12-31&#x27;</span></span><br><span class="line">            <span class="keyword">and</span></span><br><span class="line">            date_add(fail_date, <span class="type">interval</span> <span class="number">1</span> <span class="keyword">day</span>) <span class="keyword">not</span> <span class="keyword">in</span>(<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="number">63</span>_failed )</span><br><span class="line">      ) f2</span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">      f1.fail_date <span class="operator">&lt;=</span> f2.fail_date</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">      f1.fail_date</span><br><span class="line"><span class="keyword">union</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">      <span class="string">&#x27;success&#x27;</span> <span class="keyword">as</span> period_state,</span><br><span class="line">      <span class="built_in">min</span>(s1.success_date) start_date,</span><br><span class="line">      <span class="built_in">min</span>(s2.success_date) end_date</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">     (<span class="keyword">select</span> </span><br><span class="line">            success_date </span><br><span class="line">      <span class="keyword">from</span></span><br><span class="line">            <span class="number">63</span>_succeeded</span><br><span class="line">      <span class="keyword">where</span> </span><br><span class="line">            success_date <span class="keyword">between</span> <span class="string">&#x27;2019-01-01&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2019-12-31&#x27;</span></span><br><span class="line">            <span class="keyword">and</span> date_add(success_date, <span class="type">interval</span> <span class="number">-1</span> <span class="keyword">day</span>) <span class="keyword">not</span> <span class="keyword">in</span>(<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="number">63</span>_succeeded <span class="keyword">where</span> success_date <span class="keyword">between</span> <span class="string">&#x27;2019-01-01&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2019-12-31&#x27;</span>)) s1</span><br><span class="line"><span class="keyword">join</span></span><br><span class="line">     (<span class="keyword">select</span></span><br><span class="line">            success_date</span><br><span class="line">      <span class="keyword">from</span> </span><br><span class="line">            <span class="number">63</span>_succeeded </span><br><span class="line">      <span class="keyword">where</span></span><br><span class="line">            success_date <span class="keyword">between</span> <span class="string">&#x27;2019-01-01&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2019-12-31&#x27;</span> </span><br><span class="line">            <span class="keyword">and</span></span><br><span class="line">            date_add(success_date, <span class="type">interval</span> <span class="number">1</span> <span class="keyword">day</span>) <span class="keyword">not</span> <span class="keyword">in</span>(<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="number">63</span>_succeeded <span class="keyword">where</span> success_date <span class="keyword">between</span> <span class="string">&#x27;2019-01-01&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2019-12-31&#x27;</span>)) s2</span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">      s1.success_date <span class="operator">&lt;=</span> s2.success_date</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">      s1.success_date</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> </span><br><span class="line">      start_date;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法三</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">     type <span class="keyword">as</span> period_state,</span><br><span class="line">     <span class="built_in">min</span>(<span class="type">date</span>) <span class="keyword">as</span> start_date,</span><br><span class="line">     <span class="built_in">max</span>(<span class="type">date</span>) <span class="keyword">as</span> end_date</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    (<span class="keyword">select</span> </span><br><span class="line">           type, </span><br><span class="line">           `<span class="type">date</span>`,</span><br><span class="line">           subdate(`<span class="type">date</span>`,<span class="built_in">row_number</span>()<span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> type <span class="keyword">order</span> <span class="keyword">by</span> `<span class="type">date</span>`)) <span class="keyword">as</span> diff</span><br><span class="line">     <span class="keyword">from</span></span><br><span class="line">          (<span class="keyword">select</span> <span class="string">&#x27;failed&#x27;</span> <span class="keyword">as</span> type, fail_date <span class="keyword">as</span> `<span class="type">date</span>` <span class="keyword">from</span> <span class="number">63</span>_Failed</span><br><span class="line">           <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">           <span class="keyword">select</span> <span class="string">&#x27;succeeded&#x27;</span> <span class="keyword">as</span> type, success_date <span class="keyword">as</span> `<span class="type">date</span>` <span class="keyword">from</span> <span class="number">63</span>_Succeeded</span><br><span class="line">          ) a1</span><br><span class="line">      )a2</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">    `<span class="type">date</span>` <span class="keyword">between</span> <span class="string">&#x27;2019-01-01&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2019-12-31&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">     type,diff</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">     start_date;</span><br></pre></td></tr></table></figure>

<h2 id="64-每个帖子的评论数"><a href="#64-每个帖子的评论数" class="headerlink" title="64. 每个帖子的评论数"></a>64. 每个帖子的评论数</h2><p>需求一：编写 SQL 语句以查找每个帖子的评论数。结果表应包含帖子的 post_id 和对应的评论数 number_of_comments 并且按 post_id 升序排列。Submissions 可能包含重复的评论。您应该计算每个帖子的唯一评论数。Submissions 可能包含重复的帖子。您应该将它们视为一个帖子。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>post_id</th>
<th>number_of_comments</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>3</td>
</tr>
<tr>
<td>2</td>
<td>2</td>
</tr>
<tr>
<td>12</td>
<td>0</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">64</span>_Submissions (sub_id <span class="type">int</span>, parent_id <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">64</span>_Submissions;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">64</span>_Submissions (sub_id, parent_id) <span class="keyword">values</span> (<span class="number">1</span>, <span class="keyword">null</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">64</span>_Submissions (sub_id, parent_id) <span class="keyword">values</span> (<span class="number">2</span>, <span class="keyword">null</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">64</span>_Submissions (sub_id, parent_id) <span class="keyword">values</span> (<span class="number">1</span>, <span class="keyword">null</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">64</span>_Submissions (sub_id, parent_id) <span class="keyword">values</span> (<span class="number">12</span>, <span class="keyword">null</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">64</span>_Submissions (sub_id, parent_id) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">64</span>_Submissions (sub_id, parent_id) <span class="keyword">values</span> (<span class="number">5</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">64</span>_Submissions (sub_id, parent_id) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">64</span>_Submissions (sub_id, parent_id) <span class="keyword">values</span> (<span class="number">4</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">64</span>_Submissions (sub_id, parent_id) <span class="keyword">values</span> (<span class="number">9</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">64</span>_Submissions (sub_id, parent_id) <span class="keyword">values</span> (<span class="number">10</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">64</span>_Submissions (sub_id, parent_id) <span class="keyword">values</span> (<span class="number">6</span>, <span class="number">7</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">	  post_id,</span><br><span class="line">	  <span class="built_in">COUNT</span>( <span class="keyword">DISTINCT</span> S2.sub_id ) <span class="keyword">AS</span> number_of_comments </span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">	(<span class="keyword">SELECT</span></span><br><span class="line">           <span class="keyword">DISTINCT</span> sub_id <span class="keyword">AS</span> post_id </span><br><span class="line">     <span class="keyword">FROM</span> </span><br><span class="line">           <span class="number">64</span>_Submissions</span><br><span class="line">     <span class="keyword">WHERE</span> </span><br><span class="line">           parent_id <span class="keyword">IS</span> <span class="keyword">NULL</span></span><br><span class="line">    ) S1</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span></span><br><span class="line">     <span class="number">64</span>_Submissions S2</span><br><span class="line"><span class="keyword">ON</span></span><br><span class="line">     S1.post_id <span class="operator">=</span> S2.parent_id </span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">     S1.post_id;</span><br></pre></td></tr></table></figure>

<h2 id="65-平均售价"><a href="#65-平均售价" class="headerlink" title="65. 平均售价"></a>65. 平均售价</h2><p>需求一： 编写SQL查询以查找每种产品的平均售价。<br><code>average_price</code> 应该四舍五入到小数点后两位。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>product_id</th>
<th>average_price</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>6.96</td>
</tr>
<tr>
<td>2</td>
<td>16.96</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">65</span>_Prices (product_id <span class="type">int</span>, start_date <span class="type">date</span>, end_date <span class="type">date</span>, price <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">65</span>_UnitsSold (product_id <span class="type">int</span>, purchase_date <span class="type">date</span>, units <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">65</span>_Prices;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">65</span>_Prices (product_id, start_date, end_date, price) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;2019-02-17&#x27;</span>, <span class="string">&#x27;2019-02-28&#x27;</span>, <span class="number">5</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">65</span>_Prices (product_id, start_date, end_date, price) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;2019-03-01&#x27;</span>, <span class="string">&#x27;2019-03-22&#x27;</span>, <span class="number">20</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">65</span>_Prices (product_id, start_date, end_date, price) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;2019-02-01&#x27;</span>, <span class="string">&#x27;2019-02-20&#x27;</span>, <span class="number">15</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">65</span>_Prices (product_id, start_date, end_date, price) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;2019-02-21&#x27;</span>, <span class="string">&#x27;2019-03-31&#x27;</span>, <span class="number">30</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">65</span>_UnitsSold;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">65</span>_UnitsSold (product_id, purchase_date, units) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;2019-02-25&#x27;</span>, <span class="number">100</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">65</span>_UnitsSold (product_id, purchase_date, units) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;2019-03-01&#x27;</span>, <span class="number">15</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">65</span>_UnitsSold (product_id, purchase_date, units) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;2019-02-10&#x27;</span>, <span class="number">200</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">65</span>_UnitsSold (product_id, purchase_date, units) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;2019-03-22&#x27;</span>, <span class="number">30</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">      product_id,</span><br><span class="line">      round(<span class="built_in">sum</span>(a)<span class="operator">/</span><span class="built_in">sum</span>(units),<span class="number">2</span>) <span class="keyword">as</span> average_price</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">   (<span class="keyword">select</span> </span><br><span class="line">          p.product_id <span class="keyword">as</span> product_id,</span><br><span class="line">          price,units,</span><br><span class="line">          price <span class="operator">*</span> units <span class="keyword">as</span> a</span><br><span class="line">    <span class="keyword">from</span> </span><br><span class="line">          <span class="number">65</span>_Prices p </span><br><span class="line">    <span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">          <span class="number">65</span>_UnitsSold u</span><br><span class="line">    <span class="keyword">on</span> </span><br><span class="line">          p.product_id<span class="operator">=</span>u.product_id <span class="keyword">and</span> </span><br><span class="line">          purchase_date<span class="operator">&lt;=</span>end_date <span class="keyword">and</span> </span><br><span class="line">          purchase_date<span class="operator">&gt;=</span>start_date</span><br><span class="line">   )t</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">    product_id;</span><br></pre></td></tr></table></figure>

<h2 id="66-页面推荐"><a href="#66-页面推荐" class="headerlink" title="66. 页面推荐"></a>66. 页面推荐</h2><p>需求一： 写一段 SQL  向<code>user_id</code> = 1 的用户，推荐其朋友们喜欢的页面。不要推荐该用户已经喜欢的页面。 </p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>recommended_page</th>
</tr>
</thead>
<tbody><tr>
<td>23</td>
</tr>
<tr>
<td>24</td>
</tr>
<tr>
<td>56</td>
</tr>
<tr>
<td>33</td>
</tr>
<tr>
<td>77</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">66</span>_Friendship (user1_id <span class="type">int</span>, user2_id <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">66</span>_Likes (user_id <span class="type">int</span>, page_id <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">66</span>_Friendship;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">66</span>_Friendship (user1_id, user2_id) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">66</span>_Friendship (user1_id, user2_id) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">66</span>_Friendship (user1_id, user2_id) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">4</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">66</span>_Friendship (user1_id, user2_id) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">66</span>_Friendship (user1_id, user2_id) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">4</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">66</span>_Friendship (user1_id, user2_id) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">5</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">66</span>_Friendship (user1_id, user2_id) <span class="keyword">values</span> (<span class="number">6</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">66</span>_Likes;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">66</span>_Likes (user_id, page_id) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">88</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">66</span>_Likes (user_id, page_id) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">23</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">66</span>_Likes (user_id, page_id) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">24</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">66</span>_Likes (user_id, page_id) <span class="keyword">values</span> (<span class="number">4</span>, <span class="number">56</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">66</span>_Likes (user_id, page_id) <span class="keyword">values</span> (<span class="number">5</span>, <span class="number">11</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">66</span>_Likes (user_id, page_id) <span class="keyword">values</span> (<span class="number">6</span>, <span class="number">33</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">66</span>_Likes (user_id, page_id) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">77</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">66</span>_Likes (user_id, page_id) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">77</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">66</span>_Likes (user_id, page_id) <span class="keyword">values</span> (<span class="number">6</span>, <span class="number">88</span>);</span><br></pre></td></tr></table></figure>

<p>解释：</p>
<p>用户1同 用户2, 3, 4, 6 是朋友关系。</p>
<p>推荐页面为： 页面23 来自于 用户2, 页面24 来自于 用户3, 页面56 来自于 用户3 以及 页面33 来自于 用户6。<br>页面77 同时被 用户2 和 用户3 推荐。<br>页面88 没有被推荐，因为 用户1 已经喜欢了它。</p>
<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">      <span class="keyword">distinct</span> page_id <span class="keyword">as</span> recommended_page</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      <span class="number">66</span>_Likes,</span><br><span class="line">      <span class="number">66</span>_friendship</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">      page_id <span class="keyword">not</span> <span class="keyword">in</span>(<span class="keyword">select</span> page_id <span class="keyword">from</span> <span class="number">66</span>_likes <span class="keyword">where</span> user_id<span class="operator">=</span><span class="number">1</span>)</span><br><span class="line">      <span class="keyword">and</span></span><br><span class="line">      user_id <span class="keyword">in</span> (<span class="keyword">select</span> user1_id <span class="keyword">from</span> <span class="number">66</span>_friendship <span class="keyword">where</span> user2_id<span class="operator">=</span><span class="number">1</span>) </span><br><span class="line">      <span class="keyword">or</span></span><br><span class="line">      user_id <span class="keyword">in</span> (<span class="keyword">select</span> user2_id <span class="keyword">from</span> <span class="number">66</span>_friendship <span class="keyword">where</span> user1_id<span class="operator">=</span><span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<h2 id="67-汇报工作"><a href="#67-汇报工作" class="headerlink" title="67. 汇报工作"></a>67. 汇报工作</h2><p>需求：用 SQL 查询出所有直接或间接向公司 CEO 汇报工作的职工的 employee_id 。由于公司规模较小，经理之间的间接关系不超过 3 个经理。可以以任何顺序返回的结果，不需要去重。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>employee_id</th>
</tr>
</thead>
<tbody><tr>
<td>2</td>
</tr>
<tr>
<td>4</td>
</tr>
<tr>
<td>7</td>
</tr>
<tr>
<td>77</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">67</span>_Employees (employee_id <span class="type">int</span>, employee_name <span class="type">varchar</span>(<span class="number">30</span>), manager_id <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">67</span>_Employees;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">67</span>_Employees (employee_id, employee_name, manager_id) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;Boss&#x27;</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">67</span>_Employees (employee_id, employee_name, manager_id) <span class="keyword">values</span> (<span class="number">3</span>, <span class="string">&#x27;Alice&#x27;</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">67</span>_Employees (employee_id, employee_name, manager_id) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;Bob&#x27;</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">67</span>_Employees (employee_id, employee_name, manager_id) <span class="keyword">values</span> (<span class="number">4</span>, <span class="string">&#x27;Daniel&#x27;</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">67</span>_Employees (employee_id, employee_name, manager_id) <span class="keyword">values</span> (<span class="number">7</span>, <span class="string">&#x27;Luis&#x27;</span>, <span class="number">4</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">67</span>_Employees (employee_id, employee_name, manager_id) <span class="keyword">values</span> (<span class="number">8</span>, <span class="string">&#x27;John&#x27;</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">67</span>_Employees (employee_id, employee_name, manager_id) <span class="keyword">values</span> (<span class="number">9</span>, <span class="string">&#x27;Angela&#x27;</span>, <span class="number">8</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">67</span>_Employees (employee_id, employee_name, manager_id) <span class="keyword">values</span> (<span class="number">77</span>, <span class="string">&#x27;Robert&#x27;</span>, <span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<p>提示：</p>
<p>公司 CEO 的 employee_id 是 1.</p>
<p>employee_id 是 2 和 77 的职员直接汇报给公司 CEO。</p>
<p>employee_id 是 4 的职员间接汇报给公司 CEO 4 –&gt; 2 –&gt; 1 。</p>
<p>employee_id 是 7 的职员间接汇报给公司 CEO 7 –&gt; 4 –&gt; 2 –&gt; 1 。</p>
<p>employee_id 是 3, 8 ，9 的职员不会直接或间接的汇报给公司 CEO。 </p>
<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">      employee_id EMPLOYEE_ID</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      <span class="number">67</span>_Employees</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">      manager_id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> </span><br><span class="line">      employee_id<span class="operator">!=</span><span class="number">1</span></span><br><span class="line"><span class="keyword">union</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">      a1.employee_id</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      <span class="number">67</span>_Employees a1,</span><br><span class="line">     (<span class="keyword">select</span> </span><br><span class="line">            employee_id</span><br><span class="line">      <span class="keyword">from</span></span><br><span class="line">            <span class="number">67</span>_Employees</span><br><span class="line">      <span class="keyword">where</span></span><br><span class="line">            manager_id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span></span><br><span class="line">            employee_id<span class="operator">!=</span><span class="number">1</span></span><br><span class="line">     ) a</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">     manager_id<span class="operator">=</span>a.employee_id</span><br><span class="line"><span class="keyword">union</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">     a2.employee_id</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">     <span class="number">67</span>_Employees a2,</span><br><span class="line">    (<span class="keyword">select</span></span><br><span class="line">           a1.employee_id employee_id</span><br><span class="line">    <span class="keyword">from</span> </span><br><span class="line">           <span class="number">67</span>_Employees a1,</span><br><span class="line">           (<span class="keyword">select</span> </span><br><span class="line">                  employee_id</span><br><span class="line">            <span class="keyword">from</span></span><br><span class="line">                  <span class="number">67</span>_Employees</span><br><span class="line">            <span class="keyword">where</span></span><br><span class="line">                  manager_id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span></span><br><span class="line">                  employee_id<span class="operator">!=</span><span class="number">1</span></span><br><span class="line">           ) a</span><br><span class="line">    <span class="keyword">where</span> </span><br><span class="line">           manager_id<span class="operator">=</span>a.employee_id</span><br><span class="line">    ) a3</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">    manager_id<span class="operator">=</span>a3.employee_id</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> </span><br><span class="line">    employee_id;</span><br></pre></td></tr></table></figure>

<h2 id="68-学生们参加各科测试的次数"><a href="#68-学生们参加各科测试的次数" class="headerlink" title="68. 学生们参加各科测试的次数"></a>68. 学生们参加各科测试的次数</h2><p> 需求：写一段 SQL 语句，查询出每个学生参加每一门科目测试的次数，结果按 <code>student_id</code> 和 <code>subject_name</code> 排序。 </p>
<p>展示效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">+------------+--------------+--------------+----------------+</span><br><span class="line">| student_id | student_name | subject_name | attended_exams |</span><br><span class="line">+------------+--------------+--------------+----------------+</span><br><span class="line">| 1          | Alice        | Math         | 3              |</span><br><span class="line">| 1          | Alice        | Physics      | 2              |</span><br><span class="line">| 1          | Alice        | Programming  | 1              |</span><br><span class="line">| 2          | Bob          | Math         | 1              |</span><br><span class="line">| 2          | Bob          | Physics      | 0              |</span><br><span class="line">| 2          | Bob          | Programming  | 1              |</span><br><span class="line">| 6          | Alex         | Math         | 0              |</span><br><span class="line">| 6          | Alex         | Physics      | 0              |</span><br><span class="line">| 6          | Alex         | Programming  | 0              |</span><br><span class="line">| 13         | John         | Math         | 1              |</span><br><span class="line">| 13         | John         | Physics      | 1              |</span><br><span class="line">| 13         | John         | Programming  | 1              |</span><br><span class="line">+------------+--------------+--------------+----------------+</span><br></pre></td></tr></table></figure>

<p>建表语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">68</span>_Students (student_id <span class="type">int</span>, student_name <span class="type">varchar</span>(<span class="number">20</span>));</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">68</span>_Subjects (subject_name <span class="type">varchar</span>(<span class="number">20</span>));</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">68</span>_Examinations (student_id <span class="type">int</span>, subject_name <span class="type">varchar</span>(<span class="number">20</span>));</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">68</span>_Students;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">68</span>_Students (student_id, student_name) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Alice&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">68</span>_Students (student_id, student_name) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;Bob&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">68</span>_Students (student_id, student_name) <span class="keyword">values</span> (<span class="string">&#x27;13&#x27;</span>, <span class="string">&#x27;John&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">68</span>_Students (student_id, student_name) <span class="keyword">values</span> (<span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;Alex&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">68</span>_Subjects;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">68</span>_Subjects (subject_name) <span class="keyword">values</span> (<span class="string">&#x27;Math&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">68</span>_Subjects (subject_name) <span class="keyword">values</span> (<span class="string">&#x27;Physics&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">68</span>_Subjects (subject_name) <span class="keyword">values</span> (<span class="string">&#x27;Programming&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">68</span>_Examinations;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">68</span>_Examinations (student_id, subject_name) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Math&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">68</span>_Examinations (student_id, subject_name) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Physics&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">68</span>_Examinations (student_id, subject_name) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Programming&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">68</span>_Examinations (student_id, subject_name) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;Programming&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">68</span>_Examinations (student_id, subject_name) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Physics&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">68</span>_Examinations (student_id, subject_name) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Math&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">68</span>_Examinations (student_id, subject_name) <span class="keyword">values</span> (<span class="string">&#x27;13&#x27;</span>, <span class="string">&#x27;Math&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">68</span>_Examinations (student_id, subject_name) <span class="keyword">values</span> (<span class="string">&#x27;13&#x27;</span>, <span class="string">&#x27;Programming&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">68</span>_Examinations (student_id, subject_name) <span class="keyword">values</span> (<span class="string">&#x27;13&#x27;</span>, <span class="string">&#x27;Physics&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">68</span>_Examinations (student_id, subject_name) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;Math&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">68</span>_Examinations (student_id, subject_name) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Math&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终sql：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">     a.student_id,</span><br><span class="line">     a.student_name,</span><br><span class="line">     b.subject_name,</span><br><span class="line">     <span class="built_in">COUNT</span>(e.subject_name) <span class="keyword">AS</span> attended_exams</span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">     <span class="number">68</span>_Students a </span><br><span class="line"><span class="keyword">CROSS</span> <span class="keyword">JOIN</span></span><br><span class="line">     <span class="number">68</span>_Subjects b</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span></span><br><span class="line">     <span class="number">68</span>_Examinations e </span><br><span class="line"><span class="keyword">ON</span> </span><br><span class="line">     a.student_id <span class="operator">=</span> e.student_id </span><br><span class="line">     <span class="keyword">AND</span></span><br><span class="line">     b.subject_name <span class="operator">=</span> e.subject_name</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> </span><br><span class="line">     a.student_id, b.subject_name</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">     a.student_id, b.subject_name;</span><br></pre></td></tr></table></figure>

<h2 id="69-找到连续区间的开始和结束数字"><a href="#69-找到连续区间的开始和结束数字" class="headerlink" title="69. 找到连续区间的开始和结束数字"></a>69. 找到连续区间的开始和结束数字</h2><p> 需求：编写一个 SQL 查询得到 <code>Logs</code> 表中的连续区间的开始数字和结束数字。 </p>
<p>展示效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+------------+--------------+</span><br><span class="line">| start_id   | end_id       |</span><br><span class="line">+------------+--------------+</span><br><span class="line">| 1          | 3            |</span><br><span class="line">| 7          | 8            |</span><br><span class="line">| 10         | 10           |</span><br><span class="line">+------------+--------------+</span><br></pre></td></tr></table></figure>

<p>建表语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">69</span>_Logs (log_id <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">69</span>_Logs;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">69</span>_Logs (log_id) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">69</span>_Logs (log_id) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">69</span>_Logs (log_id) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">69</span>_Logs (log_id) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">69</span>_Logs (log_id) <span class="keyword">values</span> (<span class="string">&#x27;8&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">69</span>_Logs (log_id) <span class="keyword">values</span> (<span class="string">&#x27;10&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终sql：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="built_in">min</span>(log_id) start_id,</span><br><span class="line">    <span class="built_in">max</span>(log_id) end_id</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">	(<span class="keyword">SELECT</span></span><br><span class="line">		log_id,</span><br><span class="line">		<span class="keyword">CASE</span> <span class="keyword">WHEN</span> <span class="variable">@id</span> <span class="operator">=</span> log_id <span class="operator">-</span> <span class="number">1</span> <span class="keyword">THEN</span> <span class="variable">@num</span> :<span class="operator">=</span> <span class="variable">@num</span></span><br><span class="line">		<span class="keyword">ELSE</span> <span class="variable">@num</span> :<span class="operator">=</span> <span class="variable">@num</span> <span class="operator">+</span> <span class="number">1</span></span><br><span class="line">		<span class="keyword">END</span> num, <span class="variable">@id</span> :<span class="operator">=</span> log_id</span><br><span class="line">	 <span class="keyword">FROM</span> </span><br><span class="line">         <span class="number">69</span>_Logs,</span><br><span class="line">         (<span class="keyword">SELECT</span> <span class="variable">@num</span> :<span class="operator">=</span> <span class="number">0</span>, <span class="variable">@id</span> :<span class="operator">=</span> <span class="keyword">NULL</span>) a</span><br><span class="line">	) x</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> num;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法二</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">     a.log_id <span class="keyword">as</span> start_id,</span><br><span class="line">     <span class="built_in">min</span>(b.log_id) <span class="keyword">as</span> end_id</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    (<span class="keyword">select</span> log_id <span class="keyword">from</span> <span class="number">69</span>_logs <span class="keyword">where</span> log_id<span class="number">-1</span> <span class="keyword">not</span> <span class="keyword">in</span> (<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="number">69</span>_logs)) a,</span><br><span class="line">    (<span class="keyword">select</span> log_id <span class="keyword">from</span> <span class="number">69</span>_logs <span class="keyword">where</span> log_id<span class="operator">+</span><span class="number">1</span> <span class="keyword">not</span> <span class="keyword">in</span> (<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="number">69</span>_logs)) b</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">     b.log_id<span class="operator">&gt;=</span>a.log_id</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">     a.log_id;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法三</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="built_in">MIN</span>(log_id) start_id,</span><br><span class="line">    <span class="built_in">MAX</span>(log_id) end_id</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    (<span class="keyword">SELECT</span></span><br><span class="line">        log_id, </span><br><span class="line">        log_id <span class="operator">-</span> <span class="built_in">row_number</span>() <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> log_id) <span class="keyword">as</span> diff</span><br><span class="line">     <span class="keyword">FROM</span> </span><br><span class="line">        <span class="number">69</span>_Logs ) t</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> diff;</span><br></pre></td></tr></table></figure>

<h2 id="70-不同国家的天气类型"><a href="#70-不同国家的天气类型" class="headerlink" title="70. 不同国家的天气类型"></a>70. 不同国家的天气类型</h2><p>需求：写一段 SQL 来找到表中每个国家在 2019 年 11 月的天气类型。</p>
<p>天气类型的定义如下：当 weather_state 的平均值小于或等于15返回 <strong>Cold</strong>，当 weather_state 的平均值大于或等于 25 返回 <strong>Hot</strong>，否则返回 <strong>Warm</strong>。</p>
<p>展示效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">+--------------+--------------+</span><br><span class="line">| country_name | weather_type |</span><br><span class="line">+--------------+--------------+</span><br><span class="line">| USA          | Cold         |</span><br><span class="line">| Austraila    | Cold         |</span><br><span class="line">| Peru         | Hot          |</span><br><span class="line">| China        | Warm         |</span><br><span class="line">| Morocco      | Hot          |</span><br><span class="line">+--------------+--------------+</span><br></pre></td></tr></table></figure>

<p>建表语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">70</span>_Countries (country_id <span class="type">int</span>, country_name <span class="type">varchar</span>(<span class="number">20</span>));</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">70</span>_Weather (country_id <span class="type">int</span>, weather_state <span class="type">int</span>, <span class="keyword">day</span> <span class="type">date</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">70</span>_Countries;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">70</span>_Countries (country_id, country_name) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;USA&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">70</span>_Countries (country_id, country_name) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;Australia&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">70</span>_Countries (country_id, country_name) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;Peru&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">70</span>_Countries (country_id, country_name) <span class="keyword">values</span> (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;China&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">70</span>_Countries (country_id, country_name) <span class="keyword">values</span> (<span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;Morocco&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">70</span>_Countries (country_id, country_name) <span class="keyword">values</span> (<span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;Spain&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">70</span>_Weather;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">70</span>_Weather (country_id, weather_state, <span class="keyword">day</span>) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;15&#x27;</span>, <span class="string">&#x27;2019-11-01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">70</span>_Weather (country_id, weather_state, <span class="keyword">day</span>) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;12&#x27;</span>, <span class="string">&#x27;2019-10-28&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">70</span>_Weather (country_id, weather_state, <span class="keyword">day</span>) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;12&#x27;</span>, <span class="string">&#x27;2019-10-27&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">70</span>_Weather (country_id, weather_state, <span class="keyword">day</span>) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;-2&#x27;</span>, <span class="string">&#x27;2019-11-10&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">70</span>_Weather (country_id, weather_state, <span class="keyword">day</span>) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;2019-11-11&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">70</span>_Weather (country_id, weather_state, <span class="keyword">day</span>) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2019-11-12&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">70</span>_Weather (country_id, weather_state, <span class="keyword">day</span>) <span class="keyword">values</span> (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;16&#x27;</span>, <span class="string">&#x27;2019-11-07&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">70</span>_Weather (country_id, weather_state, <span class="keyword">day</span>) <span class="keyword">values</span> (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;18&#x27;</span>, <span class="string">&#x27;2019-11-09&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">70</span>_Weather (country_id, weather_state, <span class="keyword">day</span>) <span class="keyword">values</span> (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;21&#x27;</span>, <span class="string">&#x27;2019-11-23&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">70</span>_Weather (country_id, weather_state, <span class="keyword">day</span>) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;25&#x27;</span>, <span class="string">&#x27;2019-11-28&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">70</span>_Weather (country_id, weather_state, <span class="keyword">day</span>) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;22&#x27;</span>, <span class="string">&#x27;2019-12-01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">70</span>_Weather (country_id, weather_state, <span class="keyword">day</span>) <span class="keyword">values</span> (<span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;25&#x27;</span>, <span class="string">&#x27;2019-11-05&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">70</span>_Weather (country_id, weather_state, <span class="keyword">day</span>) <span class="keyword">values</span> (<span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;27&#x27;</span>, <span class="string">&#x27;2019-11-15&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">70</span>_Weather (country_id, weather_state, <span class="keyword">day</span>) <span class="keyword">values</span> (<span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;31&#x27;</span>, <span class="string">&#x27;2019-11-25&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">70</span>_Weather (country_id, weather_state, <span class="keyword">day</span>) <span class="keyword">values</span> (<span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;2019-10-23&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">70</span>_Weather (country_id, weather_state, <span class="keyword">day</span>) <span class="keyword">values</span> (<span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2019-12-23&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终sql：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    country_name,</span><br><span class="line">    (<span class="keyword">case</span> </span><br><span class="line">         <span class="keyword">when</span> <span class="built_in">avg</span>(weather_state)<span class="operator">&lt;=</span><span class="number">15</span> <span class="keyword">then</span> <span class="string">&#x27;Cold&#x27;</span></span><br><span class="line">         <span class="keyword">when</span> <span class="built_in">avg</span>(weather_state)<span class="operator">&gt;=</span><span class="number">25</span> <span class="keyword">then</span> <span class="string">&#x27;Hot&#x27;</span></span><br><span class="line">         <span class="keyword">else</span> <span class="string">&#x27;Warm&#x27;</span></span><br><span class="line">     <span class="keyword">end</span> ) weather_type</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    <span class="number">70</span>_Countries c </span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> </span><br><span class="line">    <span class="number">70</span>_Weather w</span><br><span class="line"><span class="keyword">on</span></span><br><span class="line">    c.country_id <span class="operator">=</span> w.country_id</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    date_format(<span class="keyword">day</span>,&quot;%Y-%m&quot;)<span class="operator">=</span><span class="string">&#x27;2019-11&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> country_name;</span><br></pre></td></tr></table></figure>

<h2 id="71-求团队人数"><a href="#71-求团队人数" class="headerlink" title="71. 求团队人数"></a>71. 求团队人数</h2><p>编写一个 SQL 查询，以求得每个员工所在团队的总人数。查询结果中的顺序无特定要求。</p>
<p>展示效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">+-------------+------------+</span><br><span class="line">| employee_id | team_size  |</span><br><span class="line">+-------------+------------+</span><br><span class="line">|     1       |     3      |</span><br><span class="line">|     2       |     3      |</span><br><span class="line">|     3       |     3      |</span><br><span class="line">|     4       |     1      |</span><br><span class="line">|     5       |     2      |</span><br><span class="line">|     6       |     2      |</span><br><span class="line">+-------------+------------+</span><br></pre></td></tr></table></figure>

<p>建表语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">71</span>_Employee (employee_id <span class="type">int</span>, team_id <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">71</span>_Employee;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">71</span>_Employee (employee_id, team_id) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;8&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">71</span>_Employee (employee_id, team_id) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;8&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">71</span>_Employee (employee_id, team_id) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;8&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">71</span>_Employee (employee_id, team_id) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;7&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">71</span>_Employee (employee_id, team_id) <span class="keyword">values</span> (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;9&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">71</span>_Employee (employee_id, team_id) <span class="keyword">values</span> (<span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;9&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终sql：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">     employee_id,</span><br><span class="line">    (<span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> <span class="number">71</span>_employee e2 <span class="keyword">WHERE</span> e1.team_id <span class="operator">=</span> e2.team_id) <span class="keyword">AS</span> team_size</span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">     <span class="number">71</span>_Employee e1</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">     e1.employee_id;</span><br><span class="line">     </span><br><span class="line"><span class="comment">-- 方法二</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">     e1.employee_id, </span><br><span class="line">     <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> team_size</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">     <span class="number">71</span>_Employee e1</span><br><span class="line"><span class="keyword">JOIN</span></span><br><span class="line">     <span class="number">71</span>_Employee e2 </span><br><span class="line"><span class="keyword">USING</span>(team_id)</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">     e1.employee_id</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> </span><br><span class="line">     e1.employee_id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法三</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    employee_id,</span><br><span class="line">    <span class="built_in">COUNT</span>(employee_id) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> team_id) <span class="keyword">AS</span> team_size</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    <span class="number">71</span>_Employee</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">    employee_id;</span><br></pre></td></tr></table></figure>

<h2 id="72-不同性别每日分数总计"><a href="#72-不同性别每日分数总计" class="headerlink" title="72. 不同性别每日分数总计"></a>72. 不同性别每日分数总计</h2><p>写一条SQL语句查询每种性别在每一天的总分，并按性别和日期对查询结果排序</p>
<p>展示效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">+--------+------------+-------+</span><br><span class="line">| gender | day        | total |</span><br><span class="line">+--------+------------+-------+</span><br><span class="line">| F      | 2019-12-30 | 17    |</span><br><span class="line">| F      | 2019-12-31 | 40    |</span><br><span class="line">| F      | 2020-01-01 | 57    |</span><br><span class="line">| F      | 2020-01-07 | 80    |</span><br><span class="line">| M      | 2019-12-18 | 2     |</span><br><span class="line">| M      | 2019-12-25 | 13    |</span><br><span class="line">| M      | 2019-12-30 | 26    |</span><br><span class="line">| M      | 2019-12-31 | 29    |</span><br><span class="line">| M      | 2020-01-07 | 36    |</span><br><span class="line">+--------+------------+-------+</span><br></pre></td></tr></table></figure>

<p>建表语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">72</span>_Scores (player_name <span class="type">varchar</span>(<span class="number">20</span>), gender <span class="type">varchar</span>(<span class="number">1</span>), <span class="keyword">day</span> <span class="type">date</span>, score_points <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">72</span>_Scores;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">72</span>_Scores (player_name, gender, <span class="keyword">day</span>, score_points) <span class="keyword">values</span> (<span class="string">&#x27;Aron&#x27;</span>, <span class="string">&#x27;F&#x27;</span>, <span class="string">&#x27;2020-01-01&#x27;</span>, <span class="string">&#x27;17&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">72</span>_Scores (player_name, gender, <span class="keyword">day</span>, score_points) <span class="keyword">values</span> (<span class="string">&#x27;Alice&#x27;</span>, <span class="string">&#x27;F&#x27;</span>, <span class="string">&#x27;2020-01-07&#x27;</span>, <span class="string">&#x27;23&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">72</span>_Scores (player_name, gender, <span class="keyword">day</span>, score_points) <span class="keyword">values</span> (<span class="string">&#x27;Bajrang&#x27;</span>, <span class="string">&#x27;M&#x27;</span>, <span class="string">&#x27;2020-01-07&#x27;</span>, <span class="string">&#x27;7&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">72</span>_Scores (player_name, gender, <span class="keyword">day</span>, score_points) <span class="keyword">values</span> (<span class="string">&#x27;Khali&#x27;</span>, <span class="string">&#x27;M&#x27;</span>, <span class="string">&#x27;2019-12-25&#x27;</span>, <span class="string">&#x27;11&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">72</span>_Scores (player_name, gender, <span class="keyword">day</span>, score_points) <span class="keyword">values</span> (<span class="string">&#x27;Slaman&#x27;</span>, <span class="string">&#x27;M&#x27;</span>, <span class="string">&#x27;2019-12-30&#x27;</span>, <span class="string">&#x27;13&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">72</span>_Scores (player_name, gender, <span class="keyword">day</span>, score_points) <span class="keyword">values</span> (<span class="string">&#x27;Joe&#x27;</span>, <span class="string">&#x27;M&#x27;</span>, <span class="string">&#x27;2019-12-31&#x27;</span>, <span class="string">&#x27;3&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">72</span>_Scores (player_name, gender, <span class="keyword">day</span>, score_points) <span class="keyword">values</span> (<span class="string">&#x27;Jose&#x27;</span>, <span class="string">&#x27;M&#x27;</span>, <span class="string">&#x27;2019-12-18&#x27;</span>, <span class="string">&#x27;2&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">72</span>_Scores (player_name, gender, <span class="keyword">day</span>, score_points) <span class="keyword">values</span> (<span class="string">&#x27;Priya&#x27;</span>, <span class="string">&#x27;F&#x27;</span>, <span class="string">&#x27;2019-12-31&#x27;</span>, <span class="string">&#x27;23&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">72</span>_Scores (player_name, gender, <span class="keyword">day</span>, score_points) <span class="keyword">values</span> (<span class="string">&#x27;Priyanka&#x27;</span>, <span class="string">&#x27;F&#x27;</span>, <span class="string">&#x27;2019-12-30&#x27;</span>, <span class="string">&#x27;17&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">     s1.gender,</span><br><span class="line">     s1.day,</span><br><span class="line">     <span class="built_in">SUM</span>(s2.score_points) <span class="keyword">AS</span> total</span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">     Scores <span class="keyword">AS</span> s1 </span><br><span class="line"><span class="keyword">JOIN</span> </span><br><span class="line">     Scores <span class="keyword">AS</span> s2</span><br><span class="line"><span class="keyword">ON</span> </span><br><span class="line">     s1.gender <span class="operator">=</span> s2.gender </span><br><span class="line">     <span class="keyword">AND</span></span><br><span class="line">     s1.day <span class="operator">&gt;=</span> s2.day</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> </span><br><span class="line">     s1.gender, s1.day</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> </span><br><span class="line">     s1.gender, s1.day;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法二</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">     gender,</span><br><span class="line">     <span class="keyword">day</span>,</span><br><span class="line">     <span class="built_in">SUM</span>(score_points) <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> gender <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">day</span>) <span class="keyword">AS</span> total</span><br><span class="line"><span class="keyword">FROM</span> Scores;</span><br></pre></td></tr></table></figure>



<h2 id="73-餐馆营业额变化增长"><a href="#73-餐馆营业额变化增长" class="headerlink" title="73. 餐馆营业额变化增长"></a>73. 餐馆营业额变化增长</h2><p>写一条 SQL 查询计算以 7 天（某日期 + 该日期前的 6 天）为一个时间段的顾客消费平均值</p>
<p>查询结果格式的例子如下：</p>
<ul>
<li>查询结果按 <code>visited_on</code> 排序</li>
<li><code>average_amount</code> 要 <strong>保留两位小数</strong>，日期数据的格式为 (‘YYYY-MM-DD’)</li>
</ul>
<p>展示效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">+---------------+--------+----------------+</span><br><span class="line">| visited_on    | amount | average_amount |</span><br><span class="line">+---------------+--------+----------------+</span><br><span class="line">| 2019-01-07    |    860 |         122.86 |</span><br><span class="line">| 2019-01-08    |    840 |         120.00 |</span><br><span class="line">| 2019-01-09    |    840 |         120.00 |</span><br><span class="line">| 2019-01-10    |   1000 |         142.86 |</span><br><span class="line">+---------------+--------+----------------+</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">73</span>_Customer (customer_id <span class="type">int</span>, name <span class="type">varchar</span>(<span class="number">20</span>), visited_on <span class="type">date</span>, amount <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">73</span>_Customer;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">73</span>_Customer (customer_id, name, visited_on, amount) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Jhon&#x27;</span>, <span class="string">&#x27;2019-01-01&#x27;</span>, <span class="string">&#x27;100&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">73</span>_Customer (customer_id, name, visited_on, amount) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;Daniel&#x27;</span>, <span class="string">&#x27;2019-01-02&#x27;</span>, <span class="string">&#x27;110&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">73</span>_Customer (customer_id, name, visited_on, amount) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;Jade&#x27;</span>, <span class="string">&#x27;2019-01-03&#x27;</span>, <span class="string">&#x27;120&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">73</span>_Customer (customer_id, name, visited_on, amount) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;Khaled&#x27;</span>, <span class="string">&#x27;2019-01-04&#x27;</span>, <span class="string">&#x27;130&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">73</span>_Customer (customer_id, name, visited_on, amount) <span class="keyword">values</span> (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;Winston&#x27;</span>, <span class="string">&#x27;2019-01-05&#x27;</span>, <span class="string">&#x27;110&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">73</span>_Customer (customer_id, name, visited_on, amount) <span class="keyword">values</span> (<span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;Elvis&#x27;</span>, <span class="string">&#x27;2019-01-06&#x27;</span>, <span class="string">&#x27;140&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">73</span>_Customer (customer_id, name, visited_on, amount) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;Anna&#x27;</span>, <span class="string">&#x27;2019-01-07&#x27;</span>, <span class="string">&#x27;150&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">73</span>_Customer (customer_id, name, visited_on, amount) <span class="keyword">values</span> (<span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;Maria&#x27;</span>, <span class="string">&#x27;2019-01-08&#x27;</span>, <span class="string">&#x27;80&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">73</span>_Customer (customer_id, name, visited_on, amount) <span class="keyword">values</span> (<span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;Jaze&#x27;</span>, <span class="string">&#x27;2019-01-09&#x27;</span>, <span class="string">&#x27;110&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">73</span>_Customer (customer_id, name, visited_on, amount) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Jhon&#x27;</span>, <span class="string">&#x27;2019-01-10&#x27;</span>, <span class="string">&#x27;130&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">73</span>_Customer (customer_id, name, visited_on, amount) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;Jade&#x27;</span>, <span class="string">&#x27;2019-01-10&#x27;</span>, <span class="string">&#x27;150&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终sql：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    s.visited_on,</span><br><span class="line">    <span class="built_in">sum</span>(c.amount) <span class="keyword">as</span> &quot;amount&quot;,</span><br><span class="line">    round(<span class="built_in">sum</span>(c.amount) <span class="operator">/</span> <span class="number">7</span>, <span class="number">2</span>) <span class="keyword">as</span> &quot;average_amount&quot;</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    <span class="number">73</span>_Customer c </span><br><span class="line"><span class="keyword">inner</span> <span class="keyword">join</span> </span><br><span class="line">   (<span class="keyword">select</span></span><br><span class="line">         <span class="keyword">distinct</span> visited_on</span><br><span class="line">    <span class="keyword">from</span></span><br><span class="line">         <span class="number">73</span>_Customer c </span><br><span class="line">    <span class="keyword">where</span> </span><br><span class="line">         visited_on <span class="operator">&gt;=</span> (<span class="keyword">select</span></span><br><span class="line">                              <span class="keyword">distinct</span> visited_on</span><br><span class="line">                        <span class="keyword">from</span></span><br><span class="line">                              <span class="number">73</span>_customer </span><br><span class="line">                        <span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">                              visited_on <span class="keyword">asc</span></span><br><span class="line">                        limit <span class="number">1</span> <span class="keyword">offset</span> <span class="number">6</span>)</span><br><span class="line">   ) s </span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">   datediff(s.visited_on, c.visited_on) <span class="operator">&gt;=</span> <span class="number">0</span> </span><br><span class="line">   <span class="keyword">and</span></span><br><span class="line">   datediff(s.visited_on, c.visited_on) <span class="operator">&lt;</span> <span class="number">7</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">   s.visited_on;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法二</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">     visited_on,</span><br><span class="line">     amount,</span><br><span class="line">     round(amount<span class="operator">/</span><span class="number">7</span>,<span class="number">2</span>) average_amount</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    (<span class="keyword">select</span></span><br><span class="line">          visited_on,</span><br><span class="line">          ant,</span><br><span class="line">          <span class="built_in">lag</span>(visited_on,<span class="number">6</span>,<span class="keyword">null</span>) <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> visited_on) lg,</span><br><span class="line">          <span class="built_in">sum</span>(ant) <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> visited_on <span class="keyword">rows</span> <span class="keyword">between</span> <span class="number">6</span> PRECEDING <span class="keyword">and</span> <span class="keyword">current</span> <span class="type">row</span>) amount</span><br><span class="line">     <span class="keyword">from</span></span><br><span class="line">         (<span class="keyword">select</span> </span><br><span class="line">                visited_on,</span><br><span class="line">                <span class="built_in">sum</span>(amount) ant</span><br><span class="line">          <span class="keyword">from</span> </span><br><span class="line">                <span class="number">73</span>_Customer</span><br><span class="line">          <span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">                visited_on)t1</span><br><span class="line">          )t2</span><br><span class="line"><span class="keyword">where</span> lg <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>扩展：从起始日期查询七天内，每天的平均收入，不满足七天的按实际天数求平均值。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">     c2_visited_on <span class="keyword">as</span> visited_on,</span><br><span class="line">     <span class="built_in">sum</span>(amount) amount,</span><br><span class="line">     round(<span class="built_in">sum</span>(amount)<span class="operator">/</span><span class="built_in">count</span>(<span class="keyword">distinct</span> c1_visited_on),<span class="number">2</span>) <span class="keyword">as</span> average_amount</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    (<span class="keyword">select</span></span><br><span class="line">          c1.amount,</span><br><span class="line">          c1.visited_on <span class="keyword">as</span> c1_visited_on,</span><br><span class="line">          c2.visited_on <span class="keyword">as</span> c2_visited_on</span><br><span class="line">     <span class="keyword">from</span></span><br><span class="line">          <span class="number">73</span>_Customer c1</span><br><span class="line">     <span class="keyword">join</span></span><br><span class="line">         (<span class="keyword">select</span> <span class="keyword">distinct</span> visited_on <span class="keyword">from</span> <span class="number">73</span>_Customer) c2</span><br><span class="line">     <span class="keyword">on</span></span><br><span class="line">          datediff(c2.visited_on, c1.visited_on) <span class="operator">&lt;=</span> <span class="number">6</span></span><br><span class="line">          <span class="keyword">and</span></span><br><span class="line">          datediff(c2.visited_on, c1.visited_on) <span class="operator">&gt;=</span> <span class="number">0</span></span><br><span class="line">     ) tmp</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">     tmp.c2_visited_on;</span><br></pre></td></tr></table></figure>



<h2 id="74-广告效果"><a href="#74-广告效果" class="headerlink" title="74. 广告效果"></a>74. 广告效果</h2><p>写一条SQL语句来查询每一条广告的 <code>ctr</code> ， <code>ctr</code> 要保留两位小数。结果需要按 <code>ctr</code> <strong>降序</strong>、按 <code>ad_id</code> <strong>升序</strong> 进行排序。</p>
<p>广告效果用点击通过率（Click-Through Rate：CTR）来衡量，公式如下:</p>
<p><img src="https://assets.leetcode-cn.com/aliyun-lc-upload/uploads/2020/03/06/sql1.png" alt="img"></p>
<p>展示效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">+-------+-------+</span><br><span class="line">| ad_id | ctr   |</span><br><span class="line">+-------+-------+</span><br><span class="line">| 1     | 66.67 |</span><br><span class="line">| 3     | 50.00 |</span><br><span class="line">| 2     | 33.33 |</span><br><span class="line">| 5     | 0.00  |</span><br><span class="line">+-------+-------+</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">74</span>_Ads (ad_id <span class="type">int</span>, user_id <span class="type">int</span>, action ENUM(<span class="string">&#x27;Clicked&#x27;</span>, <span class="string">&#x27;Viewed&#x27;</span>, <span class="string">&#x27;Ignored&#x27;</span>));</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">74</span>_Ads;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">74</span>_Ads (ad_id, user_id, action) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Clicked&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">74</span>_Ads (ad_id, user_id, action) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;Clicked&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">74</span>_Ads (ad_id, user_id, action) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;Viewed&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">74</span>_Ads (ad_id, user_id, action) <span class="keyword">values</span> (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;Ignored&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">74</span>_Ads (ad_id, user_id, action) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;Ignored&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">74</span>_Ads (ad_id, user_id, action) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;Viewed&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">74</span>_Ads (ad_id, user_id, action) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;Clicked&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">74</span>_Ads (ad_id, user_id, action) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;Viewed&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">74</span>_Ads (ad_id, user_id, action) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;11&#x27;</span>, <span class="string">&#x27;Viewed&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">74</span>_Ads (ad_id, user_id, action) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;Clicked&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">     ad_id,</span><br><span class="line">     ROUND(IFNULL(<span class="built_in">SUM</span>(action <span class="operator">=</span> <span class="string">&#x27;Clicked&#x27;</span>)</span><br><span class="line">                    <span class="operator">/</span></span><br><span class="line">             (<span class="built_in">SUM</span>(action <span class="operator">=</span> <span class="string">&#x27;Clicked&#x27;</span>) <span class="operator">+</span> <span class="built_in">SUM</span>(action <span class="operator">=</span> <span class="string">&#x27;Viewed&#x27;</span>)) <span class="operator">*</span> <span class="number">100</span>, <span class="number">0</span>), <span class="number">2</span>) <span class="keyword">AS</span> ctr</span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">    <span class="number">74</span>_Ads</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">    ad_id</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">    ctr <span class="keyword">DESC</span>,</span><br><span class="line">    ad_id <span class="keyword">ASC</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法二</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">     ad_id,</span><br><span class="line">     ifnull(round((Clicked<span class="operator">/</span>(Viewed <span class="operator">+</span> Clicked))<span class="operator">*</span><span class="number">100</span>,<span class="number">2</span>),<span class="number">0</span>) <span class="keyword">as</span> ctr</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    (<span class="keyword">select</span></span><br><span class="line">           ad_id,</span><br><span class="line">           <span class="built_in">count</span>(<span class="keyword">case</span> <span class="keyword">when</span> action <span class="operator">=</span> <span class="string">&#x27;Clicked&#x27;</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">end</span>) <span class="keyword">as</span> Clicked,</span><br><span class="line">           <span class="built_in">count</span>(<span class="keyword">case</span> <span class="keyword">when</span> action <span class="operator">=</span> <span class="string">&#x27;Viewed&#x27;</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">end</span>) <span class="keyword">as</span> Viewed</span><br><span class="line">     <span class="keyword">from</span> <span class="number">74</span>_Ads </span><br><span class="line">     <span class="keyword">group</span> <span class="keyword">by</span> ad_id ) a </span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> </span><br><span class="line">     ctr <span class="keyword">desc</span>,</span><br><span class="line">     ad_id <span class="keyword">asc</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法三</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">     a.ad_id,</span><br><span class="line">     ifnull(ctr,<span class="number">0</span>) ctr</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">     <span class="number">74</span>_Ads a</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> </span><br><span class="line">     (<span class="keyword">select</span></span><br><span class="line">           ad_id,</span><br><span class="line">           round(<span class="built_in">sum</span>(if(action<span class="operator">=</span><span class="string">&#x27;Clicked&#x27;</span>,<span class="number">1</span>,<span class="number">0</span>))<span class="operator">/</span><span class="built_in">count</span>(<span class="operator">*</span>)<span class="operator">*</span><span class="number">100</span>,<span class="number">2</span>) ctr </span><br><span class="line">      <span class="keyword">from</span> <span class="number">74</span>_Ads </span><br><span class="line">      <span class="keyword">where</span> action <span class="operator">!=</span><span class="string">&#x27;Ignored&#x27;</span></span><br><span class="line">      <span class="keyword">group</span> <span class="keyword">by</span> ad_id )t1 </span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">      a.ad_id<span class="operator">=</span> t1.ad_id</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">      ad_id,ctr</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">      ctr <span class="keyword">desc</span>,ad_id;</span><br></pre></td></tr></table></figure>

<h2 id="75-列出指定时间段内所有的下单产品"><a href="#75-列出指定时间段内所有的下单产品" class="headerlink" title="75. 列出指定时间段内所有的下单产品"></a>75. 列出指定时间段内所有的下单产品</h2><p>写一个 SQL 语句，要求获取在 2020 年 2 月份下单的数量不少于 100 的产品的名字和数目。返回结果表单的顺序无要求。</p>
<p>展示效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">+--------------------+---------+</span><br><span class="line">| product_name       | unit    |</span><br><span class="line">+--------------------+---------+</span><br><span class="line">| Leetcode Solutions | 130     |</span><br><span class="line">| Leetcode Kit       | 100     |</span><br><span class="line">+--------------------+---------+</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">75</span>_Products (product_id <span class="type">int</span>, product_name <span class="type">varchar</span>(<span class="number">40</span>), product_category <span class="type">varchar</span>(<span class="number">40</span>));</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">75</span>_Orders (product_id <span class="type">int</span>, order_date <span class="type">date</span>, unit <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">75</span>_Products;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">75</span>_Products (product_id, product_name, product_category) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Leetcode Solutions&#x27;</span>, <span class="string">&#x27;Book&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">75</span>_Products (product_id, product_name, product_category) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;Jewels of Stringology&#x27;</span>, <span class="string">&#x27;Book&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">75</span>_Products (product_id, product_name, product_category) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;HP&#x27;</span>, <span class="string">&#x27;Laptop&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">75</span>_Products (product_id, product_name, product_category) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;Lenovo&#x27;</span>, <span class="string">&#x27;Laptop&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">75</span>_Products (product_id, product_name, product_category) <span class="keyword">values</span> (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;Leetcode Kit&#x27;</span>, <span class="string">&#x27;T-shirt&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">75</span>_Orders;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">75</span>_Orders (product_id, order_date, unit) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2020-02-05&#x27;</span>, <span class="string">&#x27;60&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">75</span>_Orders (product_id, order_date, unit) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2020-02-10&#x27;</span>, <span class="string">&#x27;70&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">75</span>_Orders (product_id, order_date, unit) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2020-01-18&#x27;</span>, <span class="string">&#x27;30&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">75</span>_Orders (product_id, order_date, unit) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2020-02-11&#x27;</span>, <span class="string">&#x27;80&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">75</span>_Orders (product_id, order_date, unit) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2020-02-17&#x27;</span>, <span class="string">&#x27;2&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">75</span>_Orders (product_id, order_date, unit) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2020-02-24&#x27;</span>, <span class="string">&#x27;3&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">75</span>_Orders (product_id, order_date, unit) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;2020-03-01&#x27;</span>, <span class="string">&#x27;20&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">75</span>_Orders (product_id, order_date, unit) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;2020-03-04&#x27;</span>, <span class="string">&#x27;30&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">75</span>_Orders (product_id, order_date, unit) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;2020-03-04&#x27;</span>, <span class="string">&#x27;60&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">75</span>_Orders (product_id, order_date, unit) <span class="keyword">values</span> (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;2020-02-25&#x27;</span>, <span class="string">&#x27;50&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">75</span>_Orders (product_id, order_date, unit) <span class="keyword">values</span> (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;2020-02-27&#x27;</span>, <span class="string">&#x27;50&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">75</span>_Orders (product_id, order_date, unit) <span class="keyword">values</span> (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;2020-03-01&#x27;</span>, <span class="string">&#x27;50&#x27;</span>);</span><br></pre></td></tr></table></figure>



<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">    p.product_name,</span><br><span class="line">    <span class="built_in">sum</span>(o.unit) <span class="keyword">as</span> unit</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    <span class="number">75</span>_Products p</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">    <span class="number">75</span>_Orders o </span><br><span class="line"><span class="keyword">on</span></span><br><span class="line">    p.product_id<span class="operator">=</span>o.product_id</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    order_date <span class="keyword">between</span> <span class="string">&#x27;2020-02-01&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2020-02-29&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">    p.product_name</span><br><span class="line"><span class="keyword">having</span></span><br><span class="line">    <span class="built_in">sum</span>(o.unit)<span class="operator">&gt;=</span><span class="number">100</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">    <span class="built_in">sum</span>(o.unit);</span><br><span class="line">    </span><br><span class="line"><span class="comment">-- 方法二 </span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">     product_name, </span><br><span class="line">     <span class="built_in">SUM</span>(unit) <span class="keyword">AS</span> unit</span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">     <span class="number">75</span>_Products </span><br><span class="line"><span class="keyword">JOIN</span> </span><br><span class="line">     <span class="number">75</span>_Orders <span class="keyword">USING</span> (product_id)</span><br><span class="line"><span class="keyword">WHERE</span> </span><br><span class="line">     order_date <span class="keyword">LIKE</span> &quot;2020-02%&quot;</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">     product_name</span><br><span class="line"><span class="keyword">HAVING</span></span><br><span class="line">     unit <span class="operator">&gt;=</span> <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法三</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">     T.product_name,</span><br><span class="line">     T.unit</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    (<span class="keyword">select</span></span><br><span class="line">          p.product_name,</span><br><span class="line">          <span class="built_in">sum</span>(unit) <span class="keyword">as</span> unit</span><br><span class="line">     <span class="keyword">from</span></span><br><span class="line">          <span class="number">75</span>_Orders o</span><br><span class="line">     <span class="keyword">join</span></span><br><span class="line">          <span class="number">75</span>_Products p</span><br><span class="line">     <span class="keyword">on</span> </span><br><span class="line">          o.product_id <span class="operator">=</span> p.product_id</span><br><span class="line">     <span class="keyword">where</span></span><br><span class="line">         order_date <span class="keyword">like</span> &quot;2020-02%&quot;</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">         p.product_id</span><br><span class="line">    ) <span class="keyword">as</span> T</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    T.unit<span class="operator">&gt;=</span> <span class="number">100</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="76-每次访问的交易次数"><a href="#76-每次访问的交易次数" class="headerlink" title="76. 每次访问的交易次数"></a>76. 每次访问的交易次数</h2><p>写一条 SQL 查询多少客户访问了银行但没有进行任何交易，多少客户访问了银行进行了一次交易等等</p>
<p>结果包含两列：</p>
<ul>
<li><code>transactions_count：</code> 客户在一次访问中的交易次数</li>
<li><code>visits_count：</code> 在 <code>transactions_count</code> 交易次数下相应的一次访问时的客户数量</li>
</ul>
<p>展示效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">+--------------------+--------------+</span><br><span class="line">| transactions_count | visits_count |</span><br><span class="line">+--------------------+--------------+</span><br><span class="line">| 0                  | 4            |</span><br><span class="line">| 1                  | 5            |</span><br><span class="line">| 2                  | 0            |</span><br><span class="line">| 3                  | 1            |</span><br><span class="line">+--------------------+--------------+</span><br></pre></td></tr></table></figure>

<p>提示：</p>
<ul>
<li>对于 transactions_count = 0, visits 中 (1, “2020-01-01”), (2, “2020-01-02”), (12, “2020-01-01”) 和 (19, “2020-01-03”) 没有进行交易，所以 visits_count = 4 。</li>
<li>对于 transactions_count = 1, visits 中 (2, “2020-01-03”), (7, “2020-01-11”), (8, “2020-01-28”), (1, “2020-01-02”) 和 (1, “2020-01-04”) 进行了一次交易，所以 visits_count = 5 。</li>
<li>对于 transactions_count = 2, 没有客户访问银行进行了两次交易，所以 visits_count = 0 。</li>
<li>对于 transactions_count = 3, visits 中 (9, “2020-01-25”) 进行了三次交易，所以 visits_count = 1 。</li>
<li>对于 transactions_count &gt;= 4, 没有客户访问银行进行了超过3次交易，所以我们停止在 transactions_count = 3 。</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">76</span>_Visits (user_id <span class="type">int</span>, visit_date <span class="type">date</span>);</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">76</span>_Transactions (user_id <span class="type">int</span>, transaction_date <span class="type">date</span>, amount <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">76</span>_Visits;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">76</span>_Visits (user_id, visit_date) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2020-01-01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">76</span>_Visits (user_id, visit_date) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2020-01-02&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">76</span>_Visits (user_id, visit_date) <span class="keyword">values</span> (<span class="string">&#x27;12&#x27;</span>, <span class="string">&#x27;2020-01-01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">76</span>_Visits (user_id, visit_date) <span class="keyword">values</span> (<span class="string">&#x27;19&#x27;</span>, <span class="string">&#x27;2020-01-03&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">76</span>_Visits (user_id, visit_date) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2020-01-02&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">76</span>_Visits (user_id, visit_date) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2020-01-03&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">76</span>_Visits (user_id, visit_date) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2020-01-04&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">76</span>_Visits (user_id, visit_date) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;2020-01-11&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">76</span>_Visits (user_id, visit_date) <span class="keyword">values</span> (<span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;2020-01-25&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">76</span>_Visits (user_id, visit_date) <span class="keyword">values</span> (<span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;2020-01-28&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">76</span>_Transactions;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">76</span>_Transactions (user_id, transaction_date, amount) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2020-01-02&#x27;</span>, <span class="string">&#x27;120&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">76</span>_Transactions (user_id, transaction_date, amount) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2020-01-03&#x27;</span>, <span class="string">&#x27;22&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">76</span>_Transactions (user_id, transaction_date, amount) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;2020-01-11&#x27;</span>, <span class="string">&#x27;232&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">76</span>_Transactions (user_id, transaction_date, amount) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2020-01-04&#x27;</span>, <span class="string">&#x27;7&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">76</span>_Transactions (user_id, transaction_date, amount) <span class="keyword">values</span> (<span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;2020-01-25&#x27;</span>, <span class="string">&#x27;33&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">76</span>_Transactions (user_id, transaction_date, amount) <span class="keyword">values</span> (<span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;2020-01-25&#x27;</span>, <span class="string">&#x27;66&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">76</span>_Transactions (user_id, transaction_date, amount) <span class="keyword">values</span> (<span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;2020-01-28&#x27;</span>, <span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">76</span>_Transactions (user_id, transaction_date, amount) <span class="keyword">values</span> (<span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;2020-01-25&#x27;</span>, <span class="string">&#x27;99&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">     tmp.user_visits_num transactions_count,</span><br><span class="line">     <span class="built_in">count</span>(<span class="number">1</span>) visits_count</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    (<span class="keyword">select</span> </span><br><span class="line">          <span class="built_in">sum</span>(if(amount <span class="keyword">is</span> <span class="keyword">null</span>, <span class="number">0</span>, <span class="number">1</span>)) user_visits_num</span><br><span class="line">     <span class="keyword">from</span> </span><br><span class="line">          <span class="number">76</span>_Visits v1</span><br><span class="line">     <span class="keyword">left</span> <span class="keyword">join</span> </span><br><span class="line">          <span class="number">76</span>_Transactions t1</span><br><span class="line">     <span class="keyword">on</span> </span><br><span class="line">          v1.user_id <span class="operator">=</span> t1.user_id </span><br><span class="line">          <span class="keyword">and</span></span><br><span class="line">          v1.visit_date <span class="operator">=</span> t1.transaction_date</span><br><span class="line">     <span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">          v1.user_id, v1.visit_date</span><br><span class="line">    ) tmp</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> tmp.user_visits_num;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法二</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">     <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">     (<span class="keyword">SELECT</span></span><br><span class="line">            t5.rnb <span class="keyword">AS</span> transactions_count,</span><br><span class="line">            IFNULL(visits_count, <span class="number">0</span>) <span class="keyword">AS</span> visits_count</span><br><span class="line">      <span class="keyword">FROM</span></span><br><span class="line">           (<span class="keyword">SELECT</span></span><br><span class="line">                 <span class="number">0</span> <span class="keyword">AS</span> rnb</span><br><span class="line">            <span class="keyword">UNION</span></span><br><span class="line">            <span class="keyword">SELECT</span></span><br><span class="line">                 <span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span> () <span class="keyword">AS</span> rnb</span><br><span class="line">            <span class="keyword">FROM</span></span><br><span class="line">                 <span class="number">76</span>_Transactions</span><br><span class="line">            ) t5</span><br><span class="line">      <span class="keyword">LEFT</span> <span class="keyword">JOIN</span></span><br><span class="line">           (<span class="keyword">SELECT</span></span><br><span class="line">                 cnt <span class="keyword">AS</span> transactions_count,</span><br><span class="line">                 <span class="built_in">COUNT</span>(user_id) <span class="keyword">AS</span> visits_count</span><br><span class="line">            <span class="keyword">FROM</span></span><br><span class="line">                (<span class="keyword">SELECT</span></span><br><span class="line">                      t1.user_id, </span><br><span class="line">                      <span class="built_in">COUNT</span>(t2.amount) <span class="keyword">AS</span> cnt</span><br><span class="line">                 <span class="keyword">FROM</span></span><br><span class="line">                      <span class="number">76</span>_Visits t1</span><br><span class="line">                 <span class="keyword">LEFT</span> <span class="keyword">JOIN</span></span><br><span class="line">                      <span class="number">76</span>_Transactions t2</span><br><span class="line">                 <span class="keyword">ON</span> </span><br><span class="line">                      t1.user_id <span class="operator">=</span> t2.user_id</span><br><span class="line">                      <span class="keyword">AND</span></span><br><span class="line">                      t1.visit_date <span class="operator">=</span> t2.transaction_date</span><br><span class="line">                 <span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">                      user_id, </span><br><span class="line">                      visit_date ) t3</span><br><span class="line">             <span class="keyword">GROUP</span> <span class="keyword">BY</span> cnt ) t4</span><br><span class="line">       <span class="keyword">ON</span> t5.rnb <span class="operator">=</span> t4.transactions_count) t6</span><br><span class="line"><span class="keyword">WHERE</span> transactions_count <span class="operator">&lt;=</span> (<span class="keyword">SELECT</span></span><br><span class="line">                                   <span class="built_in">COUNT</span>(t2.amount) <span class="keyword">AS</span> cnt</span><br><span class="line">                              <span class="keyword">FROM</span> </span><br><span class="line">                                   <span class="number">76</span>_Visits t1</span><br><span class="line">                              <span class="keyword">LEFT</span> <span class="keyword">JOIN</span></span><br><span class="line">                                   <span class="number">76</span>_Transactions t2</span><br><span class="line">                              <span class="keyword">ON</span></span><br><span class="line">                                   t1.user_id <span class="operator">=</span> t2.user_id</span><br><span class="line">                                   <span class="keyword">AND</span></span><br><span class="line">                                   t1.visit_date <span class="operator">=</span> t2.transaction_date</span><br><span class="line">                              <span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">                                   t1.user_id, visit_date</span><br><span class="line">                              <span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">                                   cnt <span class="keyword">DESC</span></span><br><span class="line">                              LIMIT <span class="number">1</span>);</span><br></pre></td></tr></table></figure>



<h2 id="77-电影评分"><a href="#77-电影评分" class="headerlink" title="77. 电影评分"></a>77. 电影评分</h2><p>请你编写一组 SQL 查询：查找评论电影数量最多的用户名，如果出现平局，返回字典序较小的用户名。查找在2020 年 2 月 平均评分最高的电影名称，如果出现平局，返回字典序较小的电影名称。</p>
<p>展示效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">+--------------+</span><br><span class="line">| results      |</span><br><span class="line">+--------------+</span><br><span class="line">| Daniel       |</span><br><span class="line">| Frozen 2     |</span><br><span class="line">+--------------+</span><br></pre></td></tr></table></figure>

<p>建表语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">77</span>_Movies (movie_id <span class="type">int</span>, title <span class="type">varchar</span>(<span class="number">30</span>));</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">77</span>_Users (user_id <span class="type">int</span>, name <span class="type">varchar</span>(<span class="number">30</span>));</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">77</span>_Movie_Rating (movie_id <span class="type">int</span>, user_id <span class="type">int</span>, rating <span class="type">int</span>, created_at <span class="type">date</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">77</span>_Movies;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">77</span>_Movies (movie_id, title) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Avengers&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">77</span>_Movies (movie_id, title) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;Frozen 2&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">77</span>_Movies (movie_id, title) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;Joker&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">77</span>_Users;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">77</span>_Users (user_id, name) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Daniel&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">77</span>_Users (user_id, name) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;Monica&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">77</span>_Users (user_id, name) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;Maria&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">77</span>_Users (user_id, name) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;James&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">77</span>_Movie_Rating;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">77</span>_Movie_Rating (movie_id, user_id, rating, created_at) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2020-01-12&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">77</span>_Movie_Rating (movie_id, user_id, rating, created_at) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;2020-02-11&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">77</span>_Movie_Rating (movie_id, user_id, rating, created_at) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2020-02-12&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">77</span>_Movie_Rating (movie_id, user_id, rating, created_at) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2020-01-01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">77</span>_Movie_Rating (movie_id, user_id, rating, created_at) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;2020-02-17&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">77</span>_Movie_Rating (movie_id, user_id, rating, created_at) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2020-02-01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">77</span>_Movie_Rating (movie_id, user_id, rating, created_at) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2020-03-01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">77</span>_Movie_Rating (movie_id, user_id, rating, created_at) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2020-02-22&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">77</span>_Movie_Rating (movie_id, user_id, rating, created_at) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;2020-02-25&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">     name results </span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    (<span class="keyword">select</span></span><br><span class="line">          m.user_id,</span><br><span class="line">          u.name </span><br><span class="line">    <span class="keyword">from</span></span><br><span class="line">          <span class="number">77</span>_Movie_Rating m </span><br><span class="line">    <span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">          <span class="number">77</span>_Users u </span><br><span class="line">    <span class="keyword">on</span></span><br><span class="line">          m.user_id <span class="operator">=</span> u.user_id</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">          user_id</span><br><span class="line">    <span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">          <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">desc</span>,name</span><br><span class="line">    limit <span class="number">1</span>)t1</span><br><span class="line">    </span><br><span class="line"><span class="keyword">union</span> </span><br><span class="line">    (<span class="keyword">select</span></span><br><span class="line">          title results</span><br><span class="line">     <span class="keyword">from</span> </span><br><span class="line">          <span class="number">77</span>_Movie_Rating r </span><br><span class="line">     <span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">          <span class="number">77</span>_Movies m</span><br><span class="line">     <span class="keyword">on</span></span><br><span class="line">          r.movie_id <span class="operator">=</span>m.movie_id </span><br><span class="line">     <span class="keyword">where</span></span><br><span class="line">         date_format(created_at,<span class="string">&#x27;%Y-%m&#x27;</span>)<span class="operator">=</span><span class="string">&#x27;2020-02&#x27;</span></span><br><span class="line">     <span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">         r.movie_id</span><br><span class="line">     <span class="keyword">order</span> <span class="keyword">by</span> </span><br><span class="line">         <span class="built_in">avg</span>(rating) <span class="keyword">desc</span>,title </span><br><span class="line">     limit <span class="number">1</span>);</span><br></pre></td></tr></table></figure>



<h2 id="78-院系无效的学生"><a href="#78-院系无效的学生" class="headerlink" title="78. 院系无效的学生"></a>78. 院系无效的学生</h2><p>写一条 SQL 语句以查询那些所在院系不存在的学生的 id 和姓名，可以以任何顺序返回结果</p>
<p>展示效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">+------+----------+</span><br><span class="line">| id   | name     |</span><br><span class="line">+------+----------+</span><br><span class="line">| 2    | John     |</span><br><span class="line">| 7    | Daiana   |</span><br><span class="line">| 4    | Jasmine  |</span><br><span class="line">| 3    | Steve    |</span><br><span class="line">+------+----------+</span><br></pre></td></tr></table></figure>

<p>建表语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">78</span>_Departments (id <span class="type">int</span>, name <span class="type">varchar</span>(<span class="number">30</span>));</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">78</span>_Students (id <span class="type">int</span>, name <span class="type">varchar</span>(<span class="number">30</span>), department_id <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">78</span>_Departments;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">78</span>_Departments (id, name) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Electrical Engineering&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">78</span>_Departments (id, name) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;Computer Engineering&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">78</span>_Departments (id, name) <span class="keyword">values</span> (<span class="string">&#x27;13&#x27;</span>, <span class="string">&#x27;Bussiness Administration&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">78</span>_Students;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">78</span>_Students (id, name, department_id) <span class="keyword">values</span> (<span class="string">&#x27;23&#x27;</span>, <span class="string">&#x27;Alice&#x27;</span>, <span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">78</span>_Students (id, name, department_id) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Bob&#x27;</span>, <span class="string">&#x27;7&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">78</span>_Students (id, name, department_id) <span class="keyword">values</span> (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;Jennifer&#x27;</span>, <span class="string">&#x27;13&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">78</span>_Students (id, name, department_id) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;John&#x27;</span>, <span class="string">&#x27;14&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">78</span>_Students (id, name, department_id) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;Jasmine&#x27;</span>, <span class="string">&#x27;77&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">78</span>_Students (id, name, department_id) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;Steve&#x27;</span>, <span class="string">&#x27;74&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">78</span>_Students (id, name, department_id) <span class="keyword">values</span> (<span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;Luis&#x27;</span>, <span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">78</span>_Students (id, name, department_id) <span class="keyword">values</span> (<span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;Jonathan&#x27;</span>, <span class="string">&#x27;7&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">78</span>_Students (id, name, department_id) <span class="keyword">values</span> (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;Daiana&#x27;</span>, <span class="string">&#x27;33&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">78</span>_Students (id, name, department_id) <span class="keyword">values</span> (<span class="string">&#x27;11&#x27;</span>, <span class="string">&#x27;Madelynn&#x27;</span>, <span class="string">&#x27;1&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">     id,</span><br><span class="line">     name  </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">     <span class="number">78</span>_Students </span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">     department_id <span class="keyword">not</span> <span class="keyword">in</span> (<span class="keyword">select</span> id <span class="keyword">from</span> <span class="number">78</span>_Departments)</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">     id <span class="keyword">asc</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法二</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">     s.id,</span><br><span class="line">     s.name</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">     <span class="number">78</span>_students s </span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> </span><br><span class="line">     <span class="number">78</span>_Departments d</span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">     s.department_id<span class="operator">=</span>d.id</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">     d.id <span class="keyword">is</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="79-活动参与者"><a href="#79-活动参与者" class="headerlink" title="79. 活动参与者"></a>79. 活动参与者</h2><p>写一条 SQL 查询那些既没有最多，也没有最少参与者的活动的名字，可以以任何顺序返回结果，Activities 表的每项活动的参与者都来自 Friends 表</p>
<p>展示效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+--------------+</span><br><span class="line">| activity     |</span><br><span class="line">+--------------+</span><br><span class="line">| Singing      |</span><br><span class="line">+--------------+</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">79</span>_Friends (id <span class="type">int</span>, name <span class="type">varchar</span>(<span class="number">30</span>), activity <span class="type">varchar</span>(<span class="number">30</span>));</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">79</span>_Activities (id <span class="type">int</span>, name <span class="type">varchar</span>(<span class="number">30</span>));</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">79</span>_Friends;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">79</span>_Friends (id, name, activity) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Jonathan D.&#x27;</span>, <span class="string">&#x27;Eating&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">79</span>_Friends (id, name, activity) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;Jade W.&#x27;</span>, <span class="string">&#x27;Singing&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">79</span>_Friends (id, name, activity) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;Victor J.&#x27;</span>, <span class="string">&#x27;Singing&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">79</span>_Friends (id, name, activity) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;Elvis Q.&#x27;</span>, <span class="string">&#x27;Eating&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">79</span>_Friends (id, name, activity) <span class="keyword">values</span> (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;Daniel A.&#x27;</span>, <span class="string">&#x27;Eating&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">79</span>_Friends (id, name, activity) <span class="keyword">values</span> (<span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;Bob B.&#x27;</span>, <span class="string">&#x27;Horse Riding&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">79</span>_Activities;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">79</span>_Activities (id, name) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Eating&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">79</span>_Activities (id, name) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;Singing&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">79</span>_Activities (id, name) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;Horse Riding&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>提示：</p>
<p>​    Eating 活动有三个人参加, 是最多人参加的活动 (Jonathan D. , Elvis Q. and Daniel A.)</p>
<p>​    Horse Riding 活动有一个人参加, 是最少人参加的活动 (Bob B.)</p>
<p>​    Singing 活动有两个人参加 (Victor J. and Jade W.)</p>
<p>最终SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">     activity <span class="keyword">as</span> ACTIVITY</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">     <span class="number">79</span>_friends</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">     activity</span><br><span class="line"><span class="keyword">having</span></span><br><span class="line">     <span class="built_in">count</span>(<span class="operator">*</span>) <span class="operator">&gt;</span> <span class="keyword">any</span>(<span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> <span class="number">79</span>_friends <span class="keyword">group</span> <span class="keyword">by</span> activity)</span><br><span class="line">     <span class="keyword">and</span></span><br><span class="line">     <span class="built_in">count</span>(<span class="operator">*</span>) <span class="operator">&lt;</span> <span class="keyword">any</span> (<span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> <span class="number">79</span>_friends <span class="keyword">group</span> <span class="keyword">by</span> activity);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法二</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">     activity</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">     <span class="number">79</span>_Friends</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">having</span> </span><br><span class="line">     <span class="built_in">count</span>(<span class="keyword">distinct</span> id) <span class="operator">&gt;</span> <span class="keyword">some</span>(<span class="keyword">select</span> <span class="built_in">count</span>(<span class="keyword">distinct</span> id) <span class="keyword">from</span> <span class="number">79</span>_Friends <span class="keyword">group</span> <span class="keyword">by</span> activity)</span><br><span class="line">     <span class="keyword">and</span></span><br><span class="line">     <span class="built_in">count</span>(<span class="keyword">distinct</span> id) <span class="operator">&lt;</span> <span class="keyword">some</span>(<span class="keyword">select</span> <span class="built_in">count</span>(<span class="keyword">distinct</span> id) <span class="keyword">from</span> <span class="number">79</span>_Friends <span class="keyword">group</span> <span class="keyword">by</span> activity);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法三</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">     tempAct.activity <span class="keyword">AS</span> <span class="string">&#x27;ACTIVITY&#x27;</span></span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">    (<span class="keyword">SELECT</span></span><br><span class="line">          activity,</span><br><span class="line">          <span class="built_in">COUNT</span>(id) <span class="keyword">AS</span> theTimes</span><br><span class="line">     <span class="keyword">FROM</span></span><br><span class="line">          <span class="number">79</span>_Friends </span><br><span class="line">     <span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">          activity </span><br><span class="line">     <span class="keyword">HAVING</span> </span><br><span class="line">          theTimes <span class="keyword">NOT</span> <span class="keyword">IN</span> (</span><br><span class="line">            (<span class="keyword">SELECT</span> <span class="built_in">MAX</span>(tMax.countTimes) <span class="keyword">AS</span> maxCount </span><br><span class="line">             <span class="keyword">FROM</span> </span><br><span class="line">                (<span class="keyword">SELECT</span> activity, <span class="built_in">COUNT</span>(id) <span class="keyword">AS</span> countTimes</span><br><span class="line">                 <span class="keyword">FROM</span> <span class="number">79</span>_Friends </span><br><span class="line">                 <span class="keyword">GROUP</span> <span class="keyword">BY</span> activity)<span class="keyword">AS</span> tMax),</span><br><span class="line">            (<span class="keyword">SELECT</span> <span class="built_in">MIN</span>(tMin.countTimes) <span class="keyword">AS</span> minCount </span><br><span class="line">             <span class="keyword">FROM</span> </span><br><span class="line">                (<span class="keyword">SELECT</span> activity, <span class="built_in">COUNT</span>(id) <span class="keyword">AS</span> countTimes</span><br><span class="line">                 <span class="keyword">FROM</span> <span class="number">79</span>_Friends </span><br><span class="line">                 <span class="keyword">GROUP</span> <span class="keyword">BY</span> activity)<span class="keyword">AS</span> tMin))</span><br><span class="line">    ) <span class="keyword">AS</span> tempAct</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法四</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">     activity</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    (<span class="keyword">select</span></span><br><span class="line">          activity,</span><br><span class="line">          <span class="built_in">rank</span>()<span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> cnt) rk1,</span><br><span class="line">          <span class="built_in">rank</span>()<span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> cnt <span class="keyword">desc</span>) rk2</span><br><span class="line">     <span class="keyword">from</span></span><br><span class="line">         (<span class="keyword">select</span></span><br><span class="line">               activity,</span><br><span class="line">               <span class="built_in">count</span>(<span class="operator">*</span>) cnt</span><br><span class="line">          <span class="keyword">from</span> </span><br><span class="line">               <span class="number">79</span>_Friends</span><br><span class="line">          <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">               activity )t1</span><br><span class="line">    )t2</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">    rk1 <span class="operator">!=</span> <span class="number">1</span> <span class="keyword">and</span> rk2 <span class="operator">!=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>提示： </p>
<p>​         1.any关键词可以理解为“对于子查询返回的列中的任一数值，如果比较结果为true，则返回true。 </p>
<p>​         2.all的意思是“对于子查询返回的列中的所有值，如果比较结果为true，则返回true” </p>
<pre><code>     3.any 和some 具有同等含义，用法也一致。
</code></pre>
<h2 id="80-顾客的可信联系人数量"><a href="#80-顾客的可信联系人数量" class="headerlink" title="80. 顾客的可信联系人数量"></a>80. 顾客的可信联系人数量</h2><p>为每张发票 <code>invoice_id</code> 编写一个SQL查询以查找以下内容：</p>
<ul>
<li><code>customer_name</code>：与发票相关的顾客名称。</li>
<li><code>price</code>：发票的价格。</li>
<li><code>contacts_cnt</code>：该顾客的联系人数量。</li>
<li><code>trusted_contacts_cnt</code>：可信联系人的数量：既是该顾客的联系人又是商店顾客的联系人数量（即：可信联系人的电子邮件存在于客户表中）。</li>
</ul>
<p>将查询的结果按照 <code>invoice_id</code> 排序。</p>
<p>展示效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">+------------+---------------+-------+--------------+----------------------+</span><br><span class="line">| invoice_id | customer_name | price | contacts_cnt | trusted_contacts_cnt |</span><br><span class="line">+------------+---------------+-------+--------------+----------------------+</span><br><span class="line">| 44         | Alex          | 60    | 1            | 1                    |</span><br><span class="line">| 55         | John          | 500   | 0            | 0                    |</span><br><span class="line">| 66         | Bob           | 400   | 2            | 0                    |</span><br><span class="line">| 77         | Alice         | 100   | 3            | 2                    |</span><br><span class="line">| 88         | Alice         | 200   | 3            | 2                    |</span><br><span class="line">| 99         | Bob           | 300   | 2            | 0                    |</span><br><span class="line">+------------+---------------+-------+--------------+----------------------+</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">80</span>_Customers (customer_id <span class="type">int</span>, customer_name <span class="type">varchar</span>(<span class="number">20</span>), email <span class="type">varchar</span>(<span class="number">30</span>));</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">80</span>_Contacts (user_id <span class="type">int</span>, contact_name <span class="type">varchar</span>(<span class="number">20</span>), contact_email <span class="type">varchar</span>(<span class="number">30</span>));</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">80</span>_80_Invoices (invoice_id <span class="type">int</span>, price <span class="type">int</span>, user_id <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">80</span>_Customers;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">80</span>_Customers (customer_id, customer_name, email) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Alice&#x27;</span>, <span class="string">&#x27;alice@leetcode.com&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">80</span>_Customers (customer_id, customer_name, email) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;Bob&#x27;</span>, <span class="string">&#x27;bob@leetcode.com&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">80</span>_Customers (customer_id, customer_name, email) <span class="keyword">values</span> (<span class="string">&#x27;13&#x27;</span>, <span class="string">&#x27;John&#x27;</span>, <span class="string">&#x27;john@leetcode.com&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">80</span>_Customers (customer_id, customer_name, email) <span class="keyword">values</span> (<span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;Alex&#x27;</span>, <span class="string">&#x27;alex@leetcode.com&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">80</span>_Contacts;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">80</span>_Contacts (user_id, contact_name, contact_email) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Bob&#x27;</span>, <span class="string">&#x27;bob@leetcode.com&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">80</span>_Contacts (user_id, contact_name, contact_email) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;John&#x27;</span>, <span class="string">&#x27;john@leetcode.com&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">80</span>_Contacts (user_id, contact_name, contact_email) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Jal&#x27;</span>, <span class="string">&#x27;jal@leetcode.com&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">80</span>_Contacts (user_id, contact_name, contact_email) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;Omar&#x27;</span>, <span class="string">&#x27;omar@leetcode.com&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">80</span>_Contacts (user_id, contact_name, contact_email) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;Meir&#x27;</span>, <span class="string">&#x27;meir@leetcode.com&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">80</span>_Contacts (user_id, contact_name, contact_email) <span class="keyword">values</span> (<span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;Alice&#x27;</span>, <span class="string">&#x27;alice@leetcode.com&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">80</span>_Invoices;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">80</span>_Invoices (invoice_id, price, user_id) <span class="keyword">values</span> (<span class="string">&#x27;77&#x27;</span>, <span class="string">&#x27;100&#x27;</span>, <span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">80</span>_Invoices (invoice_id, price, user_id) <span class="keyword">values</span> (<span class="string">&#x27;88&#x27;</span>, <span class="string">&#x27;200&#x27;</span>, <span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">80</span>_Invoices (invoice_id, price, user_id) <span class="keyword">values</span> (<span class="string">&#x27;99&#x27;</span>, <span class="string">&#x27;300&#x27;</span>, <span class="string">&#x27;2&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">80</span>_Invoices (invoice_id, price, user_id) <span class="keyword">values</span> (<span class="string">&#x27;66&#x27;</span>, <span class="string">&#x27;400&#x27;</span>, <span class="string">&#x27;2&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">80</span>_Invoices (invoice_id, price, user_id) <span class="keyword">values</span> (<span class="string">&#x27;55&#x27;</span>, <span class="string">&#x27;500&#x27;</span>, <span class="string">&#x27;13&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">80</span>_Invoices (invoice_id, price, user_id) <span class="keyword">values</span> (<span class="string">&#x27;44&#x27;</span>, <span class="string">&#x27;60&#x27;</span>, <span class="string">&#x27;6&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">     invoice_id, </span><br><span class="line">     customer_name,</span><br><span class="line">     price,</span><br><span class="line">     ifnull(cnt,<span class="number">0</span>) contacts_cnt,</span><br><span class="line">     ifnull(bc,<span class="number">0</span>) trusted_contacts_cnt </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">     <span class="number">80</span>_Invoices i</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">     (<span class="keyword">select</span></span><br><span class="line">           user_id, </span><br><span class="line">           <span class="built_in">count</span>(<span class="operator">*</span>) cnt</span><br><span class="line">      <span class="keyword">from</span></span><br><span class="line">           <span class="number">80</span>_Contacts</span><br><span class="line">      <span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">           user_id ) t1</span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">      i.user_id<span class="operator">=</span>t1.user_id</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">     (<span class="keyword">select</span></span><br><span class="line">            user_id, </span><br><span class="line">            <span class="built_in">count</span>(<span class="operator">*</span>) bc</span><br><span class="line">      <span class="keyword">from</span> </span><br><span class="line">            <span class="number">80</span>_Contacts</span><br><span class="line">      <span class="keyword">where</span> </span><br><span class="line">            contact_name <span class="keyword">in</span>(<span class="keyword">select</span> customer_name <span class="keyword">from</span> <span class="number">80</span>_Customers )</span><br><span class="line">      <span class="keyword">group</span> <span class="keyword">by</span> user_id )t2</span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">      i.user_id <span class="operator">=</span> t2.user_id</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> </span><br><span class="line">      <span class="number">80</span>_Customers c</span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">      i.user_id<span class="operator">=</span> c.customer_id</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> </span><br><span class="line">      invoice_id;</span><br></pre></td></tr></table></figure>


    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/03/11/hello-world/" rel="prev" title="Hello World">
                  <i class="fa fa-chevron-left"></i> Hello World
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2021/03/11/81-100/" rel="next" title="">
                   <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>







<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">hefei</span>
</div>
  <div class="powered-by">تطبيق الموقع <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
