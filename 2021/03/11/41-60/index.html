<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.loli.net/css?family=Noto+Serif+SC:300,300italic,400,400italic,700,700italic%7CMa+Shan+Zheng:300,300italic,400,400italic,700,700italic%7CJetBrains+Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.2/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"hf7751.gitee.io","root":"/","images":"/images","scheme":"Muse","version":"8.2.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"بحث...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}};
  </script>
<meta name="description" content="41. 买下所有产品的用户需求：编写一个 SQL 查询，从 Customer 表中查询购买了 Product 表中所有产品的客户的 id。 展示效果：    customer_id    1   3   1234567891011Create table If Not Exists 41_Customer (customer_id int, product_key int);Create tabl">
<meta property="og:type" content="article">
<meta property="og:title" content="元">
<meta property="og:url" content="https://hf7751.gitee.io/2021/03/11/41-60/index.html">
<meta property="og:site_name" content="元">
<meta property="og:description" content="41. 买下所有产品的用户需求：编写一个 SQL 查询，从 Customer 表中查询购买了 Product 表中所有产品的客户的 id。 展示效果：    customer_id    1   3   1234567891011Create table If Not Exists 41_Customer (customer_id int, product_key int);Create tabl">
<meta property="og:locale">
<meta property="article:published_time" content="2021-03-10T18:36:18.677Z">
<meta property="article:modified_time" content="2021-03-04T07:48:04.728Z">
<meta property="article:author" content="hefei">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://hf7751.gitee.io/2021/03/11/41-60/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-Hans'
  };
</script>
<title> | 元</title>
  




  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="تشغيل شريط التصفح" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">元</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          المحتويات
        </li>
        <li class="sidebar-nav-overview">
          عام
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#41-%E4%B9%B0%E4%B8%8B%E6%89%80%E6%9C%89%E4%BA%A7%E5%93%81%E7%9A%84%E7%94%A8%E6%88%B7"><span class="nav-number">1.</span> <span class="nav-text">41. 买下所有产品的用户</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#42-%E5%90%88%E4%BD%9C%E8%BF%87%E8%87%B3%E5%B0%91%E4%B8%89%E6%AC%A1%E7%9A%84%E6%BC%94%E5%91%98%E5%92%8C%E5%AF%BC%E6%BC%94"><span class="nav-number">2.</span> <span class="nav-text">42. 合作过至少三次的演员和导演</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#43-%E4%BA%A7%E5%93%81%E9%94%80%E5%94%AE%E5%88%86%E6%9E%90"><span class="nav-number">3.</span> <span class="nav-text">43. 产品销售分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#44-%E9%A1%B9%E7%9B%AE%E5%91%98%E5%B7%A5"><span class="nav-number">4.</span> <span class="nav-text">44. 项目员工</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#45-%E9%94%80%E5%94%AE%E5%88%86%E6%9E%90"><span class="nav-number">5.</span> <span class="nav-text">45. 销售分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#46-%E5%B0%8F%E4%BC%97%E4%B9%A6%E7%B1%8D"><span class="nav-number">6.</span> <span class="nav-text">46. 小众书籍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#47-%E6%AF%8F%E6%97%A5%E6%96%B0%E7%94%A8%E6%88%B7%E7%BB%9F%E8%AE%A1"><span class="nav-number">7.</span> <span class="nav-text">47. 每日新用户统计</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#48-%E6%AF%8F%E4%BD%8D%E5%AD%A6%E7%94%9F%E7%9A%84%E6%9C%80%E9%AB%98%E6%88%90%E7%BB%A9"><span class="nav-number">8.</span> <span class="nav-text">48. 每位学生的最高成绩</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#49-%E4%B8%BE%E6%8A%A5%E8%AE%B0%E5%BD%95"><span class="nav-number">9.</span> <span class="nav-text">49. 举报记录</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#50-%E6%9F%A5%E8%AF%A2%E6%B4%BB%E8%B7%83%E4%B8%9A%E5%8A%A1"><span class="nav-number">10.</span> <span class="nav-text">50. 查询活跃业务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#51-%E7%94%A8%E6%88%B7%E8%B4%AD%E4%B9%B0%E5%B9%B3%E5%8F%B0"><span class="nav-number">11.</span> <span class="nav-text">51. 用户购买平台</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#52-%E6%9F%A5%E8%AF%A2%E8%BF%9130%E5%A4%A9%E6%B4%BB%E8%B7%83%E7%94%A8%E6%88%B7"><span class="nav-number">12.</span> <span class="nav-text">52. 查询近30天活跃用户</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#53-%E6%96%87%E7%AB%A0%E6%B5%8F%E8%A7%88"><span class="nav-number">13.</span> <span class="nav-text">53. 文章浏览</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#54-%E5%B8%82%E5%9C%BA%E5%88%86%E6%9E%90"><span class="nav-number">14.</span> <span class="nav-text">54. 市场分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#55-%E6%8C%87%E5%AE%9A%E6%97%A5%E6%9C%9F%E4%BA%A7%E5%93%81%E4%BB%B7%E6%A0%BC"><span class="nav-number">15.</span> <span class="nav-text">55. 指定日期产品价格</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#56-%E5%8D%B3%E6%97%B6%E9%A3%9F%E7%89%A9%E9%85%8D%E9%80%81"><span class="nav-number">16.</span> <span class="nav-text">56. 即时食物配送</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#57-%E9%87%8D%E6%96%B0%E6%A0%BC%E5%BC%8F%E5%8C%96%E9%83%A8%E9%97%A8%E8%A1%A8"><span class="nav-number">17.</span> <span class="nav-text">57. 重新格式化部门表</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#58-%E6%AF%8F%E6%9C%88%E4%BA%A4%E6%98%93"><span class="nav-number">18.</span> <span class="nav-text">58. 每月交易</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#59-%E9%94%A6%E6%A0%87%E8%B5%9B%E4%BC%98%E8%83%9C%E8%80%85"><span class="nav-number">19.</span> <span class="nav-text">59. 锦标赛优胜者</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#60-%E6%9C%80%E5%90%8E%E4%B8%80%E4%B8%AA%E8%83%BD%E8%BF%9B%E5%85%A5%E7%94%B5%E6%A2%AF%E7%9A%84%E4%BA%BA"><span class="nav-number">20.</span> <span class="nav-text">60. 最后一个能进入电梯的人</span></a></li><li class="nav-item nav-level-2"><a class="nav-link"><span class="nav-number">21.</span> <span class="nav-text"></span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">hefei</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">7</span>
          <span class="site-state-item-name">المقالات</span>
        </a>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://hf7751.gitee.io/2021/03/11/41-60/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="hefei">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="元">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">نُشر في</span>

      <time title="أُنشأ: 2021-03-11 02:36:18" itemprop="dateCreated datePublished" datetime="2021-03-11T02:36:18+08:00">2021-03-11</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">عُدل في</span>
        <time title="عُدل: 2021-03-04 15:48:04" itemprop="dateModified" datetime="2021-03-04T15:48:04+08:00">2021-03-04</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h2 id="41-买下所有产品的用户"><a href="#41-买下所有产品的用户" class="headerlink" title="41. 买下所有产品的用户"></a>41. 买下所有产品的用户</h2><p>需求：编写一个 SQL 查询，从 Customer 表中查询购买了 Product 表中所有产品的客户的 id。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>customer_id</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
</tr>
<tr>
<td>3</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">41</span>_Customer (customer_id <span class="type">int</span>, product_key <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> <span class="number">41</span>_Product (product_key <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">41</span>_Customer;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">41</span>_Customer (customer_id, product_key) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">5</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">41</span>_Customer (customer_id, product_key) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">6</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">41</span>_Customer (customer_id, product_key) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">5</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">41</span>_Customer (customer_id, product_key) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">6</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">41</span>_Customer (customer_id, product_key) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">6</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">41</span>_Product;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">41</span>_Product (product_key) <span class="keyword">values</span> (<span class="number">5</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">41</span>_Product (product_key) <span class="keyword">values</span> (<span class="number">6</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">	customer_id</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">	(<span class="keyword">select</span></span><br><span class="line">          customer_id,</span><br><span class="line">          <span class="built_in">count</span>(<span class="keyword">distinct</span> product_key) <span class="keyword">as</span> num </span><br><span class="line"> 	 <span class="keyword">from</span></span><br><span class="line">          <span class="number">41</span>_Customer</span><br><span class="line"> 	 <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">          customer_id) t</span><br><span class="line"><span class="keyword">join</span> </span><br><span class="line">    (<span class="keyword">select</span></span><br><span class="line">          <span class="built_in">count</span>(product_key) <span class="keyword">as</span> num</span><br><span class="line">     <span class="keyword">from</span> </span><br><span class="line">          <span class="number">41</span>_Product) m </span><br><span class="line"><span class="keyword">on</span> t.num <span class="operator">=</span> m.num;</span><br></pre></td></tr></table></figure>

<h2 id="42-合作过至少三次的演员和导演"><a href="#42-合作过至少三次的演员和导演" class="headerlink" title="42. 合作过至少三次的演员和导演"></a>42. 合作过至少三次的演员和导演</h2><p>需求：编写一个 SQL 查询，查询语句获取合作过至少三次的演员和导演的 id 对 (actor_id, director_id)</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>actor_id</th>
<th>director_id</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>1</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">42</span>_ActorDirector (actor_id <span class="type">int</span>, director_id <span class="type">int</span>, <span class="type">timestamp</span> <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">42</span>_ActorDirector;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">42</span>_ActorDirector (actor_id, director_id, <span class="type">timestamp</span>) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">42</span>_ActorDirector (actor_id, director_id, <span class="type">timestamp</span>) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">42</span>_ActorDirector (actor_id, director_id, <span class="type">timestamp</span>) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">42</span>_ActorDirector (actor_id, director_id, <span class="type">timestamp</span>) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">42</span>_ActorDirector (actor_id, director_id, <span class="type">timestamp</span>) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">2</span>, <span class="number">4</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">42</span>_ActorDirector (actor_id, director_id, <span class="type">timestamp</span>) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">1</span>, <span class="number">5</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">42</span>_ActorDirector (actor_id, director_id, <span class="type">timestamp</span>) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">1</span>, <span class="number">6</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">      actor_id,</span><br><span class="line">      director_id</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      <span class="number">42</span>_ActorDirector </span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">      actor_id,director_id </span><br><span class="line"><span class="keyword">having</span> </span><br><span class="line">      <span class="built_in">count</span>(<span class="operator">*</span>)<span class="operator">&gt;=</span><span class="number">3</span>;</span><br></pre></td></tr></table></figure>

<h2 id="43-产品销售分析"><a href="#43-产品销售分析" class="headerlink" title="43. 产品销售分析"></a>43. 产品销售分析</h2><p>需求一：获取产品表 <code>Product</code> 中所有的 <strong>产品名称 product name</strong> 以及 该产品在 <code>Sales</code> 表中相对应的 <strong>上市年份 year</strong> 和 <strong>价格 price</strong>。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>product_name</th>
<th>year</th>
<th>price</th>
</tr>
</thead>
<tbody><tr>
<td>Nokia</td>
<td>2008</td>
<td>5000</td>
</tr>
<tr>
<td>Nokia</td>
<td>2009</td>
<td>5000</td>
</tr>
<tr>
<td>Apple</td>
<td>2011</td>
<td>9000</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span>  If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">43</span>_Sales (sale_id <span class="type">int</span>, product_id <span class="type">int</span>, <span class="keyword">year</span> <span class="type">int</span>, quantity <span class="type">int</span>, price <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span>  If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">43</span>_Product (product_id <span class="type">int</span>, product_name <span class="type">varchar</span>(<span class="number">10</span>));</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">43</span>_Sales;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">43</span>_Sales (sale_id, product_id, <span class="keyword">year</span>, quantity, price) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">100</span>, <span class="number">2008</span>, <span class="number">10</span>, <span class="number">5000</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">43</span>_Sales (sale_id, product_id, <span class="keyword">year</span>, quantity, price) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">100</span>, <span class="number">2009</span>, <span class="number">12</span>, <span class="number">5000</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">43</span>_Sales (sale_id, product_id, <span class="keyword">year</span>, quantity, price) <span class="keyword">values</span> (<span class="number">7</span>, <span class="number">200</span>, <span class="number">2011</span>, <span class="number">15</span>, <span class="number">9000</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">43</span>_Product;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">43</span>_Product (product_id, product_name) <span class="keyword">values</span> (<span class="number">100</span>, <span class="string">&#x27;Nokia&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">43</span>_Product (product_id, product_name) <span class="keyword">values</span> (<span class="number">200</span>, <span class="string">&#x27;Apple&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">43</span>_Product (product_id, product_name) <span class="keyword">values</span> (<span class="number">300</span>, <span class="string">&#x27;Samsung&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">      product_name,</span><br><span class="line">      <span class="keyword">year</span>,</span><br><span class="line">      price</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      <span class="number">43</span>_Sales </span><br><span class="line"><span class="keyword">inner</span> <span class="keyword">join</span> </span><br><span class="line">      <span class="number">43</span>_Product</span><br><span class="line"><span class="keyword">on</span></span><br><span class="line">      <span class="number">43</span>_Sales.product_id <span class="operator">=</span> <span class="number">43</span>_Product.product_id;</span><br></pre></td></tr></table></figure>

<p>需求二：按产品 id（product_id ）来统计每个产品的销售总量。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>product_id</th>
<th>total_quantity</th>
</tr>
</thead>
<tbody><tr>
<td>100</td>
<td>22</td>
</tr>
<tr>
<td>200</td>
<td>15</td>
</tr>
</tbody></table>
<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    product_id, </span><br><span class="line">    <span class="built_in">SUM</span>(quantity) <span class="keyword">as</span> total_quantity</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    <span class="number">43</span>_Sales</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">    product_id;</span><br></pre></td></tr></table></figure>

<p>需求三：选出每个销售产品的第一年 的 产品 id、年份、数量 和 价格。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>product_id</th>
<th>first_year</th>
<th>quantity</th>
<th>price</th>
</tr>
</thead>
<tbody><tr>
<td>100</td>
<td>2008</td>
<td>10</td>
<td>5000</td>
</tr>
<tr>
<td>200</td>
<td>2011</td>
<td>15</td>
<td>9000</td>
</tr>
</tbody></table>
<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">      product_id,</span><br><span class="line">      <span class="keyword">year</span> <span class="keyword">as</span> first_year, </span><br><span class="line">      quantity,</span><br><span class="line">      price</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      <span class="number">43</span>_Sales</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">     (product_id , <span class="keyword">year</span>) <span class="keyword">in</span>(</span><br><span class="line">                            <span class="keyword">select</span></span><br><span class="line">                                  product_id ,</span><br><span class="line">                                  <span class="built_in">min</span>(<span class="keyword">year</span>)</span><br><span class="line">                            <span class="keyword">from</span></span><br><span class="line">                                  <span class="number">43</span>_Sales</span><br><span class="line">                            <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">                                  product_id</span><br><span class="line">                            );</span><br></pre></td></tr></table></figure>

<h2 id="44-项目员工"><a href="#44-项目员工" class="headerlink" title="44. 项目员工"></a>44. 项目员工</h2><p>需求一：查询每一个项目中员工的平均工作年限，精确到小数点后两位。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>project_id</th>
<th>average_years</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>2.00</td>
</tr>
<tr>
<td>2</td>
<td>2.50</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">44</span>_Project (project_id <span class="type">int</span>, employee_id <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">44</span>_Employee (employee_id <span class="type">int</span>, name <span class="type">varchar</span>(<span class="number">10</span>), experience_years <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">44</span>_Project;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">44</span>_Project (project_id, employee_id) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">44</span>_Project (project_id, employee_id) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">44</span>_Project (project_id, employee_id) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">44</span>_Project (project_id, employee_id) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">44</span>_Project (project_id, employee_id) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">4</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">44</span>_Employee;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">44</span>_Employee (employee_id, name, experience_years) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;Khaled&#x27;</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">44</span>_Employee (employee_id, name, experience_years) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;Ali&#x27;</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">44</span>_Employee (employee_id, name, experience_years) <span class="keyword">values</span> (<span class="number">3</span>, <span class="string">&#x27;John&#x27;</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">44</span>_Employee (employee_id, name, experience_years) <span class="keyword">values</span> (<span class="number">4</span>, <span class="string">&#x27;Doe&#x27;</span>, <span class="number">2</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">      project_id ,</span><br><span class="line">      round(<span class="built_in">avg</span>(experience_years),<span class="number">2</span>) <span class="keyword">as</span> average_years</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      <span class="number">44</span>_Project p</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">      <span class="number">44</span>_Employee e</span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">      p.employee_id <span class="operator">=</span> e.employee_id</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">      project_id</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">      project_id;</span><br></pre></td></tr></table></figure>

<p>需求二：报告所有雇员最多的项目。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>project_id</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
</tr>
</tbody></table>
<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">      project_id</span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">      <span class="number">44</span>_Project</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> </span><br><span class="line">      project_id</span><br><span class="line"><span class="keyword">HAVING</span> </span><br><span class="line">      <span class="built_in">COUNT</span>(employee_id) <span class="operator">=</span> (<span class="keyword">SELECT</span></span><br><span class="line">                                  <span class="built_in">MAX</span>(count_employee_id)</span><br><span class="line">                            <span class="keyword">FROM</span></span><br><span class="line">                                (<span class="keyword">SELECT</span> </span><br><span class="line">                                       project_id,</span><br><span class="line">                                       <span class="built_in">COUNT</span>(employee_id) <span class="keyword">AS</span> count_employee_id</span><br><span class="line">                                 <span class="keyword">FROM</span></span><br><span class="line">                                       <span class="number">44</span>_Project</span><br><span class="line">                                 <span class="keyword">GROUP</span> <span class="keyword">BY</span> </span><br><span class="line">                                       project_id</span><br><span class="line">                                ) <span class="keyword">As</span> temp</span><br><span class="line">                           );</span><br></pre></td></tr></table></figure>

<p>需求三：报告在每一个项目中经验最丰富的雇员是谁。如果出现经验年数相同的情况，请报告所有具有最大经验年数的员工。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>project_id</th>
<th>employee_id</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td>2</td>
<td>1</td>
</tr>
</tbody></table>
<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">      p.project_id,</span><br><span class="line">      p.employee_id</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      <span class="number">44</span>_Project p</span><br><span class="line"><span class="keyword">join</span> </span><br><span class="line">      <span class="number">44</span>_Employee e</span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">      p.employee_id <span class="operator">=</span> e.employee_id</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">     (p.project_id, e.experience_years) <span class="keyword">in</span> (<span class="keyword">select</span></span><br><span class="line">                                                  p.project_id,</span><br><span class="line">                                                  <span class="built_in">max</span>(e.experience_years)</span><br><span class="line">                                            <span class="keyword">from</span></span><br><span class="line">                                                  <span class="number">44</span>_project p </span><br><span class="line">                                            <span class="keyword">join</span></span><br><span class="line">                                                  <span class="number">44</span>_employee e</span><br><span class="line">                                            <span class="keyword">on</span> </span><br><span class="line">                                                  p.employee_id <span class="operator">=</span> e.employee_id</span><br><span class="line">                                            <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">                                                  p.project_id</span><br><span class="line">                                           );</span><br></pre></td></tr></table></figure>

<h2 id="45-销售分析"><a href="#45-销售分析" class="headerlink" title="45. 销售分析"></a>45. 销售分析</h2><p>需求一：编写一个 SQL 查询，查询总销售额最高的销售者，如果有并列的，就都展示出来。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>seller_id</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
</tr>
<tr>
<td>3</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">45</span>_Product (product_id <span class="type">int</span>, product_name <span class="type">varchar</span>(<span class="number">10</span>), unit_price <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">45</span>_Sales (seller_id <span class="type">int</span>, product_id <span class="type">int</span>,buyer_id <span class="type">int</span>, sale_date <span class="type">date</span>, quantity <span class="type">int</span>, price <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">45</span>_Product;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">45</span>_Product (product_id, product_name, unit_price) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;S8&#x27;</span>, <span class="number">1000</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">45</span>_Product (product_id, product_name, unit_price) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;G4&#x27;</span>, <span class="number">800</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">45</span>_Product (product_id, product_name, unit_price) <span class="keyword">values</span> (<span class="number">3</span>, <span class="string">&#x27;iPhone&#x27;</span>, <span class="number">1400</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">45</span>_Sales;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">45</span>_Sales (seller_id, product_id, buyer_id, sale_date, quantity, price) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>,<span class="string">&#x27;2019-01-21&#x27;</span>, <span class="number">2</span>, <span class="number">2000</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">45</span>_Sales (seller_id, product_id, buyer_id, sale_date, quantity, price) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>,<span class="string">&#x27;2019-02-17&#x27;</span>, <span class="number">1</span>, <span class="number">800</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">45</span>_Sales (seller_id, product_id, buyer_id, sale_date, quantity, price) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">1</span>, <span class="number">3</span>,<span class="string">&#x27;2019-06-02&#x27;</span>, <span class="number">1</span>, <span class="number">800</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">45</span>_Sales (seller_id, product_id, buyer_id, sale_date, quantity, price) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>,<span class="string">&#x27;2019-05-13&#x27;</span>, <span class="number">2</span>, <span class="number">2800</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">      seller_id </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      <span class="number">45</span>_Sales</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">      seller_id</span><br><span class="line"><span class="keyword">having</span> </span><br><span class="line">      <span class="built_in">sum</span>(price) <span class="operator">=</span> (<span class="keyword">select</span></span><br><span class="line">                          <span class="built_in">sum</span>(price) <span class="keyword">as</span> ye_ji</span><br><span class="line">                    <span class="keyword">from</span>  </span><br><span class="line">                          <span class="number">45</span>_Sales</span><br><span class="line">                    <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">                          seller_id</span><br><span class="line">                    <span class="keyword">order</span> <span class="keyword">by</span> </span><br><span class="line">                          ye_ji <span class="keyword">desc</span></span><br><span class="line">                    limit <span class="number">1</span></span><br><span class="line">                   );</span><br></pre></td></tr></table></figure>

<p>需求二：编写一个 SQL 查询，查询购买了 S8 手机却没有购买 iPhone 的买家。注意这里 S8 和 iPhone 是 Product 表中的产品。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>buyer_id</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
</tr>
</tbody></table>
<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">      <span class="keyword">distinct</span> buyer_id</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      <span class="number">45</span>_product p </span><br><span class="line"><span class="keyword">inner</span> <span class="keyword">join</span> </span><br><span class="line">      <span class="number">45</span>_sales s</span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">      p.product_id<span class="operator">=</span>s.product_id</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">      product_name<span class="operator">=</span><span class="string">&#x27;S8&#x27;</span> <span class="keyword">and</span> buyer_id <span class="keyword">not</span> <span class="keyword">in</span> (<span class="keyword">select</span></span><br><span class="line">                                                    buyer_id</span><br><span class="line">                                              <span class="keyword">from</span></span><br><span class="line">                                                    <span class="number">45</span>_product p</span><br><span class="line">                                              <span class="keyword">inner</span> <span class="keyword">join</span></span><br><span class="line">                                                    <span class="number">45</span>_sales s</span><br><span class="line">                                              <span class="keyword">on</span></span><br><span class="line">                                                    p.product_id<span class="operator">=</span>s.product_id</span><br><span class="line">                                              <span class="keyword">where</span></span><br><span class="line">                                                    product_name<span class="operator">=</span><span class="string">&#x27;iPhone&#x27;</span></span><br><span class="line">                                              );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法二</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">      s8 <span class="keyword">as</span> buyer_id</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      (<span class="keyword">select</span> </span><br><span class="line">             <span class="keyword">distinct</span> buyer_id s8</span><br><span class="line">       <span class="keyword">from</span></span><br><span class="line">             <span class="number">45</span>_product p </span><br><span class="line">       <span class="keyword">inner</span> <span class="keyword">join</span> </span><br><span class="line">             <span class="number">45</span>_sales s</span><br><span class="line">       <span class="keyword">on</span></span><br><span class="line">             p.product_id<span class="operator">=</span>s.product_id</span><br><span class="line">       <span class="keyword">where</span></span><br><span class="line">             product_name<span class="operator">=</span><span class="string">&#x27;S8&#x27;</span>) t1</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">      (<span class="keyword">select</span></span><br><span class="line">             <span class="keyword">distinct</span> buyer_id ip</span><br><span class="line">       <span class="keyword">from</span></span><br><span class="line">             <span class="number">45</span>_product p</span><br><span class="line">       <span class="keyword">inner</span> <span class="keyword">join</span> </span><br><span class="line">             <span class="number">45</span>_sales s</span><br><span class="line">       <span class="keyword">on</span></span><br><span class="line">             p.product_id<span class="operator">=</span>s.product_id</span><br><span class="line">       <span class="keyword">where</span></span><br><span class="line">             product_name<span class="operator">=</span><span class="string">&#x27;iPhone&#x27;</span></span><br><span class="line">      ) t2</span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">       s8<span class="operator">=</span>ip</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">       ip <span class="keyword">is</span> <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure>

<p>需求三：编写一个 SQL 查询，报告2019年仅在春季才售出的产品。即在2019-01-01至2019-03-31（含）之间。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>product_id</th>
<th>product_name</th>
</tr>
</thead>
<tbody><tr>
<td>2</td>
<td>G4</td>
</tr>
</tbody></table>
<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">	<span class="keyword">DISTINCT</span> s.product_id,</span><br><span class="line">    p.product_name</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    <span class="number">45</span>_Sales <span class="keyword">AS</span> s</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span></span><br><span class="line">    <span class="number">45</span>_Product <span class="keyword">AS</span> p</span><br><span class="line"><span class="keyword">ON</span></span><br><span class="line">    s.product_id <span class="operator">=</span> p.product_id</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">	s.product_id <span class="keyword">NOT</span> <span class="keyword">IN</span>(</span><br><span class="line">		<span class="keyword">SELECT</span></span><br><span class="line">			 <span class="keyword">DISTINCT</span> product_id</span><br><span class="line">		<span class="keyword">FROM</span></span><br><span class="line">		     <span class="number">45</span>_Sales</span><br><span class="line">		<span class="keyword">WHERE</span></span><br><span class="line">			sale_date <span class="keyword">NOT</span> <span class="keyword">BETWEEN</span> <span class="string">&#x27;2019-01-01&#x27;</span> <span class="keyword">AND</span> <span class="string">&#x27;2019-03-31&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h2 id="46-小众书籍"><a href="#46-小众书籍" class="headerlink" title="46. 小众书籍"></a>46. 小众书籍</h2><p>需求：筛选出过去一年中订单总量少于10本的书籍 。注意：不考虑上架（available from）距今不满一个月的书籍。并且假设今天是2019-06-23 。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>book_id</th>
<th>name</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>Kalila And Demna</td>
</tr>
<tr>
<td>2</td>
<td>28 Letters</td>
</tr>
<tr>
<td>5</td>
<td>The Hunger Games</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">46</span>_Books (book_id <span class="type">int</span>, name <span class="type">varchar</span>(<span class="number">50</span>), available_from <span class="type">date</span>);</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">46</span>_Orders (order_id <span class="type">int</span>, book_id <span class="type">int</span>, quantity <span class="type">int</span>, dispatch_date <span class="type">date</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">46</span>_Books;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">46</span>_Books (book_id, name, available_from) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;Kalila And Demna&#x27;</span>, <span class="string">&#x27;2010-01-01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">46</span>_Books (book_id, name, available_from) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;28 Letters&#x27;</span>, <span class="string">&#x27;2012-05-12&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">46</span>_Books (book_id, name, available_from) <span class="keyword">values</span> (<span class="number">3</span>, <span class="string">&#x27;The Hobbit&#x27;</span>, <span class="string">&#x27;2019-06-10&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">46</span>_Books (book_id, name, available_from) <span class="keyword">values</span> (<span class="number">4</span>, <span class="string">&#x27;13 Reasons Why&#x27;</span>, <span class="string">&#x27;2019-06-01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">46</span>_Books (book_id, name, available_from) <span class="keyword">values</span> (<span class="number">5</span>, <span class="string">&#x27;The Hunger Games&#x27;</span>, <span class="string">&#x27;2008-09-21&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">46</span>_Orders;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">46</span>_Orders (order_id, book_id, quantity, dispatch_date) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="string">&#x27;2018-07-26&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">46</span>_Orders (order_id, book_id, quantity, dispatch_date) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="string">&#x27;2018-11-05&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">46</span>_Orders (order_id, book_id, quantity, dispatch_date) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">3</span>, <span class="number">8</span>, <span class="string">&#x27;2019-06-11&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">46</span>_Orders (order_id, book_id, quantity, dispatch_date) <span class="keyword">values</span> (<span class="number">4</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="string">&#x27;2019-06-05&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">46</span>_Orders (order_id, book_id, quantity, dispatch_date) <span class="keyword">values</span> (<span class="number">5</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="string">&#x27;2019-06-20&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">46</span>_Orders (order_id, book_id, quantity, dispatch_date) <span class="keyword">values</span> (<span class="number">6</span>, <span class="number">5</span>, <span class="number">9</span>, <span class="string">&#x27;2009-02-02&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">46</span>_Orders (order_id, book_id, quantity, dispatch_date) <span class="keyword">values</span> (<span class="number">7</span>, <span class="number">5</span>, <span class="number">8</span>, <span class="string">&#x27;2010-04-13&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">      t1.book_id,</span><br><span class="line">      (<span class="keyword">select</span> name <span class="keyword">from</span> <span class="number">46</span>_books t3 <span class="keyword">where</span> t1.book_id <span class="operator">=</span> t3.book_id) <span class="keyword">as</span> name</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      (<span class="keyword">select</span></span><br><span class="line">             <span class="operator">*</span></span><br><span class="line">       <span class="keyword">from</span></span><br><span class="line">             <span class="number">46</span>_books</span><br><span class="line">       <span class="keyword">where</span></span><br><span class="line">             available_from <span class="operator">&lt;</span> date_sub(<span class="string">&#x27;2019-06-23&#x27;</span>,<span class="type">interval</span> <span class="number">1</span> <span class="keyword">Month</span>)</span><br><span class="line">      ) t1 </span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> </span><br><span class="line">      (<span class="keyword">select</span> </span><br><span class="line">             <span class="operator">*</span>,</span><br><span class="line">             <span class="keyword">case</span></span><br><span class="line">                  <span class="keyword">when</span> dispatch_date <span class="keyword">between</span> <span class="string">&#x27;2018-06-23&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2019-06-23&#x27;</span> <span class="keyword">then</span> quantity</span><br><span class="line">                  <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">              <span class="keyword">end</span> num</span><br><span class="line">       <span class="keyword">from</span> <span class="number">46</span>_orders</span><br><span class="line">      )  t2</span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">     t1.book_id<span class="operator">=</span>t2.book_id </span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">     t1.book_id </span><br><span class="line"><span class="keyword">having</span> </span><br><span class="line">     <span class="built_in">sum</span>(if(t2.num <span class="keyword">is</span> <span class="keyword">null</span>,<span class="number">0</span>,t2.num))<span class="operator">&lt;</span><span class="number">10</span>;</span><br></pre></td></tr></table></figure>

<h2 id="47-每日新用户统计"><a href="#47-每日新用户统计" class="headerlink" title="47. 每日新用户统计"></a>47. 每日新用户统计</h2><p>需求一：编写一个 SQL 查询，以查询从今天起最多 90 天内，每个日期内首次登录的用户数。假设今天是 <strong>2019-06-30</strong>.</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>login_date</th>
<th>user_count</th>
</tr>
</thead>
<tbody><tr>
<td>2019-05-01</td>
<td>1</td>
</tr>
<tr>
<td>2019-06-21</td>
<td>2</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">47</span>_Traffic (user_id <span class="type">int</span>, activity ENUM(<span class="string">&#x27;login&#x27;</span>, <span class="string">&#x27;logout&#x27;</span>, <span class="string">&#x27;jobs&#x27;</span>, <span class="string">&#x27;groups&#x27;</span>, <span class="string">&#x27;homepage&#x27;</span>), activity_date <span class="type">date</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">47</span>_Traffic;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">47</span>_Traffic (user_id, activity, activity_date) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;login&#x27;</span>, <span class="string">&#x27;2019-05-01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">47</span>_Traffic (user_id, activity, activity_date) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;homepage&#x27;</span>, <span class="string">&#x27;2019-05-01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">47</span>_Traffic (user_id, activity, activity_date) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;logout&#x27;</span>, <span class="string">&#x27;2019-05-01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">47</span>_Traffic (user_id, activity, activity_date) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;login&#x27;</span>, <span class="string">&#x27;2019-06-21&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">47</span>_Traffic (user_id, activity, activity_date) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;logout&#x27;</span>, <span class="string">&#x27;2019-06-21&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">47</span>_Traffic (user_id, activity, activity_date) <span class="keyword">values</span> (<span class="number">3</span>, <span class="string">&#x27;login&#x27;</span>, <span class="string">&#x27;2019-01-01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">47</span>_Traffic (user_id, activity, activity_date) <span class="keyword">values</span> (<span class="number">3</span>, <span class="string">&#x27;jobs&#x27;</span>, <span class="string">&#x27;2019-01-01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">47</span>_Traffic (user_id, activity, activity_date) <span class="keyword">values</span> (<span class="number">3</span>, <span class="string">&#x27;logout&#x27;</span>, <span class="string">&#x27;2019-01-01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">47</span>_Traffic (user_id, activity, activity_date) <span class="keyword">values</span> (<span class="number">4</span>, <span class="string">&#x27;login&#x27;</span>, <span class="string">&#x27;2019-06-21&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">47</span>_Traffic (user_id, activity, activity_date) <span class="keyword">values</span> (<span class="number">4</span>, <span class="string">&#x27;groups&#x27;</span>, <span class="string">&#x27;2019-06-21&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">47</span>_Traffic (user_id, activity, activity_date) <span class="keyword">values</span> (<span class="number">4</span>, <span class="string">&#x27;logout&#x27;</span>, <span class="string">&#x27;2019-06-21&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">47</span>_Traffic (user_id, activity, activity_date) <span class="keyword">values</span> (<span class="number">5</span>, <span class="string">&#x27;login&#x27;</span>, <span class="string">&#x27;2019-03-01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">47</span>_Traffic (user_id, activity, activity_date) <span class="keyword">values</span> (<span class="number">5</span>, <span class="string">&#x27;logout&#x27;</span>, <span class="string">&#x27;2019-03-01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">47</span>_Traffic (user_id, activity, activity_date) <span class="keyword">values</span> (<span class="number">5</span>, <span class="string">&#x27;login&#x27;</span>, <span class="string">&#x27;2019-06-21&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">47</span>_Traffic (user_id, activity, activity_date) <span class="keyword">values</span> (<span class="number">5</span>, <span class="string">&#x27;logout&#x27;</span>, <span class="string">&#x27;2019-06-21&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    minx <span class="keyword">as</span> login_date,</span><br><span class="line">    <span class="built_in">count</span>(user_id) <span class="keyword">as</span> user_count</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">   (<span class="keyword">select</span> </span><br><span class="line">          user_id,</span><br><span class="line">          <span class="built_in">min</span>(activity_date) <span class="keyword">as</span> minx</span><br><span class="line">    <span class="keyword">from</span> </span><br><span class="line">          <span class="number">47</span>_Traffic</span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">          activity<span class="operator">=</span><span class="string">&#x27;login&#x27;</span></span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">          user_id</span><br><span class="line">    <span class="keyword">having</span> </span><br><span class="line">          datediff(<span class="string">&#x27;2019-06-30&#x27;</span>,minx)<span class="operator">&lt;=</span><span class="number">90</span></span><br><span class="line">    )s</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">    minx;</span><br></pre></td></tr></table></figure>

<h2 id="48-每位学生的最高成绩"><a href="#48-每位学生的最高成绩" class="headerlink" title="48. 每位学生的最高成绩"></a>48. 每位学生的最高成绩</h2><p>需求：查询每位学生获得的最高成绩和它所对应的科目，若科目成绩并列，取 <code>course_id</code> 最小的一门。查询结果需按 <code>student_id</code> 增序进行排序。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>student_id</th>
<th>course_id</th>
<th>grade</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>2</td>
<td>99</td>
</tr>
<tr>
<td>2</td>
<td>2</td>
<td>95</td>
</tr>
<tr>
<td>3</td>
<td>3</td>
<td>82</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">48</span>_Enrollments (student_id <span class="type">int</span>, course_id <span class="type">int</span>, grade <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">48</span>_Enrollments;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">48</span>_Enrollments (student_id, course_id, grade) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">2</span>, <span class="number">95</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">48</span>_Enrollments (student_id, course_id, grade) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">3</span>, <span class="number">95</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">48</span>_Enrollments (student_id, course_id, grade) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="number">90</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">48</span>_Enrollments (student_id, course_id, grade) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">2</span>, <span class="number">99</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">48</span>_Enrollments (student_id, course_id, grade) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">1</span>, <span class="number">80</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">48</span>_Enrollments (student_id, course_id, grade) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">2</span>, <span class="number">75</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">48</span>_Enrollments (student_id, course_id, grade) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">3</span>, <span class="number">82</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">      e1.student_id,</span><br><span class="line">      <span class="built_in">min</span>(e1.course_id) <span class="keyword">as</span> course_id,</span><br><span class="line">      <span class="built_in">max</span>(e1.grade) <span class="keyword">as</span> grade</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      <span class="number">48</span>_Enrollments e1</span><br><span class="line"><span class="keyword">right</span> <span class="keyword">join</span></span><br><span class="line">     (<span class="keyword">select</span></span><br><span class="line">            student_id,</span><br><span class="line">            <span class="built_in">max</span>(grade) <span class="keyword">as</span> max1 </span><br><span class="line">      <span class="keyword">from</span> </span><br><span class="line">            <span class="number">48</span>_Enrollments</span><br><span class="line">      <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">            student_id </span><br><span class="line">     )e2</span><br><span class="line"><span class="keyword">on</span></span><br><span class="line">      e2.student_id<span class="operator">=</span>e1.student_id </span><br><span class="line">      <span class="keyword">and</span></span><br><span class="line">      e2.max1 <span class="operator">=</span> e1.grade</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">      e1.student_id</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> </span><br><span class="line">      e1.student_id;</span><br></pre></td></tr></table></figure>

<h2 id="49-举报记录"><a href="#49-举报记录" class="headerlink" title="49. 举报记录"></a>49. 举报记录</h2><p>需求一： 编写一条SQL，查询昨天不同举报类型的数量，假设今天是 <strong>2019-07-05</strong>。 在action 列标记为<code>report</code> 被认为遭到举报，对应的产生举报原因。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>report_reason</th>
<th>report_count</th>
</tr>
</thead>
<tbody><tr>
<td>spam</td>
<td>1</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">49</span>_Actions (user_id <span class="type">int</span>, post_id <span class="type">int</span>, action_date <span class="type">date</span>, action ENUM(<span class="string">&#x27;view&#x27;</span>, <span class="string">&#x27;like&#x27;</span>, <span class="string">&#x27;reaction&#x27;</span>, <span class="string">&#x27;comment&#x27;</span>, <span class="string">&#x27;report&#x27;</span>, <span class="string">&#x27;share&#x27;</span>), extra <span class="type">varchar</span>(<span class="number">10</span>));</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">49</span>_Actions;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">49</span>_Actions (user_id, post_id, action_date, action, extra) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="string">&#x27;2019-07-01&#x27;</span>, <span class="string">&#x27;view&#x27;</span>, <span class="keyword">null</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">49</span>_Actions (user_id, post_id, action_date, action, extra) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="string">&#x27;2019-07-01&#x27;</span>, <span class="string">&#x27;like&#x27;</span>, <span class="keyword">null</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">49</span>_Actions (user_id, post_id, action_date, action, extra) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="string">&#x27;2019-07-01&#x27;</span>, <span class="string">&#x27;share&#x27;</span>, <span class="keyword">null</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">49</span>_Actions (user_id, post_id, action_date, action, extra) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">4</span>, <span class="string">&#x27;2019-07-04&#x27;</span>, <span class="string">&#x27;view&#x27;</span>, <span class="keyword">null</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">49</span>_Actions (user_id, post_id, action_date, action, extra) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">4</span>, <span class="string">&#x27;2019-07-04&#x27;</span>, <span class="string">&#x27;report&#x27;</span>, <span class="string">&#x27;spam&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">49</span>_Actions (user_id, post_id, action_date, action, extra) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">4</span>, <span class="string">&#x27;2019-07-04&#x27;</span>, <span class="string">&#x27;view&#x27;</span>, <span class="keyword">null</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">49</span>_Actions (user_id, post_id, action_date, action, extra) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">4</span>, <span class="string">&#x27;2019-07-04&#x27;</span>, <span class="string">&#x27;report&#x27;</span>, <span class="string">&#x27;spam&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">49</span>_Actions (user_id, post_id, action_date, action, extra) <span class="keyword">values</span> (<span class="number">4</span>, <span class="number">3</span>, <span class="string">&#x27;2019-07-02&#x27;</span>, <span class="string">&#x27;view&#x27;</span>, <span class="keyword">null</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">49</span>_Actions (user_id, post_id, action_date, action, extra) <span class="keyword">values</span> (<span class="number">4</span>, <span class="number">3</span>, <span class="string">&#x27;2019-07-02&#x27;</span>, <span class="string">&#x27;report&#x27;</span>, <span class="string">&#x27;spam&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">49</span>_Actions (user_id, post_id, action_date, action, extra) <span class="keyword">values</span> (<span class="number">5</span>, <span class="number">2</span>, <span class="string">&#x27;2019-07-03&#x27;</span>, <span class="string">&#x27;view&#x27;</span>, <span class="keyword">null</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">49</span>_Actions (user_id, post_id, action_date, action, extra) <span class="keyword">values</span> (<span class="number">5</span>, <span class="number">2</span>, <span class="string">&#x27;2019-07-03&#x27;</span>, <span class="string">&#x27;report&#x27;</span>, <span class="string">&#x27;racism&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">49</span>_Actions (user_id, post_id, action_date, action, extra) <span class="keyword">values</span> (<span class="number">5</span>, <span class="number">5</span>, <span class="string">&#x27;2019-07-03&#x27;</span>, <span class="string">&#x27;view&#x27;</span>, <span class="keyword">null</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">49</span>_Actions (user_id, post_id, action_date, action, extra) <span class="keyword">values</span> (<span class="number">5</span>, <span class="number">5</span>, <span class="string">&#x27;2019-07-03&#x27;</span>, <span class="string">&#x27;report&#x27;</span>, <span class="string">&#x27;racism&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">      extra report_reason,</span><br><span class="line">      <span class="built_in">count</span>(<span class="keyword">distinct</span> post_id) report_count </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      <span class="number">49</span>_Actions </span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">      datediff(<span class="string">&#x27;2019-07-05&#x27;</span>, action_date) <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">      <span class="keyword">and</span></span><br><span class="line">      extra <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">      <span class="keyword">and</span></span><br><span class="line">      action <span class="operator">=</span> <span class="string">&#x27;report&#x27;</span> </span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">      extra;</span><br></pre></td></tr></table></figure>

<h2 id="50-查询活跃业务"><a href="#50-查询活跃业务" class="headerlink" title="50. 查询活跃业务"></a>50. 查询活跃业务</h2><p>需求：写一段 SQL 来查询所有活跃的业务。如果一个业务的某个事件类型的发生次数大于此事件类型在所有业务中的平均发生次数，并且该业务至少有两个这样的事件类型，那么该业务就可被看做是活跃业务。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>business_id</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
</tr>
</tbody></table>
<p>reviews、 ads 和 page views 的总平均发生次数分别是 (7+3)/2=5, (11+7+6)/3=8, (3+12)/2=7.5。<br>id 为 1 的业务有 7 个 ‘reviews’ 事件（大于 5）和 11 个 ‘ads’ 事件（大于 8），所以它是活跃业务。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">50</span>_Events (business_id <span class="type">int</span>, event_type <span class="type">varchar</span>(<span class="number">10</span>), occurences <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">50</span>_Events;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">50</span>_Events (business_id, event_type, occurences) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;reviews&#x27;</span>, <span class="number">7</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">50</span>_Events (business_id, event_type, occurences) <span class="keyword">values</span> (<span class="number">3</span>, <span class="string">&#x27;reviews&#x27;</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">50</span>_Events (business_id, event_type, occurences) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;ads&#x27;</span>, <span class="number">11</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">50</span>_Events (business_id, event_type, occurences) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;ads&#x27;</span>, <span class="number">7</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">50</span>_Events (business_id, event_type, occurences) <span class="keyword">values</span> (<span class="number">3</span>, <span class="string">&#x27;ads&#x27;</span>, <span class="number">6</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">50</span>_Events (business_id, event_type, occurences) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;page views&#x27;</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">50</span>_Events (business_id, event_type, occurences) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;page views&#x27;</span>, <span class="number">12</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    e2.business_id</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    <span class="number">50</span>_events e2</span><br><span class="line"><span class="keyword">join</span> </span><br><span class="line">   (<span class="keyword">select</span> </span><br><span class="line">          event_type,</span><br><span class="line">          <span class="built_in">avg</span>(occurences) <span class="keyword">as</span> avg_occ</span><br><span class="line">    <span class="keyword">from</span></span><br><span class="line">          <span class="number">50</span>_events</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">		  event_type) e1</span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">    e2.event_type <span class="operator">=</span> e1.event_type </span><br><span class="line">    <span class="keyword">and</span> </span><br><span class="line">    e2.occurences <span class="operator">&gt;</span> e1.avg_occ</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">    e2.business_id</span><br><span class="line"><span class="keyword">having</span> </span><br><span class="line">    <span class="built_in">count</span>(business_id) <span class="operator">&gt;=</span><span class="number">2</span>;</span><br></pre></td></tr></table></figure>

<h2 id="51-用户购买平台"><a href="#51-用户购买平台" class="headerlink" title="51. 用户购买平台"></a>51. 用户购买平台</h2><p>需求一： 写一段 SQL 来查找每天 <strong>仅</strong> 使用手机端用户、<strong>仅</strong> 使用桌面端用户和 <strong>同时</strong> 使用桌面端和手机端的用户人数和总支出金额。 </p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>spend_date</th>
<th>platform</th>
<th>total_amount</th>
<th>total_users</th>
</tr>
</thead>
<tbody><tr>
<td>2019-07-01</td>
<td>desktop</td>
<td>100</td>
<td>1</td>
</tr>
<tr>
<td>2019-07-01</td>
<td>mobile</td>
<td>100</td>
<td>1</td>
</tr>
<tr>
<td>2019-07-01</td>
<td>both</td>
<td>200</td>
<td>1</td>
</tr>
<tr>
<td>2019-07-02</td>
<td>desktop</td>
<td>100</td>
<td>1</td>
</tr>
<tr>
<td>2019-07-02</td>
<td>mobile</td>
<td>100</td>
<td>1</td>
</tr>
<tr>
<td>2019-07-02</td>
<td>both</td>
<td>0</td>
<td>0</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">51</span>_Spending (user_id <span class="type">int</span>, spend_date <span class="type">date</span>, platform ENUM(<span class="string">&#x27;desktop&#x27;</span>, <span class="string">&#x27;mobile&#x27;</span>), amount <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">51</span>_Spending;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">51</span>_Spending (user_id, spend_date, platform, amount) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;2019-07-01&#x27;</span>, <span class="string">&#x27;mobile&#x27;</span>, <span class="number">100</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">51</span>_Spending (user_id, spend_date, platform, amount) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;2019-07-01&#x27;</span>, <span class="string">&#x27;desktop&#x27;</span>, <span class="number">100</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">51</span>_Spending (user_id, spend_date, platform, amount) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;2019-07-01&#x27;</span>, <span class="string">&#x27;mobile&#x27;</span>, <span class="number">100</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">51</span>_Spending (user_id, spend_date, platform, amount) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;2019-07-02&#x27;</span>, <span class="string">&#x27;mobile&#x27;</span>, <span class="number">100</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">51</span>_Spending (user_id, spend_date, platform, amount) <span class="keyword">values</span> (<span class="number">3</span>, <span class="string">&#x27;2019-07-01&#x27;</span>, <span class="string">&#x27;desktop&#x27;</span>, <span class="number">100</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">51</span>_Spending (user_id, spend_date, platform, amount) <span class="keyword">values</span> (<span class="number">3</span>, <span class="string">&#x27;2019-07-02&#x27;</span>, <span class="string">&#x27;desktop&#x27;</span>, <span class="number">100</span>);</span><br></pre></td></tr></table></figure>

<p>在 2019-07-01, 用户1 同时 使用桌面端和手机端购买, 用户2 仅 使用了手机端购买，而用户3 仅 使用了桌面端购买。</p>
<p>在 2019-07-02, 用户2 仅 使用了手机端购买, 用户3 仅 使用了桌面端购买，且没有用户 同时 使用桌面端和手机端购买。</p>
<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">      temp1.spend_date,</span><br><span class="line">      temp1.platform, </span><br><span class="line">      ifnull(temp3.total_amount, <span class="number">0</span>) total_amount, </span><br><span class="line">      ifnull(temp3.total_users,<span class="number">0</span>) total_users</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">     (<span class="keyword">select</span></span><br><span class="line">            <span class="keyword">distinct</span>(spend_date),</span><br><span class="line">            p.platform   </span><br><span class="line">      <span class="keyword">from</span> </span><br><span class="line">            <span class="number">51</span>_Spending,</span><br><span class="line">           (<span class="keyword">select</span></span><br><span class="line">                  <span class="string">&#x27;desktop&#x27;</span> <span class="keyword">as</span> platform <span class="keyword">union</span></span><br><span class="line">            <span class="keyword">select</span> </span><br><span class="line">                  <span class="string">&#x27;mobile&#x27;</span> <span class="keyword">as</span> platform <span class="keyword">union</span></span><br><span class="line">            <span class="keyword">select</span></span><br><span class="line">                  <span class="string">&#x27;both&#x27;</span> <span class="keyword">as</span> platform</span><br><span class="line">           ) <span class="keyword">as</span> p </span><br><span class="line">       ) <span class="keyword">as</span> temp1</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> </span><br><span class="line">      (<span class="keyword">select</span></span><br><span class="line">             spend_date,</span><br><span class="line">             platform,</span><br><span class="line">             <span class="built_in">sum</span>(amount) <span class="keyword">as</span> total_amount,</span><br><span class="line">             <span class="built_in">count</span>(user_id) total_users</span><br><span class="line">       <span class="keyword">from</span></span><br><span class="line">            (<span class="keyword">select</span></span><br><span class="line">                   spend_date,</span><br><span class="line">                   user_id, </span><br><span class="line">                   <span class="keyword">case</span> <span class="built_in">count</span>(<span class="keyword">distinct</span> platform)</span><br><span class="line">                        <span class="keyword">when</span> <span class="number">1</span> <span class="keyword">then</span> platform</span><br><span class="line">                        <span class="keyword">when</span> <span class="number">2</span> <span class="keyword">then</span> <span class="string">&#x27;both&#x27;</span></span><br><span class="line">                   <span class="keyword">end</span> <span class="keyword">as</span>  platform, </span><br><span class="line">                   <span class="built_in">sum</span>(amount) <span class="keyword">as</span> amount</span><br><span class="line">             <span class="keyword">from</span> </span><br><span class="line">                   <span class="number">51</span>_Spending</span><br><span class="line">             <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">                   spend_date,</span><br><span class="line">                   user_id</span><br><span class="line">            ) <span class="keyword">as</span> temp2</span><br><span class="line">      <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">             spend_date,</span><br><span class="line">             platform</span><br><span class="line">      ) <span class="keyword">as</span>  temp3</span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">      temp1.platform <span class="operator">=</span> temp3.platform <span class="keyword">and</span></span><br><span class="line">      temp1.spend_date <span class="operator">=</span> temp3.spend_date;</span><br></pre></td></tr></table></figure>

<h2 id="52-查询近30天活跃用户"><a href="#52-查询近30天活跃用户" class="headerlink" title="52. 查询近30天活跃用户"></a>52. 查询近30天活跃用户</h2><p>需求一：请写SQL查询出截至 <strong>2019-07-27</strong>（包含2019-07-27）<strong>，近</strong> 30天的每日活跃用户数（当天只要有一条活动记录，即为活跃用户）。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>day</th>
<th>active_users</th>
</tr>
</thead>
<tbody><tr>
<td>2019-07-20</td>
<td>2</td>
</tr>
<tr>
<td>2019-07-21</td>
<td>2</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">52</span>_Activity (user_id <span class="type">int</span>, session_id <span class="type">int</span>, activity_date <span class="type">date</span>, activity_type ENUM(<span class="string">&#x27;open_session&#x27;</span>, <span class="string">&#x27;end_session&#x27;</span>, <span class="string">&#x27;scroll_down&#x27;</span>, <span class="string">&#x27;send_message&#x27;</span>));</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">52</span>_Activity;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">52</span>_Activity (user_id, session_id, activity_date, activity_type) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="string">&#x27;2019-07-20&#x27;</span>, <span class="string">&#x27;open_session&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">52</span>_Activity (user_id, session_id, activity_date, activity_type) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="string">&#x27;2019-07-20&#x27;</span>, <span class="string">&#x27;scroll_down&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">52</span>_Activity (user_id, session_id, activity_date, activity_type) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="string">&#x27;2019-07-20&#x27;</span>, <span class="string">&#x27;end_session&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">52</span>_Activity (user_id, session_id, activity_date, activity_type) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">4</span>, <span class="string">&#x27;2019-07-20&#x27;</span>, <span class="string">&#x27;open_session&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">52</span>_Activity (user_id, session_id, activity_date, activity_type) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">4</span>, <span class="string">&#x27;2019-07-21&#x27;</span>, <span class="string">&#x27;send_message&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">52</span>_Activity (user_id, session_id, activity_date, activity_type) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">4</span>, <span class="string">&#x27;2019-07-21&#x27;</span>, <span class="string">&#x27;end_session&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">52</span>_Activity (user_id, session_id, activity_date, activity_type) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">2</span>, <span class="string">&#x27;2019-07-21&#x27;</span>, <span class="string">&#x27;open_session&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">52</span>_Activity (user_id, session_id, activity_date, activity_type) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">2</span>, <span class="string">&#x27;2019-07-21&#x27;</span>, <span class="string">&#x27;send_message&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">52</span>_Activity (user_id, session_id, activity_date, activity_type) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">2</span>, <span class="string">&#x27;2019-07-21&#x27;</span>, <span class="string">&#x27;end_session&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">52</span>_Activity (user_id, session_id, activity_date, activity_type) <span class="keyword">values</span> (<span class="number">4</span>, <span class="number">3</span>, <span class="string">&#x27;2019-06-25&#x27;</span>, <span class="string">&#x27;open_session&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">52</span>_Activity (user_id, session_id, activity_date, activity_type) <span class="keyword">values</span> (<span class="number">4</span>, <span class="number">3</span>, <span class="string">&#x27;2019-06-25&#x27;</span>, <span class="string">&#x27;end_session&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">      t.activity_date <span class="keyword">as</span> <span class="keyword">day</span>,</span><br><span class="line">      <span class="built_in">count</span>(<span class="keyword">distinct</span> t.user_id) <span class="keyword">as</span> active_users</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">     (<span class="keyword">select</span> </span><br><span class="line">            activity_date,</span><br><span class="line">            user_id</span><br><span class="line">      <span class="keyword">from</span></span><br><span class="line">            <span class="number">52</span>_Activity</span><br><span class="line">      <span class="keyword">where</span> </span><br><span class="line">            datediff(<span class="string">&#x27;2019-07-27&#x27;</span>,activity_date) <span class="operator">&lt;</span><span class="number">30</span></span><br><span class="line">            <span class="keyword">and</span></span><br><span class="line">            datediff( <span class="string">&#x27;2019-07-27&#x27;</span>, activity_date) <span class="operator">&gt;=</span><span class="number">0</span></span><br><span class="line">      <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">            user_id,</span><br><span class="line">            activity_date</span><br><span class="line">      <span class="keyword">having</span> </span><br><span class="line">            <span class="built_in">count</span>(activity_type)<span class="operator">&gt;</span><span class="number">0</span></span><br><span class="line">     ) <span class="keyword">as</span> t</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">      t.activity_date;</span><br></pre></td></tr></table></figure>

<p>需求二：编写SQL查询以查找截至2019年7月27日（含）的30天内每个用户的平均会话数，四舍五入到小数点后两位。我们要为用户计算的会话是在该时间段内至少进行了一项活动的会话。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>average_sessions_per_user</th>
</tr>
</thead>
<tbody><tr>
<td>1.00</td>
</tr>
</tbody></table>
<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">      ROUND(IFNULL(<span class="built_in">AVG</span>(count_session_id), <span class="number">0</span>), <span class="number">2</span>) <span class="keyword">AS</span> average_sessions_per_user</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">     (<span class="keyword">SELECT</span></span><br><span class="line">            <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> session_id) <span class="keyword">AS</span> count_session_id</span><br><span class="line">      <span class="keyword">FROM</span></span><br><span class="line">            <span class="number">52</span>_Activity</span><br><span class="line">      <span class="keyword">WHERE</span> </span><br><span class="line">            activity_date <span class="keyword">BETWEEN</span> DATE_SUB(&quot;2019-07-27&quot;, <span class="type">INTERVAL</span> <span class="number">29</span> <span class="keyword">DAY</span>) <span class="keyword">AND</span> &quot;2019-07-27&quot;</span><br><span class="line">      <span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">            user_id</span><br><span class="line">      ) <span class="keyword">AS</span> temp;</span><br></pre></td></tr></table></figure>

<h2 id="53-文章浏览"><a href="#53-文章浏览" class="headerlink" title="53. 文章浏览"></a>53. 文章浏览</h2><p>需求一：找出所有浏览过自己文章的作者，结果按照 id 升序排列。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>id</th>
</tr>
</thead>
<tbody><tr>
<td>4</td>
</tr>
<tr>
<td>7</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">53</span>_Views (article_id <span class="type">int</span>, author_id <span class="type">int</span>, viewer_id <span class="type">int</span>, view_date <span class="type">date</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">53</span>_Views;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">53</span>_Views (article_id, author_id, viewer_id, view_date) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="string">&#x27;2019-08-01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">53</span>_Views (article_id, author_id, viewer_id, view_date) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="string">&#x27;2019-08-01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">53</span>_Views (article_id, author_id, viewer_id, view_date) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">3</span>, <span class="number">6</span>, <span class="string">&#x27;2019-08-02&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">53</span>_Views (article_id, author_id, viewer_id, view_date) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="string">&#x27;2019-08-01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">53</span>_Views (article_id, author_id, viewer_id, view_date) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">7</span>, <span class="number">6</span>, <span class="string">&#x27;2019-08-02&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">53</span>_Views (article_id, author_id, viewer_id, view_date) <span class="keyword">values</span> (<span class="number">4</span>, <span class="number">7</span>, <span class="number">1</span>, <span class="string">&#x27;2019-07-22&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">53</span>_Views (article_id, author_id, viewer_id, view_date) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="string">&#x27;2019-07-21&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">53</span>_Views (article_id, author_id, viewer_id, view_date) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="string">&#x27;2019-07-21&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">      <span class="keyword">distinct</span> viewer_id <span class="keyword">as</span> id</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      <span class="number">53</span>_Views </span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">      viewer_id <span class="operator">=</span> author_id</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> </span><br><span class="line">      viewer_id;</span><br></pre></td></tr></table></figure>

<p>需求二：找出在同一天阅读至少两篇文章的人，结果按照 id 升序排序。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>project_id</th>
</tr>
</thead>
<tbody><tr>
<td>5</td>
</tr>
<tr>
<td>6</td>
</tr>
</tbody></table>
<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">      <span class="keyword">DISTINCT</span> viewer_id <span class="keyword">as</span> id </span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">      <span class="number">53</span>_views</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> </span><br><span class="line">      viewer_id,view_date</span><br><span class="line"><span class="keyword">HAVING</span></span><br><span class="line">      <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> article_id)<span class="operator">&gt;=</span><span class="number">2</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> </span><br><span class="line">      viewer_id;</span><br></pre></td></tr></table></figure>

<h2 id="54-市场分析"><a href="#54-市场分析" class="headerlink" title="54. 市场分析"></a>54. 市场分析</h2><p>需求一： 请写出一条SQL语句以查询每个用户的注册日期和在 <strong>2019</strong> 年作为买家的订单总数。 </p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>buyer_id</th>
<th>join_date</th>
<th>orders_in_2019</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>2018-01-01</td>
<td>1</td>
</tr>
<tr>
<td>2</td>
<td>2018-02-09</td>
<td>2</td>
</tr>
<tr>
<td>3</td>
<td>2018-01-19</td>
<td>0</td>
</tr>
<tr>
<td>4</td>
<td>2018-05-21</td>
<td>0</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">54</span>_Users (user_id <span class="type">int</span>, join_date <span class="type">date</span>, favorite_brand <span class="type">varchar</span>(<span class="number">10</span>));</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> <span class="number">54</span>_Orders (order_id <span class="type">int</span>, order_date <span class="type">date</span>, item_id <span class="type">int</span>, buyer_id <span class="type">int</span>, seller_id <span class="type">int</span>);</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> <span class="number">54</span>_Items (item_id <span class="type">int</span>, item_brand <span class="type">varchar</span>(<span class="number">10</span>));</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">54</span>_Users;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">54</span>_Users (user_id, join_date, favorite_brand) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;2018-01-01&#x27;</span>, <span class="string">&#x27;Lenovo&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">54</span>_Users (user_id, join_date, favorite_brand) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;2018-02-09&#x27;</span>, <span class="string">&#x27;Samsung&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">54</span>_Users (user_id, join_date, favorite_brand) <span class="keyword">values</span> (<span class="number">3</span>, <span class="string">&#x27;2018-01-19&#x27;</span>, <span class="string">&#x27;LG&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">54</span>_Users (user_id, join_date, favorite_brand) <span class="keyword">values</span> (<span class="number">4</span>, <span class="string">&#x27;2018-05-21&#x27;</span>, <span class="string">&#x27;HP&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">54</span>_Orders;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">54</span>_Orders (order_id, order_date, item_id, buyer_id, seller_id) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;2019-08-01&#x27;</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">54</span>_Orders (order_id, order_date, item_id, buyer_id, seller_id) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;2018-08-02&#x27;</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">54</span>_Orders (order_id, order_date, item_id, buyer_id, seller_id) <span class="keyword">values</span> (<span class="number">3</span>, <span class="string">&#x27;2019-08-03&#x27;</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">54</span>_Orders (order_id, order_date, item_id, buyer_id, seller_id) <span class="keyword">values</span> (<span class="number">4</span>, <span class="string">&#x27;2018-08-04&#x27;</span>, <span class="number">1</span>, <span class="number">4</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">54</span>_Orders (order_id, order_date, item_id, buyer_id, seller_id) <span class="keyword">values</span> (<span class="number">5</span>, <span class="string">&#x27;2018-08-04&#x27;</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">4</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">54</span>_Orders (order_id, order_date, item_id, buyer_id, seller_id) <span class="keyword">values</span> (<span class="number">6</span>, <span class="string">&#x27;2019-08-05&#x27;</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">4</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">54</span>_Items;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">54</span>_Items (item_id, item_brand) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;Samsung&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">54</span>_Items (item_id, item_brand) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;Lenovo&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">54</span>_Items (item_id, item_brand) <span class="keyword">values</span> (<span class="number">3</span>, <span class="string">&#x27;LG&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">54</span>_Items (item_id, item_brand) <span class="keyword">values</span> (<span class="number">4</span>, <span class="string">&#x27;HP&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">       user_id <span class="keyword">AS</span> buyer_id,</span><br><span class="line">       join_date,</span><br><span class="line">       IFNULL(<span class="built_in">COUNT</span>(buyer_Id), <span class="number">0</span>) <span class="keyword">AS</span> orders_in_2019</span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">       <span class="number">54</span>_Users u </span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span></span><br><span class="line">       <span class="number">54</span>_Orders o</span><br><span class="line"><span class="keyword">ON</span>  </span><br><span class="line">       U.user_id <span class="operator">=</span> o.buyer_id </span><br><span class="line">       <span class="keyword">AND</span></span><br><span class="line">       order_date <span class="operator">&gt;=</span> <span class="string">&#x27;2019-01-01&#x27;</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">       user_id</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">       user_id;</span><br></pre></td></tr></table></figure>

<p>需求二： 写一个 SQL 查询确定每一个用户按日期顺序卖出的第二件商品的品牌是否是他们最喜爱的品牌。如果一个用户卖出少于两件商品，查询的结果是 <code>no</code> 。 </p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>seller_id</th>
<th>2nd_item_fav_brand</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>no</td>
</tr>
<tr>
<td>2</td>
<td>no</td>
</tr>
<tr>
<td>3</td>
<td>yes</td>
</tr>
<tr>
<td>4</td>
<td>no</td>
</tr>
</tbody></table>
<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">      user_id <span class="keyword">as</span> seller_id,</span><br><span class="line">      if (r2.item_brand <span class="keyword">is</span> <span class="keyword">null</span> <span class="operator">||</span> r2.item_brand <span class="operator">!=</span> favorite_brand, &quot;no&quot;, &quot;yes&quot;) <span class="keyword">as</span> <span class="number">2</span>nd_item_fav_brand</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      <span class="number">54</span>_users</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> </span><br><span class="line">     (<span class="keyword">select</span></span><br><span class="line">            r1.seller_id,</span><br><span class="line">            i.item_brand </span><br><span class="line">      <span class="keyword">from</span></span><br><span class="line">           (<span class="keyword">select</span> </span><br><span class="line">                  <span class="variable">@rk</span> :<span class="operator">=</span> if (<span class="variable">@seller</span> <span class="operator">=</span> a.seller_id, <span class="variable">@rk</span> <span class="operator">+</span> <span class="number">1</span>, <span class="number">1</span>) <span class="keyword">as</span> `rank`,</span><br><span class="line">                  <span class="variable">@seller</span> :<span class="operator">=</span> a.seller_id <span class="keyword">as</span> seller_id, </span><br><span class="line">                  a.item_id</span><br><span class="line">            <span class="keyword">from</span> </span><br><span class="line">                 (<span class="keyword">select</span> </span><br><span class="line">                       seller_id,</span><br><span class="line">                       item_id</span><br><span class="line">                  <span class="keyword">from</span> </span><br><span class="line">                       <span class="number">54</span>_orders </span><br><span class="line">                  <span class="keyword">order</span> <span class="keyword">by</span> </span><br><span class="line">                       seller_id, order_date) a,</span><br><span class="line">                 (<span class="keyword">select</span> <span class="variable">@seller</span> :<span class="operator">=</span> <span class="number">-1</span>, <span class="variable">@rk</span> :<span class="operator">=</span> <span class="number">0</span>) b</span><br><span class="line">            ) r1</span><br><span class="line">     <span class="keyword">join</span> </span><br><span class="line">          <span class="number">54</span>_items i</span><br><span class="line">     <span class="keyword">on</span></span><br><span class="line">          r1.item_id <span class="operator">=</span> i.item_id</span><br><span class="line">     <span class="keyword">where</span></span><br><span class="line">          r1.`rank` <span class="operator">=</span> <span class="number">2</span>) r2 </span><br><span class="line"><span class="keyword">on</span></span><br><span class="line">     user_id <span class="operator">=</span> r2.seller_id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法二：</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">     user_id seller_id,</span><br><span class="line">     if(favorite_brand <span class="operator">=</span> item_brand, <span class="string">&#x27;yes&#x27;</span>, <span class="string">&#x27;no&#x27;</span>) <span class="number">2</span>nd_item_fav_brand</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">     <span class="number">54</span>_users</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">    (<span class="keyword">select</span></span><br><span class="line">          o1.seller_id,</span><br><span class="line">          item_brand</span><br><span class="line">     <span class="keyword">from</span></span><br><span class="line">          <span class="number">54</span>_orders o1 </span><br><span class="line">     <span class="keyword">join</span></span><br><span class="line">          <span class="number">54</span>_orders o2</span><br><span class="line">     <span class="keyword">on</span></span><br><span class="line">          o1.seller_id <span class="operator">=</span> o2.seller_id</span><br><span class="line">     <span class="keyword">join</span></span><br><span class="line">          <span class="number">54</span>_items i</span><br><span class="line">     <span class="keyword">on</span></span><br><span class="line">          o1.item_id <span class="operator">=</span> i.item_id</span><br><span class="line">     <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">          o1.order_id</span><br><span class="line">     <span class="keyword">having</span> </span><br><span class="line">          <span class="built_in">sum</span>(o1.order_date <span class="operator">&gt;</span> o2.order_date) <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">     ) tmp</span><br><span class="line"><span class="keyword">on</span> user_id <span class="operator">=</span> seller_id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法三：</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">     u.seller_id,</span><br><span class="line">     if(favorite_brand <span class="operator">=</span> item_brand, <span class="string">&#x27;yes&#x27;</span>, <span class="string">&#x27;no&#x27;</span>) <span class="keyword">as</span>  <span class="number">2</span>nd_item_fav_brand                          </span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    (<span class="keyword">select</span> user_id <span class="keyword">as</span> seller_id <span class="keyword">from</span> <span class="number">54</span>_Users) u</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">    (<span class="keyword">select</span> </span><br><span class="line">           <span class="operator">*</span> </span><br><span class="line">     <span class="keyword">from</span></span><br><span class="line">          (<span class="keyword">select</span></span><br><span class="line">                o.order_date,</span><br><span class="line">                o.seller_id,</span><br><span class="line">                i.item_brand,</span><br><span class="line">                u.favorite_brand,</span><br><span class="line">                <span class="built_in">rank</span>() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> o.seller_id <span class="keyword">order</span> <span class="keyword">by</span> o.order_date) rnk</span><br><span class="line">           <span class="keyword">from</span> </span><br><span class="line">                <span class="number">54</span>_Orders o </span><br><span class="line">           <span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">                <span class="number">54</span>_Users u</span><br><span class="line">           <span class="keyword">on</span> </span><br><span class="line">                o.seller_id <span class="operator">=</span> u.user_id</span><br><span class="line">           <span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">                <span class="number">54</span>_Items i</span><br><span class="line">           <span class="keyword">on</span> </span><br><span class="line">                o.item_id <span class="operator">=</span> i.item_id</span><br><span class="line">           ) t1</span><br><span class="line">     <span class="keyword">where</span> rnk <span class="operator">=</span> <span class="number">2</span></span><br><span class="line">     ) t2</span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">     u.seller_id <span class="operator">=</span> t2.seller_id</span><br></pre></td></tr></table></figure>

<h2 id="55-指定日期产品价格"><a href="#55-指定日期产品价格" class="headerlink" title="55. 指定日期产品价格"></a>55. 指定日期产品价格</h2><p>需求一： 写一段 SQL来查找在 <strong>2019-08-16</strong> 时全部产品的价格，假设所有产品在修改前的价格都是 <strong>10。</strong> </p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>project_id</th>
<th>price</th>
</tr>
</thead>
<tbody><tr>
<td>2</td>
<td>50</td>
</tr>
<tr>
<td>1</td>
<td>35</td>
</tr>
<tr>
<td>3</td>
<td>10</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">55</span>_Products (product_id <span class="type">int</span>, new_price <span class="type">int</span>, change_date <span class="type">date</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">55</span>_Products;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">55</span>_Products (product_id, new_price, change_date) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">20</span>, <span class="string">&#x27;2019-08-14&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">55</span>_Products (product_id, new_price, change_date) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">50</span>, <span class="string">&#x27;2019-08-14&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">55</span>_Products (product_id, new_price, change_date) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">30</span>, <span class="string">&#x27;2019-08-15&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">55</span>_Products (product_id, new_price, change_date) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">35</span>, <span class="string">&#x27;2019-08-16&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">55</span>_Products (product_id, new_price, change_date) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">65</span>, <span class="string">&#x27;2019-08-17&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">55</span>_Products (product_id, new_price, change_date) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">20</span>, <span class="string">&#x27;2019-08-18&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="operator">*</span> </span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">    (<span class="keyword">SELECT</span> </span><br><span class="line">           product_id,</span><br><span class="line">           new_price <span class="keyword">AS</span> price</span><br><span class="line">     <span class="keyword">FROM</span> </span><br><span class="line">           <span class="number">55</span>_Products</span><br><span class="line">     <span class="keyword">WHERE</span> (product_id, change_date) <span class="keyword">IN</span> (</span><br><span class="line">                                          <span class="keyword">SELECT</span></span><br><span class="line">                                                product_id,</span><br><span class="line">                                                <span class="built_in">MAX</span>(change_date)</span><br><span class="line">                                          <span class="keyword">FROM</span> </span><br><span class="line">                                                <span class="number">55</span>_Products</span><br><span class="line">                                          <span class="keyword">WHERE</span> </span><br><span class="line">                                                change_date <span class="operator">&lt;=</span> <span class="string">&#x27;2019-08-16&#x27;</span></span><br><span class="line">                                          <span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">                                                product_id</span><br><span class="line">                                         )</span><br><span class="line">     <span class="keyword">UNION</span></span><br><span class="line">     <span class="keyword">SELECT</span></span><br><span class="line">            <span class="keyword">DISTINCT</span> product_id, <span class="number">10</span> <span class="keyword">AS</span> price</span><br><span class="line">     <span class="keyword">FROM</span> </span><br><span class="line">            <span class="number">55</span>_Products</span><br><span class="line">     <span class="keyword">WHERE</span> </span><br><span class="line">            product_id <span class="keyword">NOT</span> <span class="keyword">IN</span> (<span class="keyword">SELECT</span></span><br><span class="line">                                     product_id</span><br><span class="line">                               <span class="keyword">FROM</span>  </span><br><span class="line">                                     <span class="number">55</span>_Products</span><br><span class="line">                               <span class="keyword">WHERE</span> change_date <span class="operator">&lt;=</span> <span class="string">&#x27;2019-08-16&#x27;</span></span><br><span class="line">                              )</span><br><span class="line">     ) tmp</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> </span><br><span class="line">     price <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<h2 id="56-即时食物配送"><a href="#56-即时食物配送" class="headerlink" title="56. 即时食物配送"></a>56. 即时食物配送</h2><p>需求一：查询语句获取即时订单所占的百分比， <strong>保留两位小数。</strong></p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>immediate_percentage</th>
</tr>
</thead>
<tbody><tr>
<td>42.86</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">56</span>_Delivery (delivery_id <span class="type">int</span>, customer_id <span class="type">int</span>, order_date <span class="type">date</span>, customer_pref_delivery_date <span class="type">date</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">56</span>_Delivery;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">56</span>_Delivery (delivery_id, customer_id, order_date, customer_pref_delivery_date) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="string">&#x27;2019-08-01&#x27;</span>, <span class="string">&#x27;2019-08-02&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">56</span>_Delivery (delivery_id, customer_id, order_date, customer_pref_delivery_date) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">5</span>, <span class="string">&#x27;2019-08-02&#x27;</span>, <span class="string">&#x27;2019-08-02&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">56</span>_Delivery (delivery_id, customer_id, order_date, customer_pref_delivery_date) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">1</span>, <span class="string">&#x27;2019-08-11&#x27;</span>, <span class="string">&#x27;2019-08-11&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">56</span>_Delivery (delivery_id, customer_id, order_date, customer_pref_delivery_date) <span class="keyword">values</span> (<span class="number">4</span>, <span class="number">3</span>, <span class="string">&#x27;2019-08-24&#x27;</span>, <span class="string">&#x27;2019-08-26&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">56</span>_Delivery (delivery_id, customer_id, order_date, customer_pref_delivery_date) <span class="keyword">values</span> (<span class="number">5</span>, <span class="number">4</span>, <span class="string">&#x27;2019-08-21&#x27;</span>, <span class="string">&#x27;2019-08-22&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">56</span>_Delivery (delivery_id, customer_id, order_date, customer_pref_delivery_date) <span class="keyword">values</span> (<span class="number">6</span>, <span class="number">2</span>, <span class="string">&#x27;2019-08-11&#x27;</span>, <span class="string">&#x27;2019-08-13&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">56</span>_Delivery (delivery_id, customer_id, order_date, customer_pref_delivery_date) <span class="keyword">values</span> (<span class="number">7</span>, <span class="number">4</span>, <span class="string">&#x27;2019-08-09&#x27;</span>, <span class="string">&#x27;2019-08-09&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> ROUND(</span><br><span class="line">    (<span class="keyword">SELECT</span></span><br><span class="line">           <span class="built_in">COUNT</span>(delivery_id)</span><br><span class="line">    <span class="keyword">FROM</span> </span><br><span class="line">           <span class="number">56</span>_Delivery</span><br><span class="line">    <span class="keyword">WHERE</span> </span><br><span class="line">           order_date <span class="operator">=</span> customer_pref_delivery_date</span><br><span class="line">    ) <span class="operator">*</span> <span class="number">100</span> <span class="operator">/</span> <span class="built_in">COUNT</span>(delivery_id) , <span class="number">2</span>) <span class="keyword">AS</span> immediate_percentage</span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">    <span class="number">56</span>_Delivery;</span><br></pre></td></tr></table></figure>

<p>需求二：查询语句获取即时订单在所有用户的首次订单中的比例。<strong>保留两位小数。</strong></p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>immediate_percentage</th>
</tr>
</thead>
<tbody><tr>
<td>40.00</td>
</tr>
</tbody></table>
<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">      round(</span><br><span class="line">               <span class="built_in">count</span>(<span class="keyword">case</span> <span class="keyword">when</span> d.order_date <span class="operator">=</span> d.customer_pref_delivery_date <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">end</span>)</span><br><span class="line">               <span class="operator">*</span> </span><br><span class="line">               <span class="number">100</span><span class="operator">/</span><span class="built_in">count</span>(<span class="operator">*</span>), <span class="number">2</span>) <span class="keyword">as</span> immediate_percentage</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">     <span class="number">56</span>_Delivery d,</span><br><span class="line">    (<span class="keyword">select</span></span><br><span class="line">           delivery_id,</span><br><span class="line">           customer_id,</span><br><span class="line">           <span class="built_in">min</span>(order_date) <span class="keyword">as</span> order_date</span><br><span class="line">     <span class="keyword">from</span></span><br><span class="line">           <span class="number">56</span>_Delivery</span><br><span class="line">     <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">           customer_id</span><br><span class="line">    ) <span class="keyword">as</span> t</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">     d.customer_id <span class="operator">=</span> t.customer_id</span><br><span class="line">     <span class="keyword">and</span> d.order_date <span class="operator">=</span> t.order_date;</span><br></pre></td></tr></table></figure>

<h2 id="57-重新格式化部门表"><a href="#57-重新格式化部门表" class="headerlink" title="57. 重新格式化部门表"></a>57. 重新格式化部门表</h2><p>需求一：编写一个 SQL 查询来重新格式化表，使得新的表中有一个部门 id 列和一些对应 每个月 的收入（revenue）列。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>Jan_Revenue</th>
<th>Feb_Revenue</th>
<th>Mar_Revenue</th>
<th>…</th>
<th>Dec_Revenue</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>8000</td>
<td>7000</td>
<td>6000</td>
<td>…</td>
<td>null</td>
</tr>
<tr>
<td>2</td>
<td>9000</td>
<td>null</td>
<td>null</td>
<td>…</td>
<td>null</td>
</tr>
<tr>
<td>3</td>
<td>null</td>
<td>10000</td>
<td>null</td>
<td>…</td>
<td>null</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">57</span>_Department (id <span class="type">int</span>, revenue <span class="type">int</span>, <span class="keyword">month</span> <span class="type">varchar</span>(<span class="number">5</span>));</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">57</span>_Department;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">57</span>_Department (id, revenue, <span class="keyword">month</span>) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">8000</span>, <span class="string">&#x27;Jan&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">57</span>_Department (id, revenue, <span class="keyword">month</span>) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">9000</span>, <span class="string">&#x27;Jan&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">57</span>_Department (id, revenue, <span class="keyword">month</span>) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">10000</span>, <span class="string">&#x27;Feb&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">57</span>_Department (id, revenue, <span class="keyword">month</span>) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">7000</span>, <span class="string">&#x27;Feb&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">57</span>_Department (id, revenue, <span class="keyword">month</span>) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">6000</span>, <span class="string">&#x27;Mar&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">      <span class="keyword">DISTINCT</span> id <span class="keyword">AS</span> &quot;id&quot;,</span><br><span class="line">      <span class="built_in">SUM</span>(IF (<span class="keyword">month</span> <span class="operator">=</span> &quot;Jan&quot;, revenue, <span class="keyword">null</span>)) <span class="keyword">AS</span> &quot;Jan_Revenue&quot;,</span><br><span class="line">      <span class="built_in">SUM</span>(IF (<span class="keyword">month</span> <span class="operator">=</span> &quot;Feb&quot;, revenue, <span class="keyword">null</span>)) <span class="keyword">AS</span> &quot;Feb_Revenue&quot;,</span><br><span class="line">      <span class="built_in">SUM</span>(IF (<span class="keyword">month</span> <span class="operator">=</span> &quot;Mar&quot;, revenue, <span class="keyword">null</span>)) <span class="keyword">AS</span> &quot;Mar_Revenue&quot;,</span><br><span class="line">      <span class="built_in">SUM</span>(IF (<span class="keyword">month</span> <span class="operator">=</span> &quot;Apr&quot;, revenue, <span class="keyword">null</span>)) <span class="keyword">AS</span> &quot;Apr_Revenue&quot;,</span><br><span class="line">      <span class="built_in">SUM</span>(IF (<span class="keyword">month</span> <span class="operator">=</span> &quot;May&quot;, revenue, <span class="keyword">null</span>)) <span class="keyword">AS</span> &quot;May_Revenue&quot;,</span><br><span class="line">      <span class="built_in">SUM</span>(IF (<span class="keyword">month</span> <span class="operator">=</span> &quot;Jun&quot;, revenue, <span class="keyword">null</span>)) <span class="keyword">AS</span> &quot;Jun_Revenue&quot;,</span><br><span class="line">      <span class="built_in">SUM</span>(IF (<span class="keyword">month</span> <span class="operator">=</span> &quot;Jul&quot;, revenue, <span class="keyword">null</span>)) <span class="keyword">AS</span> &quot;Jul_Revenue&quot;,</span><br><span class="line">      <span class="built_in">SUM</span>(IF (<span class="keyword">month</span> <span class="operator">=</span> &quot;Aug&quot;, revenue, <span class="keyword">null</span>)) <span class="keyword">AS</span> &quot;Aug_Revenue&quot;,</span><br><span class="line">      <span class="built_in">SUM</span>(IF (<span class="keyword">month</span> <span class="operator">=</span> &quot;Sep&quot;, revenue, <span class="keyword">null</span>)) <span class="keyword">AS</span> &quot;Sep_Revenue&quot;,</span><br><span class="line">      <span class="built_in">SUM</span>(IF (<span class="keyword">month</span> <span class="operator">=</span> &quot;Oct&quot;, revenue, <span class="keyword">null</span>)) <span class="keyword">AS</span> &quot;Oct_Revenue&quot;,</span><br><span class="line">      <span class="built_in">SUM</span>(IF (<span class="keyword">month</span> <span class="operator">=</span> &quot;Nov&quot;, revenue, <span class="keyword">null</span>)) <span class="keyword">AS</span> &quot;Nov_Revenue&quot;,</span><br><span class="line">      <span class="built_in">SUM</span>(IF (<span class="keyword">month</span> <span class="operator">=</span> &quot;Dec&quot;, revenue, <span class="keyword">null</span>)) <span class="keyword">AS</span> &quot;Dec_Revenue&quot; </span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">      <span class="number">57</span>_Department</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> id;</span><br></pre></td></tr></table></figure>

<h2 id="58-每月交易"><a href="#58-每月交易" class="headerlink" title="58. 每月交易"></a>58. 每月交易</h2><p>需求一：查找每个月和每个国家/地区的事务数及其总金额、已批准的事务数及其总金额。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>month</th>
<th>country</th>
<th>trans_count</th>
<th>approved_count</th>
<th>trans_total_amount</th>
<th>approved_total_amount</th>
</tr>
</thead>
<tbody><tr>
<td>2018-12</td>
<td>US</td>
<td>2</td>
<td>1</td>
<td>3000</td>
<td>1000</td>
</tr>
<tr>
<td>2019-01</td>
<td>US</td>
<td>1</td>
<td>1</td>
<td>2000</td>
<td>2000</td>
</tr>
<tr>
<td>2019-01</td>
<td>DE</td>
<td>1</td>
<td>1</td>
<td>2000</td>
<td>2000</td>
</tr>
<tr>
<td>2019-05</td>
<td>US</td>
<td>2</td>
<td>1</td>
<td>3000</td>
<td>1000</td>
</tr>
<tr>
<td>2019-06</td>
<td>US</td>
<td>3</td>
<td>2</td>
<td>12000</td>
<td>8000</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> <span class="number">58</span>_Transactions (id <span class="type">int</span>, country <span class="type">varchar</span>(<span class="number">4</span>), state enum(<span class="string">&#x27;approved&#x27;</span>, <span class="string">&#x27;declined&#x27;</span>), amount <span class="type">int</span>, trans_date <span class="type">date</span>);</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> <span class="number">58</span>_Chargebacks (trans_id <span class="type">int</span>, trans_date <span class="type">date</span>);</span><br><span class="line"><span class="keyword">truncate</span> <span class="keyword">table</span> <span class="number">58</span>_Transactions;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">58</span>_Transactions (id, country, state, amount, trans_date) <span class="keyword">values</span> (<span class="number">101</span>, <span class="string">&#x27;US&#x27;</span>, <span class="string">&#x27;approved&#x27;</span>, <span class="number">1000</span>, <span class="string">&#x27;2018-12-18&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">58</span>_Transactions (id, country, state, amount, trans_date) <span class="keyword">values</span> (<span class="number">102</span>, <span class="string">&#x27;US&#x27;</span>, <span class="string">&#x27;declined&#x27;</span>, <span class="number">2000</span>, <span class="string">&#x27;2018-12-19&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">58</span>_Transactions (id, country, state, amount, trans_date) <span class="keyword">values</span> (<span class="number">103</span>, <span class="string">&#x27;US&#x27;</span>, <span class="string">&#x27;approved&#x27;</span>, <span class="number">2000</span>, <span class="string">&#x27;2019-01-01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">58</span>_Transactions (id, country, state, amount, trans_date) <span class="keyword">values</span> (<span class="number">104</span>, <span class="string">&#x27;DE&#x27;</span>, <span class="string">&#x27;approved&#x27;</span>, <span class="number">2000</span>, <span class="string">&#x27;2019-01-07&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">58</span>_Transactions (id, country, state, amount, trans_date) <span class="keyword">values</span> (<span class="number">105</span>, <span class="string">&#x27;US&#x27;</span>, <span class="string">&#x27;approved&#x27;</span>, <span class="number">1000</span>, <span class="string">&#x27;2019-05-18&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">58</span>_Transactions (id, country, state, amount, trans_date) <span class="keyword">values</span> (<span class="number">106</span>, <span class="string">&#x27;US&#x27;</span>, <span class="string">&#x27;declined&#x27;</span>, <span class="number">2000</span>, <span class="string">&#x27;2019-05-19&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">58</span>_Transactions (id, country, state, amount, trans_date) <span class="keyword">values</span> (<span class="number">107</span>, <span class="string">&#x27;US&#x27;</span>, <span class="string">&#x27;approved&#x27;</span>, <span class="number">3000</span>, <span class="string">&#x27;2019-06-10&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">58</span>_Transactions (id, country, state, amount, trans_date) <span class="keyword">values</span> (<span class="number">108</span>, <span class="string">&#x27;US&#x27;</span>, <span class="string">&#x27;declined&#x27;</span>, <span class="number">4000</span>, <span class="string">&#x27;2019-06-13&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">58</span>_Transactions (id, country, state, amount, trans_date) <span class="keyword">values</span> (<span class="number">109</span>, <span class="string">&#x27;US&#x27;</span>, <span class="string">&#x27;approved&#x27;</span>, <span class="number">5000</span>, <span class="string">&#x27;2019-06-15&#x27;</span>);</span><br><span class="line"><span class="keyword">truncate</span> <span class="keyword">table</span> <span class="number">58</span>_Chargebacks;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">58</span>_Chargebacks (trans_id, trans_date) <span class="keyword">values</span> (<span class="number">102</span>, <span class="string">&#x27;2019-05-29&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">58</span>_Chargebacks (trans_id, trans_date) <span class="keyword">values</span> (<span class="number">101</span>, <span class="string">&#x27;2019-06-30&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">58</span>_Chargebacks (trans_id, trans_date) <span class="keyword">values</span> (<span class="number">105</span>, <span class="string">&#x27;2019-09-18&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">      date_format(trans_date,<span class="string">&#x27;%Y-%m&#x27;</span>) <span class="keyword">as</span> <span class="keyword">month</span>,</span><br><span class="line">      country,</span><br><span class="line">      <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> trans_count,</span><br><span class="line">      <span class="built_in">sum</span>(if(state<span class="operator">=</span><span class="string">&#x27;approved&#x27;</span>,<span class="number">1</span>,<span class="number">0</span>)) <span class="keyword">as</span> approved_count,</span><br><span class="line">      <span class="built_in">sum</span>(amount) <span class="keyword">as</span> trans_total_amount,</span><br><span class="line">      <span class="built_in">sum</span>(if(state<span class="operator">=</span><span class="string">&#x27;approved&#x27;</span>,amount,<span class="number">0</span>)) <span class="keyword">as</span> approved_total_amount</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      <span class="number">58</span>_Transactions t</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">      date_format(trans_date,<span class="string">&#x27;%Y-%m&#x27;</span>),</span><br><span class="line">      country;</span><br></pre></td></tr></table></figure>

<p>需求二：编写一个 SQL 查询，以查找每个月和每个国家/地区的已批准交易的数量及其总金额、退单的数量及其总金额。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>month</th>
<th>country</th>
<th>approved_count</th>
<th>approved_amount</th>
<th>chargeback_count</th>
<th>chargeback_amount</th>
</tr>
</thead>
<tbody><tr>
<td>2018-12</td>
<td>US</td>
<td>1</td>
<td>1000</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>2019-01</td>
<td>DE</td>
<td>1</td>
<td>2000</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>2019-01</td>
<td>US</td>
<td>1</td>
<td>2000</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>2019-05</td>
<td>US</td>
<td>1</td>
<td>1000</td>
<td>1</td>
<td>2000</td>
</tr>
<tr>
<td>2019-06</td>
<td>US</td>
<td>2</td>
<td>8000</td>
<td>1</td>
<td>1000</td>
</tr>
<tr>
<td>2019-09</td>
<td>US</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>1000</td>
</tr>
</tbody></table>
<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">       <span class="keyword">month</span> <span class="keyword">as</span> <span class="keyword">MONTH</span>,</span><br><span class="line">       country <span class="keyword">as</span> COUNTRY,</span><br><span class="line">       <span class="built_in">SUM</span>(IF(type <span class="operator">=</span> <span class="string">&#x27;approved&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) <span class="keyword">AS</span> APPROVED_COUNT,</span><br><span class="line">       <span class="built_in">SUM</span>(IF(type <span class="operator">=</span> <span class="string">&#x27;approved&#x27;</span>, amount, <span class="number">0</span>)) <span class="keyword">AS</span> APPROVED_AMOUNT,</span><br><span class="line">       <span class="built_in">SUM</span>(IF(type <span class="operator">=</span> <span class="string">&#x27;chargeback&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) <span class="keyword">AS</span> CHARGEBACK_COUNT,</span><br><span class="line">       <span class="built_in">SUM</span>(IF(type <span class="operator">=</span> <span class="string">&#x27;chargeback&#x27;</span>, amount, <span class="number">0</span>)) <span class="keyword">AS</span> CHARGEBACK_AMOUNT</span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">      (<span class="keyword">SELECT</span> </span><br><span class="line">              date_format(t.trans_date,<span class="string">&#x27;%Y-%m&#x27;</span>) <span class="keyword">AS</span> <span class="keyword">month</span>,</span><br><span class="line">              t.country,</span><br><span class="line">              amount,</span><br><span class="line">              <span class="string">&#x27;approved&#x27;</span> <span class="keyword">AS</span> type</span><br><span class="line">        <span class="keyword">FROM</span></span><br><span class="line">              <span class="number">58</span>_Transactions <span class="keyword">AS</span> t</span><br><span class="line">        <span class="keyword">WHERE</span> </span><br><span class="line">              state <span class="operator">=</span> <span class="string">&#x27;approved&#x27;</span></span><br><span class="line">        <span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line">        <span class="keyword">SELECT</span></span><br><span class="line">              date_format(c.trans_date,<span class="string">&#x27;%Y-%m&#x27;</span>) <span class="keyword">AS</span> <span class="keyword">month</span>,</span><br><span class="line">              t.country,</span><br><span class="line">              amount,</span><br><span class="line">              <span class="string">&#x27;chargeback&#x27;</span> <span class="keyword">AS</span> type</span><br><span class="line">         <span class="keyword">FROM</span> </span><br><span class="line">              <span class="number">58</span>_Transactions <span class="keyword">AS</span> t</span><br><span class="line">         <span class="keyword">INNER</span> <span class="keyword">JOIN</span></span><br><span class="line">              <span class="number">58</span>_Chargebacks <span class="keyword">AS</span> c </span><br><span class="line">         <span class="keyword">ON</span> t.id <span class="operator">=</span> c.trans_id</span><br><span class="line">         ) <span class="keyword">AS</span> tt</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> </span><br><span class="line">         tt.month,</span><br><span class="line">         tt.country;</span><br></pre></td></tr></table></figure>

<h2 id="59-锦标赛优胜者"><a href="#59-锦标赛优胜者" class="headerlink" title="59. 锦标赛优胜者"></a>59. 锦标赛优胜者</h2><p>需求一：编写一个 SQL 查询来查找每组中的获胜者。每组的获胜者是在组内得分最高的选手。如果平局，player_id 最小的的选手获胜。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>group_id</th>
<th>player_id</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>15</td>
</tr>
<tr>
<td>2</td>
<td>35</td>
</tr>
<tr>
<td>3</td>
<td>40</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">59</span>_Players (player_id <span class="type">int</span>, group_id <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">59</span>_Matches (match_id <span class="type">int</span>, first_player <span class="type">int</span>, second_player <span class="type">int</span>, first_score <span class="type">int</span>, second_score <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">59</span>_Players;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">59</span>_Players (player_id, group_id) <span class="keyword">values</span> (<span class="number">10</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">59</span>_Players (player_id, group_id) <span class="keyword">values</span> (<span class="number">15</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">59</span>_Players (player_id, group_id) <span class="keyword">values</span> (<span class="number">20</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">59</span>_Players (player_id, group_id) <span class="keyword">values</span> (<span class="number">25</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">59</span>_Players (player_id, group_id) <span class="keyword">values</span> (<span class="number">30</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">59</span>_Players (player_id, group_id) <span class="keyword">values</span> (<span class="number">35</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">59</span>_Players (player_id, group_id) <span class="keyword">values</span> (<span class="number">40</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">59</span>_Players (player_id, group_id) <span class="keyword">values</span> (<span class="number">45</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">59</span>_Players (player_id, group_id) <span class="keyword">values</span> (<span class="number">50</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">59</span>_Matches;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">59</span>_Matches (match_id, first_player, second_player, first_score, second_score) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">15</span>, <span class="number">45</span>, <span class="number">3</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">59</span>_Matches (match_id, first_player, second_player, first_score, second_score) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">30</span>, <span class="number">25</span>, <span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">59</span>_Matches (match_id, first_player, second_player, first_score, second_score) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">30</span>, <span class="number">15</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">59</span>_Matches (match_id, first_player, second_player, first_score, second_score) <span class="keyword">values</span> (<span class="number">4</span>, <span class="number">40</span>, <span class="number">20</span>, <span class="number">5</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">59</span>_Matches (match_id, first_player, second_player, first_score, second_score) <span class="keyword">values</span> (<span class="number">5</span>, <span class="number">35</span>, <span class="number">50</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">      group_id,</span><br><span class="line">      <span class="built_in">max</span>(total_scores) max_scores</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    (<span class="keyword">select</span> </span><br><span class="line">           group_id,</span><br><span class="line">           player_id,</span><br><span class="line">           <span class="built_in">sum</span>(</span><br><span class="line">               <span class="keyword">case</span></span><br><span class="line">                   <span class="keyword">when</span> player_id <span class="operator">=</span> first_player <span class="keyword">then</span> first_score</span><br><span class="line">                   <span class="keyword">when</span> player_id <span class="operator">=</span> second_player <span class="keyword">then</span> second_score</span><br><span class="line">               <span class="keyword">end</span></span><br><span class="line">               ) <span class="keyword">as</span> total_scores</span><br><span class="line">     <span class="keyword">from</span> </span><br><span class="line">          <span class="number">59</span>_Players p,</span><br><span class="line">          <span class="number">59</span>_Matches m</span><br><span class="line">     <span class="keyword">where</span></span><br><span class="line">          p.player_id <span class="operator">=</span> m.first_player <span class="keyword">or</span></span><br><span class="line">          p.player_id <span class="operator">=</span> m.second_player</span><br><span class="line">     <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">          group_id,</span><br><span class="line">          player_id</span><br><span class="line">     <span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">          group_id,</span><br><span class="line">          total_scores <span class="keyword">desc</span>,</span><br><span class="line">          player_id</span><br><span class="line">    ) <span class="keyword">as</span> temp</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">     group_id</span><br><span class="line"></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> </span><br><span class="line">     group_id,</span><br><span class="line">     total_scores <span class="keyword">desc</span>,</span><br><span class="line">     player_id;</span><br></pre></td></tr></table></figure>

<h2 id="60-最后一个能进入电梯的人"><a href="#60-最后一个能进入电梯的人" class="headerlink" title="60. 最后一个能进入电梯的人"></a>60. 最后一个能进入电梯的人</h2><p>需求：查找最后一个能进入电梯且不超过重量限制的 <code>person_name</code> 。题目确保队列中第一位的人可以进入电梯 。</p>
<p>展示效果：</p>
<table>
<thead>
<tr>
<th>person_name</th>
</tr>
</thead>
<tbody><tr>
<td>Thomas Jefferson</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> <span class="number">60</span>_Queue (person_id <span class="type">int</span>, person_name <span class="type">varchar</span>(<span class="number">30</span>), weight <span class="type">int</span>, turn <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> <span class="number">60</span>_Queue;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">60</span>_Queue (person_id, person_name, weight, turn) <span class="keyword">values</span> (<span class="number">5</span>, <span class="string">&#x27;George Washington&#x27;</span>, <span class="number">250</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">60</span>_Queue (person_id, person_name, weight, turn) <span class="keyword">values</span> (<span class="number">4</span>, <span class="string">&#x27;Thomas Jefferson&#x27;</span>, <span class="number">175</span>, <span class="number">5</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">60</span>_Queue (person_id, person_name, weight, turn) <span class="keyword">values</span> (<span class="number">3</span>, <span class="string">&#x27;John Adams&#x27;</span>, <span class="number">350</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">60</span>_Queue (person_id, person_name, weight, turn) <span class="keyword">values</span> (<span class="number">6</span>, <span class="string">&#x27;Thomas Jefferson&#x27;</span>, <span class="number">400</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">60</span>_Queue (person_id, person_name, weight, turn) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;James Elephant&#x27;</span>, <span class="number">500</span>, <span class="number">6</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="number">60</span>_Queue (person_id, person_name, weight, turn) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;Will Johnliams&#x27;</span>, <span class="number">200</span>, <span class="number">4</span>);</span><br></pre></td></tr></table></figure>

<p>最终SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">      person_name</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">      <span class="number">60</span>_Queue q1</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">     (<span class="keyword">select</span></span><br><span class="line">           <span class="built_in">sum</span>(weight)</span><br><span class="line">      <span class="keyword">from</span></span><br><span class="line">           <span class="number">60</span>_Queue q</span><br><span class="line">      <span class="keyword">where</span> turn <span class="operator">&lt;=</span> q1.turn) <span class="operator">&lt;=</span> <span class="number">1000</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> </span><br><span class="line">      turn <span class="keyword">desc</span> </span><br><span class="line">limit <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<h2 id=""><a href="#" class="headerlink" title=""></a></h2>
    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/03/11/101-/" rel="prev" title="101-最后">
                  <i class="fa fa-chevron-left"></i> 101-最后
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2021/03/11/1-20/" rel="next" title="1-20">
                  1-20 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>







<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">hefei</span>
</div>
  <div class="powered-by">تطبيق الموقع <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
